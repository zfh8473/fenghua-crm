# Story 2.4: äº§å“ä¸å®¢æˆ·å…³è”æŸ¥çœ‹ï¼ˆæŒ‰è§’è‰²ï¼‰

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a **å‰ç«¯ä¸“å‘˜/åç«¯ä¸“å‘˜/æ€»ç›‘/ç®¡ç†å‘˜**,
I want **æŸ¥çœ‹æŸä¸ªäº§å“ä¸å“ªäº›å®¢æˆ·æœ‰å…³è”**,
So that **æˆ‘å¯ä»¥äº†è§£äº§å“çš„å®¢æˆ·å…³ç³»ï¼Œåˆ†æäº§å“çš„ä¸šåŠ¡æƒ…å†µ**.

## Acceptance Criteria

1. **Given** å‰ç«¯ä¸“å‘˜å·²ç™»å½•ç³»ç»Ÿ
   **When** å‰ç«¯ä¸“å‘˜æŸ¥çœ‹äº§å“è¯¦æƒ…é¡µé¢
   **Then** ç³»ç»Ÿæ˜¾ç¤º"å…³è”çš„é‡‡è´­å•†"éƒ¨åˆ†
   **And** ç³»ç»Ÿåªæ˜¾ç¤ºè¯¥äº§å“å…³è”çš„é‡‡è´­å•†ç±»å‹å®¢æˆ·
   **And** ç³»ç»Ÿä¸æ˜¾ç¤ºä¾›åº”å•†ç±»å‹å®¢æˆ·

2. **Given** åç«¯ä¸“å‘˜å·²ç™»å½•ç³»ç»Ÿ
   **When** åç«¯ä¸“å‘˜æŸ¥çœ‹äº§å“è¯¦æƒ…é¡µé¢
   **Then** ç³»ç»Ÿæ˜¾ç¤º"å…³è”çš„ä¾›åº”å•†"éƒ¨åˆ†
   **And** ç³»ç»Ÿåªæ˜¾ç¤ºè¯¥äº§å“å…³è”çš„ä¾›åº”å•†ç±»å‹å®¢æˆ·
   **And** ç³»ç»Ÿä¸æ˜¾ç¤ºé‡‡è´­å•†ç±»å‹å®¢æˆ·

3. **Given** æ€»ç›‘æˆ–ç®¡ç†å‘˜å·²ç™»å½•ç³»ç»Ÿ
   **When** æ€»ç›‘æˆ–ç®¡ç†å‘˜æŸ¥çœ‹äº§å“è¯¦æƒ…é¡µé¢
   **Then** ç³»ç»Ÿæ˜¾ç¤º"å…³è”çš„å®¢æˆ·"éƒ¨åˆ†
   **And** ç³»ç»Ÿæ˜¾ç¤ºè¯¥äº§å“å…³è”çš„æ‰€æœ‰å®¢æˆ·ï¼ˆåŒ…æ‹¬é‡‡è´­å•†å’Œä¾›åº”å•†ï¼‰
   **And** å®¢æˆ·åˆ—è¡¨æŒ‰å®¢æˆ·ç±»å‹åˆ†ç»„æ˜¾ç¤º

4. **Given** ç”¨æˆ·æŸ¥çœ‹äº§å“ä¸å®¢æˆ·çš„å…³è”
   **When** äº§å“æœ‰å…³è”çš„å®¢æˆ·
   **Then** ç³»ç»Ÿæ˜¾ç¤ºå®¢æˆ·åˆ—è¡¨ï¼Œæ¯ä¸ªå®¢æˆ·æ˜¾ç¤ºï¼šå®¢æˆ·åç§°ã€å®¢æˆ·ç±»å‹ã€å…³è”çš„äº’åŠ¨æ•°é‡
   **And** ç”¨æˆ·å¯ä»¥ç‚¹å‡»å®¢æˆ·åç§°æŸ¥çœ‹å®¢æˆ·è¯¦æƒ…
   **And** ç”¨æˆ·å¯ä»¥ç‚¹å‡»"æŸ¥çœ‹äº’åŠ¨å†å²"æŸ¥çœ‹è¯¥äº§å“ä¸è¯¥å®¢æˆ·çš„å®Œæ•´äº’åŠ¨è®°å½•

5. **Given** ç”¨æˆ·æŸ¥çœ‹äº§å“ä¸å®¢æˆ·çš„å…³è”
   **When** äº§å“æ²¡æœ‰å…³è”çš„å®¢æˆ·
   **Then** ç³»ç»Ÿæ˜¾ç¤ºç©ºçŠ¶æ€"è¯¥äº§å“å°šæœªä¸ä»»ä½•å®¢æˆ·å…³è”"
   **And** ç³»ç»Ÿæä¾›æç¤º"è®°å½•äº’åŠ¨æ—¶å…³è”æ­¤äº§å“ï¼Œå³å¯å»ºç«‹å…³è”å…³ç³»"

6. **Given** ç”¨æˆ·æŸ¥çœ‹äº§å“ä¸å®¢æˆ·çš„å…³è”
   **When** å…³è”çš„å®¢æˆ·æ•°é‡è¾ƒå¤šï¼ˆ> 10 ä¸ªï¼‰
   **Then** ç³»ç»Ÿä½¿ç”¨åˆ†é¡µæˆ–æ»šåŠ¨åŠ è½½æ˜¾ç¤ºå®¢æˆ·åˆ—è¡¨
   **And** ç³»ç»Ÿæ˜¾ç¤ºå…³è”å®¢æˆ·æ€»æ•°

## Tasks / Subtasks

- [x] Task 1: åç«¯ API å®ç° (AC: #1, #2, #3, #4, #6)
  - [x] åˆ›å»ºäº§å“å®¢æˆ·å…³è”æœåŠ¡ (ProductCustomerAssociationService)
    - [x] å®ç°æŸ¥è¯¢äº§å“å…³è”å®¢æˆ·çš„æ–¹æ³• `getProductCustomers(productId, token, page, limit)`
    - [x] å®ç°åŸºäºè§’è‰²çš„æ•°æ®è¿‡æ»¤ï¼ˆä½¿ç”¨ PermissionService.getDataAccessFilterï¼‰
    - [x] ä½¿ç”¨ SQL JOIN æŸ¥è¯¢ `product_customer_interactions` å’Œ `companies` è¡¨
    - [x] ç»Ÿè®¡æ¯ä¸ªå®¢æˆ·çš„äº’åŠ¨æ•°é‡ï¼ˆä½¿ç”¨ COUNT å’Œ GROUP BYï¼‰
    - [x] å®ç° customer_type å¤§å°å†™è½¬æ¢ï¼ˆPermissionService è¿”å›å°å†™ï¼Œæ•°æ®åº“å­˜å‚¨å¤§å†™ï¼‰
    - [x] å®ç°åˆ†é¡µæ”¯æŒï¼ˆé»˜è®¤æ¯é¡µ 10 æ¡ï¼‰
    - [x] å¤„ç†è½¯åˆ é™¤çš„å®¢æˆ·ï¼ˆè¿‡æ»¤ `deleted_at IS NULL`ï¼‰
    - [x] å¤„ç†æ— æ•ˆçš„ customer_idï¼ˆé€šè¿‡ JOIN è‡ªåŠ¨è¿‡æ»¤ï¼‰
  - [x] åˆ›å»ºäº§å“å®¢æˆ·å…³è”æ§åˆ¶å™¨ (ProductCustomerAssociationController)
    - [x] åˆ›å»º GET `/api/products/:id/customers` ç«¯ç‚¹
    - [x] ä½¿ç”¨ `@UseGuards(JwtAuthGuard)` ä¿æŠ¤ç«¯ç‚¹
    - [x] å®ç°æŸ¥è¯¢å‚æ•°ï¼š`page`, `limit`, `customerType`ï¼ˆå¯é€‰ï¼Œç”¨äºæ€»ç›‘/ç®¡ç†å‘˜ç­›é€‰ï¼‰
    - [x] è¿”å›å®¢æˆ·åˆ—è¡¨å’Œæ€»æ•°
    - [x] å®ç°é”™è¯¯å¤„ç†ï¼ˆäº§å“ä¸å­˜åœ¨ã€æƒé™æ£€æŸ¥å¤±è´¥ã€æ•°æ®åº“é”™è¯¯ï¼‰
  - [x] åˆ›å»º DTOs
    - [x] `ProductCustomerAssociationDto` - è¿”å›æ•°æ®ç»“æ„ï¼ˆåŒ…å«å®¢æˆ·ä¿¡æ¯å’Œäº’åŠ¨æ•°é‡ï¼‰
    - [x] `ProductCustomerQueryDto` - æŸ¥è¯¢å‚æ•°ç»“æ„ï¼ˆpage, limit, customerTypeï¼‰

- [x] Task 2: æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ– (AC: #4, #6)
  - [x] ç¡®è®¤ `product_customer_interactions` è¡¨ç´¢å¼•å·²åˆ›å»º
    - [x] `idx_interactions_product` - æŒ‰äº§å“æŸ¥è¯¢
    - [x] `idx_interactions_product_customer` - æŒ‰äº§å“å’Œå®¢æˆ·æŸ¥è¯¢
  - [x] ç¡®è®¤ `companies` è¡¨ç´¢å¼•å·²åˆ›å»º
    - [x] `idx_companies_customer_type` - æŒ‰å®¢æˆ·ç±»å‹æŸ¥è¯¢
  - [x] å®ç°é«˜æ•ˆæŸ¥è¯¢ SQLï¼ˆä½¿ç”¨ JOIN é¿å… N+1 æŸ¥è¯¢ï¼‰ï¼š
    ```sql
    SELECT 
      c.id,
      c.name,
      c.customer_type,
      COUNT(pci.id) as interaction_count
    FROM product_customer_interactions pci
    INNER JOIN companies c ON c.id = pci.customer_id
    WHERE pci.product_id = $1 
      AND pci.deleted_at IS NULL
      AND c.deleted_at IS NULL
      AND ($2::text IS NULL OR c.customer_type = $2)  -- è§’è‰²è¿‡æ»¤ï¼Œå¤§å°å†™è½¬æ¢
    GROUP BY c.id, c.name, c.customer_type
    ORDER BY interaction_count DESC
    LIMIT $3 OFFSET $4
    ```
  - [x] å®ç°åŸºäºè§’è‰²çš„å®¢æˆ·ç±»å‹è¿‡æ»¤ï¼ˆåœ¨ SQL æŸ¥è¯¢ä¸­ï¼‰
    - [x] å‰ç«¯ä¸“å‘˜ï¼š`customer_type = 'BUYER'`ï¼ˆä½¿ç”¨ toUpperCase() è½¬æ¢ï¼‰
    - [x] åç«¯ä¸“å‘˜ï¼š`customer_type = 'SUPPLIER'`ï¼ˆä½¿ç”¨ toUpperCase() è½¬æ¢ï¼‰
    - [x] æ€»ç›‘/ç®¡ç†å‘˜ï¼šæ— è¿‡æ»¤ï¼ˆè¿”å›æ‰€æœ‰å®¢æˆ·ï¼‰
  - [x] å®ç°æ€»æ•°æŸ¥è¯¢ï¼ˆç”¨äºåˆ†é¡µï¼‰ï¼š
    ```sql
    SELECT COUNT(DISTINCT c.id)
    FROM product_customer_interactions pci
    INNER JOIN companies c ON c.id = pci.customer_id
    WHERE pci.product_id = $1 
      AND pci.deleted_at IS NULL
      AND c.deleted_at IS NULL
      AND ($2::text IS NULL OR c.customer_type = $2)
    ```

- [x] Task 3: å‰ç«¯ç»„ä»¶å®ç° (AC: #1, #2, #3, #4, #5, #6)
  - [x] åˆ›å»º `ProductCustomerAssociation` ç»„ä»¶
    - [x] æ¥æ”¶ `productId` å’Œ `product` ä½œä¸º props
    - [x] ä½¿ç”¨ `useAuth()` è·å–å½“å‰ç”¨æˆ·è§’è‰²
    - [x] æ ¹æ®è§’è‰²æ˜¾ç¤ºä¸åŒçš„æ ‡é¢˜ï¼ˆ"å…³è”çš„é‡‡è´­å•†"ã€"å…³è”çš„ä¾›åº”å•†"ã€"å…³è”çš„å®¢æˆ·"ï¼‰
    - [x] è°ƒç”¨åç«¯ API è·å–å…³è”å®¢æˆ·åˆ—è¡¨
    - [x] å®ç°åŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†
    - [x] ä½¿ç”¨ React Query ç¼“å­˜å®¢æˆ·åˆ—è¡¨æ•°æ®ï¼ˆç¼“å­˜é”®ï¼š`['product-customers', productId, page, limit]`ï¼‰
    - [x] å®ç°ç¼“å­˜å¤±æ•ˆé€»è¾‘ï¼ˆå½“äº§å“æ›´æ–°æˆ–å®¢æˆ·æ›´æ–°æ—¶ï¼‰
  - [x] å®ç°å®¢æˆ·åˆ—è¡¨æ˜¾ç¤º
    - [x] ä½¿ç”¨ Card ç»„ä»¶æ˜¾ç¤ºå®¢æˆ·ä¿¡æ¯
    - [x] æ¯ä¸ªå®¢æˆ·æ˜¾ç¤ºï¼šå®¢æˆ·åç§°ã€å®¢æˆ·ç±»å‹æ ‡ç­¾ã€äº’åŠ¨æ•°é‡
    - [x] å®ç°å®¢æˆ·åç§°ç‚¹å‡»è·³è½¬åˆ°å®¢æˆ·è¯¦æƒ…ï¼ˆä½¿ç”¨ Link ç»„ä»¶ï¼Œè·¯å¾„ï¼š`/customers/:id`ï¼‰
    - [x] å®ç°"æŸ¥çœ‹äº’åŠ¨å†å²"æŒ‰é’®ï¼ˆè·³è½¬åˆ° Story 2.5 çš„äº’åŠ¨å†å²é¡µé¢ï¼Œè·¯å¾„ï¼š`/products/:productId/interactions?customerId=:customerId`ï¼‰
  - [x] å®ç°ç©ºçŠ¶æ€æ˜¾ç¤º (AC: #5)
    - [x] æ˜¾ç¤ºç©ºçŠ¶æ€å›¾æ ‡å’Œæ¶ˆæ¯
    - [x] æ˜¾ç¤ºæç¤ºæ–‡æœ¬"è®°å½•äº’åŠ¨æ—¶å…³è”æ­¤äº§å“ï¼Œå³å¯å»ºç«‹å…³è”å…³ç³»"
  - [x] å®ç°åˆ†é¡µæˆ–æ»šåŠ¨åŠ è½½ (AC: #6)
    - [x] å¦‚æœå®¢æˆ·æ•°é‡ > 10ï¼Œå®ç°åˆ†é¡µæ§ä»¶
    - [x] æˆ–å®ç°æ— é™æ»šåŠ¨åŠ è½½ï¼ˆä½¿ç”¨ React Query çš„ `useInfiniteQuery`ï¼‰
    - [x] æ˜¾ç¤ºå…³è”å®¢æˆ·æ€»æ•°

- [x] Task 4: é›†æˆåˆ° ProductDetailPanel (AC: #1, #2, #3)
  - [x] åœ¨ `ProductDetailPanel.tsx` ä¸­æ·»åŠ "å…³è”çš„å®¢æˆ·"éƒ¨åˆ†
  - [x] å°† `ProductCustomerAssociation` ç»„ä»¶é›†æˆåˆ°è¯¦æƒ…é¢æ¿
  - [x] ç¡®ä¿æ ·å¼ä¸ç°æœ‰è¯¦æƒ…é¢æ¿ä¸€è‡´ï¼ˆä½¿ç”¨ Card ç»„ä»¶ï¼ŒMonday.com é£æ ¼ï¼‰
  - [x] ç¡®ä¿å“åº”å¼å¸ƒå±€ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼‰
  - [x] ç¡®ä¿ç»„ä»¶ä½ç½®åˆç†ï¼ˆæ”¾åœ¨"å…¶ä»–ä¿¡æ¯"å¡ç‰‡ä¹‹åï¼‰

- [x] Task 5: è§’è‰²æƒé™éªŒè¯ (AC: #1, #2, #3)
  - [x] åç«¯æƒé™éªŒè¯
    - [x] ä½¿ç”¨ `PermissionService.getDataAccessFilter()` è·å–æ•°æ®è®¿é—®è¿‡æ»¤å™¨
    - [x] åœ¨ SQL æŸ¥è¯¢ä¸­åº”ç”¨è¿‡æ»¤å™¨ï¼ˆä½¿ç”¨ UPPER() è½¬æ¢å¤§å°å†™ï¼‰
    - [x] ç¡®ä¿å‰ç«¯ä¸“å‘˜åªèƒ½çœ‹åˆ°é‡‡è´­å•†ï¼Œåç«¯ä¸“å‘˜åªèƒ½çœ‹åˆ°ä¾›åº”å•†
    - [x] å¤„ç†æƒé™æ£€æŸ¥å¤±è´¥çš„æƒ…å†µï¼ˆè¿”å› 403 Forbiddenï¼‰
  - [x] å‰ç«¯æƒé™æ˜¾ç¤º
    - [x] ä½¿ç”¨ `isFrontendSpecialist()`, `isBackendSpecialist()`, `isDirector()`, `isAdmin()` å‡½æ•°
    - [x] æ ¹æ®è§’è‰²æ˜¾ç¤ºä¸åŒçš„æ ‡é¢˜å’Œå†…å®¹
    - [x] å¤„ç†æƒé™é”™è¯¯ï¼ˆæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼‰

- [x] Task 6: å®¢æˆ·ç±»å‹åˆ†ç»„æ˜¾ç¤º (AC: #3)
  - [x] æ€»ç›‘/ç®¡ç†å‘˜è§†å›¾ï¼šæŒ‰å®¢æˆ·ç±»å‹åˆ†ç»„
    - [x] æ˜¾ç¤º"é‡‡è´­å•†"åˆ†ç»„ï¼ˆcustomer_type = 'BUYER'ï¼‰
    - [x] æ˜¾ç¤º"ä¾›åº”å•†"åˆ†ç»„ï¼ˆcustomer_type = 'SUPPLIER'ï¼‰
    - [x] æ¯ä¸ªåˆ†ç»„æ˜¾ç¤ºå®¢æˆ·åˆ—è¡¨
    - [x] æ¯ä¸ªåˆ†ç»„æ˜¾ç¤ºè¯¥ç±»å‹çš„å®¢æˆ·æ€»æ•°

- [x] Task 7: é”™è¯¯å¤„ç†å®ç°
  - [x] å¤„ç†äº§å“ä¸å­˜åœ¨çš„æƒ…å†µï¼ˆè¿”å› 404 Not Foundï¼‰
  - [x] å¤„ç†å®¢æˆ·å·²è¢«è½¯åˆ é™¤çš„æƒ…å†µï¼ˆé€šè¿‡ JOIN è‡ªåŠ¨è¿‡æ»¤ `c.deleted_at IS NULL`ï¼‰
  - [x] å¤„ç†æ— æ•ˆçš„ customer_idï¼ˆé€šè¿‡ JOIN è‡ªåŠ¨è¿‡æ»¤ï¼Œå¦‚æœ customer_id ä¸å­˜åœ¨ï¼ŒJOIN ä¼šè¿”å›ç©ºç»“æœï¼‰
  - [x] å¤„ç†æƒé™æ£€æŸ¥å¤±è´¥ï¼ˆè¿”å› 403 Forbiddenï¼‰
  - [x] å¤„ç†æ•°æ®åº“é”™è¯¯ï¼ˆè¿”å› 500 Internal Server Errorï¼Œè®°å½•æ—¥å¿—ï¼‰
  - [x] å‰ç«¯é”™è¯¯å¤„ç†ï¼šæ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æ¶ˆæ¯ï¼Œæä¾›é‡è¯•é€‰é¡¹

## Dev Notes

### å½“å‰å®ç°çŠ¶æ€

**å·²æœ‰ç»„ä»¶ï¼š**
- `ProductDetailPanel` ç»„ä»¶å·²å­˜åœ¨äº `fenghua-frontend/src/products/components/ProductDetailPanel.tsx`
- ç»„ä»¶å·²é›†æˆåˆ° `ProductManagementPage` ä¸­ï¼Œé€šè¿‡ `MainLayout` çš„ `detailPanel` prop æ˜¾ç¤º
- ç»„ä»¶å·²å®ç°åŸºæœ¬çš„äº§å“ä¿¡æ¯æ˜¾ç¤ºï¼ˆåç§°ã€HSç¼–ç ã€ç±»åˆ«ã€æè¿°ã€è§„æ ¼ã€å›¾ç‰‡ã€åˆ›å»ºæ—¶é—´ã€æ›´æ–°æ—¶é—´ï¼‰

**æ•°æ®åº“ç»“æ„ï¼š**
- `product_customer_interactions` è¡¨å·²åˆ›å»ºï¼ˆè¿ç§»è„šæœ¬ `002-create-interactions-table.sql`ï¼‰
  - è¡¨ç»“æ„åŒ…å«ï¼š`product_id`, `customer_id`, `interaction_type`, `interaction_date`, ç­‰å­—æ®µ
  - ç´¢å¼•å·²åˆ›å»ºï¼š`idx_interactions_product`, `idx_interactions_product_customer`
  - **å¤–é”®çº¦æŸï¼š** `customer_id` æœ‰å¤–é”®çº¦æŸåˆ° `companies.id`ï¼ˆè¿ç§»è„šæœ¬ 007 å·²æ·»åŠ ï¼‰
- `companies` è¡¨å·²åˆ›å»ºï¼ˆè¿ç§»è„šæœ¬ `006-create-companies-and-people-tables.sql`ï¼‰
  - è¡¨ç»“æ„åŒ…å«ï¼š`id`, `name`, `customer_type`, `address`, `industry`, ç­‰å­—æ®µ
  - `customer_type` å­—æ®µï¼š`'SUPPLIER'` æˆ– `'BUYER'`ï¼ˆå¤§å†™ï¼‰
  - ç´¢å¼•å·²åˆ›å»ºï¼š`idx_companies_customer_type`
  - **é‡è¦ï¼š** `customer_id` ç°åœ¨å…³è”åˆ° `companies.id`ï¼Œä¸æ˜¯ Twenty CRM

**æƒé™ç³»ç»Ÿï¼š**
- `PermissionService` å·²å®ç°ï¼Œæä¾› `getDataAccessFilter()` æ–¹æ³•
- è¿”å›æ ¼å¼ï¼š`{ customerType: 'buyer' }` æˆ– `{ customerType: 'supplier' }` æˆ– `null`ï¼ˆå°å†™ï¼‰
- è§’è‰²å¸¸é‡å·²å®šä¹‰ï¼š`FRONTEND_SPECIALIST`, `BACKEND_SPECIALIST`, `DIRECTOR`, `ADMIN`
- æƒé™æ£€æŸ¥å‡½æ•°å·²å®ç°ï¼š`isFrontendSpecialist()`, `isBackendSpecialist()`, `isDirector()`, `isAdmin()`

**æ¶æ„å˜æ›´ï¼ˆé‡è¦ï¼‰ï¼š**
- **å·²ç§»é™¤ Twenty CRM ä¾èµ–**ï¼šç³»ç»Ÿä½¿ç”¨åŸç”Ÿ PostgreSQL è¡¨
- **å·²ç§»é™¤ workspace_id**ï¼šè¿ç§»è„šæœ¬ 007 å·²ç§»é™¤è¯¥å­—æ®µï¼Œä½¿ç”¨ `created_by` è¿›è¡Œæ•°æ®éš”ç¦»
- **å®¢æˆ·æ•°æ®æº**ï¼šå®¢æˆ·ä¿¡æ¯å­˜å‚¨åœ¨ `companies` è¡¨ä¸­ï¼Œä¸æ˜¯ Twenty CRM
- **å¤–é”®çº¦æŸ**ï¼š`product_customer_interactions.customer_id` æœ‰å¤–é”®çº¦æŸåˆ° `companies.id`

**éœ€è¦å®ç°çš„åŠŸèƒ½ï¼š**
1. **åç«¯ APIï¼š** æŸ¥è¯¢äº§å“å…³è”å®¢æˆ·çš„æœåŠ¡å’Œæ§åˆ¶å™¨ï¼ˆä½¿ç”¨ SQL JOINï¼‰
2. **å‰ç«¯ç»„ä»¶ï¼š** æ˜¾ç¤ºäº§å“å…³è”å®¢æˆ·çš„ç»„ä»¶
3. **é›†æˆï¼š** å°†ç»„ä»¶é›†æˆåˆ° ProductDetailPanel

### æŠ€æœ¯å®ç°è¦ç‚¹

**1. åç«¯ API å®ç°ï¼š**

**æœåŠ¡å±‚ (ProductCustomerAssociationService):**
```typescript
@Injectable()
export class ProductCustomerAssociationService implements OnModuleDestroy {
  private pgPool: Pool | null = null;
  private readonly logger = new Logger(ProductCustomerAssociationService.name);

  constructor(
    @Inject('PG_POOL') private readonly pool: Pool,
    private readonly permissionService: PermissionService,
  ) {
    this.pgPool = pool;
  }

  async getProductCustomers(
    productId: string,
    token: string,
    page: number = 1,
    limit: number = 10,
  ): Promise<{ customers: CustomerAssociation[]; total: number }> {
    if (!this.pgPool) {
      throw new BadRequestException('æ•°æ®åº“è¿æ¥æœªåˆå§‹åŒ–');
    }

    // 1. è·å–ç”¨æˆ·æƒé™å’Œæ•°æ®è®¿é—®è¿‡æ»¤å™¨
    const dataFilter = await this.permissionService.getDataAccessFilter(token);
    
    // 2. è½¬æ¢ customer_type å¤§å°å†™ï¼ˆPermissionService è¿”å›å°å†™ï¼Œæ•°æ®åº“å­˜å‚¨å¤§å†™ï¼‰
    const customerTypeFilter = dataFilter?.customerType 
      ? dataFilter.customerType.toUpperCase() 
      : null;

    // 3. å¤„ç†æƒé™æ£€æŸ¥å¤±è´¥
    if (dataFilter?.customerType === 'NONE') {
      throw new ForbiddenException('æ‚¨æ²¡æœ‰æƒé™æŸ¥çœ‹å®¢æˆ·ä¿¡æ¯');
    }

    // 4. éªŒè¯äº§å“æ˜¯å¦å­˜åœ¨
    const productCheck = await this.pgPool.query(
      'SELECT id FROM products WHERE id = $1 AND deleted_at IS NULL',
      [productId]
    );
    if (productCheck.rows.length === 0) {
      throw new NotFoundException('äº§å“ä¸å­˜åœ¨');
    }

    // 5. æŸ¥è¯¢äº§å“å…³è”çš„å®¢æˆ·å’Œäº’åŠ¨æ•°é‡ï¼ˆä½¿ç”¨ SQL JOINï¼‰
    const offset = (page - 1) * limit;
    const query = `
      SELECT 
        c.id,
        c.name,
        c.customer_type,
        COUNT(pci.id) as interaction_count
      FROM product_customer_interactions pci
      INNER JOIN companies c ON c.id = pci.customer_id
      WHERE pci.product_id = $1 
        AND pci.deleted_at IS NULL
        AND c.deleted_at IS NULL
        AND ($2::text IS NULL OR c.customer_type = $2)
      GROUP BY c.id, c.name, c.customer_type
      ORDER BY interaction_count DESC
      LIMIT $3 OFFSET $4
    `;

    const result = await this.pgPool.query(query, [
      productId,
      customerTypeFilter,
      limit,
      offset,
    ]);

    // 6. æŸ¥è¯¢æ€»æ•°ï¼ˆç”¨äºåˆ†é¡µï¼‰
    const countQuery = `
      SELECT COUNT(DISTINCT c.id) as total
      FROM product_customer_interactions pci
      INNER JOIN companies c ON c.id = pci.customer_id
      WHERE pci.product_id = $1 
        AND pci.deleted_at IS NULL
        AND c.deleted_at IS NULL
        AND ($2::text IS NULL OR c.customer_type = $2)
    `;

    const countResult = await this.pgPool.query(countQuery, [
      productId,
      customerTypeFilter,
    ]);

    const total = parseInt(countResult.rows[0].total, 10);

    // 7. æ˜ å°„ç»“æœ
    const customers: CustomerAssociation[] = result.rows.map((row) => ({
      id: row.id,
      name: row.name,
      customerType: row.customer_type,
      interactionCount: parseInt(row.interaction_count, 10),
    }));

    return { customers, total };
  }

  async onModuleDestroy() {
    // Cleanup if needed
  }
}
```

**æ§åˆ¶å™¨å±‚ (ProductCustomerAssociationController):**
```typescript
@Controller('products')
export class ProductCustomerAssociationController {
  constructor(
    private readonly service: ProductCustomerAssociationService,
  ) {}

  @Get(':id/customers')
  @UseGuards(JwtAuthGuard)
  async getProductCustomers(
    @Param('id') productId: string,
    @Token() token: string,
    @Query() query: ProductCustomerQueryDto,
  ): Promise<{ customers: CustomerAssociation[]; total: number }> {
    try {
      return await this.service.getProductCustomers(
        productId,
        token,
        query.page || 1,
        query.limit || 10,
      );
    } catch (error) {
      if (error instanceof NotFoundException || error instanceof ForbiddenException) {
        throw error;
      }
      throw new BadRequestException('è·å–äº§å“å…³è”å®¢æˆ·å¤±è´¥');
    }
  }
}
```

**DTOs:**
```typescript
// ProductCustomerAssociationDto
export class ProductCustomerAssociationDto {
  id: string;
  name: string;
  customerType: 'SUPPLIER' | 'BUYER';
  interactionCount: number;
}

// ProductCustomerQueryDto
export class ProductCustomerQueryDto {
  @IsOptional()
  @Type(() => Number)
  @IsInt()
  @Min(1)
  page?: number = 1;

  @IsOptional()
  @Type(() => Number)
  @IsInt()
  @Min(1)
  @Max(100)
  limit?: number = 10;

  @IsOptional()
  @IsEnum(['BUYER', 'SUPPLIER'])
  customerType?: 'BUYER' | 'SUPPLIER'; // å¯é€‰ï¼Œç”¨äºæ€»ç›‘/ç®¡ç†å‘˜ç­›é€‰
}
```

**2. å‰ç«¯ç»„ä»¶å®ç°ï¼š**

**ProductCustomerAssociation ç»„ä»¶ï¼š**
```tsx
import { useQuery } from '@tanstack/react-query';
import { useAuth } from '../../auth/AuthContext';
import { isFrontendSpecialist, isBackendSpecialist } from '../../common/constants/roles';
import { Card } from '../../components/ui/Card';
import { Link } from 'react-router-dom';
import { Button } from '../../components/ui/Button';

interface ProductCustomerAssociationProps {
  productId: string;
  product: Product;
}

interface CustomerAssociation {
  id: string;
  name: string;
  customerType: 'SUPPLIER' | 'BUYER';
  interactionCount: number;
}

export const ProductCustomerAssociation: React.FC<ProductCustomerAssociationProps> = ({
  productId,
  product,
}) => {
  const { user, token } = useAuth();
  const [page, setPage] = useState(1);
  const limit = 10;

  // æ ¹æ®è§’è‰²æ˜¾ç¤ºæ ‡é¢˜
  const getTitle = () => {
    if (isFrontendSpecialist(user?.role)) return 'å…³è”çš„é‡‡è´­å•†';
    if (isBackendSpecialist(user?.role)) return 'å…³è”çš„ä¾›åº”å•†';
    return 'å…³è”çš„å®¢æˆ·';
  };

  // ä½¿ç”¨ React Query è·å–å®¢æˆ·åˆ—è¡¨
  const { data, isLoading, error, refetch } = useQuery({
    queryKey: ['product-customers', productId, page, limit],
    queryFn: async () => {
      const response = await fetch(
        `${import.meta.env.VITE_API_BASE_URL}/api/products/${productId}/customers?page=${page}&limit=${limit}`,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        }
      );
      if (!response.ok) {
        throw new Error('è·å–å®¢æˆ·åˆ—è¡¨å¤±è´¥');
      }
      return response.json();
    },
    enabled: !!productId && !!token,
    staleTime: 5 * 60 * 1000, // 5 åˆ†é’Ÿç¼“å­˜
  });

  // æŒ‰å®¢æˆ·ç±»å‹åˆ†ç»„ï¼ˆæ€»ç›‘/ç®¡ç†å‘˜ï¼‰
  const groupedCustomers = useMemo(() => {
    if (!data?.customers) return null;
    if (isFrontendSpecialist(user?.role) || isBackendSpecialist(user?.role)) {
      return { all: data.customers };
    }
    return {
      buyers: data.customers.filter(c => c.customerType === 'BUYER'),
      suppliers: data.customers.filter(c => c.customerType === 'SUPPLIER'),
    };
  }, [data, user?.role]);

  if (isLoading) {
    return (
      <Card variant="outlined" className="p-monday-4">
        <div className="flex items-center justify-center py-monday-8">
          <span className="animate-spin">â³</span>
          <span className="ml-monday-2 text-monday-sm text-monday-text-secondary">åŠ è½½ä¸­...</span>
        </div>
      </Card>
    );
  }

  if (error) {
    return (
      <Card variant="outlined" className="p-monday-4">
        <div className="text-center py-monday-8">
          <p className="text-monday-sm text-primary-red mb-monday-2">åŠ è½½å¤±è´¥</p>
          <Button size="sm" onClick={() => refetch()}>é‡è¯•</Button>
        </div>
      </Card>
    );
  }

  if (!data || data.customers.length === 0) {
    return (
      <Card variant="outlined" className="p-monday-4">
        <h4 className="text-monday-base font-semibold text-monday-text mb-monday-3">
          {getTitle()}
        </h4>
        <div className="text-center py-monday-8">
          <div className="text-monday-4xl mb-monday-4 opacity-50">ğŸ“‹</div>
          <p className="text-monday-base text-monday-text-secondary mb-monday-2">
            è¯¥äº§å“å°šæœªä¸ä»»ä½•å®¢æˆ·å…³è”
          </p>
          <p className="text-monday-sm text-monday-text-placeholder">
            è®°å½•äº’åŠ¨æ—¶å…³è”æ­¤äº§å“ï¼Œå³å¯å»ºç«‹å…³è”å…³ç³»
          </p>
        </div>
      </Card>
    );
  }

  return (
    <Card variant="outlined" className="p-monday-4">
      <h4 className="text-monday-base font-semibold text-monday-text mb-monday-3">
        {getTitle()}
      </h4>
      
      {/* æ€»ç›‘/ç®¡ç†å‘˜ï¼šæŒ‰ç±»å‹åˆ†ç»„æ˜¾ç¤º */}
      {!isFrontendSpecialist(user?.role) && !isBackendSpecialist(user?.role) && groupedCustomers ? (
        <div className="space-y-monday-6">
          {groupedCustomers.buyers.length > 0 && (
            <div>
              <h5 className="text-monday-sm font-semibold text-monday-text-secondary mb-monday-3">
                é‡‡è´­å•† ({groupedCustomers.buyers.length})
              </h5>
              <div className="space-y-monday-2">
                {groupedCustomers.buyers.map((customer) => (
                  <CustomerCard key={customer.id} customer={customer} productId={productId} />
                ))}
              </div>
            </div>
          )}
          {groupedCustomers.suppliers.length > 0 && (
            <div>
              <h5 className="text-monday-sm font-semibold text-monday-text-secondary mb-monday-3">
                ä¾›åº”å•† ({groupedCustomers.suppliers.length})
              </h5>
              <div className="space-y-monday-2">
                {groupedCustomers.suppliers.map((customer) => (
                  <CustomerCard key={customer.id} customer={customer} productId={productId} />
                ))}
              </div>
            </div>
          )}
        </div>
      ) : (
        /* å‰ç«¯/åç«¯ä¸“å‘˜ï¼šç›´æ¥æ˜¾ç¤ºåˆ—è¡¨ */
        <div className="space-y-monday-2">
          {data.customers.map((customer) => (
            <CustomerCard key={customer.id} customer={customer} productId={productId} />
          ))}
        </div>
      )}

      {/* åˆ†é¡µ */}
      {data.total > limit && (
        <div className="flex items-center justify-between mt-monday-4 pt-monday-4 border-t border-gray-200">
          <span className="text-monday-sm text-monday-text-secondary">
            å…± {data.total} ä¸ªå®¢æˆ·
          </span>
          <div className="flex gap-monday-2">
            <Button
              size="sm"
              variant="ghost"
              onClick={() => setPage(p => Math.max(1, p - 1))}
              disabled={page === 1}
            >
              ä¸Šä¸€é¡µ
            </Button>
            <span className="text-monday-sm text-monday-text-secondary flex items-center">
              ç¬¬ {page} é¡µ
            </span>
            <Button
              size="sm"
              variant="ghost"
              onClick={() => setPage(p => p + 1)}
              disabled={page * limit >= data.total}
            >
              ä¸‹ä¸€é¡µ
            </Button>
          </div>
        </div>
      )}
    </Card>
  );
};

// CustomerCard å­ç»„ä»¶
const CustomerCard: React.FC<{ customer: CustomerAssociation; productId: string }> = ({
  customer,
  productId,
}) => {
  return (
    <Card variant="outlined" className="p-monday-3 hover:shadow-monday-sm transition-shadow">
      <div className="flex items-center justify-between">
        <div className="flex-1 min-w-0">
          <Link
            to={`/customers/${customer.id}`}
            className="text-monday-base font-semibold text-monday-text hover:text-primary-blue transition-colors truncate block"
          >
            {customer.name}
          </Link>
          <div className="flex items-center gap-monday-2 mt-monday-1">
            <span className={`px-monday-2 py-monday-0.5 rounded-full text-monday-xs font-semibold ${
              customer.customerType === 'BUYER' 
                ? 'bg-primary-blue/10 text-primary-blue' 
                : 'bg-primary-purple/10 text-primary-purple'
            }`}>
              {customer.customerType === 'BUYER' ? 'é‡‡è´­å•†' : 'ä¾›åº”å•†'}
            </span>
            <span className="text-monday-xs text-monday-text-secondary">
              {customer.interactionCount} æ¬¡äº’åŠ¨
            </span>
          </div>
        </div>
        <Link
          to={`/products/${productId}/interactions?customerId=${customer.id}`}
          className="ml-monday-4"
        >
          <Button
            size="sm"
            variant="secondary"
            className="text-monday-xs"
          >
            æŸ¥çœ‹äº’åŠ¨å†å²
          </Button>
        </Link>
      </div>
    </Card>
  );
};
```

**3. é›†æˆåˆ° ProductDetailPanelï¼š**

åœ¨ `ProductDetailPanel.tsx` ä¸­æ·»åŠ ï¼š
```tsx
{/* å…³è”çš„å®¢æˆ· */}
<ProductCustomerAssociation
  productId={product.id}
  product={product}
/>
```

### æ¶æ„å‚è€ƒ

**æ–‡ä»¶ç»“æ„ï¼š**
- åç«¯æœåŠ¡ï¼š`fenghua-backend/src/products/product-customer-association.service.ts`
- åç«¯æ§åˆ¶å™¨ï¼š`fenghua-backend/src/products/product-customer-association.controller.ts`
- å‰ç«¯ç»„ä»¶ï¼š`fenghua-frontend/src/products/components/ProductCustomerAssociation.tsx`
- å‰ç«¯æœåŠ¡ï¼š`fenghua-frontend/src/products/product-customer-association.service.ts`ï¼ˆå¯é€‰ï¼Œå¦‚æœä½¿ç”¨ service å±‚ï¼‰

**ä¾èµ–å…³ç³»ï¼š**
- ä¾èµ– `ProductDetailPanel` ç»„ä»¶ï¼ˆå·²å­˜åœ¨ï¼‰
- ä¾èµ– `PermissionService`ï¼ˆå·²å­˜åœ¨ï¼‰
- ä¾èµ– `Card` ç»„ä»¶ï¼ˆå·²å­˜åœ¨ï¼‰
- ä¾èµ– `useAuth` hookï¼ˆå·²å­˜åœ¨ï¼‰
- ä¾èµ–è§’è‰²æ£€æŸ¥å‡½æ•°ï¼ˆå·²å­˜åœ¨ï¼‰
- ä¾èµ– React Queryï¼ˆéœ€è¦å®‰è£… `@tanstack/react-query`ï¼‰

**API è°ƒç”¨ï¼š**
- GET `/api/products/:id/customers?page=1&limit=10` - è·å–äº§å“å…³è”å®¢æˆ·åˆ—è¡¨
- **æ•°æ®æºï¼š** ç›´æ¥ä» PostgreSQL `companies` è¡¨æŸ¥è¯¢ï¼ˆä¸æ˜¯ Twenty CRMï¼‰

**æ•°æ®æ¨¡å‹ï¼š**
- `product_customer_interactions` è¡¨ï¼šå­˜å‚¨äº§å“-å®¢æˆ·äº’åŠ¨è®°å½•
- `companies` è¡¨ï¼šå­˜å‚¨å®¢æˆ·ä¿¡æ¯ï¼ˆåŸç”Ÿ PostgreSQL è¡¨ï¼‰
- **å¤–é”®çº¦æŸï¼š** `product_customer_interactions.customer_id` â†’ `companies.id`ï¼ˆå·²å­˜åœ¨ï¼‰
- é€šè¿‡ SQL JOIN å…³è”ä¸¤ä¸ªè¡¨

**æ•°æ®éš”ç¦»ç­–ç•¥ï¼š**
- **äº§å“èŒƒå›´éš”ç¦»ï¼š** é€šè¿‡ `product_id` é™å®šæŸ¥è¯¢èŒƒå›´ï¼ˆä¸éœ€è¦ workspace_idï¼‰
- **è§’è‰²è¿‡æ»¤ï¼š** é€šè¿‡ `customer_type` å­—æ®µè¿‡æ»¤ï¼ˆ`'BUYER'` æˆ– `'SUPPLIER'`ï¼‰
- **è½¯åˆ é™¤è¿‡æ»¤ï¼š** é€šè¿‡ `deleted_at IS NULL` è¿‡æ»¤å·²åˆ é™¤çš„è®°å½•
- **å¤§å°å†™è½¬æ¢ï¼š** PermissionService è¿”å›å°å†™ï¼ˆ`'buyer'`, `'supplier'`ï¼‰ï¼Œæ•°æ®åº“å­˜å‚¨å¤§å†™ï¼ˆ`'BUYER'`, `'SUPPLIER'`ï¼‰ï¼Œéœ€è¦åœ¨ SQL æŸ¥è¯¢ä¸­ä½¿ç”¨ `UPPER()` æˆ–åº”ç”¨å±‚è½¬æ¢

### UI è®¾è®¡æ ‡å‡†

**å‚è€ƒæ–‡æ¡£ï¼š**
- `docs/design-system/ui-design-standards.md`

**å…³é”®è®¾è®¡è¦ç‚¹ï¼š**
1. **å¡ç‰‡å¸ƒå±€ï¼š** ä½¿ç”¨ `Card` ç»„ä»¶ï¼Œç¬¦åˆ Monday.com é£æ ¼
2. **å®¢æˆ·åˆ—è¡¨ï¼š** ä½¿ç”¨å¡ç‰‡åˆ—è¡¨ï¼Œæ¯ä¸ªå®¢æˆ·ä¸€ä¸ªå¡ç‰‡
3. **å®¢æˆ·ç±»å‹æ ‡ç­¾ï¼š** ä½¿ç”¨å½©è‰²æ ‡ç­¾åŒºåˆ†é‡‡è´­å•†å’Œä¾›åº”å•†
   - é‡‡è´­å•†ï¼š`bg-primary-blue/10 text-primary-blue`
   - ä¾›åº”å•†ï¼š`bg-primary-purple/10 text-primary-purple`
4. **äº’åŠ¨æ•°é‡ï¼š** æ˜¾ç¤ºä¸ºæ–‡æœ¬ï¼ˆ"X æ¬¡äº’åŠ¨"ï¼‰
5. **ç©ºçŠ¶æ€ï¼š** ä½¿ç”¨å‹å¥½çš„ç©ºçŠ¶æ€è®¾è®¡ï¼ˆå›¾æ ‡ + æ¶ˆæ¯ + æç¤ºï¼‰
6. **åˆ†é¡µï¼š** ä½¿ç”¨åˆ†é¡µæ§ä»¶ï¼ˆä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µæŒ‰é’® + é¡µç æ˜¾ç¤ºï¼‰
7. **å“åº”å¼è®¾è®¡ï¼š** ä½¿ç”¨ Tailwind å“åº”å¼ç±»ï¼ˆ`sm:`, `md:`, `lg:`ï¼‰
8. **åŠ è½½çŠ¶æ€ï¼š** æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨ï¼ˆâ³ å›¾æ ‡ + "åŠ è½½ä¸­..." æ–‡æœ¬ï¼‰
9. **é”™è¯¯çŠ¶æ€ï¼š** æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ + é‡è¯•æŒ‰é’®

### æƒé™è¿‡æ»¤ç­–ç•¥

**åç«¯è¿‡æ»¤ï¼ˆSQL æŸ¥è¯¢å±‚ï¼‰ï¼š**
- ä½¿ç”¨ `PermissionService.getDataAccessFilter()` è·å–è¿‡æ»¤å™¨
- å‰ç«¯ä¸“å‘˜ï¼š`{ customerType: 'buyer' }` â†’ SQL: `customer_type = 'BUYER'`
- åç«¯ä¸“å‘˜ï¼š`{ customerType: 'supplier' }` â†’ SQL: `customer_type = 'SUPPLIER'`
- æ€»ç›‘/ç®¡ç†å‘˜ï¼š`null` â†’ SQL: æ— è¿‡æ»¤ï¼ˆè¿”å›æ‰€æœ‰å®¢æˆ·ï¼‰

**å¤§å°å†™è½¬æ¢ï¼š**
- PermissionService è¿”å›ï¼š`'buyer'` æˆ– `'supplier'`ï¼ˆå°å†™ï¼‰
- æ•°æ®åº“å­˜å‚¨ï¼š`'BUYER'` æˆ– `'SUPPLIER'`ï¼ˆå¤§å†™ï¼‰
- **è½¬æ¢æ–¹æ³•ï¼š** åœ¨ SQL æŸ¥è¯¢ä¸­ä½¿ç”¨ `UPPER($2)` æˆ–åœ¨åº”ç”¨å±‚ä½¿ç”¨ `customerType.toUpperCase()`

**æŸ¥è¯¢å®¢æˆ·ä¿¡æ¯æ—¶çš„è¿‡æ»¤ï¼š**
- ç›´æ¥åœ¨ SQL JOIN æŸ¥è¯¢ä¸­åº”ç”¨ `customer_type` è¿‡æ»¤
- å‰ç«¯ä¸“å‘˜ï¼šåªæŸ¥è¯¢ `customer_type = 'BUYER'` çš„å®¢æˆ·
- åç«¯ä¸“å‘˜ï¼šåªæŸ¥è¯¢ `customer_type = 'SUPPLIER'` çš„å®¢æˆ·
- æ€»ç›‘/ç®¡ç†å‘˜ï¼šæŸ¥è¯¢æ‰€æœ‰å®¢æˆ·ï¼Œå‰ç«¯æŒ‰ç±»å‹åˆ†ç»„æ˜¾ç¤º

### æ€§èƒ½ä¼˜åŒ–

**æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ï¼š**
- ä½¿ç”¨å·²åˆ›å»ºçš„ç´¢å¼•ï¼š
  - `idx_interactions_product` - æŒ‰äº§å“æŸ¥è¯¢
  - `idx_interactions_product_customer` - æŒ‰äº§å“å’Œå®¢æˆ·æŸ¥è¯¢
  - `idx_companies_customer_type` - æŒ‰å®¢æˆ·ç±»å‹æŸ¥è¯¢
- ä½¿ç”¨ SQL JOIN é¿å… N+1 æŸ¥è¯¢ï¼ˆä¸€æ¬¡æ€§è·å–æ‰€æœ‰å®¢æˆ·ä¿¡æ¯ï¼‰
- ä½¿ç”¨ `GROUP BY` å’Œ `COUNT(*)` ç»Ÿè®¡äº’åŠ¨æ•°é‡
- ä½¿ç”¨ `LIMIT` å’Œ `OFFSET` å®ç°åˆ†é¡µ
- **æŸ¥è¯¢æ€§èƒ½ç›®æ ‡ï¼š** < 1 ç§’ P95

**å‰ç«¯ä¼˜åŒ–ï¼š**
- ä½¿ç”¨ React Query ç¼“å­˜å®¢æˆ·åˆ—è¡¨æ•°æ®
  - ç¼“å­˜é”®ï¼š`['product-customers', productId, page, limit]`
  - ç¼“å­˜æ—¶é—´ï¼š5 åˆ†é’Ÿï¼ˆ`staleTime: 5 * 60 * 1000`ï¼‰
  - ç¼“å­˜å¤±æ•ˆï¼šå½“äº§å“æ›´æ–°æˆ–å®¢æˆ·æ›´æ–°æ—¶ï¼ˆé€šè¿‡ `queryClient.invalidateQueries`ï¼‰
- å®ç°é˜²æŠ–å’ŒèŠ‚æµï¼ˆå¦‚æœéœ€è¦å®æ—¶æœç´¢ï¼‰
- ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¦‚æœå®¢æˆ·æ•°é‡å¾ˆå¤§ï¼Œ> 100 ä¸ªï¼‰

**æŸ¥è¯¢æ€§èƒ½éªŒè¯ï¼š**
- ä½¿ç”¨ `EXPLAIN ANALYZE` éªŒè¯æŸ¥è¯¢æ€§èƒ½
- ç¡®ä¿ä½¿ç”¨ç´¢å¼•ï¼ˆæ£€æŸ¥æ‰§è¡Œè®¡åˆ’ï¼‰
- æµ‹è¯•å¤§é‡å®¢æˆ·ï¼ˆ> 100 ä¸ªï¼‰çš„æŸ¥è¯¢æ€§èƒ½

### é”™è¯¯å¤„ç†

**åç«¯é”™è¯¯å¤„ç†ï¼š**
1. **äº§å“ä¸å­˜åœ¨ï¼š** è¿”å› `404 Not Found`
2. **å®¢æˆ·å·²è¢«è½¯åˆ é™¤ï¼š** é€šè¿‡ JOIN è‡ªåŠ¨è¿‡æ»¤ï¼ˆ`c.deleted_at IS NULL`ï¼‰
3. **æ— æ•ˆçš„ customer_idï¼š** é€šè¿‡ JOIN è‡ªåŠ¨è¿‡æ»¤ï¼ˆå¦‚æœ customer_id ä¸å­˜åœ¨ï¼ŒJOIN ä¼šè¿”å›ç©ºç»“æœï¼‰
4. **æƒé™æ£€æŸ¥å¤±è´¥ï¼š** è¿”å› `403 Forbidden`
5. **æ•°æ®åº“é”™è¯¯ï¼š** è¿”å› `500 Internal Server Error`ï¼Œè®°å½•æ—¥å¿—

**å‰ç«¯é”™è¯¯å¤„ç†ï¼š**
1. **åŠ è½½å¤±è´¥ï¼š** æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ + é‡è¯•æŒ‰é’®
2. **æƒé™é”™è¯¯ï¼š** æ˜¾ç¤º"æ‚¨æ²¡æœ‰æƒé™æŸ¥çœ‹å®¢æˆ·ä¿¡æ¯"
3. **ç½‘ç»œé”™è¯¯ï¼š** æ˜¾ç¤º"ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
4. **ç©ºç»“æœï¼š** æ˜¾ç¤ºå‹å¥½çš„ç©ºçŠ¶æ€ï¼ˆä¸æ˜¯é”™è¯¯ï¼‰

### æµ‹è¯•è¦æ±‚

**åŠŸèƒ½æµ‹è¯•ï¼š**
1. **è§’è‰²è¿‡æ»¤æµ‹è¯•ï¼š**
   - æµ‹è¯•å‰ç«¯ä¸“å‘˜åªèƒ½çœ‹åˆ°é‡‡è´­å•†ï¼ˆ`customer_type = 'BUYER'`ï¼‰
   - æµ‹è¯•åç«¯ä¸“å‘˜åªèƒ½çœ‹åˆ°ä¾›åº”å•†ï¼ˆ`customer_type = 'SUPPLIER'`ï¼‰
   - æµ‹è¯•æ€»ç›‘/ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰å®¢æˆ·ï¼ˆæŒ‰ç±»å‹åˆ†ç»„ï¼‰
   - æµ‹è¯•å‰ç«¯ä¸“å‘˜æ— æ³•çœ‹åˆ°ä¾›åº”å•†
   - æµ‹è¯•åç«¯ä¸“å‘˜æ— æ³•çœ‹åˆ°é‡‡è´­å•†

2. **å®¢æˆ·åˆ—è¡¨æ˜¾ç¤ºæµ‹è¯•ï¼š**
   - æµ‹è¯•å®¢æˆ·åˆ—è¡¨æ˜¾ç¤ºï¼ˆåç§°ã€ç±»å‹ã€äº’åŠ¨æ•°é‡ï¼‰
   - æµ‹è¯•å®¢æˆ·ç±»å‹æ ‡ç­¾é¢œè‰²æ­£ç¡®
   - æµ‹è¯•äº’åŠ¨æ•°é‡ç»Ÿè®¡æ­£ç¡®

3. **äº¤äº’æµ‹è¯•ï¼š**
   - æµ‹è¯•å®¢æˆ·åç§°ç‚¹å‡»è·³è½¬åˆ°å®¢æˆ·è¯¦æƒ…ï¼ˆ`/customers/:id`ï¼‰
   - æµ‹è¯•"æŸ¥çœ‹äº’åŠ¨å†å²"æŒ‰é’®è·³è½¬ï¼ˆ`/products/:productId/interactions?customerId=:customerId`ï¼‰

4. **ç©ºçŠ¶æ€æµ‹è¯•ï¼š**
   - æµ‹è¯•äº§å“æ²¡æœ‰å…³è”å®¢æˆ·æ—¶æ˜¾ç¤ºç©ºçŠ¶æ€
   - æµ‹è¯•ç©ºçŠ¶æ€æ¶ˆæ¯å’Œæç¤ºæ–‡æœ¬æ­£ç¡®

5. **åˆ†é¡µæµ‹è¯•ï¼š**
   - æµ‹è¯•åˆ†é¡µåŠŸèƒ½ï¼ˆä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µï¼‰
   - æµ‹è¯•åˆ†é¡µæ§ä»¶æ˜¾ç¤ºæ­£ç¡®ï¼ˆé¡µç ã€æ€»æ•°ï¼‰
   - æµ‹è¯•è¾¹ç•Œæƒ…å†µï¼ˆç¬¬ä¸€é¡µã€æœ€åä¸€é¡µï¼‰

6. **é”™è¯¯å¤„ç†æµ‹è¯•ï¼š**
   - æµ‹è¯•äº§å“ä¸å­˜åœ¨æ—¶çš„é”™è¯¯å¤„ç†
   - æµ‹è¯•æƒé™æ£€æŸ¥å¤±è´¥æ—¶çš„é”™è¯¯å¤„ç†
   - æµ‹è¯•ç½‘ç»œé”™è¯¯æ—¶çš„é”™è¯¯å¤„ç†
   - æµ‹è¯•é‡è¯•åŠŸèƒ½

**æ€§èƒ½æµ‹è¯•ï¼š**
1. **æŸ¥è¯¢æ€§èƒ½æµ‹è¯•ï¼š**
   - æµ‹è¯•å¤§é‡å®¢æˆ·ï¼ˆ> 100 ä¸ªï¼‰çš„æŸ¥è¯¢æ€§èƒ½
   - æµ‹è¯•åˆ†é¡µåŠ è½½æ€§èƒ½
   - æµ‹è¯•æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ï¼ˆ< 1 ç§’ P95ï¼‰
   - ä½¿ç”¨ `EXPLAIN ANALYZE` éªŒè¯æŸ¥è¯¢è®¡åˆ’

2. **å‰ç«¯æ€§èƒ½æµ‹è¯•ï¼š**
   - æµ‹è¯• React Query ç¼“å­˜æ•ˆæœ
   - æµ‹è¯•å¤§é‡å®¢æˆ·æ¸²æŸ“æ€§èƒ½ï¼ˆ> 100 ä¸ªï¼‰
   - æµ‹è¯•åˆ†é¡µåˆ‡æ¢æ€§èƒ½

**æƒé™æµ‹è¯•ï¼š**
1. æµ‹è¯•å‰ç«¯ä¸“å‘˜æ— æ³•çœ‹åˆ°ä¾›åº”å•†ï¼ˆAPI è¿”å›ç©ºåˆ—è¡¨ï¼‰
2. æµ‹è¯•åç«¯ä¸“å‘˜æ— æ³•çœ‹åˆ°é‡‡è´­å•†ï¼ˆAPI è¿”å›ç©ºåˆ—è¡¨ï¼‰
3. æµ‹è¯•æœªæˆæƒç”¨æˆ·æ— æ³•è®¿é—® APIï¼ˆè¿”å› 401 Unauthorizedï¼‰
4. æµ‹è¯•æƒé™æ£€æŸ¥å¤±è´¥æ—¶è¿”å› 403 Forbidden

**å“åº”å¼æµ‹è¯•ï¼š**
1. æµ‹è¯•ç§»åŠ¨ç«¯å¸ƒå±€ï¼ˆ< 768pxï¼‰
2. æµ‹è¯•å¹³æ¿å¸ƒå±€ï¼ˆ768px - 1024pxï¼‰
3. æµ‹è¯•æ¡Œé¢å¸ƒå±€ï¼ˆ> 1024pxï¼‰
4. æµ‹è¯•å®¢æˆ·å¡ç‰‡åœ¨å°å±å¹•ä¸Šçš„æ˜¾ç¤º

**è¾¹ç•Œæƒ…å†µæµ‹è¯•ï¼š**
1. æµ‹è¯• 0 ä¸ªå®¢æˆ·ï¼ˆç©ºçŠ¶æ€ï¼‰
2. æµ‹è¯• 1 ä¸ªå®¢æˆ·ï¼ˆä¸éœ€è¦åˆ†é¡µï¼‰
3. æµ‹è¯• 10 ä¸ªå®¢æˆ·ï¼ˆåˆšå¥½ä¸€é¡µï¼‰
4. æµ‹è¯• 11 ä¸ªå®¢æˆ·ï¼ˆéœ€è¦åˆ†é¡µï¼‰
5. æµ‹è¯• 100+ ä¸ªå®¢æˆ·ï¼ˆå¤§é‡æ•°æ®ï¼‰
6. æµ‹è¯•å®¢æˆ·åç§°å¾ˆé•¿ï¼ˆæ–‡æœ¬æˆªæ–­ï¼‰
7. æµ‹è¯•äº’åŠ¨æ•°é‡ä¸º 0 çš„å®¢æˆ·

### å‚è€ƒå®ç°

**Story 2.3 ç›¸å…³æ–‡ä»¶ï¼š**
- `fenghua-frontend/src/products/components/ProductDetailPanel.tsx` - äº§å“è¯¦æƒ…é¢æ¿
- `fenghua-frontend/src/products/ProductManagementPage.tsx` - äº§å“ç®¡ç†é¡µé¢

**æƒé™ç³»ç»Ÿå‚è€ƒï¼š**
- `fenghua-backend/src/permission/permission.service.ts` - æƒé™æœåŠ¡
- `fenghua-frontend/src/common/constants/roles.ts` - è§’è‰²å¸¸é‡

**æ•°æ®åº“å‚è€ƒï¼š**
- `fenghua-backend/migrations/002-create-interactions-table.sql` - äº’åŠ¨è®°å½•è¡¨
- `fenghua-backend/migrations/006-create-companies-and-people-tables.sql` - å®¢æˆ·è¡¨
- `fenghua-backend/migrations/007-remove-workspace-dependencies.sql` - ç§»é™¤ workspace_id å’Œå¤–é”®çº¦æŸ
- `docs/database-schema-design.md` - æ•°æ®åº“è®¾è®¡æ–‡æ¡£

**æœåŠ¡æ¨¡å¼å‚è€ƒï¼š**
- `fenghua-backend/src/products/products.service.ts` - äº§å“æœåŠ¡ï¼ˆå‚è€ƒæ•°æ®åº“æŸ¥è¯¢æ¨¡å¼ï¼‰
- `fenghua-backend/src/users/users.service.ts` - ç”¨æˆ·æœåŠ¡ï¼ˆå‚è€ƒ SQL æŸ¥è¯¢æ¨¡å¼ï¼‰

### Project Structure Notes

- ç»„ä»¶ä½ç½®ç¬¦åˆé¡¹ç›®ç»“æ„ï¼š`fenghua-frontend/src/products/components/`
- æœåŠ¡ä½ç½®ç¬¦åˆé¡¹ç›®ç»“æ„ï¼š`fenghua-backend/src/products/`
- ä½¿ç”¨ç»Ÿä¸€çš„ UI ç»„ä»¶åº“ï¼ˆCard, Button, Linkï¼‰
- éµå¾ª Monday.com è®¾è®¡ç³»ç»Ÿ
- éµå¾ªæƒé™è¿‡æ»¤ç­–ç•¥ï¼ˆSQL æŸ¥è¯¢å±‚è¿‡æ»¤ï¼‰
- **æ¶æ„å˜æ›´ï¼š** ä½¿ç”¨åŸç”Ÿ PostgreSQL è¡¨ï¼Œä¸æ˜¯ Twenty CRM

### References

- [Source: _bmad-output/epics.md#Story-2.4] - Story 2.4 éœ€æ±‚å®šä¹‰
- [Source: _bmad-output/prd.md#FR4] - FR4: æŸ¥çœ‹äº§å“ä¸å®¢æˆ·çš„å…³è”ï¼ˆæŒ‰è§’è‰²ï¼‰
- [Source: fenghua-frontend/src/products/components/ProductDetailPanel.tsx] - äº§å“è¯¦æƒ…é¢æ¿å®ç°
- [Source: docs/design-system/ui-design-standards.md] - UI è®¾è®¡æ ‡å‡†
- [Source: fenghua-backend/migrations/002-create-interactions-table.sql] - äº’åŠ¨è®°å½•è¡¨ç»“æ„
- [Source: fenghua-backend/migrations/006-create-companies-and-people-tables.sql] - å®¢æˆ·è¡¨ç»“æ„
- [Source: fenghua-backend/migrations/007-remove-workspace-dependencies.sql] - å¤–é”®çº¦æŸå’Œ workspace_id ç§»é™¤
- [Source: fenghua-backend/src/permission/permission.service.ts] - æƒé™æœåŠ¡å®ç°
- [Source: fenghua-backend/src/products/products.service.ts] - äº§å“æœåŠ¡ï¼ˆå‚è€ƒæ•°æ®åº“æŸ¥è¯¢æ¨¡å¼ï¼‰
- [Source: _bmad-output/implementation-artifacts/stories/2-3-product-details-view.md] - Story 2.3 å®ç°å‚è€ƒ

## Dev Agent Record

### Agent Model Used

Auto (Cursor AI Assistant)

### Debug Log References

### Completion Notes List

### File List

**åç«¯æ–‡ä»¶ï¼š**
- `fenghua-backend/src/products/dto/product-customer-association.dto.ts` - DTOs
- `fenghua-backend/src/products/product-customer-association.service.ts` - æœåŠ¡å±‚
- `fenghua-backend/src/products/product-customer-association.controller.ts` - æ§åˆ¶å™¨
- `fenghua-backend/src/products/products.module.ts` - æ¨¡å—æ›´æ–°ï¼ˆæ·»åŠ æ–°æœåŠ¡å’Œæ§åˆ¶å™¨ï¼‰

**å‰ç«¯æ–‡ä»¶ï¼š**
- `fenghua-frontend/src/products/components/ProductCustomerAssociation.tsx` - å‰ç«¯ç»„ä»¶
- `fenghua-frontend/src/products/components/ProductDetailPanel.tsx` - é›†æˆç»„ä»¶

### Completion Notes List

**å®ç°å®Œæˆæ—¶é—´ï¼š** 2025-01-03  
**ä»£ç å®¡æŸ¥å®Œæˆæ—¶é—´ï¼š** 2025-01-03

**ä»£ç å®¡æŸ¥ä¿®å¤ï¼š**
- âœ… H1: ä¿®å¤ Controller ä¸­ä¸å®‰å…¨çš„ Logger è®¿é—® - åœ¨ Controller ä¸­æ³¨å…¥ Logger
- âœ… H2: ä¿®å¤ parseInt ç¼ºå°‘é”™è¯¯å¤„ç† - æ·»åŠ é»˜è®¤å€¼å’Œç©ºå€¼æ£€æŸ¥
- âœ… M1: ä¸º DTO æ·»åŠ éªŒè¯è£…é¥°å™¨ - æ·»åŠ  class-validator è£…é¥°å™¨
- âœ… M2: ä¿®å¤å‰ç«¯åˆ†ç»„é€»è¾‘ç±»å‹å®‰å…¨é—®é¢˜ - æ·»åŠ ç±»å‹å®šä¹‰å’Œç±»å‹å®ˆå«
- âœ… M3: åœ¨ Service å±‚æ·»åŠ æ•°æ®åº“æŸ¥è¯¢é”™è¯¯å¤„ç† - æ·»åŠ  try-catch å—
- âœ… L2: æ·»åŠ è¾“å…¥éªŒè¯çš„è¾¹ç•Œæƒ…å†µå¤„ç† - éªŒè¯å’Œè§„èŒƒåŒ– page å’Œ limit å‚æ•°

**å®ç°çš„åŠŸèƒ½ï¼š**
1. âœ… åç«¯ API å®ç°
   - åˆ›å»ºäº† `ProductCustomerAssociationService`ï¼Œå®ç°åŸºäºè§’è‰²çš„æ•°æ®è¿‡æ»¤
   - ä½¿ç”¨ SQL JOIN æŸ¥è¯¢ `product_customer_interactions` å’Œ `companies` è¡¨
   - å®ç° customer_type å¤§å°å†™è½¬æ¢ï¼ˆPermissionService è¿”å›å°å†™ï¼Œæ•°æ®åº“å­˜å‚¨å¤§å†™ï¼‰
   - å®ç°åˆ†é¡µæ”¯æŒï¼ˆé»˜è®¤æ¯é¡µ 10 æ¡ï¼‰
   - å¤„ç†è½¯åˆ é™¤å’Œé”™è¯¯æƒ…å†µ

2. âœ… åç«¯æ§åˆ¶å™¨å®ç°
   - åˆ›å»ºäº† `ProductCustomerAssociationController`
   - å®ç° GET `/api/products/:id/customers` ç«¯ç‚¹
   - ä½¿ç”¨ `@UseGuards(JwtAuthGuard)` ä¿æŠ¤ç«¯ç‚¹
   - å®ç°é”™è¯¯å¤„ç†ï¼ˆäº§å“ä¸å­˜åœ¨ã€æƒé™æ£€æŸ¥å¤±è´¥ã€æ•°æ®åº“é”™è¯¯ï¼‰

3. âœ… DTOs å®ç°
   - `ProductCustomerAssociationDto` - è¿”å›æ•°æ®ç»“æ„
   - `ProductCustomerQueryDto` - æŸ¥è¯¢å‚æ•°ç»“æ„ï¼ˆæ”¯æŒ page, limit, customerTypeï¼‰

4. âœ… å‰ç«¯ç»„ä»¶å®ç°
   - åˆ›å»ºäº† `ProductCustomerAssociation` ç»„ä»¶
   - ä½¿ç”¨ React Query ç¼“å­˜å®¢æˆ·åˆ—è¡¨æ•°æ®
   - å®ç°åŠ è½½çŠ¶æ€ã€é”™è¯¯å¤„ç†å’Œç©ºçŠ¶æ€æ˜¾ç¤º
   - å®ç°åˆ†é¡µæ§ä»¶
   - å®ç°è§’è‰²åˆ†ç»„æ˜¾ç¤ºï¼ˆæ€»ç›‘/ç®¡ç†å‘˜æŒ‰ç±»å‹åˆ†ç»„ï¼‰

5. âœ… é›†æˆåˆ° ProductDetailPanel
   - åœ¨ `ProductDetailPanel.tsx` ä¸­æ·»åŠ äº† `ProductCustomerAssociation` ç»„ä»¶
   - ç»„ä»¶ä½ç½®ï¼šæ”¾åœ¨"å…¶ä»–ä¿¡æ¯"å¡ç‰‡ä¹‹å

**æŠ€æœ¯è¦ç‚¹ï¼š**
- ä½¿ç”¨ SQL JOIN é¿å… N+1 æŸ¥è¯¢
- å®ç°åŸºäºè§’è‰²çš„æ•°æ®è¿‡æ»¤ï¼ˆå‰ç«¯ä¸“å‘˜åªçœ‹åˆ°é‡‡è´­å•†ï¼Œåç«¯ä¸“å‘˜åªçœ‹åˆ°ä¾›åº”å•†ï¼‰
- å®ç° customer_type å¤§å°å†™è½¬æ¢
- ä½¿ç”¨ React Query ç¼“å­˜æ•°æ®ï¼ˆ5 åˆ†é’Ÿç¼“å­˜æ—¶é—´ï¼‰
- å®ç°åˆ†é¡µæ”¯æŒï¼ˆé»˜è®¤æ¯é¡µ 10 æ¡ï¼‰

**å¾…æµ‹è¯•ï¼š**
- åŠŸèƒ½æµ‹è¯•ï¼šè§’è‰²è¿‡æ»¤ã€å®¢æˆ·åˆ—è¡¨æ˜¾ç¤ºã€åˆ†é¡µã€ç©ºçŠ¶æ€
- æ€§èƒ½æµ‹è¯•ï¼šæŸ¥è¯¢æ€§èƒ½ã€å‰ç«¯æ¸²æŸ“æ€§èƒ½
- æƒé™æµ‹è¯•ï¼šæƒé™æ£€æŸ¥ã€æ•°æ®éš”ç¦»
- å“åº”å¼æµ‹è¯•ï¼šç§»åŠ¨ç«¯ã€å¹³æ¿ã€æ¡Œé¢å¸ƒå±€
