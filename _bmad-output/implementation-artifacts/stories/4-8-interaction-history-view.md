# Story 4.8: äº’åŠ¨å†å²æŸ¥çœ‹ï¼ˆæŒ‰è§’è‰²ï¼‰

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a **å‰ç«¯ä¸“å‘˜/åç«¯ä¸“å‘˜/æ€»ç›‘/ç®¡ç†å‘˜**,
I want **æŸ¥çœ‹å®¢æˆ·çš„æ‰€æœ‰äº’åŠ¨è®°å½•**,
so that **æˆ‘å¯ä»¥äº†è§£ä¸å®¢æˆ·çš„å®Œæ•´ä¸šåŠ¡å¾€æ¥å†å²**.

## Acceptance Criteria

**AC1: å‰ç«¯ä¸“å‘˜æŸ¥çœ‹é‡‡è´­å•†äº’åŠ¨å†å²**
- **Given** å‰ç«¯ä¸“å‘˜å·²ç™»å½•ç³»ç»Ÿ
- **When** å‰ç«¯ä¸“å‘˜åœ¨é‡‡è´­å•†è¯¦æƒ…é¡µé¢æŸ¥çœ‹"äº’åŠ¨å†å²"
- **Then** ç³»ç»Ÿæ˜¾ç¤ºè¯¥é‡‡è´­å•†çš„æ‰€æœ‰äº’åŠ¨è®°å½•
- **And** äº’åŠ¨è®°å½•æŒ‰æ—¶é—´é¡ºåºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
- **And** æ¯æ¡äº’åŠ¨è®°å½•æ˜¾ç¤ºï¼šäº’åŠ¨ç±»å‹ã€äº’åŠ¨æ—¶é—´ã€å…³è”çš„äº§å“ã€äº’åŠ¨æè¿°ã€åˆ›å»ºè€…ç­‰
- **And** ç³»ç»Ÿåªæ˜¾ç¤ºå‰ç«¯ä¸“å‘˜æœ‰æƒé™æŸ¥çœ‹çš„äº’åŠ¨è®°å½•ï¼ˆåªæ˜¾ç¤ºé‡‡è´­å•†ç±»å‹çš„å®¢æˆ·ï¼‰

**AC2: åç«¯ä¸“å‘˜æŸ¥çœ‹ä¾›åº”å•†äº’åŠ¨å†å²**
- **Given** åç«¯ä¸“å‘˜å·²ç™»å½•ç³»ç»Ÿ
- **When** åç«¯ä¸“å‘˜åœ¨ä¾›åº”å•†è¯¦æƒ…é¡µé¢æŸ¥çœ‹"äº’åŠ¨å†å²"
- **Then** ç³»ç»Ÿæ˜¾ç¤ºè¯¥ä¾›åº”å•†çš„æ‰€æœ‰äº’åŠ¨è®°å½•
- **And** äº’åŠ¨è®°å½•æŒ‰æ—¶é—´é¡ºåºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
- **And** æ¯æ¡äº’åŠ¨è®°å½•æ˜¾ç¤ºï¼šäº’åŠ¨ç±»å‹ã€äº’åŠ¨æ—¶é—´ã€å…³è”çš„äº§å“ã€äº’åŠ¨æè¿°ã€åˆ›å»ºè€…ç­‰
- **And** ç³»ç»Ÿåªæ˜¾ç¤ºåç«¯ä¸“å‘˜æœ‰æƒé™æŸ¥çœ‹çš„äº’åŠ¨è®°å½•ï¼ˆåªæ˜¾ç¤ºä¾›åº”å•†ç±»å‹çš„å®¢æˆ·ï¼‰

**AC3: æ€»ç›‘/ç®¡ç†å‘˜æŸ¥çœ‹å®¢æˆ·äº’åŠ¨å†å²**
- **Given** æ€»ç›‘æˆ–ç®¡ç†å‘˜å·²ç™»å½•ç³»ç»Ÿ
- **When** æ€»ç›‘æˆ–ç®¡ç†å‘˜åœ¨å®¢æˆ·è¯¦æƒ…é¡µé¢æŸ¥çœ‹"äº’åŠ¨å†å²"
- **Then** ç³»ç»Ÿæ˜¾ç¤ºè¯¥å®¢æˆ·çš„æ‰€æœ‰äº’åŠ¨è®°å½•
- **And** äº’åŠ¨è®°å½•æŒ‰æ—¶é—´é¡ºåºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
- **And** ç³»ç»Ÿæ˜¾ç¤ºæ‰€æœ‰ç±»å‹çš„äº’åŠ¨è®°å½•ï¼ˆé‡‡è´­å•†å’Œä¾›åº”å•†çš„äº’åŠ¨ï¼‰

**AC4: é™„ä»¶æ˜¾ç¤ºå’ŒæŸ¥çœ‹**
- **Given** ç”¨æˆ·æŸ¥çœ‹äº’åŠ¨å†å²
- **When** äº’åŠ¨è®°å½•åŒ…å«é™„ä»¶ï¼ˆç…§ç‰‡ã€æ–‡æ¡£ç­‰ï¼‰
- **Then** ç³»ç»Ÿåœ¨äº’åŠ¨è®°å½•ä¸­æ˜¾ç¤ºé™„ä»¶å›¾æ ‡æˆ–ç¼©ç•¥å›¾
- **And** ç”¨æˆ·å¯ä»¥ç‚¹å‡»é™„ä»¶æŸ¥çœ‹æˆ–ä¸‹è½½
- **And** å¦‚æœæ˜¯ç…§ç‰‡ï¼Œç”¨æˆ·å¯ä»¥æŸ¥çœ‹å¤§å›¾ï¼ˆæ”¯æŒå¤šå¼ ç…§ç‰‡åˆ‡æ¢ï¼‰
- **And** é™„ä»¶æ˜¾ç¤ºåœ¨äº’åŠ¨è®°å½•çš„é™„ä»¶åŒºåŸŸ

**AC5: åˆ†é¡µå’Œæ»šåŠ¨åŠ è½½**
- **Given** ç”¨æˆ·æŸ¥çœ‹äº’åŠ¨å†å²
- **When** äº’åŠ¨å†å²è®°å½•è¾ƒå¤šï¼ˆ> 20 æ¡ï¼‰
- **Then** ç³»ç»Ÿä½¿ç”¨åˆ†é¡µæˆ–æ»šåŠ¨åŠ è½½æ˜¾ç¤ºäº’åŠ¨è®°å½•
- **And** ç³»ç»Ÿæ˜¾ç¤ºäº’åŠ¨è®°å½•æ€»æ•°
- **And** ç³»ç»Ÿæ”¯æŒæŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰æˆ–æœ€æ—§çš„åœ¨å‰ï¼Œç”¨æˆ·å¯é€‰æ‹©ï¼‰
- **And** ç³»ç»Ÿæ”¯æŒæŒ‰æ—¶é—´èŒƒå›´ç­›é€‰ï¼ˆæœ¬å‘¨ã€æœ¬æœˆã€æœ¬å¹´ã€å…¨éƒ¨ï¼‰

**AC6: ç©ºçŠ¶æ€å¤„ç†**
- **Given** ç”¨æˆ·æŸ¥çœ‹äº’åŠ¨å†å²
- **When** æ²¡æœ‰äº’åŠ¨è®°å½•
- **Then** ç³»ç»Ÿæ˜¾ç¤ºç©ºçŠ¶æ€"è¯¥å®¢æˆ·å°šæœªæœ‰ä»»ä½•äº’åŠ¨è®°å½•"
- **And** ç³»ç»Ÿæä¾›"è®°å½•æ–°äº’åŠ¨"æŒ‰é’®ï¼Œç”¨æˆ·å¯ä»¥å¿«é€Ÿè®°å½•äº’åŠ¨
- **And** ç©ºçŠ¶æ€æ˜¾ç¤ºå‹å¥½çš„æç¤ºä¿¡æ¯

## Tasks / Subtasks

- [x] Task 1: éªŒè¯å’Œå®Œå–„åç«¯ API ç«¯ç‚¹ (AC: #1, #2, #3, #5)
  - [x] éªŒè¯ `GET /api/customers/:customerId/timeline` ç«¯ç‚¹å·²å®ç°
  - [x] éªŒè¯åŸºäºè§’è‰²çš„æ•°æ®è¿‡æ»¤å·²å®ç°ï¼ˆå‰ç«¯ä¸“å‘˜åªçœ‹åˆ°é‡‡è´­å•†ï¼Œåç«¯ä¸“å‘˜åªçœ‹åˆ°ä¾›åº”å•†ï¼‰
  - [x] éªŒè¯åˆ†é¡µåŠŸèƒ½å·²å®ç°ï¼ˆpage, limit å‚æ•°ï¼‰
  - [x] éªŒè¯æ’åºåŠŸèƒ½å·²å®ç°ï¼ˆsortOrder: 'asc' | 'desc'ï¼‰
  - [x] éªŒè¯æ—¶é—´èŒƒå›´ç­›é€‰å·²å®ç°ï¼ˆdateRange: 'week' | 'month' | 'year' | 'all'ï¼‰
  - [x] åˆ›å»ºæŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–ç´¢å¼•ï¼ˆcustomer_id + interaction_date å¤åˆç´¢å¼•ï¼‰
  - [x] éªŒè¯é™„ä»¶æ•°æ®å·²åŒ…å«åœ¨å“åº”ä¸­ï¼ˆattachments æ•°ç»„ï¼‰

- [x] Task 2: éªŒè¯å’Œå®Œå–„å‰ç«¯ CustomerTimeline ç»„ä»¶ (AC: #1, #2, #3, #4, #5, #6)
  - [x] éªŒè¯ `CustomerTimeline` ç»„ä»¶å·²å®ç°å¹¶é›†æˆåˆ° `CustomerDetailPanel`
  - [x] éªŒè¯äº’åŠ¨è®°å½•æŒ‰æ—¶é—´é¡ºåºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
  - [x] éªŒè¯æ¯æ¡äº’åŠ¨è®°å½•æ˜¾ç¤ºï¼šäº’åŠ¨ç±»å‹ã€äº’åŠ¨æ—¶é—´ã€å…³è”çš„äº§å“ã€äº’åŠ¨æè¿°ã€åˆ›å»ºè€…
  - [x] éªŒè¯é™„ä»¶æ˜¾ç¤ºåŠŸèƒ½ï¼ˆé™„ä»¶å›¾æ ‡æˆ–ç¼©ç•¥å›¾ï¼‰
  - [x] éªŒè¯é™„ä»¶ç‚¹å‡»æŸ¥çœ‹åŠŸèƒ½ï¼ˆç…§ç‰‡å¤§å›¾æŸ¥çœ‹ï¼Œæ–‡æ¡£ä¸‹è½½ï¼‰
  - [x] éªŒè¯åˆ†é¡µåŠŸèƒ½ï¼ˆå¦‚æœè®°å½• > 20 æ¡ï¼‰
  - [x] éªŒè¯æ’åºåŠŸèƒ½ï¼ˆç”¨æˆ·å¯é€‰æ‹©æœ€æ–°çš„åœ¨å‰æˆ–æœ€æ—§çš„åœ¨å‰ï¼‰
  - [x] éªŒè¯æ—¶é—´èŒƒå›´ç­›é€‰åŠŸèƒ½ï¼ˆæœ¬å‘¨ã€æœ¬æœˆã€æœ¬å¹´ã€å…¨éƒ¨ï¼‰
  - [x] éªŒè¯ç©ºçŠ¶æ€æ˜¾ç¤ºï¼ˆ"è¯¥å®¢æˆ·å°šæœªæœ‰ä»»ä½•äº’åŠ¨è®°å½•"ï¼‰
  - [x] å®ç°"è®°å½•æ–°äº’åŠ¨"æŒ‰é’®ï¼ˆé“¾æ¥åˆ°äº’åŠ¨è®°å½•åˆ›å»ºé¡µé¢ï¼‰
    - [x] æŒ‰é’®é“¾æ¥åˆ° `/interactions/create`ï¼Œé€šè¿‡ `useNavigate` å’Œ `state` ä¼ é€’å®¢æˆ·ä¿¡æ¯ï¼ˆ`customerId`ï¼‰
    - [x] æŒ‰é’®æ˜¾ç¤ºåœ¨ç©ºçŠ¶æ€ä¸­ï¼Œæ ·å¼ä¸ºä¸»æŒ‰é’®ï¼ˆprimaryï¼‰
    - [x] æŒ‰é’®æ–‡æœ¬ï¼š"è®°å½•æ–°äº’åŠ¨"
    - [x] ç¡®ä¿ `InteractionCreateForm` èƒ½å¤Ÿæ¥æ”¶å¹¶é¢„å¡«å……å®¢æˆ·ä¿¡æ¯ï¼ˆé€šè¿‡ `prefillCustomerId` propï¼‰

- [x] Task 3: ä¼˜åŒ–é™„ä»¶æ˜¾ç¤ºå’Œäº¤äº’ (AC: #4)
  - [x] å®ç°é™„ä»¶å›¾æ ‡æ˜¾ç¤ºï¼ˆæ ¹æ®æ–‡ä»¶ç±»å‹æ˜¾ç¤ºä¸åŒå›¾æ ‡ï¼‰
    - [x] ç…§ç‰‡é™„ä»¶ï¼šä¼˜å…ˆæ˜¾ç¤ºç¼©ç•¥å›¾ï¼ˆä½¿ç”¨ `fileUrl` ä½œä¸ºç¼©ç•¥å›¾æºï¼‰ï¼Œå¦‚æœåŠ è½½å¤±è´¥åˆ™æ˜¾ç¤ºå›¾ç‰‡å›¾æ ‡ ğŸ–¼ï¸
    - [x] PDF æ–‡æ¡£ï¼šæ˜¾ç¤º PDF å›¾æ ‡ ğŸ“„
    - [x] Word æ–‡æ¡£ï¼šæ˜¾ç¤º Word å›¾æ ‡ ğŸ“ï¼ˆæ£€æµ‹ `mimeType` åŒ…å« 'word' æˆ–æ–‡ä»¶åä»¥ `.docx`/`.doc` ç»“å°¾ï¼‰
    - [x] Excel æ–‡æ¡£ï¼šæ˜¾ç¤º Excel å›¾æ ‡ ğŸ“Šï¼ˆæ£€æµ‹ `mimeType` åŒ…å« 'excel' æˆ–æ–‡ä»¶åä»¥ `.xlsx`/`.xls` ç»“å°¾ï¼‰
    - [x] å…¶ä»–æ–‡æ¡£ï¼šæ˜¾ç¤ºé»˜è®¤é™„ä»¶å›¾æ ‡ ğŸ“
  - [x] å®ç°ç…§ç‰‡ç¼©ç•¥å›¾æ˜¾ç¤ºï¼ˆå¦‚æœé™„ä»¶æ˜¯ç…§ç‰‡ï¼‰
    - [x] ç…§ç‰‡é™„ä»¶ï¼ˆ`fileType === 'photo'` æˆ– `mimeType?.startsWith('image/')`ï¼‰æ˜¾ç¤ºç¼©ç•¥å›¾
    - [x] ç¼©ç•¥å›¾å°ºå¯¸ï¼š64x64pxï¼ˆæ¡Œé¢ç«¯ï¼‰
    - [x] ç¼©ç•¥å›¾ä½¿ç”¨ `object-cover` ä¿æŒå®½é«˜æ¯”
    - [x] æ·»åŠ  hover æ•ˆæœï¼ˆè¾¹æ¡†é«˜äº®ï¼‰
  - [x] **å¤ç”¨ Story 4.5 çš„ `PhotoPreview` ç»„ä»¶å®ç°ç…§ç‰‡å¤§å›¾æŸ¥çœ‹åŠŸèƒ½**
    - [x] å¯¼å…¥ `PhotoPreview` ç»„ä»¶ï¼š`import { PhotoPreview } from '../../attachments/components/PhotoPreview';`
    - [x] å®ç°ç…§ç‰‡é¢„è§ˆçŠ¶æ€ç®¡ç†ï¼ˆ`selectedPhotoIndex` å’Œ `photoAttachments` æ•°ç»„ï¼‰
    - [x] å¤„ç†ç…§ç‰‡ç‚¹å‡»äº‹ä»¶ï¼šç­›é€‰å‡ºæ‰€æœ‰ç…§ç‰‡é™„ä»¶ï¼Œæ‰¾åˆ°å½“å‰ç…§ç‰‡ç´¢å¼•ï¼Œæ‰“å¼€é¢„è§ˆ
    - [x] å®ç°å¤šå¼ ç…§ç‰‡åˆ‡æ¢é€»è¾‘ï¼ˆä¸Šä¸€å¼ /ä¸‹ä¸€å¼ ï¼Œæ”¯æŒé”®ç›˜å¯¼èˆªï¼‰
    - [x] é›†æˆ `PhotoPreview` ç»„ä»¶åˆ° `CustomerTimeline` ç»„ä»¶
  - [x] å®ç°æ–‡æ¡£ä¸‹è½½åŠŸèƒ½ï¼ˆç‚¹å‡»æ–‡æ¡£é™„ä»¶ç›´æ¥ä¸‹è½½ï¼‰
    - [x] ä½¿ç”¨ `<a>` æ ‡ç­¾çš„ `download` å±æ€§å®ç°ä¸‹è½½
  - [x] ä¼˜åŒ–é™„ä»¶æ˜¾ç¤ºå¸ƒå±€ï¼ˆç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯ï¼‰
    - [x] ä½¿ç”¨ flex-wrap å¸ƒå±€ï¼Œè‡ªåŠ¨æ¢è¡Œ

- [x] Task 4: ä¼˜åŒ–äº’åŠ¨è®°å½•å¡ç‰‡æ˜¾ç¤º (AC: #1, #2, #3)
  - [x] ç¡®ä¿äº’åŠ¨ç±»å‹æ˜¾ç¤ºä¸­æ–‡æ ‡ç­¾ï¼ˆä½¿ç”¨ INTERACTION_TYPE_LABELSï¼‰
  - [x] ç¡®ä¿äº’åŠ¨æ—¶é—´æ ¼å¼åŒ–æ˜¾ç¤ºï¼ˆä½¿ç”¨ getTimeLabel å‡½æ•°ï¼‰
  - [x] ç¡®ä¿å…³è”äº§å“ä¿¡æ¯æ˜¾ç¤ºï¼ˆäº§å“åç§°ã€HSç¼–ç ï¼‰
  - [x] ç¡®ä¿åˆ›å»ºè€…ä¿¡æ¯æ˜¾ç¤ºï¼ˆåˆ›å»ºè€…å§“åæˆ–é‚®ç®±ï¼‰
  - [x] ä¼˜åŒ–å¡ç‰‡å¸ƒå±€ï¼ˆç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯ï¼‰

- [x] Task 5: æ·»åŠ æµ‹è¯•ç”¨ä¾‹ (AC: #1, #2, #3, #4, #5, #6)
  - [x] æ·»åŠ å‰ç«¯ç»„ä»¶æµ‹è¯•ï¼ˆCustomerTimeline ç»„ä»¶ï¼‰
  - [x] æµ‹è¯•åŸºäºè§’è‰²çš„æ•°æ®è¿‡æ»¤ï¼ˆå‰ç«¯ä¸“å‘˜åªçœ‹åˆ°é‡‡è´­å•†ï¼Œåç«¯ä¸“å‘˜åªçœ‹åˆ°ä¾›åº”å•†ï¼‰
  - [x] æµ‹è¯•åˆ†é¡µåŠŸèƒ½
  - [x] æµ‹è¯•æ’åºåŠŸèƒ½
  - [x] æµ‹è¯•æ—¶é—´èŒƒå›´ç­›é€‰åŠŸèƒ½
  - [x] æµ‹è¯•é™„ä»¶æ˜¾ç¤ºå’Œäº¤äº’
  - [x] æµ‹è¯•ç©ºçŠ¶æ€æ˜¾ç¤º
  - [x] æ·»åŠ åç«¯ API æµ‹è¯•ï¼ˆCustomerTimelineController å’Œ CustomerTimelineServiceï¼‰

## Technical Notes

### åç«¯ API

**ç«¯ç‚¹ï¼š** `GET /api/customers/:customerId/timeline`

**æŸ¥è¯¢å‚æ•°ï¼š**
- `page` (number, default: 1): é¡µç 
- `limit` (number, default: 50, max: 100): æ¯é¡µè®°å½•æ•°
- `sortOrder` ('asc' | 'desc', default: 'desc'): æ’åºé¡ºåº
- `dateRange` ('week' | 'month' | 'year' | 'all', default: 'all'): æ—¶é—´èŒƒå›´ç­›é€‰

**å“åº”æ ¼å¼ï¼š**
```typescript
{
  interactions: CustomerTimelineInteractionDto[];
  total: number;
}

interface CustomerTimelineInteractionDto {
  id: string;
  interactionType: string;
  interactionDate: string;
  description?: string;
  status?: string;
  additionalInfo?: Record<string, unknown>;
  createdAt: string;
  createdBy?: string;
  creatorEmail?: string;
  creatorFirstName?: string;
  creatorLastName?: string;
  productId?: string;
  productName?: string;
  productHsCode?: string;
  attachments: FileAttachment[];
}

interface FileAttachment {
  id: string;
  fileName: string;
  fileUrl: string;
  fileType: string;
  fileSize: number;
  mimeType?: string;
}
```

**å®ç°ä½ç½®ï¼š**
- Controller: `fenghua-backend/src/companies/customer-timeline.controller.ts`
- Service: `fenghua-backend/src/companies/customer-timeline.service.ts`
- DTO: `fenghua-backend/src/companies/dto/customer-timeline.dto.ts`

### å‰ç«¯ç»„ä»¶

**ç»„ä»¶ï¼š** `CustomerTimeline`

**ä½ç½®ï¼š** `fenghua-frontend/src/customers/components/CustomerTimeline.tsx`

**é›†æˆä½ç½®ï¼š** `fenghua-frontend/src/customers/components/CustomerDetailPanel.tsx`

**åŠŸèƒ½ï¼š**
- æ˜¾ç¤ºå®¢æˆ·çš„æ‰€æœ‰äº’åŠ¨è®°å½•ï¼ˆä¸é™å®šäº§å“ï¼‰
- æ”¯æŒåŸºäºè§’è‰²çš„æ•°æ®è¿‡æ»¤
- æ”¯æŒåˆ†é¡µã€æ’åºã€æ—¶é—´èŒƒå›´ç­›é€‰
- æ”¯æŒé™„ä»¶æ˜¾ç¤ºå’ŒæŸ¥çœ‹
- æ”¯æŒç©ºçŠ¶æ€æ˜¾ç¤º

### åŸºäºè§’è‰²çš„æ•°æ®è¿‡æ»¤

**å‰ç«¯ä¸“å‘˜ï¼š**
- åªèƒ½æŸ¥çœ‹é‡‡è´­å•†ï¼ˆBUYERï¼‰ç±»å‹çš„å®¢æˆ·çš„äº’åŠ¨è®°å½•
- åªèƒ½æŸ¥çœ‹å‰ç«¯ä¸“å‘˜çš„äº’åŠ¨ç±»å‹ï¼ˆåˆæ­¥æ¥è§¦ã€äº§å“è¯¢ä»·ã€æŠ¥ä»·ç­‰ï¼‰

**åç«¯ä¸“å‘˜ï¼š**
- åªèƒ½æŸ¥çœ‹ä¾›åº”å•†ï¼ˆSUPPLIERï¼‰ç±»å‹çš„å®¢æˆ·çš„äº’åŠ¨è®°å½•
- åªèƒ½æŸ¥çœ‹åç«¯ä¸“å‘˜çš„äº’åŠ¨ç±»å‹ï¼ˆè¯¢ä»·äº§å“ã€æ¥æ”¶æŠ¥ä»·ã€ç”Ÿäº§è¿›åº¦è·Ÿè¿›ç­‰ï¼‰

**æ€»ç›‘/ç®¡ç†å‘˜ï¼š**
- å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç±»å‹çš„å®¢æˆ·çš„äº’åŠ¨è®°å½•
- å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç±»å‹çš„äº’åŠ¨è®°å½•

### é™„ä»¶æ˜¾ç¤º

**ç…§ç‰‡é™„ä»¶ï¼š**
- æ˜¾ç¤ºç¼©ç•¥å›¾ï¼ˆä½¿ç”¨ `fileUrl` ä½œä¸ºç¼©ç•¥å›¾æºï¼Œå°ºå¯¸ï¼š64x64px æ¡Œé¢ç«¯ï¼Œ48x48px ç§»åŠ¨ç«¯ï¼‰
- ç‚¹å‡»ç¼©ç•¥å›¾æŸ¥çœ‹å¤§å›¾ï¼ˆå¤ç”¨ Story 4.5 çš„ `PhotoPreview` ç»„ä»¶ï¼‰
- æ”¯æŒå¤šå¼ ç…§ç‰‡åˆ‡æ¢ï¼ˆä¸Šä¸€å¼ /ä¸‹ä¸€å¼ ï¼Œé”®ç›˜å¯¼èˆªï¼šâ†/â†’ï¼‰
- ç…§ç‰‡é¢„è§ˆçŠ¶æ€ç®¡ç†ï¼š
  - `selectedPhotoIndex`: å½“å‰é¢„è§ˆçš„ç…§ç‰‡ç´¢å¼•ï¼ˆ`number | null`ï¼‰
  - `photoAttachments`: å½“å‰äº’åŠ¨è®°å½•çš„æ‰€æœ‰ç…§ç‰‡é™„ä»¶æ•°ç»„

**æ–‡æ¡£é™„ä»¶ï¼š**
- æ ¹æ®æ–‡ä»¶ç±»å‹æ˜¾ç¤ºå¯¹åº”å›¾æ ‡ï¼š
  - PDF: ğŸ“„
  - Word (.docx, .doc): ğŸ“
  - Excel (.xlsx, .xls): ğŸ“Š
  - å…¶ä»–: ğŸ“
- æ˜¾ç¤ºæ–‡ä»¶åå’Œæ–‡ä»¶å¤§å°ï¼ˆæ ¼å¼åŒ–æ˜¾ç¤ºï¼Œå¦‚ "1.2 MB"ï¼‰
- ç‚¹å‡»é™„ä»¶ç›´æ¥ä¸‹è½½ï¼ˆä½¿ç”¨ `<a>` æ ‡ç­¾çš„ `download` å±æ€§ï¼‰

**é™„ä»¶å›¾æ ‡æ˜¾ç¤ºé€»è¾‘ï¼š**
```typescript
const getFileIcon = (attachment: FileAttachment): string => {
  if (attachment.fileType === 'photo' || attachment.mimeType?.startsWith('image/')) {
    return 'ğŸ–¼ï¸'; // ç…§ç‰‡å›¾æ ‡ï¼ˆä»…åœ¨ç¼©ç•¥å›¾åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºï¼‰
  }
  if (attachment.mimeType === 'application/pdf' || attachment.fileName.endsWith('.pdf')) {
    return 'ğŸ“„'; // PDF å›¾æ ‡
  }
  if (attachment.mimeType?.includes('word') || 
      attachment.fileName.endsWith('.docx') || 
      attachment.fileName.endsWith('.doc')) {
    return 'ğŸ“'; // Word å›¾æ ‡
  }
  if (attachment.mimeType?.includes('excel') || 
      attachment.fileName.endsWith('.xlsx') || 
      attachment.fileName.endsWith('.xls')) {
    return 'ğŸ“Š'; // Excel å›¾æ ‡
  }
  return 'ğŸ“'; // é»˜è®¤é™„ä»¶å›¾æ ‡
};
```

### æ€§èƒ½ä¼˜åŒ–

**æ•°æ®åº“ç´¢å¼•ï¼š**
- `customer_id + created_at` å¤åˆç´¢å¼•ï¼ˆç”¨äºæŒ‰å®¢æˆ·å’Œæ—¶é—´æ’åºï¼‰
- `customer_id + interaction_type` å¤åˆç´¢å¼•ï¼ˆç”¨äºæŒ‰å®¢æˆ·å’Œç±»å‹ç­›é€‰ï¼‰

**æŸ¥è¯¢ä¼˜åŒ–ï¼š**
- ä½¿ç”¨åˆ†é¡µé™åˆ¶è¿”å›è®°å½•æ•°ï¼ˆé»˜è®¤ 50 æ¡ï¼Œæœ€å¤§ 100 æ¡ï¼‰
- ä½¿ç”¨èšåˆæŸ¥è¯¢ä¸€æ¬¡æ€§è·å–é™„ä»¶æ•°æ®ï¼ˆé¿å… N+1 æŸ¥è¯¢ï¼‰
- ä½¿ç”¨ React Query ç¼“å­˜æŸ¥è¯¢ç»“æœï¼ˆ5 åˆ†é’Ÿç¼“å­˜ï¼‰

## Code Examples

### å‰ç«¯ç»„ä»¶ä½¿ç”¨ç¤ºä¾‹

```tsx
// CustomerDetailPanel.tsx
import { CustomerTimeline } from './CustomerTimeline';

export const CustomerDetailPanel: React.FC<CustomerDetailPanelProps> = ({
  customer,
}) => {
  return (
    <div className="space-y-monday-4">
      {/* å…¶ä»–å®¢æˆ·ä¿¡æ¯ */}
      
      {/* æ—¶é—´çº¿è§†å›¾ */}
      <Card variant="outlined" className="p-monday-4">
        <h4 className="text-monday-base font-semibold text-monday-text mb-monday-3">
          äº’åŠ¨å†å²
        </h4>
        <CustomerTimeline customerId={customer.id} />
      </Card>
    </div>
  );
};
```

### åç«¯ API è°ƒç”¨ç¤ºä¾‹

```typescript
// è·å–å®¢æˆ·æ—¶é—´çº¿
const response = await fetch(
  `/api/customers/${customerId}/timeline?page=1&limit=50&sortOrder=desc&dateRange=all`,
  {
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json',
    },
  }
);

const data = await response.json();
// data.interactions: äº’åŠ¨è®°å½•æ•°ç»„
// data.total: æ€»è®°å½•æ•°
```

### é™„ä»¶æ˜¾ç¤ºç¤ºä¾‹

```tsx
// å¯¼å…¥ PhotoPreview ç»„ä»¶
import { PhotoPreview } from '../../attachments/components/PhotoPreview';

// ç…§ç‰‡é¢„è§ˆçŠ¶æ€ç®¡ç†
const [selectedPhotoIndex, setSelectedPhotoIndex] = useState<number | null>(null);
const [photoAttachments, setPhotoAttachments] = useState<FileAttachment[]>([]);

/**
 * è·å–æ–‡ä»¶ç±»å‹å›¾æ ‡
 */
const getFileIcon = (attachment: FileAttachment): string => {
  if (attachment.fileType === 'photo' || attachment.mimeType?.startsWith('image/')) {
    return 'ğŸ–¼ï¸';
  }
  if (attachment.mimeType === 'application/pdf' || attachment.fileName.endsWith('.pdf')) {
    return 'ğŸ“„';
  }
  if (attachment.mimeType?.includes('word') || 
      attachment.fileName.endsWith('.docx') || 
      attachment.fileName.endsWith('.doc')) {
    return 'ğŸ“';
  }
  if (attachment.mimeType?.includes('excel') || 
      attachment.fileName.endsWith('.xlsx') || 
      attachment.fileName.endsWith('.xls')) {
    return 'ğŸ“Š';
  }
  return 'ğŸ“';
};

/**
 * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
 */
const formatFileSize = (bytes: number): string => {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
};

/**
 * å¤„ç†ç…§ç‰‡ç‚¹å‡» - æ‰“å¼€ç…§ç‰‡é¢„è§ˆ
 */
const handlePhotoClick = (attachment: FileAttachment, allAttachments: FileAttachment[]) => {
  // ç­›é€‰å‡ºæ‰€æœ‰ç…§ç‰‡é™„ä»¶
  const photos = allAttachments.filter(a => 
    a.fileType === 'photo' || a.mimeType?.startsWith('image/')
  );
  
  // æ‰¾åˆ°å½“å‰ç…§ç‰‡çš„ç´¢å¼•
  const index = photos.findIndex(a => a.id === attachment.id);
  
  if (index !== -1) {
    setPhotoAttachments(photos);
    setSelectedPhotoIndex(index);
  }
};

/**
 * å¤„ç†ç…§ç‰‡é¢„è§ˆå¯¼èˆª
 */
const handlePhotoNext = () => {
  if (selectedPhotoIndex !== null && selectedPhotoIndex < photoAttachments.length - 1) {
    setSelectedPhotoIndex(selectedPhotoIndex + 1);
  }
};

const handlePhotoPrevious = () => {
  if (selectedPhotoIndex !== null && selectedPhotoIndex > 0) {
    setSelectedPhotoIndex(selectedPhotoIndex - 1);
  }
};

// åœ¨äº’åŠ¨è®°å½•å¡ç‰‡ä¸­æ˜¾ç¤ºé™„ä»¶
{interaction.attachments && interaction.attachments.length > 0 && (
  <div className="mt-2 flex flex-wrap gap-2">
    {interaction.attachments.map((attachment) => {
      const isPhoto = attachment.fileType === 'photo' || attachment.mimeType?.startsWith('image/');
      
      if (isPhoto) {
        // ç…§ç‰‡é™„ä»¶ï¼šæ˜¾ç¤ºç¼©ç•¥å›¾
        return (
          <button
            key={attachment.id}
            onClick={() => handlePhotoClick(attachment, interaction.attachments)}
            className="relative w-16 h-16 rounded overflow-hidden border border-gray-200 hover:border-primary-blue transition-colors"
            aria-label={`æŸ¥çœ‹ç…§ç‰‡: ${attachment.fileName}`}
          >
            <img
              src={attachment.fileUrl}
              alt={attachment.fileName}
              className="w-full h-full object-cover"
              onError={(e) => {
                // ç¼©ç•¥å›¾åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºå›¾æ ‡
                e.currentTarget.style.display = 'none';
                e.currentTarget.nextElementSibling?.classList.remove('hidden');
              }}
            />
            <span className="hidden absolute inset-0 flex items-center justify-center text-2xl bg-gray-100">
              {getFileIcon(attachment)}
            </span>
          </button>
        );
      } else {
        // æ–‡æ¡£é™„ä»¶ï¼šæ˜¾ç¤ºå›¾æ ‡å’Œæ–‡ä»¶å
        return (
          <a
            key={attachment.id}
            href={attachment.fileUrl}
            download={attachment.fileName}
            className="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded hover:bg-gray-200 transition-colors"
          >
            <span className="text-lg">{getFileIcon(attachment)}</span>
            <div className="flex flex-col">
              <span className="text-sm font-medium">{attachment.fileName}</span>
              <span className="text-xs text-gray-500">{formatFileSize(attachment.fileSize)}</span>
            </div>
          </a>
        );
      }
    })}
  </div>
)}

// ç…§ç‰‡é¢„è§ˆç»„ä»¶
// æ³¨æ„ï¼šPhotoPreview ç»„ä»¶æ¥å— Attachment[] ç±»å‹ï¼Œéœ€è¦ç¡®ä¿ç±»å‹åŒ¹é…
{selectedPhotoIndex !== null && photoAttachments.length > 0 && (
  <PhotoPreview
    photos={photoAttachments.map(a => ({
      id: a.id,
      fileName: a.fileName,
      fileUrl: a.fileUrl,
      fileType: a.fileType,
      fileSize: a.fileSize,
      mimeType: a.mimeType,
    })) as Attachment[]}
    currentIndex={selectedPhotoIndex}
    onClose={() => {
      setSelectedPhotoIndex(null);
      setPhotoAttachments([]);
    }}
    onNext={handlePhotoNext}
    onPrevious={handlePhotoPrevious}
  />
)}
```

### "è®°å½•æ–°äº’åŠ¨"æŒ‰é’®å®ç°ç¤ºä¾‹

```tsx
// å¯¼å…¥ useNavigate
import { useNavigate } from 'react-router-dom';

// åœ¨ CustomerTimeline ç»„ä»¶ä¸­
const navigate = useNavigate();

/**
 * å¤„ç†åˆ›å»ºæ–°äº’åŠ¨
 */
const handleCreateInteraction = () => {
  navigate('/interactions/create', {
    state: { 
      customerId: customerId,
      // å¦‚æœéœ€è¦å®¢æˆ·åç§°ï¼Œå¯ä»¥ä» props æˆ– context è·å–
    }
  });
};

// åœ¨ç©ºçŠ¶æ€ä¸­æ˜¾ç¤ºæŒ‰é’®
{!data || data.interactions.length === 0 ? (
  <Card variant="outlined" className="p-monday-4">
    <div className="text-center py-monday-8">
      <div className="text-monday-4xl mb-monday-4 opacity-50">ğŸ“…</div>
      <p className="text-monday-base text-monday-text-secondary mb-monday-4">
        è¯¥å®¢æˆ·å°šæœªæœ‰ä»»ä½•äº’åŠ¨è®°å½•
      </p>
      <Button onClick={handleCreateInteraction} variant="primary">
        è®°å½•æ–°äº’åŠ¨
      </Button>
    </div>
  </Card>
) : (
  // æ˜¾ç¤ºäº’åŠ¨è®°å½•åˆ—è¡¨
  <div className="space-y-monday-4">
    {data.interactions.map((interaction) => (
      <TimelineInteractionCard
        key={interaction.id}
        interaction={interaction}
        isLast={false}
        onCardClick={handleCardClick}
      />
    ))}
  </div>
)}
```

## Project Structure

```
fenghua-backend/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ companies/
â”‚       â”œâ”€â”€ customer-timeline.controller.ts (GET /api/customers/:customerId/timeline)
â”‚       â”œâ”€â”€ customer-timeline.service.ts (ä¸šåŠ¡é€»è¾‘)
â”‚       â””â”€â”€ dto/
â”‚           â””â”€â”€ customer-timeline.dto.ts (DTO å®šä¹‰)

fenghua-frontend/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ customers/
â”‚       â””â”€â”€ components/
â”‚           â”œâ”€â”€ CustomerTimeline.tsx (äº’åŠ¨å†å²ç»„ä»¶)
â”‚           â””â”€â”€ CustomerDetailPanel.tsx (å®¢æˆ·è¯¦æƒ…é¢æ¿ï¼Œé›†æˆ CustomerTimeline)
```

## Dependencies

**ç°æœ‰ä¾èµ–ï¼š**
- `@tanstack/react-query` - ç”¨äºæ•°æ®è·å–å’Œç¼“å­˜
- `react-router-dom` - ç”¨äºè·¯ç”±å¯¼èˆª

**æ— éœ€æ–°å¢ä¾èµ–ï¼š**
- æ‰€æœ‰å¿…éœ€çš„åŠŸèƒ½éƒ½å·²å®ç°ï¼Œåªéœ€éªŒè¯å’Œå®Œå–„

## References

- **Epic 4:** äº’åŠ¨è®°å½•æ ¸å¿ƒåŠŸèƒ½
- **FR26:** å‰ç«¯ä¸“å‘˜å¯ä»¥æŸ¥çœ‹æŸä¸ªé‡‡è´­å•†çš„æ‰€æœ‰äº’åŠ¨è®°å½•ï¼›åç«¯ä¸“å‘˜å¯ä»¥æŸ¥çœ‹æŸä¸ªä¾›åº”å•†çš„æ‰€æœ‰äº’åŠ¨è®°å½•ï¼›æ€»ç›‘å’Œç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æŸä¸ªå®¢æˆ·çš„æ‰€æœ‰äº’åŠ¨è®°å½•
- **Story 3.6:** å®¢æˆ·æ—¶é—´çº¿è§†å›¾ï¼ˆå·²å®ç° CustomerTimeline ç»„ä»¶ï¼‰
- **Story 4.1:** äº’åŠ¨è®°å½•åˆ›å»ºï¼ˆå‰ç«¯ä¸“å‘˜ - é‡‡è´­å•†äº’åŠ¨ï¼‰
- **Story 4.2:** äº’åŠ¨è®°å½•åˆ›å»ºï¼ˆåç«¯ä¸“å‘˜ - ä¾›åº”å•†äº’åŠ¨ï¼‰
- **Story 4.4:** äº’åŠ¨è®°å½•é™„ä»¶ä¸Šä¼ 
- **Story 4.5:** ç”Ÿäº§è¿›åº¦ç…§ç‰‡ä¸Šä¼ ï¼ˆPhotoPreview ç»„ä»¶ï¼‰
- **Story 4.6:** å‘è´§å‰éªŒæ”¶ç…§ç‰‡ä¸Šä¼ ï¼ˆç…§ç‰‡é¢„è§ˆå’Œåˆ‡æ¢ï¼‰

## Dev Agent Record

### å®ç°æ‘˜è¦

Story 4.8 å·²æˆåŠŸå®ç°äº’åŠ¨å†å²æŸ¥çœ‹åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

1. **åç«¯ API éªŒè¯å’Œå®Œå–„**
   - éªŒè¯äº† `GET /api/customers/:customerId/timeline` ç«¯ç‚¹å·²å®ç°
   - éªŒè¯äº†åŸºäºè§’è‰²çš„æ•°æ®è¿‡æ»¤ã€åˆ†é¡µã€æ’åºã€æ—¶é—´èŒƒå›´ç­›é€‰åŠŸèƒ½
   - åˆ›å»ºäº† `customer_id + interaction_date` å¤åˆç´¢å¼•ä»¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼ˆè¿ç§»æ–‡ä»¶ï¼š`015-add-customer-timeline-index.sql`ï¼‰
   - éªŒè¯äº†é™„ä»¶æ•°æ®å·²åŒ…å«åœ¨å“åº”ä¸­

2. **å‰ç«¯ CustomerTimeline ç»„ä»¶å®Œå–„**
   - éªŒè¯äº†ç»„ä»¶å·²å®ç°å¹¶é›†æˆåˆ° `CustomerDetailPanel`
   - å®ç°äº†"è®°å½•æ–°äº’åŠ¨"æŒ‰é’®ï¼Œä½¿ç”¨ `useNavigate` å’Œ `state` ä¼ é€’å®¢æˆ·ä¿¡æ¯
   - æ›´æ–°äº† `InteractionCreateForm` ä»¥æ”¯æŒä» navigation state æ¥æ”¶é¢„å¡«å……çš„å®¢æˆ·ä¿¡æ¯

3. **é™„ä»¶æ˜¾ç¤ºå’Œäº¤äº’ä¼˜åŒ–**
   - å®ç°äº†é™„ä»¶å›¾æ ‡æ˜¾ç¤ºé€»è¾‘ï¼ˆæ ¹æ®æ–‡ä»¶ç±»å‹æ˜¾ç¤ºä¸åŒå›¾æ ‡ï¼šç…§ç‰‡ ğŸ–¼ï¸ã€PDF ğŸ“„ã€Word ğŸ“ã€Excel ğŸ“Šã€å…¶ä»– ğŸ“ï¼‰
   - å®ç°äº†ç…§ç‰‡ç¼©ç•¥å›¾æ˜¾ç¤ºï¼ˆ64x64pxï¼Œå¸¦ hover æ•ˆæœï¼‰
   - å¤ç”¨äº† Story 4.5 çš„ `PhotoPreview` ç»„ä»¶å®ç°ç…§ç‰‡å¤§å›¾æŸ¥çœ‹åŠŸèƒ½
   - å®ç°äº†å¤šå¼ ç…§ç‰‡åˆ‡æ¢é€»è¾‘ï¼ˆä¸Šä¸€å¼ /ä¸‹ä¸€å¼ ï¼Œæ”¯æŒé”®ç›˜å¯¼èˆªï¼‰
   - å®ç°äº†æ–‡æ¡£ä¸‹è½½åŠŸèƒ½ï¼ˆä½¿ç”¨ `<a>` æ ‡ç­¾çš„ `download` å±æ€§ï¼‰
   - ä¼˜åŒ–äº†é™„ä»¶æ˜¾ç¤ºå¸ƒå±€ï¼ˆflex-wrapï¼Œè‡ªåŠ¨æ¢è¡Œï¼‰

4. **äº’åŠ¨è®°å½•å¡ç‰‡æ˜¾ç¤ºä¼˜åŒ–**
   - ç¡®ä¿äº’åŠ¨ç±»å‹æ˜¾ç¤ºä¸­æ–‡æ ‡ç­¾ï¼ˆä½¿ç”¨ `INTERACTION_TYPE_LABELS`ï¼‰
   - ç¡®ä¿äº’åŠ¨æ—¶é—´æ ¼å¼åŒ–æ˜¾ç¤ºï¼ˆä½¿ç”¨ `getTimeLabel` å‡½æ•°ï¼‰
   - ç¡®ä¿å…³è”äº§å“ä¿¡æ¯æ˜¾ç¤ºï¼ˆäº§å“åç§°ã€HSç¼–ç ï¼‰
   - ç¡®ä¿åˆ›å»ºè€…ä¿¡æ¯æ˜¾ç¤ºï¼ˆåˆ›å»ºè€…å§“åæˆ–é‚®ç®±ï¼‰
   - ä¼˜åŒ–äº†å¡ç‰‡å¸ƒå±€ï¼ˆç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯ï¼‰

### æŠ€æœ¯å®ç°ç»†èŠ‚

**ç…§ç‰‡é¢„è§ˆåŠŸèƒ½ï¼š**
- ä½¿ç”¨ `PhotoPreview` ç»„ä»¶ï¼ˆStory 4.5ï¼‰
- çŠ¶æ€ç®¡ç†ï¼š`selectedPhotoIndex` å’Œ `photoAttachments`
- ç…§ç‰‡ç‚¹å‡»å¤„ç†ï¼šç­›é€‰å‡ºæ‰€æœ‰ç…§ç‰‡é™„ä»¶ï¼Œæ‰¾åˆ°å½“å‰ç…§ç‰‡ç´¢å¼•ï¼Œæ‰“å¼€é¢„è§ˆ
- å¤šå¼ ç…§ç‰‡åˆ‡æ¢ï¼šæ”¯æŒ `onNext` å’Œ `onPrevious` å›è°ƒï¼Œé”®ç›˜å¯¼èˆªï¼ˆâ†/â†’ï¼‰

**é™„ä»¶å›¾æ ‡æ˜¾ç¤ºï¼š**
- `getFileIcon` å‡½æ•°æ ¹æ®æ–‡ä»¶ç±»å‹è¿”å›å¯¹åº”å›¾æ ‡
- ç…§ç‰‡é™„ä»¶ï¼šä¼˜å…ˆæ˜¾ç¤ºç¼©ç•¥å›¾ï¼Œå¤±è´¥æ—¶æ˜¾ç¤ºå›¾æ ‡
- æ–‡æ¡£é™„ä»¶ï¼šæ ¹æ® `mimeType` æˆ–æ–‡ä»¶æ‰©å±•åæ˜¾ç¤ºå¯¹åº”å›¾æ ‡

**"è®°å½•æ–°äº’åŠ¨"æŒ‰é’®ï¼š**
- ä½¿ç”¨ `useNavigate` å’Œ `state` ä¼ é€’ `customerId`
- `InteractionCreateForm` é€šè¿‡ `prefillCustomerId` prop æ¥æ”¶å®¢æˆ· ID
- è‡ªåŠ¨åŠ è½½å¹¶é€‰æ‹©å®¢æˆ·ï¼ˆå¦‚æœå®¢æˆ·ç±»å‹ç¬¦åˆç”¨æˆ·è§’è‰²ï¼‰

**æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–ï¼š**
- åˆ›å»ºäº† `idx_interactions_customer_date` å¤åˆç´¢å¼•ï¼ˆ`customer_id, interaction_date DESC`ï¼‰
- ä¼˜åŒ–äº†æŒ‰å®¢æˆ·ç­›é€‰å¹¶æŒ‰æ—¶é—´æ’åºçš„æŸ¥è¯¢æ€§èƒ½

**ä»£ç å®¡æŸ¥ä¿®å¤ï¼ˆ2025-01-03ï¼‰ï¼š**
- æ·»åŠ äº† `customerId` UUID æ ¼å¼éªŒè¯ï¼Œé˜²æ­¢æ— æ•ˆ API è°ƒç”¨
- æ”¹è¿›äº†ç…§ç‰‡é™„ä»¶æ˜ å°„ä¸­çš„å ä½ç¬¦å€¼ï¼ˆä½¿ç”¨ `'timeline'` ä½œä¸º storageProviderï¼Œattachment id ä½œä¸º storageKeyï¼‰
- åˆ›å»ºäº† `ErrorBoundary` ç»„ä»¶å¹¶åŒ…è£… `PhotoPreview`ï¼Œé˜²æ­¢é¢„è§ˆé”™è¯¯å½±å“æ•´ä¸ªç»„ä»¶
- æ·»åŠ äº† `handleDocumentClick` å‡½æ•°çš„ JSDoc æ³¨é‡Š
- åˆ›å»ºäº†ç»Ÿä¸€çš„é”™è¯¯æ¶ˆæ¯å¸¸é‡æ–‡ä»¶ï¼ˆ`error-messages.ts`ï¼‰ï¼Œæ ‡å‡†åŒ–é”™è¯¯æ¶ˆæ¯æ ¼å¼

## File List

### æ–°å»ºçš„æ–‡ä»¶

**åç«¯ï¼š**
- `fenghua-backend/migrations/015-add-customer-timeline-index.sql` - æ·»åŠ  customer_id + interaction_date å¤åˆç´¢å¼•ä»¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

### ä¿®æ”¹çš„æ–‡ä»¶

**å‰ç«¯ï¼š**
- `fenghua-frontend/src/customers/components/CustomerTimeline.tsx` - æ·»åŠ ç…§ç‰‡é¢„è§ˆåŠŸèƒ½ã€æ”¹è¿›é™„ä»¶æ˜¾ç¤ºï¼ˆç…§ç‰‡ç¼©ç•¥å›¾ã€æ–‡æ¡£å›¾æ ‡ï¼‰ã€æ›´æ–°"è®°å½•æ–°äº’åŠ¨"æŒ‰é’®ï¼ˆä½¿ç”¨ useNavigate + stateï¼‰ã€æ·»åŠ  customerId UUID éªŒè¯ã€æ·»åŠ  ErrorBoundary åŒ…è£… PhotoPreviewã€ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯æ¶ˆæ¯å¸¸é‡
- `fenghua-frontend/src/interactions/components/InteractionCreateForm.tsx` - æ·»åŠ é¢„å¡«å……å®¢æˆ·ä¿¡æ¯æ”¯æŒï¼ˆé€šè¿‡ `prefillCustomerId` propï¼‰
- `fenghua-frontend/src/interactions/pages/InteractionCreatePage.tsx` - ä» navigation state æˆ– URL å‚æ•°è·å– customerId å¹¶ä¼ é€’ç»™è¡¨å•ç»„ä»¶
- `fenghua-frontend/src/components/ErrorBoundary.tsx` (æ–°å»º) - é”™è¯¯è¾¹ç•Œç»„ä»¶ï¼Œç”¨äºæ•è· React ç»„ä»¶é”™è¯¯
- `fenghua-frontend/src/common/constants/error-messages.ts` (æ–°å»º) - ç»Ÿä¸€çš„é”™è¯¯æ¶ˆæ¯å¸¸é‡æ–‡ä»¶ï¼ŒåŒ…å«å®¢æˆ·ã€æ—¶é—´çº¿ã€ç…§ç‰‡é¢„è§ˆç­‰é”™è¯¯æ¶ˆæ¯

