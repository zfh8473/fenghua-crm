# Story 3.5: å®¢æˆ·äº§å“äº’åŠ¨å†å²æŸ¥çœ‹ï¼ˆæŒ‰è§’è‰²ï¼‰

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a **å‰ç«¯ä¸“å‘˜/åç«¯ä¸“å‘˜/æ€»ç›‘/ç®¡ç†å‘˜**,
I want **æŸ¥çœ‹æŸä¸ªå®¢æˆ·é’ˆå¯¹æŸä¸ªäº§å“çš„å®Œæ•´äº’åŠ¨å†å²**,
So that **æˆ‘å¯ä»¥äº†è§£è¯¥å®¢æˆ·ä¸è¯¥äº§å“çš„ä¸šåŠ¡å¾€æ¥æƒ…å†µï¼Œè·Ÿè¸ªä¸šåŠ¡è¿›å±•**.

## Acceptance Criteria

**AC1: å‰ç«¯ä¸“å‘˜æŸ¥çœ‹é‡‡è´­å•†äº§å“äº’åŠ¨å†å²**
- **Given** å‰ç«¯ä¸“å‘˜å·²ç™»å½•ç³»ç»Ÿ
- **When** å‰ç«¯ä¸“å‘˜åœ¨é‡‡è´­å•†è¯¦æƒ…é¡µé¢é€‰æ‹©æŸä¸ªäº§å“ï¼Œç‚¹å‡»"æŸ¥çœ‹äº’åŠ¨å†å²"
- **Then** ç³»ç»Ÿæ˜¾ç¤ºè¯¥é‡‡è´­å•†é’ˆå¯¹è¯¥äº§å“çš„å®Œæ•´äº’åŠ¨å†å²
- **And** äº’åŠ¨è®°å½•æŒ‰æ—¶é—´é¡ºåºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
- **And** æ¯æ¡äº’åŠ¨è®°å½•æ˜¾ç¤ºï¼šäº’åŠ¨ç±»å‹ã€äº’åŠ¨æ—¶é—´ã€äº’åŠ¨æè¿°ã€åˆ›å»ºè€…ç­‰
- **And** ç³»ç»Ÿåªæ˜¾ç¤ºå‰ç«¯ä¸“å‘˜æœ‰æƒé™æŸ¥çœ‹çš„äº’åŠ¨è®°å½•

**AC2: åç«¯ä¸“å‘˜æŸ¥çœ‹ä¾›åº”å•†äº§å“äº’åŠ¨å†å²**
- **Given** åç«¯ä¸“å‘˜å·²ç™»å½•ç³»ç»Ÿ
- **When** åç«¯ä¸“å‘˜åœ¨ä¾›åº”å•†è¯¦æƒ…é¡µé¢é€‰æ‹©æŸä¸ªäº§å“ï¼Œç‚¹å‡»"æŸ¥çœ‹äº’åŠ¨å†å²"
- **Then** ç³»ç»Ÿæ˜¾ç¤ºè¯¥ä¾›åº”å•†é’ˆå¯¹è¯¥äº§å“çš„å®Œæ•´äº’åŠ¨å†å²
- **And** äº’åŠ¨è®°å½•æŒ‰æ—¶é—´é¡ºåºæ’åˆ—
- **And** ç³»ç»Ÿåªæ˜¾ç¤ºåç«¯ä¸“å‘˜æœ‰æƒé™æŸ¥çœ‹çš„äº’åŠ¨è®°å½•

**AC3: æ€»ç›‘/ç®¡ç†å‘˜æŸ¥çœ‹å®¢æˆ·äº§å“äº’åŠ¨å†å²**
- **Given** æ€»ç›‘æˆ–ç®¡ç†å‘˜å·²ç™»å½•ç³»ç»Ÿ
- **When** æ€»ç›‘æˆ–ç®¡ç†å‘˜åœ¨å®¢æˆ·è¯¦æƒ…é¡µé¢é€‰æ‹©æŸä¸ªäº§å“ï¼Œç‚¹å‡»"æŸ¥çœ‹äº’åŠ¨å†å²"
- **Then** ç³»ç»Ÿæ˜¾ç¤ºè¯¥å®¢æˆ·é’ˆå¯¹è¯¥äº§å“çš„å®Œæ•´äº’åŠ¨å†å²
- **And** ç³»ç»Ÿæ˜¾ç¤ºæ‰€æœ‰ç±»å‹çš„äº’åŠ¨è®°å½•

**AC4: é™„ä»¶æ˜¾ç¤ºå’Œä¸‹è½½**
- **Given** ç”¨æˆ·æŸ¥çœ‹å®¢æˆ·äº§å“äº’åŠ¨å†å²
- **When** äº’åŠ¨è®°å½•åŒ…å«é™„ä»¶ï¼ˆç…§ç‰‡ã€æ–‡æ¡£ç­‰ï¼‰
- **Then** ç³»ç»Ÿåœ¨äº’åŠ¨è®°å½•ä¸­æ˜¾ç¤ºé™„ä»¶å›¾æ ‡
- **And** ç”¨æˆ·å¯ä»¥ç‚¹å‡»é™„ä»¶æŸ¥çœ‹æˆ–ä¸‹è½½

**AC5: åˆ†é¡µå’Œæ»šåŠ¨åŠ è½½**
- **Given** ç”¨æˆ·æŸ¥çœ‹å®¢æˆ·äº§å“äº’åŠ¨å†å²
- **When** äº’åŠ¨å†å²è®°å½•è¾ƒå¤šï¼ˆ> 20 æ¡ï¼‰
- **Then** ç³»ç»Ÿä½¿ç”¨åˆ†é¡µæˆ–æ»šåŠ¨åŠ è½½æ˜¾ç¤ºäº’åŠ¨è®°å½•
- **And** ç³»ç»Ÿæ˜¾ç¤ºäº’åŠ¨è®°å½•æ€»æ•°

**AC6: ç©ºçŠ¶æ€å¤„ç†**
- **Given** ç”¨æˆ·æŸ¥çœ‹å®¢æˆ·äº§å“äº’åŠ¨å†å²
- **When** æ²¡æœ‰äº’åŠ¨è®°å½•
- **Then** ç³»ç»Ÿæ˜¾ç¤ºç©ºçŠ¶æ€"è¯¥å®¢æˆ·ä¸è¯¥äº§å“å°šæœªæœ‰ä»»ä½•äº’åŠ¨è®°å½•"
- **And** ç³»ç»Ÿæä¾›"è®°å½•æ–°äº’åŠ¨"æŒ‰é’®ï¼Œç”¨æˆ·å¯ä»¥å¿«é€Ÿè®°å½•äº’åŠ¨

## Tasks / Subtasks

- [x] Task 1: åç«¯ API å®ç° (AC: #1, #2, #3, #5)
  - [x] åˆ›å»ºå®¢æˆ·äº§å“äº’åŠ¨å†å²æœåŠ¡ (CustomerProductInteractionHistoryService)
    - [x] åˆ›å»º `fenghua-backend/src/companies/customer-product-interaction-history.service.ts`
    - [x] å®ç°æŸ¥è¯¢å®¢æˆ·-äº§å“äº’åŠ¨å†å²çš„æ–¹æ³• `getCustomerProductInteractions(customerId, productId, token, page, limit)`
    - [x] **éªŒè¯å®¢æˆ·æ˜¯å¦å­˜åœ¨**ï¼ˆåœ¨æŸ¥è¯¢äº’åŠ¨å†å²ä¹‹å‰ï¼‰ï¼š
      ```typescript
      const customerCheck = await this.pgPool.query(
        'SELECT id, customer_type FROM companies WHERE id = $1 AND deleted_at IS NULL',
        [customerId]
      );
      if (customerCheck.rows.length === 0) {
        throw new NotFoundException('å®¢æˆ·ä¸å­˜åœ¨');
      }
      ```
    - [x] **éªŒè¯äº§å“æ˜¯å¦å­˜åœ¨**ï¼ˆåœ¨æŸ¥è¯¢äº’åŠ¨å†å²ä¹‹å‰ï¼‰ï¼š
      ```typescript
      const productCheck = await this.pgPool.query(
        'SELECT id FROM products WHERE id = $1 AND deleted_at IS NULL',
        [productId]
      );
      if (productCheck.rows.length === 0) {
        throw new NotFoundException('äº§å“ä¸å­˜åœ¨');
      }
      ```
    - [x] å®ç°åŸºäºè§’è‰²çš„æ•°æ®è¿‡æ»¤ï¼ˆä½¿ç”¨ PermissionService.getDataAccessFilterï¼‰
    - [x] ä½¿ç”¨ SQL JOIN æŸ¥è¯¢ `product_customer_interactions`ã€`file_attachments` å’Œ `users` è¡¨
    - [x] å®ç°æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆORDER BY interaction_date DESCï¼‰
    - [x] å®ç°åˆ†é¡µæ”¯æŒï¼ˆé»˜è®¤æ¯é¡µ 20 æ¡ï¼‰
    - [x] å¤„ç†è½¯åˆ é™¤çš„äº’åŠ¨è®°å½•ï¼ˆè¿‡æ»¤ `deleted_at IS NULL`ï¼‰
    - [x] å®ç° customer_type å¤§å°å†™è½¬æ¢ï¼ˆPermissionService è¿”å›å°å†™ï¼Œæ•°æ®åº“å­˜å‚¨å¤§å†™ï¼‰
    - [x] éªŒè¯å®¢æˆ·ç±»å‹æƒé™ï¼ˆå¦‚æœç”¨æˆ·åªèƒ½æŸ¥çœ‹ç‰¹å®šç±»å‹çš„å®¢æˆ·ï¼ŒéªŒè¯å®¢æˆ·ç±»å‹ï¼‰
  - [x] åˆ›å»ºå®¢æˆ·äº§å“äº’åŠ¨å†å²æ§åˆ¶å™¨ (CustomerProductInteractionHistoryController)
    - [x] åˆ›å»º `fenghua-backend/src/companies/customer-product-interaction-history.controller.ts`
    - [x] åˆ›å»º GET `/api/customers/:customerId/interactions?productId=:productId&page=1&limit=20` ç«¯ç‚¹
    - [x] ä½¿ç”¨ `@UseGuards(JwtAuthGuard)` ä¿æŠ¤ç«¯ç‚¹
    - [x] å®ç°æŸ¥è¯¢å‚æ•°ï¼š`productId`ï¼ˆå¿…å¡«ï¼‰, `page`, `limit`
    - [x] è¿”å›äº’åŠ¨è®°å½•åˆ—è¡¨å’Œæ€»æ•°
    - [x] å®ç°é”™è¯¯å¤„ç†ï¼ˆå®¢æˆ·ä¸å­˜åœ¨ã€äº§å“ä¸å­˜åœ¨ã€æƒé™æ£€æŸ¥å¤±è´¥ã€æ•°æ®åº“é”™è¯¯ï¼‰
  - [x] åˆ›å»º DTOs
    - [x] åˆ›å»º `fenghua-backend/src/companies/dto/customer-product-interaction-history.dto.ts`
    - [x] `CustomerProductInteractionDto` - è¿”å›æ•°æ®ç»“æ„ï¼ˆåŒ…å«äº’åŠ¨ä¿¡æ¯å’Œé™„ä»¶åˆ—è¡¨ï¼‰
    - [x] `CustomerProductInteractionQueryDto` - æŸ¥è¯¢å‚æ•°ç»“æ„ï¼ˆproductId, page, limitï¼‰
    - [x] `FileAttachmentDto` - é™„ä»¶æ•°æ®ç»“æ„ï¼ˆå¤ç”¨æˆ–å‚è€ƒ Story 2.5 çš„ DTOï¼‰
  - [x] æ³¨å†ŒæœåŠ¡å’Œæ§åˆ¶å™¨åˆ°æ¨¡å—
    - [x] åœ¨ `fenghua-backend/src/companies/companies.module.ts` ä¸­æ·»åŠ æœåŠ¡å’Œæ§åˆ¶å™¨

- [x] Task 2: æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ– (AC: #1, #2, #3, #5)
  - [ ] **éªŒè¯** `product_customer_interactions` è¡¨ç´¢å¼•å·²å­˜åœ¨ï¼ˆè¿ç§» 002 å·²åˆ›å»ºï¼‰ï¼š
    - [ ] `idx_interactions_customer` - æŒ‰å®¢æˆ·æŸ¥è¯¢ï¼ˆå·²å­˜åœ¨ï¼Œè¿ç§» 002 ç¬¬ 64-66 è¡Œï¼‰
    - [ ] `idx_interactions_product_customer` - æŒ‰äº§å“å’Œå®¢æˆ·æŸ¥è¯¢ï¼ˆå·²å­˜åœ¨ï¼Œè¿ç§» 002 ç¬¬ 69-71 è¡Œï¼‰
  - [ ] **éªŒè¯** `file_attachments` è¡¨ç´¢å¼•å·²å­˜åœ¨ï¼š
    - [ ] `idx_attachments_interaction` - æŒ‰äº’åŠ¨è®°å½•æŸ¥è¯¢é™„ä»¶ï¼ˆå·²å­˜åœ¨ï¼‰
  - [ ] **æ€§èƒ½ä¼˜åŒ–æç¤ºï¼š** ä½¿ç”¨ `EXPLAIN ANALYZE` éªŒè¯æŸ¥è¯¢è®¡åˆ’ï¼Œç¡®ä¿ä½¿ç”¨ç´¢å¼• `idx_interactions_customer` å’Œ `idx_interactions_product_customer`
    - [ ] å¯¹äºå¤§é‡æ•°æ®ï¼Œå¦‚æœæŸ¥è¯¢æ€§èƒ½ä¸è¶³ï¼Œè€ƒè™‘æ·»åŠ å¤åˆç´¢å¼• `(customer_id, product_id, interaction_date)`
  - [ ] å®ç°é«˜æ•ˆæŸ¥è¯¢ SQLï¼ˆä½¿ç”¨ JOIN é¿å… N+1 æŸ¥è¯¢ï¼‰ï¼š
    ```sql
    SELECT 
      pci.id,
      pci.interaction_type,
      pci.interaction_date,
      pci.description,
      pci.status,
      pci.additional_info,
      pci.created_at,
      pci.created_by,
      u.email as creator_email,
      u.first_name as creator_first_name,
      u.last_name as creator_last_name,
      COALESCE(
        json_agg(
          json_build_object(
            'id', fa.id,
            'fileName', fa.file_name,
            'fileUrl', fa.file_url,
            'fileType', fa.file_type,
            'fileSize', fa.file_size
          )
        ) FILTER (WHERE fa.id IS NOT NULL),
        '[]'::json
      ) as attachments
    FROM product_customer_interactions pci
    INNER JOIN companies c ON c.id = pci.customer_id
    LEFT JOIN users u ON u.id = pci.created_by
    LEFT JOIN file_attachments fa ON fa.interaction_id = pci.id AND fa.deleted_at IS NULL
    WHERE pci.customer_id = $1 
      AND pci.product_id = $2
      AND pci.deleted_at IS NULL
      AND c.deleted_at IS NULL
      AND ($3::text IS NULL OR c.customer_type = $3)  -- è§’è‰²è¿‡æ»¤
    GROUP BY pci.id, pci.interaction_type, pci.interaction_date, pci.description, 
             pci.status, pci.additional_info, pci.created_at, pci.created_by,
             u.email, u.first_name, u.last_name
    ORDER BY pci.interaction_date DESC
    LIMIT $4 OFFSET $5
    ```
  - [ ] å®ç°åŸºäºè§’è‰²çš„å®¢æˆ·ç±»å‹è¿‡æ»¤ï¼ˆåœ¨ SQL æŸ¥è¯¢ä¸­ï¼‰
    - [ ] å‰ç«¯ä¸“å‘˜ï¼šåªæŸ¥è¯¢ `customer_type = 'BUYER'` çš„å®¢æˆ·çš„äº’åŠ¨è®°å½•
    - [ ] åç«¯ä¸“å‘˜ï¼šåªæŸ¥è¯¢ `customer_type = 'SUPPLIER'` çš„å®¢æˆ·çš„äº’åŠ¨è®°å½•
    - [ ] æ€»ç›‘/ç®¡ç†å‘˜ï¼šæ— è¿‡æ»¤ï¼ˆè¿”å›æ‰€æœ‰äº’åŠ¨è®°å½•ï¼‰
  - [ ] å®ç°æ€»æ•°æŸ¥è¯¢ï¼ˆç”¨äºåˆ†é¡µï¼‰ï¼š
    ```sql
    SELECT COUNT(DISTINCT pci.id)
    FROM product_customer_interactions pci
    INNER JOIN companies c ON c.id = pci.customer_id
    WHERE pci.customer_id = $1 
      AND pci.product_id = $2
      AND pci.deleted_at IS NULL
      AND c.deleted_at IS NULL
      AND ($3::text IS NULL OR c.customer_type = $3)
    ```

- [x] Task 3: å‰ç«¯ç»„ä»¶å®ç° (AC: #1, #2, #3, #4, #5, #6)
  - [ ] åˆ›å»º `CustomerProductInteractionHistory` ç»„ä»¶
    - [ ] åˆ›å»º `fenghua-frontend/src/customers/components/CustomerProductInteractionHistory.tsx`
    - [ ] æ¥æ”¶ `customerId` å’Œ `productId` ä½œä¸º propsï¼ˆä» URL å‚æ•°è·å–ï¼‰
    - [ ] ä½¿ç”¨ `useAuth()` è·å–å½“å‰ç”¨æˆ·è§’è‰²
    - [ ] **æ•°æ®è·å–ç­–ç•¥ï¼š** å‚è€ƒ `ProductCustomerInteractionHistory.tsx`ï¼Œç›´æ¥åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ `fetch` è°ƒç”¨ APIï¼Œæ— éœ€åœ¨ `customers.service.ts` ä¸­æ·»åŠ æ–°æ–¹æ³•
    - [ ] ä½¿ç”¨ React Query çš„ `useQuery` hookï¼Œç¼“å­˜é”®ï¼š`['customer-interactions', customerId, productId, page, limit]`
    - [ ] å®ç°åŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†
    - [ ] **ç¼“å­˜å¤±æ•ˆç­–ç•¥ï¼š**
      - [ ] å½“äº’åŠ¨è®°å½•åˆ›å»º/æ›´æ–°/åˆ é™¤æ—¶ï¼Œä½¿ `['customer-interactions', customerId, productId]` ç¼“å­˜å¤±æ•ˆ
      - [ ] ä½¿ç”¨ `queryClient.invalidateQueries` è¿›è¡Œç¼“å­˜å¤±æ•ˆ
      - [ ] è®¾ç½® `staleTime: 5 * 60 * 1000`ï¼ˆ5 åˆ†é’Ÿç¼“å­˜ï¼‰
  - [ ] å®ç°äº’åŠ¨è®°å½•åˆ—è¡¨æ˜¾ç¤º
    - [ ] ä½¿ç”¨ Card ç»„ä»¶æ˜¾ç¤ºæ¯æ¡äº’åŠ¨è®°å½•
    - [ ] æ¯æ¡è®°å½•æ˜¾ç¤ºï¼šäº’åŠ¨ç±»å‹æ ‡ç­¾ã€äº’åŠ¨æ—¶é—´ã€äº’åŠ¨æè¿°ã€åˆ›å»ºè€…ä¿¡æ¯
    - [ ] å®ç°äº’åŠ¨ç±»å‹çš„ä¸­æ–‡æ ‡ç­¾æ˜ å°„ï¼š
      ```typescript
      const INTERACTION_TYPE_LABELS: Record<string, string> = {
        // é‡‡è´­å•†äº’åŠ¨ç±»å‹
        initial_contact: 'åˆæ­¥æ¥è§¦',
        product_inquiry: 'äº§å“è¯¢ä»·',
        quotation: 'æŠ¥ä»·',
        quotation_accepted: 'æ¥å—æŠ¥ä»·',
        quotation_rejected: 'æ‹’ç»æŠ¥ä»·',
        order_signed: 'ç­¾ç½²è®¢å•',
        order_completed: 'å®Œæˆè®¢å•',
        // ä¾›åº”å•†äº’åŠ¨ç±»å‹
        product_inquiry_supplier: 'è¯¢ä»·äº§å“',
        quotation_received: 'æ¥æ”¶æŠ¥ä»·',
        specification_confirmed: 'äº§å“è§„æ ¼ç¡®è®¤',
        production_progress: 'ç”Ÿäº§è¿›åº¦è·Ÿè¿›',
        pre_shipment_inspection: 'å‘è´§å‰éªŒæ”¶',
        shipped: 'å·²å‘è´§',
      };
      ```
    - [ ] å®ç°äº’åŠ¨ç±»å‹é¢œè‰²æ ‡ç­¾å‡½æ•°ï¼š
      ```typescript
      const getInteractionTypeColor = (type: string): string => {
        const buyerTypes = ['initial_contact', 'product_inquiry', 'quotation', 'quotation_accepted', 'quotation_rejected', 'order_signed', 'order_completed'];
        const supplierTypes = ['product_inquiry_supplier', 'quotation_received', 'specification_confirmed', 'production_progress', 'pre_shipment_inspection', 'shipped'];
        if (buyerTypes.includes(type)) return 'bg-primary-blue/10 text-primary-blue';
        if (supplierTypes.includes(type)) return 'bg-primary-purple/10 text-primary-purple';
        return 'bg-gray-100 text-monday-text-secondary';
      };
      ```
  - [ ] å®ç°é™„ä»¶æ˜¾ç¤º (AC: #4)
    - [ ] å¦‚æœäº’åŠ¨è®°å½•æœ‰é™„ä»¶ï¼Œæ˜¾ç¤ºé™„ä»¶å›¾æ ‡
    - [ ] å®ç°é™„ä»¶åˆ—è¡¨æ˜¾ç¤ºï¼ˆæ–‡ä»¶åã€æ–‡ä»¶ç±»å‹ã€æ–‡ä»¶å¤§å°ï¼‰
    - [ ] å®ç°é™„ä»¶ç‚¹å‡»æŸ¥çœ‹/ä¸‹è½½åŠŸèƒ½ï¼ˆä½¿ç”¨ `fileUrl`ï¼Œå‚è€ƒ `ProductCustomerInteractionHistory.tsx` çš„ `handleAttachmentClick` æ¨¡å¼ï¼‰ï¼š
      ```typescript
      const handleAttachmentClick = (attachment: FileAttachment) => {
        const link = document.createElement('a');
        link.href = attachment.fileUrl;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.click();
      };
      ```
    - [ ] å®ç°é™„ä»¶æ˜¾ç¤ºç»„ä»¶ï¼ˆå‚è€ƒ `ProductCustomerInteractionHistory.tsx` çš„ `InteractionCard` å­ç»„ä»¶ï¼‰ï¼š
      ```tsx
      {interaction.attachments && interaction.attachments.length > 0 && (
        <div className="mt-monday-3 pt-monday-3 border-t border-gray-200">
          <div className="text-monday-xs text-monday-text-secondary mb-monday-2">é™„ä»¶ï¼š</div>
          <div className="flex flex-wrap gap-monday-2">
            {interaction.attachments.map((attachment) => (
              <button
                key={attachment.id}
                onClick={() => handleAttachmentClick(attachment)}
                className="flex items-center gap-monday-1 px-monday-2 py-monday-1 rounded-monday-md bg-gray-50 hover:bg-gray-100 text-monday-xs text-monday-text-secondary hover:text-monday-text transition-colors"
              >
                <span>ğŸ“</span>
                <span>{attachment.fileName}</span>
                <span className="text-monday-xs opacity-60">
                  ({(attachment.fileSize / 1024).toFixed(1)} KB)
                </span>
              </button>
            ))}
          </div>
        </div>
      )}
      ```
    - [ ] å®ç°å›¾ç‰‡é™„ä»¶é¢„è§ˆï¼ˆå¦‚æœæ˜¯å›¾ç‰‡ç±»å‹ï¼‰
  - [ ] å®ç°ç©ºçŠ¶æ€æ˜¾ç¤º (AC: #6)
    - [ ] æ˜¾ç¤ºç©ºçŠ¶æ€å›¾æ ‡å’Œæ¶ˆæ¯
    - [ ] æ˜¾ç¤º"è®°å½•æ–°äº’åŠ¨"æŒ‰é’®ï¼ˆè·³è½¬åˆ°äº’åŠ¨è®°å½•åˆ›å»ºé¡µé¢ï¼Œè·¯å¾„ï¼š`/interactions/create?customerId=:customerId&productId=:productId`ï¼‰
  - [ ] å®ç°åˆ†é¡µæˆ–æ»šåŠ¨åŠ è½½ (AC: #5)
    - [ ] å¦‚æœäº’åŠ¨è®°å½•æ•°é‡ > 20ï¼Œå®ç°åˆ†é¡µæ§ä»¶
    - [ ] æˆ–å®ç°æ— é™æ»šåŠ¨åŠ è½½ï¼ˆä½¿ç”¨ React Query çš„ `useInfiniteQuery`ï¼‰
    - [ ] æ˜¾ç¤ºäº’åŠ¨è®°å½•æ€»æ•°

- [x] Task 4: åˆ›å»ºäº’åŠ¨å†å²é¡µé¢ (AC: #1, #2, #3)
  - [ ] åˆ›å»ºé¡µé¢ç»„ä»¶æ–‡ä»¶: `fenghua-frontend/src/customers/CustomerProductInteractionHistoryPage.tsx`
    - [ ] è·¯ç”±è·¯å¾„ï¼š`/customers/:customerId/interactions?productId=:productId`
    - [ ] ä» URL å‚æ•°è·å– `customerId`ï¼ˆä½¿ç”¨ `useParams`ï¼‰å’Œ `productId`ï¼ˆä½¿ç”¨ `useSearchParams`ï¼‰
    - [ ] ä½¿ç”¨ `MainLayout` å¸ƒå±€
    - [ ] æ˜¾ç¤ºé¡µé¢æ ‡é¢˜ï¼ˆ"å®¢æˆ·ä¸äº§å“äº’åŠ¨å†å²"ï¼‰
    - [ ] ä½¿ç”¨ API è°ƒç”¨ `GET /api/customers/:customerId` è·å–å®¢æˆ·ä¿¡æ¯
    - [ ] ä½¿ç”¨ API è°ƒç”¨ `GET /api/products/:productId` è·å–äº§å“ä¿¡æ¯
    - [ ] æ˜¾ç¤ºå®¢æˆ·åç§°å’Œäº§å“åç§°ï¼ˆä» API è·å–ï¼‰
    - [ ] é›†æˆ `CustomerProductInteractionHistory` ç»„ä»¶
  - [ ] æ·»åŠ è·¯ç”±é…ç½®åˆ° `fenghua-frontend/src/App.tsx`
    - [ ] åœ¨ `<Routes>` å†…æ·»åŠ ï¼š`<Route path="/customers/:customerId/interactions" element={<ProtectedRoute><CustomerProductInteractionHistoryPage /></ProtectedRoute>} />`
    - [ ] ä½¿ç”¨ `ProtectedRoute` ä¿æŠ¤è·¯ç”±ï¼ˆå‚è€ƒç°æœ‰è·¯ç”±æ¨¡å¼ï¼‰

- [x] Task 5: é›†æˆåˆ° CustomerProductAssociation ç»„ä»¶ (AC: #1, #2, #3)
  - [ ] åœ¨ `CustomerProductAssociation.tsx` ä¸­ï¼Œæ›´æ–°"æŸ¥çœ‹äº’åŠ¨å†å²"æŒ‰é’®
    - [ ] å°†æŒ‰é’®ä» `disabled={true}` æ”¹ä¸º `disabled={false}`
    - [ ] æ›´æ–° Link è·¯å¾„ä¸ºï¼š`/customers/${customerId}/interactions?productId=${product.id}`
    - [ ] ç§»é™¤ `title="Story 3.5 å°šæœªå®ç°"` å±æ€§

- [x] Task 6: è§’è‰²æƒé™éªŒè¯ (AC: #1, #2, #3)
  - [ ] åç«¯æƒé™éªŒè¯
    - [ ] ä½¿ç”¨ `PermissionService.getDataAccessFilter()` è·å–æ•°æ®è®¿é—®è¿‡æ»¤å™¨
    - [ ] åœ¨ SQL æŸ¥è¯¢ä¸­åº”ç”¨è¿‡æ»¤å™¨ï¼ˆä½¿ç”¨ UPPER() è½¬æ¢å¤§å°å†™ï¼‰
    - [ ] ç¡®ä¿å‰ç«¯ä¸“å‘˜åªèƒ½çœ‹åˆ°é‡‡è´­å•†ç±»å‹çš„å®¢æˆ·çš„äº’åŠ¨è®°å½•
    - [ ] ç¡®ä¿åç«¯ä¸“å‘˜åªèƒ½çœ‹åˆ°ä¾›åº”å•†ç±»å‹çš„å®¢æˆ·çš„äº’åŠ¨è®°å½•
    - [ ] å¤„ç†æƒé™æ£€æŸ¥å¤±è´¥çš„æƒ…å†µï¼ˆè¿”å› 403 Forbiddenï¼‰
  - [ ] å‰ç«¯æƒé™æ˜¾ç¤º
    - [ ] ä½¿ç”¨ `isFrontendSpecialist()`, `isBackendSpecialist()`, `isDirector()`, `isAdmin()` å‡½æ•°
    - [ ] æ ¹æ®è§’è‰²æ˜¾ç¤ºä¸åŒçš„æ ‡é¢˜å’Œå†…å®¹
    - [ ] å¤„ç†æƒé™é”™è¯¯ï¼ˆæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼‰

- [x] Task 7: åç«¯å•å…ƒæµ‹è¯• (AC: #1, #2, #3, #5)
  - [ ] åˆ›å»º `customer-product-interaction-history.service.spec.ts`
  - [ ] æµ‹è¯•è§’è‰²è¿‡æ»¤é€»è¾‘ï¼ˆå‰ç«¯ä¸“å‘˜ã€åç«¯ä¸“å‘˜ã€æ€»ç›‘/ç®¡ç†å‘˜ï¼‰
  - [ ] æµ‹è¯•åˆ†é¡µåŠŸèƒ½
  - [ ] æµ‹è¯•æ’åºåŠŸèƒ½ï¼ˆæŒ‰äº’åŠ¨æ—¶é—´å€’åºï¼‰
  - [ ] æµ‹è¯•ç©ºçŠ¶æ€å¤„ç†
  - [ ] æµ‹è¯•é”™è¯¯å¤„ç†ï¼ˆå®¢æˆ·ä¸å­˜åœ¨ã€äº§å“ä¸å­˜åœ¨ã€æƒé™å¤±è´¥ï¼‰

- [x] Task 8: å‰ç«¯ç»„ä»¶æµ‹è¯• (AC: #1, #2, #3, #4, #5, #6)
  - [ ] åˆ›å»º `CustomerProductInteractionHistory.test.tsx`
  - [ ] æµ‹è¯•äº’åŠ¨è®°å½•åˆ—è¡¨æ˜¾ç¤º
  - [ ] æµ‹è¯•é™„ä»¶æ˜¾ç¤º
  - [ ] æµ‹è¯•ç©ºçŠ¶æ€æ˜¾ç¤º
  - [ ] æµ‹è¯•åˆ†é¡µåŠŸèƒ½
  - [ ] æµ‹è¯•è§’è‰²æƒé™æ˜¾ç¤º
  - [ ] æµ‹è¯•é”™è¯¯å¤„ç†

## Dev Notes

### Architecture Patterns

- **å‚è€ƒ Story 2.5**: æœ¬ Story æ˜¯ Story 2.5ï¼ˆäº§å“ä¸å®¢æˆ·äº’åŠ¨å†å²æŸ¥çœ‹ï¼‰çš„é•œåƒå®ç°ï¼Œä½†æ–¹å‘ç›¸åï¼ˆä»å®¢æˆ·æŸ¥çœ‹äº§å“äº’åŠ¨å†å²ï¼‰
- **æ•°æ®æ¨¡å‹**: ä½¿ç”¨ `product_customer_interactions` è¡¨ä½œä¸ºäº’åŠ¨è®°å½•è¡¨ï¼Œé€šè¿‡ JOIN æŸ¥è¯¢è·å–äº’åŠ¨å†å²å’Œé™„ä»¶
- **è§’è‰²è¿‡æ»¤**: ä½¿ç”¨ `PermissionService.getDataAccessFilter()` è·å–è§’è‰²è¿‡æ»¤å™¨ï¼Œåœ¨ SQL æŸ¥è¯¢ä¸­åº”ç”¨
- **åˆ†é¡µç­–ç•¥**: ä½¿ç”¨ SQL LIMIT/OFFSET å®ç°åˆ†é¡µï¼Œé»˜è®¤æ¯é¡µ 20 æ¡
- **æ’åºç­–ç•¥**: æŒ‰äº’åŠ¨æ—¶é—´å€’åºæ’åºï¼ˆORDER BY interaction_date DESCï¼‰

### Technical Requirements

**åç«¯å®ç°ï¼š**
- æœåŠ¡å±‚ï¼š`CustomerProductInteractionHistoryService` - å¤„ç†ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®åº“æŸ¥è¯¢
- æ§åˆ¶å™¨å±‚ï¼š`CustomerProductInteractionHistoryController` - å¤„ç† HTTP è¯·æ±‚å’Œå“åº”
- DTO å±‚ï¼š`CustomerProductInteractionDto`, `CustomerProductInteractionQueryDto`, `FileAttachmentDto` - æ•°æ®ä¼ è¾“å¯¹è±¡
- æƒé™éªŒè¯ï¼šä½¿ç”¨ `JwtAuthGuard` å’Œ `PermissionService`
- æ•°æ®åº“æŸ¥è¯¢ï¼šä½¿ç”¨ PostgreSQL JOIN æŸ¥è¯¢ï¼Œé¿å… N+1 æŸ¥è¯¢é—®é¢˜

**å‰ç«¯å®ç°ï¼š**
- ç»„ä»¶ï¼š`CustomerProductInteractionHistory` - æ˜¾ç¤ºå®¢æˆ·äº§å“äº’åŠ¨å†å²åˆ—è¡¨
- é¡µé¢ï¼š`CustomerProductInteractionHistoryPage` - äº’åŠ¨å†å²é¡µé¢
- æ•°æ®è·å–ï¼šä½¿ç”¨ React Query (`useQuery`) è·å–å’Œç¼“å­˜æ•°æ®
- è·¯ç”±ï¼šäº’åŠ¨å†å²é¡µé¢é“¾æ¥åˆ° `/customers/:customerId/interactions?productId=:productId`
- UI ç»„ä»¶ï¼šä½¿ç”¨ Cardã€Buttonã€Link ç­‰ç°æœ‰ UI ç»„ä»¶

### Previous Story Intelligence

**Story 2.5 å­¦ä¹ ç‚¹ï¼ˆå…·ä½“ä»£ç æ¨¡å¼ï¼‰ï¼š**
- **SQL æŸ¥è¯¢æ¨¡å¼ï¼š** ä½¿ç”¨ JOIN companiesã€users å’Œ file_attachments è¡¨ï¼š
  ```sql
  FROM product_customer_interactions pci
  INNER JOIN companies c ON c.id = pci.customer_id
  LEFT JOIN users u ON u.id = pci.created_by
  LEFT JOIN file_attachments fa ON fa.interaction_id = pci.id AND fa.deleted_at IS NULL
  WHERE pci.customer_id = $1 AND pci.product_id = $2
    AND ($3::text IS NULL OR c.customer_type = $3)
  ```
- **é”™è¯¯å¤„ç†æ¨¡å¼ï¼š** éªŒè¯å®¢æˆ·å’Œäº§å“éƒ½å­˜åœ¨ï¼Œå¤„ç†æƒé™æ£€æŸ¥å¤±è´¥ï¼š
  ```typescript
  // éªŒè¯å®¢æˆ·
  const customerCheck = await this.pgPool.query(
    'SELECT id, customer_type FROM companies WHERE id = $1 AND deleted_at IS NULL',
    [customerId]
  );
  if (customerCheck.rows.length === 0) {
    throw new NotFoundException('å®¢æˆ·ä¸å­˜åœ¨');
  }
  const customerType = customerCheck.rows[0].customer_type;
  // éªŒè¯äº§å“
  const productCheck = await this.pgPool.query(
    'SELECT id FROM products WHERE id = $1 AND deleted_at IS NULL',
    [productId]
  );
  if (productCheck.rows.length === 0) {
    throw new NotFoundException('äº§å“ä¸å­˜åœ¨');
  }
  // æƒé™æ£€æŸ¥
  if (customerTypeFilter && customerType !== customerTypeFilter) {
    throw new ForbiddenException('æ‚¨æ²¡æœ‰æƒé™æŸ¥çœ‹è¯¥å®¢æˆ·çš„äº’åŠ¨å†å²');
  }
  ```
- **React Query ç¼“å­˜é…ç½®ï¼š**
  ```typescript
  useQuery({
    queryKey: ['customer-interactions', customerId, productId, page, limit],
    queryFn: async () => {
      const apiBaseUrl = import.meta.env.VITE_API_BASE_URL || import.meta.env.VITE_BACKEND_URL || 'http://localhost:3006';
      const response = await fetch(
        `${apiBaseUrl}/api/customers/${customerId}/interactions?productId=${productId}&page=${page}&limit=${limit}`,
        {
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        }
      );
      if (!response.ok) {
        if (response.status === 403) throw new Error('æ‚¨æ²¡æœ‰æƒé™æŸ¥çœ‹äº’åŠ¨å†å²');
        if (response.status === 404) throw new Error('å®¢æˆ·æˆ–äº§å“ä¸å­˜åœ¨');
        throw new Error('è·å–äº’åŠ¨å†å²å¤±è´¥');
      }
      return response.json();
    },
    enabled: !!customerId && !!productId && !!token,
    staleTime: 5 * 60 * 1000, // 5 åˆ†é’Ÿç¼“å­˜
  })
  ```
- **é™„ä»¶å¤„ç†ï¼š** ä½¿ç”¨ `json_agg` èšåˆé™„ä»¶ï¼Œå‰ç«¯è§£æ JSON æ•°ç»„
- **Creator ä¿¡æ¯å¤„ç†ï¼š** ä½¿ç”¨ LEFT JOIN users è¡¨è·å–åˆ›å»ºè€… emailã€first_nameã€last_name
- **äº’åŠ¨ç±»å‹æ˜ å°„ï¼š** å¿…é¡»ä½¿ç”¨ä¸ Story 2.5 å®Œå…¨ç›¸åŒçš„ `INTERACTION_TYPE_LABELS` å’Œ `getInteractionTypeColor` å‡½æ•°ï¼ˆè§ Task 3 å…·ä½“å®ç°ï¼‰

**Story 3.4 å­¦ä¹ ç‚¹ï¼š**
- å®¢æˆ·éªŒè¯æ¨¡å¼ï¼ˆéªŒè¯å®¢æˆ·æ˜¯å¦å­˜åœ¨å’Œç±»å‹ï¼‰
- å®¢æˆ·ç±»å‹æƒé™æ£€æŸ¥æ¨¡å¼
- å‰ç«¯ç»„ä»¶é›†æˆåˆ° CustomerDetailPanel çš„æ¨¡å¼

### Implementation Details

**SQL æŸ¥è¯¢ç¤ºä¾‹ï¼ˆå®Œæ•´å®ç°ï¼‰ï¼š**
```sql
-- æŸ¥è¯¢å®¢æˆ·äº§å“äº’åŠ¨å†å²ï¼ˆå¸¦è§’è‰²è¿‡æ»¤å’Œé™„ä»¶ï¼‰
-- æ³¨æ„ï¼šå¿…é¡» JOIN companies è¡¨ä»¥è·å– customer_type è¿›è¡Œè§’è‰²è¿‡æ»¤
SELECT 
  pci.id,
  pci.interaction_type,
  pci.interaction_date,
  pci.description,
  pci.status,
  pci.additional_info,
  pci.created_at,
  pci.created_by,
  u.email as creator_email,
  u.first_name as creator_first_name,
  u.last_name as creator_last_name,
  COALESCE(
    json_agg(
      json_build_object(
        'id', fa.id,
        'fileName', fa.file_name,
        'fileUrl', fa.file_url,
        'fileType', fa.file_type,
        'fileSize', fa.file_size,
        'mimeType', fa.mime_type
      )
    ) FILTER (WHERE fa.id IS NOT NULL),
    '[]'::json
  ) as attachments
FROM product_customer_interactions pci
INNER JOIN companies c ON c.id = pci.customer_id  -- å¿…é¡» JOIN ä»¥è¿‡æ»¤ customer_type
LEFT JOIN users u ON u.id = pci.created_by
LEFT JOIN file_attachments fa ON fa.interaction_id = pci.id AND fa.deleted_at IS NULL
WHERE pci.customer_id = $1 
  AND pci.product_id = $2
  AND pci.deleted_at IS NULL
  AND c.deleted_at IS NULL  -- è¿‡æ»¤è½¯åˆ é™¤çš„å®¢æˆ·
  AND ($3::text IS NULL OR c.customer_type = $3)  -- è§’è‰²è¿‡æ»¤ï¼ˆ$3 ä¸º customerTypeFilterï¼‰
GROUP BY pci.id, pci.interaction_type, pci.interaction_date, pci.description, 
         pci.status, pci.additional_info, pci.created_at, pci.created_by,
         u.email, u.first_name, u.last_name
ORDER BY pci.interaction_date DESC
LIMIT $4 OFFSET $5
```

**æ€§èƒ½éªŒè¯ï¼š**
- ä½¿ç”¨ `EXPLAIN ANALYZE` éªŒè¯æŸ¥è¯¢è®¡åˆ’ï¼Œç¡®ä¿ä½¿ç”¨ç´¢å¼• `idx_interactions_customer` å’Œ `idx_interactions_product_customer`
- å¦‚æœæŸ¥è¯¢æ€§èƒ½ä¸è¶³ï¼Œè€ƒè™‘æ·»åŠ å¤åˆç´¢å¼• `(customer_id, product_id, interaction_date)`

**å‰ç«¯ç»„ä»¶ç»“æ„ï¼š**
```tsx
interface CustomerProductInteractionHistoryProps {
  customerId: string;
  productId: string;
}

interface Interaction {
  id: string;
  interactionType: string;
  interactionDate: string;
  description?: string;
  status?: string;
  additionalInfo?: Record<string, unknown>;
  createdAt: string;
  createdBy?: string;
  creator?: {
    email?: string;
    firstName?: string;
    lastName?: string;
  };
  attachments: FileAttachment[];
}

interface FileAttachment {
  id: string;
  fileName: string;
  fileUrl: string;
  fileType: string;
  fileSize: number;
  mimeType?: string;
}
```

**API ç«¯ç‚¹ï¼š**
- `GET /api/customers/:customerId/interactions?productId=:productId&page=1&limit=20`
- è¿”å›ï¼š`{ interactions: CustomerProductInteractionDto[]; total: number }`

### Testing Standards

- **åç«¯æµ‹è¯•**: ä½¿ç”¨ Jestï¼Œæµ‹è¯•æœåŠ¡å±‚å’Œæ§åˆ¶å™¨å±‚
- **å‰ç«¯æµ‹è¯•**: ä½¿ç”¨ Vitest + React Testing Libraryï¼Œæµ‹è¯•ç»„ä»¶æ¸²æŸ“å’Œäº¤äº’
- **é›†æˆæµ‹è¯•**: éªŒè¯ API ç«¯ç‚¹å’Œå‰ç«¯ç»„ä»¶çš„é›†æˆ

### Project Structure Notes

- åç«¯æœåŠ¡ï¼š`fenghua-backend/src/companies/customer-product-interaction-history.service.ts`
- åç«¯æ§åˆ¶å™¨ï¼š`fenghua-backend/src/companies/customer-product-interaction-history.controller.ts`
- åç«¯ DTOï¼š`fenghua-backend/src/companies/dto/customer-product-interaction-history.dto.ts`
- å‰ç«¯ç»„ä»¶ï¼š`fenghua-frontend/src/customers/components/CustomerProductInteractionHistory.tsx`
- å‰ç«¯é¡µé¢ï¼š`fenghua-frontend/src/customers/CustomerProductInteractionHistoryPage.tsx`
- å‰ç«¯é›†æˆï¼š`fenghua-frontend/src/customers/components/CustomerProductAssociation.tsx`

### References

- [Source: _bmad-output/epics.md#Story-3.5] - Story 3.5 çš„åŸå§‹éœ€æ±‚
- [Source: _bmad-output/implementation-artifacts/stories/2-5-product-customer-interaction-history.md] - Story 2.5 çš„å®ç°å‚è€ƒ
- [Source: _bmad-output/implementation-artifacts/stories/3-4-customer-product-association-view.md] - Story 3.4 çš„é›†æˆæ¨¡å¼
- [Source: fenghua-backend/src/products/product-customer-interaction-history.service.ts] - äº§å“å®¢æˆ·äº’åŠ¨å†å²æœåŠ¡çš„å®ç°å‚è€ƒ
- [Source: fenghua-frontend/src/products/components/ProductCustomerInteractionHistory.tsx] - äº§å“å®¢æˆ·äº’åŠ¨å†å²ç»„ä»¶çš„å®ç°å‚è€ƒ

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

- `fenghua-backend/src/companies/dto/customer-product-interaction-history.dto.ts` - **NEW** - DTOs for customer-product interaction history
- `fenghua-backend/src/companies/customer-product-interaction-history.service.ts` - **NEW** - Backend service for customer-product interaction history
- `fenghua-backend/src/companies/customer-product-interaction-history.controller.ts` - **NEW** - Backend controller for customer-product interaction history
- `fenghua-backend/src/companies/companies.module.ts` - **MODIFY** - Registered new service and controller
- `fenghua-backend/src/companies/customer-product-interaction-history.service.spec.ts` - **NEW** - Unit tests for backend service
- `fenghua-frontend/src/customers/components/CustomerProductInteractionHistory.tsx` - **NEW** - Frontend component for customer-product interaction history
- `fenghua-frontend/src/customers/CustomerProductInteractionHistoryPage.tsx` - **NEW** - Frontend page for customer-product interaction history
- `fenghua-frontend/src/customers/components/CustomerProductAssociation.tsx` - **MODIFY** - Enabled "æŸ¥çœ‹äº’åŠ¨å†å²" button
- `fenghua-frontend/src/App.tsx` - **MODIFY** - Added route for customer-product interaction history page
- `fenghua-frontend/src/customers/components/CustomerProductInteractionHistory.test.tsx` - **NEW** - Unit tests for frontend component

