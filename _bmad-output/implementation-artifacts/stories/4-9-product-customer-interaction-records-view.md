# Story 4.9: äº§å“ä¸å®¢æˆ·äº’åŠ¨è®°å½•æŸ¥çœ‹ï¼ˆæŒ‰è§’è‰²ï¼‰

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a **å‰ç«¯ä¸“å‘˜/åç«¯ä¸“å‘˜/æ€»ç›‘/ç®¡ç†å‘˜**,
I want **æŸ¥çœ‹æŸä¸ªäº§å“ä¸å®¢æˆ·çš„æ‰€æœ‰äº’åŠ¨è®°å½•**,
so that **æˆ‘å¯ä»¥äº†è§£è¯¥äº§å“ä¸å®¢æˆ·çš„ä¸šåŠ¡å¾€æ¥æƒ…å†µ**.

## Acceptance Criteria

**AC1: å‰ç«¯ä¸“å‘˜æŸ¥çœ‹äº§å“ä¸é‡‡è´­å•†äº’åŠ¨è®°å½•**
- **Given** å‰ç«¯ä¸“å‘˜å·²ç™»å½•ç³»ç»Ÿ
- **When** å‰ç«¯ä¸“å‘˜åœ¨äº§å“è¯¦æƒ…é¡µé¢é€‰æ‹©æŸä¸ªé‡‡è´­å•†ï¼Œç‚¹å‡»"æŸ¥çœ‹äº’åŠ¨è®°å½•"
- **Then** ç³»ç»Ÿæ˜¾ç¤ºè¯¥äº§å“ä¸è¯¥é‡‡è´­å•†çš„æ‰€æœ‰äº’åŠ¨è®°å½•
- **And** äº’åŠ¨è®°å½•æŒ‰æ—¶é—´é¡ºåºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
- **And** æ¯æ¡äº’åŠ¨è®°å½•æ˜¾ç¤ºï¼šäº’åŠ¨ç±»å‹ã€äº’åŠ¨æ—¶é—´ã€äº’åŠ¨æè¿°ã€åˆ›å»ºè€…ç­‰
- **And** ç³»ç»Ÿåªæ˜¾ç¤ºå‰ç«¯ä¸“å‘˜æœ‰æƒé™æŸ¥çœ‹çš„äº’åŠ¨è®°å½•ï¼ˆåªæ˜¾ç¤ºé‡‡è´­å•†ç±»å‹çš„å®¢æˆ·ï¼‰

**AC2: åç«¯ä¸“å‘˜æŸ¥çœ‹äº§å“ä¸ä¾›åº”å•†äº’åŠ¨è®°å½•**
- **Given** åç«¯ä¸“å‘˜å·²ç™»å½•ç³»ç»Ÿ
- **When** åç«¯ä¸“å‘˜åœ¨äº§å“è¯¦æƒ…é¡µé¢é€‰æ‹©æŸä¸ªä¾›åº”å•†ï¼Œç‚¹å‡»"æŸ¥çœ‹äº’åŠ¨è®°å½•"
- **Then** ç³»ç»Ÿæ˜¾ç¤ºè¯¥äº§å“ä¸è¯¥ä¾›åº”å•†çš„æ‰€æœ‰äº’åŠ¨è®°å½•
- **And** äº’åŠ¨è®°å½•æŒ‰æ—¶é—´é¡ºåºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
- **And** æ¯æ¡äº’åŠ¨è®°å½•æ˜¾ç¤ºï¼šäº’åŠ¨ç±»å‹ã€äº’åŠ¨æ—¶é—´ã€äº’åŠ¨æè¿°ã€åˆ›å»ºè€…ç­‰
- **And** ç³»ç»Ÿåªæ˜¾ç¤ºåç«¯ä¸“å‘˜æœ‰æƒé™æŸ¥çœ‹çš„äº’åŠ¨è®°å½•ï¼ˆåªæ˜¾ç¤ºä¾›åº”å•†ç±»å‹çš„å®¢æˆ·ï¼‰

**AC3: æ€»ç›‘/ç®¡ç†å‘˜æŸ¥çœ‹äº§å“ä¸å®¢æˆ·äº’åŠ¨è®°å½•**
- **Given** æ€»ç›‘æˆ–ç®¡ç†å‘˜å·²ç™»å½•ç³»ç»Ÿ
- **When** æ€»ç›‘æˆ–ç®¡ç†å‘˜åœ¨äº§å“è¯¦æƒ…é¡µé¢é€‰æ‹©æŸä¸ªå®¢æˆ·ï¼Œç‚¹å‡»"æŸ¥çœ‹äº’åŠ¨è®°å½•"
- **Then** ç³»ç»Ÿæ˜¾ç¤ºè¯¥äº§å“ä¸è¯¥å®¢æˆ·çš„æ‰€æœ‰äº’åŠ¨è®°å½•
- **And** äº’åŠ¨è®°å½•æŒ‰æ—¶é—´é¡ºåºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
- **And** ç³»ç»Ÿæ˜¾ç¤ºæ‰€æœ‰ç±»å‹çš„äº’åŠ¨è®°å½•ï¼ˆé‡‡è´­å•†å’Œä¾›åº”å•†çš„äº’åŠ¨ï¼‰

**AC4: é™„ä»¶æ˜¾ç¤ºå’ŒæŸ¥çœ‹**
- **Given** ç”¨æˆ·æŸ¥çœ‹äº§å“ä¸å®¢æˆ·çš„äº’åŠ¨è®°å½•
- **When** äº’åŠ¨è®°å½•åŒ…å«é™„ä»¶ï¼ˆç…§ç‰‡ã€æ–‡æ¡£ç­‰ï¼‰
- **Then** ç³»ç»Ÿåœ¨äº’åŠ¨è®°å½•ä¸­æ˜¾ç¤ºé™„ä»¶å›¾æ ‡æˆ–ç¼©ç•¥å›¾
- **And** ç”¨æˆ·å¯ä»¥ç‚¹å‡»é™„ä»¶æŸ¥çœ‹æˆ–ä¸‹è½½
- **And** å¦‚æœæ˜¯ç…§ç‰‡ï¼Œç”¨æˆ·å¯ä»¥æŸ¥çœ‹å¤§å›¾ï¼ˆæ”¯æŒå¤šå¼ ç…§ç‰‡åˆ‡æ¢ï¼‰
- **And** é™„ä»¶æ˜¾ç¤ºåœ¨äº’åŠ¨è®°å½•çš„é™„ä»¶åŒºåŸŸ

**AC5: åˆ†é¡µå’Œæ»šåŠ¨åŠ è½½**
- **Given** ç”¨æˆ·æŸ¥çœ‹äº§å“ä¸å®¢æˆ·çš„äº’åŠ¨è®°å½•
- **When** äº’åŠ¨è®°å½•è¾ƒå¤šï¼ˆ> 20 æ¡ï¼‰
- **Then** ç³»ç»Ÿä½¿ç”¨åˆ†é¡µæˆ–æ»šåŠ¨åŠ è½½æ˜¾ç¤ºäº’åŠ¨è®°å½•
- **And** ç³»ç»Ÿæ˜¾ç¤ºäº’åŠ¨è®°å½•æ€»æ•°
- **And** ç³»ç»Ÿæ”¯æŒæŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰æˆ–æœ€æ—§çš„åœ¨å‰ï¼Œç”¨æˆ·å¯é€‰æ‹©ï¼‰

**AC6: ç©ºçŠ¶æ€å¤„ç†**
- **Given** ç”¨æˆ·æŸ¥çœ‹äº§å“ä¸å®¢æˆ·çš„äº’åŠ¨è®°å½•
- **When** æ²¡æœ‰äº’åŠ¨è®°å½•
- **Then** ç³»ç»Ÿæ˜¾ç¤ºç©ºçŠ¶æ€"è¯¥äº§å“ä¸è¯¥å®¢æˆ·å°šæœªæœ‰ä»»ä½•äº’åŠ¨è®°å½•"
- **And** ç³»ç»Ÿæä¾›"è®°å½•æ–°äº’åŠ¨"æŒ‰é’®ï¼Œç”¨æˆ·å¯ä»¥å¿«é€Ÿè®°å½•äº’åŠ¨
- **And** ç©ºçŠ¶æ€æ˜¾ç¤ºå‹å¥½çš„æç¤ºä¿¡æ¯

## Tasks / Subtasks

- [x] Task 1: éªŒè¯å’Œå®Œå–„åç«¯ API ç«¯ç‚¹ (AC: #1, #2, #3, #5)
  - [x] éªŒè¯ `GET /api/products/:productId/interactions?customerId=:customerId` ç«¯ç‚¹å·²å®ç°
  - [x] éªŒè¯åŸºäºè§’è‰²çš„æ•°æ®è¿‡æ»¤å·²å®ç°ï¼ˆå‰ç«¯ä¸“å‘˜åªçœ‹åˆ°é‡‡è´­å•†ï¼Œåç«¯ä¸“å‘˜åªçœ‹åˆ°ä¾›åº”å•†ï¼‰
  - [x] éªŒè¯åˆ†é¡µåŠŸèƒ½å·²å®ç°ï¼ˆpage, limit å‚æ•°ï¼‰
  - [x] **MEDIUM**: å®ç°æ’åºåŠŸèƒ½ï¼ˆå¦‚æœéœ€è¦ï¼Œæ·»åŠ  sortOrder å‚æ•°ï¼‰
    - [x] åœ¨ `ProductCustomerInteractionQueryDto` ä¸­æ·»åŠ  `sortOrder?: 'asc' | 'desc'` å­—æ®µ
    - [x] åœ¨ `ProductCustomerInteractionHistoryService.getProductCustomerInteractions` æ–¹æ³•ä¸­å¤„ç† `sortOrder` å‚æ•°
    - [x] æ›´æ–° SQL æŸ¥è¯¢çš„ `ORDER BY` å­å¥ï¼š`ORDER BY pci.interaction_date ${sortOrder === 'asc' ? 'ASC' : 'DESC'}`
    - [x] é»˜è®¤å€¼ä¸º `'desc'`ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
  - [x] éªŒè¯é™„ä»¶æ•°æ®å·²åŒ…å«åœ¨å“åº”ä¸­ï¼ˆattachments æ•°ç»„ï¼‰
  - [x] éªŒè¯äº§å“ä¸å­˜åœ¨æ—¶è¿”å› 404
  - [x] éªŒè¯å®¢æˆ·ä¸å­˜åœ¨æ—¶è¿”å› 404
  - [x] éªŒè¯æƒé™æ£€æŸ¥å¤±è´¥æ—¶è¿”å› 403

- [x] Task 2: éªŒè¯å’Œå®Œå–„å‰ç«¯ ProductCustomerInteractionHistory ç»„ä»¶ (AC: #1, #2, #3, #4, #5, #6)
  - [x] éªŒè¯ç»„ä»¶å·²å®ç°å¹¶é›†æˆåˆ° `ProductDetailPanel` æˆ– `ProductCustomerAssociation`
  - [x] éªŒè¯äº’åŠ¨è®°å½•æŒ‰æ—¶é—´é¡ºåºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
  - [x] éªŒè¯æ¯æ¡äº’åŠ¨è®°å½•æ˜¾ç¤ºï¼šäº’åŠ¨ç±»å‹ã€äº’åŠ¨æ—¶é—´ã€äº’åŠ¨æè¿°ã€åˆ›å»ºè€…
  - [x] **CRITICAL**: ä¿®å¤é™„ä»¶æ˜¾ç¤ºåŠŸèƒ½ï¼Œå¤ç”¨ Story 4.8 çš„å®ç°
    - [x] ç…§ç‰‡é™„ä»¶ï¼šæ˜¾ç¤ºç¼©ç•¥å›¾ï¼ˆ64x64px æ¡Œé¢ç«¯ï¼Œ48x48px ç§»åŠ¨ç«¯ï¼‰ï¼Œç‚¹å‡»æŸ¥çœ‹å¤§å›¾ï¼ˆä½¿ç”¨ `PhotoPreview` ç»„ä»¶ï¼‰
    - [x] æ–‡æ¡£é™„ä»¶ï¼šä½¿ç”¨ `getFileIcon` æ˜¾ç¤ºå›¾æ ‡ï¼Œä½¿ç”¨ `formatFileSize` æ ¼å¼åŒ–æ–‡ä»¶å¤§å°ï¼Œç‚¹å‡»ä¸‹è½½
    - [x] å¤ç”¨ `CustomerTimeline` ç»„ä»¶çš„é™„ä»¶æ˜¾ç¤ºé€»è¾‘ï¼ˆå‚è€ƒ `fenghua-frontend/src/customers/components/CustomerTimeline.tsx`ï¼‰
    - [x] æ·»åŠ ç…§ç‰‡é¢„è§ˆçŠ¶æ€ç®¡ç†ï¼ˆ`selectedPhotoIndex`, `photoAttachments`ï¼‰
    - [x] é›†æˆ `PhotoPreview` ç»„ä»¶ï¼ˆä» `fenghua-frontend/src/attachments/components/PhotoPreview.tsx` å¯¼å…¥ï¼‰
    - [x] ä½¿ç”¨ `getFileIcon` å’Œ `formatFileSize` å·¥å…·å‡½æ•°ï¼ˆä» `attachments.service` å¯¼å…¥ `formatFileSize`ï¼Œå¤åˆ¶ `getFileIcon`ï¼‰
  - [x] éªŒè¯åˆ†é¡µåŠŸèƒ½ï¼ˆå¦‚æœè®°å½• > 20 æ¡ï¼‰
  - [x] **MEDIUM**: å®ç°æ’åºåŠŸèƒ½ï¼ˆç”¨æˆ·å¯é€‰æ‹©æœ€æ–°çš„åœ¨å‰æˆ–æœ€æ—§çš„åœ¨å‰ï¼‰
    - [x] æ·»åŠ æ’åºé€‰æ‹©å™¨ï¼ˆåˆ‡æ¢æŒ‰é’®ï¼‰
    - [x] å°† `sortOrder` å‚æ•°ä¼ é€’ç»™åç«¯ API
    - [x] æ›´æ–° React Query ç¼“å­˜é”®ä»¥åŒ…å« `sortOrder`
  - [x] éªŒè¯ç©ºçŠ¶æ€æ˜¾ç¤ºï¼ˆ"è¯¥äº§å“ä¸è¯¥å®¢æˆ·å°šæœªæœ‰ä»»ä½•äº’åŠ¨è®°å½•"ï¼‰
  - [x] **HIGH**: ä¿®å¤"è®°å½•æ–°äº’åŠ¨"æŒ‰é’®ï¼ˆé“¾æ¥åˆ°äº’åŠ¨è®°å½•åˆ›å»ºé¡µé¢ï¼‰
    - [x] æŒ‰é’®é“¾æ¥åˆ° `/interactions/create?productId=${productId}&customerId=${customerId}`
    - [x] **HIGH**: æŒ‰é’®æ ·å¼æ”¹ä¸º `variant="primary"`ï¼ˆå½“å‰ä¸º `secondary`ï¼‰
    - [x] æŒ‰é’®æ–‡æœ¬ï¼š"è®°å½•æ–°äº’åŠ¨"
    - [x] **HIGH**: ç¡®ä¿ `InteractionCreateForm` èƒ½å¤Ÿæ¥æ”¶å¹¶é¢„å¡«å……äº§å“å’Œå®¢æˆ·ä¿¡æ¯
      - [x] æ›´æ–° `InteractionCreatePage` ä» URL å‚æ•°è·å– `productId`
      - [x] æ›´æ–° `InteractionCreateForm` æ·»åŠ  `prefillProductId` prop
      - [x] åœ¨ `InteractionCreateForm` ä¸­æ·»åŠ  `useEffect` åŠ è½½å¹¶è®¾ç½®äº§å“ä¿¡æ¯ï¼ˆç±»ä¼¼ `prefillCustomerId` çš„å¤„ç†ï¼‰
  - [x] **MEDIUM**: ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯æ¶ˆæ¯å¸¸é‡
    - [x] åœ¨ `error-messages.ts` ä¸­æ·»åŠ  `PRODUCT_INTERACTION_ERRORS` éƒ¨åˆ†
    - [x] æ›¿æ¢æ‰€æœ‰ç¡¬ç¼–ç çš„é”™è¯¯æ¶ˆæ¯ä¸ºå¸¸é‡
  - [x] **LOW**: æ·»åŠ  JSDoc æ³¨é‡Šåˆ°æ‰€æœ‰å‡½æ•°

- [x] Task 3: ä¼˜åŒ–é™„ä»¶æ˜¾ç¤ºå’Œäº¤äº’ (AC: #4) - **CRITICAL FIX**
  - [x] **å¿…é¡»ä¿®å¤**: å½“å‰å®ç°è¿‡äºç®€å•ï¼Œéœ€è¦å®Œå…¨å¤ç”¨ Story 4.8 çš„é™„ä»¶æ˜¾ç¤ºé€»è¾‘
    - [x] ç…§ç‰‡é™„ä»¶ï¼šæ˜¾ç¤ºç¼©ç•¥å›¾ï¼ˆ64x64px æ¡Œé¢ç«¯ï¼Œ48x48px ç§»åŠ¨ç«¯ï¼‰ï¼Œç‚¹å‡»æŸ¥çœ‹å¤§å›¾
      - [x] ä½¿ç”¨ `<img>` æ ‡ç­¾æ˜¾ç¤ºç¼©ç•¥å›¾ï¼Œ`onError` å¤„ç†åŠ è½½å¤±è´¥
      - [x] ç‚¹å‡»ç¼©ç•¥å›¾æ‰“å¼€ `PhotoPreview` ç»„ä»¶
      - [x] æ”¯æŒå¤šå¼ ç…§ç‰‡åˆ‡æ¢ï¼ˆä¸Šä¸€å¼ /ä¸‹ä¸€å¼ ï¼Œé”®ç›˜å¯¼èˆªï¼šâ†/â†’ï¼‰
    - [x] æ–‡æ¡£é™„ä»¶ï¼šæ˜¾ç¤ºå›¾æ ‡å’Œæ–‡ä»¶åï¼Œç‚¹å‡»ä¸‹è½½
      - [x] ä½¿ç”¨ `getFileIcon` å‡½æ•°æ ¹æ®æ–‡ä»¶ç±»å‹æ˜¾ç¤ºå›¾æ ‡ï¼ˆPDF: ğŸ“„, Word: ğŸ“, Excel: ğŸ“Š, å…¶ä»–: ğŸ“ï¼‰
      - [x] ä½¿ç”¨ `formatFileSize` å‡½æ•°æ ¼å¼åŒ–æ–‡ä»¶å¤§å°ï¼ˆå¦‚ "1.2 MB"ï¼‰
      - [x] ä½¿ç”¨ `<a>` æ ‡ç­¾çš„ `download` å±æ€§å®ç°ä¸‹è½½
      - [x] ä½¿ç”¨ `handleDocumentClick` å‡½æ•°å®‰å…¨å¤„ç†ä¸‹è½½ï¼ˆé˜²æ­¢ tabnabbing æ”»å‡»ï¼‰
    - [x] å¤ç”¨ `PhotoPreview` ç»„ä»¶ï¼ˆä» `fenghua-frontend/src/attachments/components/PhotoPreview.tsx` å¯¼å…¥ï¼‰
    - [x] å¤ç”¨ `getFileIcon` å’Œ `formatFileSize` å·¥å…·å‡½æ•°
      - [x] ä» `CustomerTimeline` ç»„ä»¶å¤åˆ¶ `getFileIcon` å‡½æ•°
      - [x] ä» `attachments.service` å¯¼å…¥ `formatFileSize`ï¼ˆå·²å¯ç”¨ï¼‰
    - [x] å‚è€ƒå®ç°ï¼š`fenghua-frontend/src/customers/components/CustomerTimeline.tsx` çš„ `TimelineInteractionCard` ç»„ä»¶ï¼ˆç¬¬ 292-356 è¡Œï¼‰
  - [x] ç¡®ä¿é™„ä»¶æ˜¾ç¤ºå¸ƒå±€ä¼˜åŒ–ï¼ˆç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯ï¼‰
  - [x] æ·»åŠ ç…§ç‰‡é¢„è§ˆçŠ¶æ€ç®¡ç†ï¼š
    - [x] `selectedPhotoIndex: number | null` - å½“å‰é¢„è§ˆçš„ç…§ç‰‡ç´¢å¼•
    - [x] `photoAttachments: Attachment[]` - å½“å‰äº’åŠ¨è®°å½•çš„æ‰€æœ‰ç…§ç‰‡é™„ä»¶æ•°ç»„
    - [x] `handlePhotoClick` - å¤„ç†ç…§ç‰‡ç‚¹å‡»ï¼Œæ‰“å¼€é¢„è§ˆ
    - [x] `handlePhotoNext` - åˆ‡æ¢åˆ°ä¸‹ä¸€å¼ ç…§ç‰‡
    - [x] `handlePhotoPrevious` - åˆ‡æ¢åˆ°ä¸Šä¸€å¼ ç…§ç‰‡

- [x] Task 4: ä¼˜åŒ–äº’åŠ¨è®°å½•å¡ç‰‡æ˜¾ç¤º (AC: #1, #2, #3)
  - [x] ç¡®ä¿äº’åŠ¨ç±»å‹æ˜¾ç¤ºä¸­æ–‡æ ‡ç­¾ï¼ˆä½¿ç”¨ INTERACTION_TYPE_LABELSï¼‰
  - [x] ç¡®ä¿äº’åŠ¨æ—¶é—´æ ¼å¼åŒ–æ˜¾ç¤ºï¼ˆä½¿ç”¨ `toLocaleString`ï¼‰
  - [x] ç¡®ä¿åˆ›å»ºè€…ä¿¡æ¯æ˜¾ç¤ºï¼ˆåˆ›å»ºè€…å§“åæˆ–é‚®ç®±ï¼‰
  - [x] ä¼˜åŒ–å¡ç‰‡å¸ƒå±€ï¼ˆç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯ï¼‰

- [x] Task 5: é›†æˆåˆ°äº§å“è¯¦æƒ…é¡µé¢ (AC: #1, #2, #3)
  - [x] éªŒè¯ `ProductCustomerAssociation` ç»„ä»¶ä¸­çš„"æŸ¥çœ‹äº’åŠ¨è®°å½•"æŒ‰é’®å·²å®ç°
  - [x] éªŒè¯æŒ‰é’®é“¾æ¥åˆ°æ­£ç¡®çš„è·¯ç”±ï¼ˆ`/products/:productId/interactions?customerId=:customerId`ï¼‰
  - [x] éªŒè¯ `ProductCustomerInteractionHistoryPage` é¡µé¢å·²å®ç°
  - [x] éªŒè¯é¡µé¢æ˜¾ç¤ºäº§å“åç§°å’Œå®¢æˆ·åç§°
  - [x] éªŒè¯é¡µé¢é›†æˆ `ProductCustomerInteractionHistory` ç»„ä»¶

- [ ] Task 6: æ·»åŠ æµ‹è¯•ç”¨ä¾‹ (AC: #1, #2, #3, #4, #5, #6)
  - [ ] æ·»åŠ å‰ç«¯ç»„ä»¶æµ‹è¯•ï¼ˆProductCustomerInteractionHistory ç»„ä»¶ï¼‰
  - [ ] æµ‹è¯•åŸºäºè§’è‰²çš„æ•°æ®è¿‡æ»¤ï¼ˆå‰ç«¯ä¸“å‘˜åªçœ‹åˆ°é‡‡è´­å•†ï¼Œåç«¯ä¸“å‘˜åªçœ‹åˆ°ä¾›åº”å•†ï¼‰
  - [ ] æµ‹è¯•åˆ†é¡µåŠŸèƒ½
  - [ ] æµ‹è¯•æ’åºåŠŸèƒ½ï¼ˆå¦‚æœéœ€è¦ï¼‰
  - [ ] æµ‹è¯•é™„ä»¶æ˜¾ç¤ºå’Œäº¤äº’
  - [ ] æµ‹è¯•ç©ºçŠ¶æ€æ˜¾ç¤º
  - [ ] æ·»åŠ åç«¯ API æµ‹è¯•ï¼ˆProductCustomerInteractionHistoryController å’Œ ProductCustomerInteractionHistoryServiceï¼‰

## Technical Notes

### ç°æœ‰å®ç°åˆ†æ

**Story 2.5 å·²å®Œæˆçš„å·¥ä½œï¼š**
- âœ… åç«¯ `ProductCustomerInteractionHistoryService` å·²å®ç°
- âœ… åç«¯ `ProductCustomerInteractionHistoryController` å·²å®ç°
- âœ… åç«¯ API ç«¯ç‚¹ï¼š`GET /api/products/:productId/interactions?customerId=:customerId`
- âœ… å‰ç«¯ `ProductCustomerInteractionHistory` ç»„ä»¶å·²å®ç°
- âœ… å‰ç«¯ `ProductCustomerInteractionHistoryPage` é¡µé¢å·²å®ç°
- âœ… è·¯ç”±å·²é…ç½®ï¼š`/products/:productId/interactions`
- âœ… `ProductCustomerAssociation` ç»„ä»¶ä¸­å·²æœ‰"æŸ¥çœ‹äº’åŠ¨è®°å½•"æŒ‰é’®

**éœ€è¦éªŒè¯å’Œå®Œå–„çš„å·¥ä½œï¼š**
- âš ï¸ **CRITICAL**: é™„ä»¶æ˜¾ç¤ºæœªå¤ç”¨ Story 4.8 çš„å®ç°ï¼ˆç…§ç‰‡é¢„è§ˆã€æ–‡æ¡£ä¸‹è½½é€»è¾‘ï¼‰
- âš ï¸ **HIGH**: InteractionCreateForm ä¸æ”¯æŒ productId é¢„å¡«å……ï¼ˆä»…æ”¯æŒ customerIdï¼‰
- âš ï¸ **HIGH**: ç©ºçŠ¶æ€æŒ‰é’®æ ·å¼ä¸ç¬¦åˆè¦æ±‚ï¼ˆå½“å‰ä¸º secondaryï¼Œåº”ä¸º primaryï¼‰
- âš ï¸ **MEDIUM**: åç«¯ API å¯èƒ½ä¸æ”¯æŒæ’åºåŠŸèƒ½ï¼ˆsortOrder å‚æ•°ï¼‰
- âš ï¸ **MEDIUM**: å‰ç«¯ç»„ä»¶æœªä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯æ¶ˆæ¯å¸¸é‡
- âš ï¸ **LOW**: æ–‡ä»¶å¤§å°æ ¼å¼åŒ–æœªä½¿ç”¨ formatFileSize å·¥å…·å‡½æ•°
- âš ï¸ **LOW**: ç¼ºå°‘ JSDoc æ³¨é‡Š

### åç«¯ API

**ç«¯ç‚¹ï¼š** `GET /api/products/:productId/interactions?customerId=:customerId`

**æŸ¥è¯¢å‚æ•°ï¼š**
- `customerId` (string, required): å®¢æˆ· ID
- `page` (number, default: 1): é¡µç 
- `limit` (number, default: 20, max: 100): æ¯é¡µè®°å½•æ•°
- `sortOrder` (optional, 'asc' | 'desc', default: 'desc'): æ’åºé¡ºåºï¼ˆ**éœ€è¦å®ç°**ï¼‰

**å“åº”æ ¼å¼ï¼š**
```typescript
{
  interactions: ProductCustomerInteractionDto[];
  total: number;
}

interface ProductCustomerInteractionDto {
  id: string;
  interactionType: string;
  interactionDate: string;
  description?: string;
  status?: string;
  additionalInfo?: Record<string, unknown>;
  createdAt: string;
  createdBy?: string;
  creatorEmail?: string;
  creatorFirstName?: string;
  creatorLastName?: string;
  attachments: FileAttachmentDto[];
}

interface FileAttachmentDto {
  id: string;
  fileName: string;
  fileUrl: string;
  fileType: string;
  fileSize: number;
  mimeType?: string;
}
```

**å®ç°ä½ç½®ï¼š**
- Controller: `fenghua-backend/src/products/product-customer-interaction-history.controller.ts`
- Service: `fenghua-backend/src/products/product-customer-interaction-history.service.ts`
- DTO: `fenghua-backend/src/products/dto/product-customer-interaction-history.dto.ts`

### å‰ç«¯ç»„ä»¶

**ç»„ä»¶ï¼š** `ProductCustomerInteractionHistory`

**ä½ç½®ï¼š** `fenghua-frontend/src/products/components/ProductCustomerInteractionHistory.tsx`

**é¡µé¢ï¼š** `ProductCustomerInteractionHistoryPage`

**ä½ç½®ï¼š** `fenghua-frontend/src/products/ProductCustomerInteractionHistoryPage.tsx`

**é›†æˆä½ç½®ï¼š** 
- `ProductCustomerAssociation` ç»„ä»¶ä¸­çš„"æŸ¥çœ‹äº’åŠ¨è®°å½•"æŒ‰é’®
- è·¯ç”±ï¼š`/products/:productId/interactions?customerId=:customerId`

**åŠŸèƒ½ï¼š**
- æ˜¾ç¤ºäº§å“ä¸å®¢æˆ·çš„äº’åŠ¨è®°å½•ï¼ˆé™å®šäº§å“å’Œå®¢æˆ·ï¼‰
- æ”¯æŒåŸºäºè§’è‰²çš„æ•°æ®è¿‡æ»¤
- æ”¯æŒåˆ†é¡µ
- æ”¯æŒé™„ä»¶æ˜¾ç¤ºå’ŒæŸ¥çœ‹
- æ”¯æŒç©ºçŠ¶æ€æ˜¾ç¤º

### åŸºäºè§’è‰²çš„æ•°æ®è¿‡æ»¤

**å‰ç«¯ä¸“å‘˜ï¼š**
- åªèƒ½æŸ¥çœ‹é‡‡è´­å•†ï¼ˆBUYERï¼‰ç±»å‹çš„å®¢æˆ·çš„äº’åŠ¨è®°å½•
- åªèƒ½æŸ¥çœ‹å‰ç«¯ä¸“å‘˜çš„äº’åŠ¨ç±»å‹ï¼ˆåˆæ­¥æ¥è§¦ã€äº§å“è¯¢ä»·ã€æŠ¥ä»·ç­‰ï¼‰

**åç«¯ä¸“å‘˜ï¼š**
- åªèƒ½æŸ¥çœ‹ä¾›åº”å•†ï¼ˆSUPPLIERï¼‰ç±»å‹çš„å®¢æˆ·çš„äº’åŠ¨è®°å½•
- åªèƒ½æŸ¥çœ‹åç«¯ä¸“å‘˜çš„äº’åŠ¨ç±»å‹ï¼ˆè¯¢ä»·äº§å“ã€æ¥æ”¶æŠ¥ä»·ã€ç”Ÿäº§è¿›åº¦è·Ÿè¿›ç­‰ï¼‰

**æ€»ç›‘/ç®¡ç†å‘˜ï¼š**
- å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç±»å‹çš„å®¢æˆ·çš„äº’åŠ¨è®°å½•
- å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç±»å‹çš„äº’åŠ¨è®°å½•

### é™„ä»¶æ˜¾ç¤º

**ç…§ç‰‡é™„ä»¶ï¼š**
- æ˜¾ç¤ºç¼©ç•¥å›¾ï¼ˆä½¿ç”¨ `fileUrl` ä½œä¸ºç¼©ç•¥å›¾æºï¼Œå°ºå¯¸ï¼š64x64px æ¡Œé¢ç«¯ï¼Œ48x48px ç§»åŠ¨ç«¯ï¼‰
- ç‚¹å‡»ç¼©ç•¥å›¾æŸ¥çœ‹å¤§å›¾ï¼ˆå¤ç”¨ Story 4.5 çš„ `PhotoPreview` ç»„ä»¶ï¼‰
- æ”¯æŒå¤šå¼ ç…§ç‰‡åˆ‡æ¢ï¼ˆä¸Šä¸€å¼ /ä¸‹ä¸€å¼ ï¼Œé”®ç›˜å¯¼èˆªï¼šâ†/â†’ï¼‰

**æ–‡æ¡£é™„ä»¶ï¼š**
- æ ¹æ®æ–‡ä»¶ç±»å‹æ˜¾ç¤ºå¯¹åº”å›¾æ ‡ï¼š
  - PDF: ğŸ“„
  - Word (.docx, .doc): ğŸ“
  - Excel (.xlsx, .xls): ğŸ“Š
  - å…¶ä»–: ğŸ“
- æ˜¾ç¤ºæ–‡ä»¶åå’Œæ–‡ä»¶å¤§å°ï¼ˆæ ¼å¼åŒ–æ˜¾ç¤ºï¼Œå¦‚ "1.2 MB"ï¼‰
- ç‚¹å‡»é™„ä»¶ç›´æ¥ä¸‹è½½ï¼ˆä½¿ç”¨ `<a>` æ ‡ç­¾çš„ `download` å±æ€§ï¼‰

**å¤ç”¨ Story 4.8 çš„å®ç°ï¼ˆCRITICAL - å¿…é¡»ä¿®å¤ï¼‰ï¼š**
- **å½“å‰é—®é¢˜**: `ProductCustomerInteractionHistory` ç»„ä»¶çš„é™„ä»¶æ˜¾ç¤ºè¿‡äºç®€å•ï¼Œæœªå¤ç”¨ Story 4.8 çš„å®ç°
- **å¿…é¡»ä¿®å¤**: å®Œå…¨å¤ç”¨ `CustomerTimeline` ç»„ä»¶çš„é™„ä»¶æ˜¾ç¤ºé€»è¾‘
- å¤ç”¨ `PhotoPreview` ç»„ä»¶ï¼ˆä» `fenghua-frontend/src/attachments/components/PhotoPreview.tsx` å¯¼å…¥ï¼‰
- å¤ç”¨ `getFileIcon` å’Œ `formatFileSize` å·¥å…·å‡½æ•°
  - `getFileIcon`: æ ¹æ®æ–‡ä»¶ç±»å‹è¿”å›å›¾æ ‡ï¼ˆPDF: ğŸ“„, Word: ğŸ“, Excel: ğŸ“Š, ç…§ç‰‡: ğŸ–¼ï¸, å…¶ä»–: ğŸ“ï¼‰
  - `formatFileSize`: æ ¼å¼åŒ–æ–‡ä»¶å¤§å°ï¼ˆå¦‚ "1.2 MB", "512 KB"ï¼‰
- å¤ç”¨é™„ä»¶æ˜¾ç¤ºå¸ƒå±€å’Œæ ·å¼
- **å‚è€ƒå®ç°**: `fenghua-frontend/src/customers/components/CustomerTimeline.tsx` çš„ `TimelineInteractionCard` ç»„ä»¶ï¼ˆç¬¬ 292-356 è¡Œï¼‰

### æ€§èƒ½ä¼˜åŒ–

**æ•°æ®åº“ç´¢å¼•ï¼š**
- `idx_interactions_product_customer_date` - æŒ‰äº§å“+å®¢æˆ·+æ—¶é—´æŸ¥è¯¢ï¼ˆå·²å­˜åœ¨ï¼‰
- `idx_interactions_product_customer` - æŒ‰äº§å“å’Œå®¢æˆ·æŸ¥è¯¢ï¼ˆå·²å­˜åœ¨ï¼‰

**æŸ¥è¯¢ä¼˜åŒ–ï¼š**
- ä½¿ç”¨åˆ†é¡µé™åˆ¶è¿”å›è®°å½•æ•°ï¼ˆé»˜è®¤ 20 æ¡ï¼Œæœ€å¤§ 100 æ¡ï¼‰
- ä½¿ç”¨èšåˆæŸ¥è¯¢ä¸€æ¬¡æ€§è·å–é™„ä»¶æ•°æ®ï¼ˆé¿å… N+1 æŸ¥è¯¢ï¼‰
- ä½¿ç”¨ React Query ç¼“å­˜æŸ¥è¯¢ç»“æœï¼ˆ5 åˆ†é’Ÿç¼“å­˜ï¼‰

## Code Examples

### å‰ç«¯ç»„ä»¶ä½¿ç”¨ç¤ºä¾‹

```tsx
// ProductCustomerAssociation.tsx
import { Link } from 'react-router-dom';

export const ProductCustomerAssociation: React.FC<ProductCustomerAssociationProps> = ({
  productId,
}) => {
  return (
    <div>
      {/* å®¢æˆ·åˆ—è¡¨ */}
      {customers.map((customer) => (
        <div key={customer.id}>
          <span>{customer.name}</span>
          <Link
            to={`/products/${productId}/interactions?customerId=${customer.id}`}
          >
            æŸ¥çœ‹äº’åŠ¨è®°å½•
          </Link>
        </div>
      ))}
    </div>
  );
};
```

### åç«¯ API è°ƒç”¨ç¤ºä¾‹

```typescript
// è·å–äº§å“å®¢æˆ·äº’åŠ¨å†å²
const response = await fetch(
  `/api/products/${productId}/interactions?customerId=${customerId}&page=1&limit=20`,
  {
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json',
    },
  }
);

const data = await response.json();
// data.interactions: äº’åŠ¨è®°å½•æ•°ç»„
// data.total: æ€»è®°å½•æ•°
```

### "è®°å½•æ–°äº’åŠ¨"æŒ‰é’®å®ç°ç¤ºä¾‹

```tsx
// ProductCustomerInteractionHistory.tsx
import { Link } from 'react-router-dom';

// åœ¨ç©ºçŠ¶æ€ä¸­æ˜¾ç¤ºæŒ‰é’®
{!data || data.interactions.length === 0 ? (
  <Card variant="outlined" className="p-monday-4">
    <div className="text-center py-monday-8">
      <div className="text-monday-4xl mb-monday-4 opacity-50">ğŸ“…</div>
      <p className="text-monday-base text-monday-text-secondary mb-monday-4">
        è¯¥äº§å“ä¸è¯¥å®¢æˆ·å°šæœªæœ‰ä»»ä½•äº’åŠ¨è®°å½•
      </p>
      <Link
        to={`/interactions/create?productId=${productId}&customerId=${customerId}`}
      >
        <Button variant="primary">è®°å½•æ–°äº’åŠ¨</Button> {/* HIGH: å¿…é¡»ä½¿ç”¨ primaryï¼Œä¸æ˜¯ secondary */}
      </Link>
    </div>
  </Card>
) : (
  // æ˜¾ç¤ºäº’åŠ¨è®°å½•åˆ—è¡¨
)}
```

### InteractionCreateForm æ”¯æŒ productId é¢„å¡«å……ï¼ˆHIGH - å¿…é¡»ä¿®å¤ï¼‰

```tsx
// InteractionCreatePage.tsx
import { useSearchParams } from 'react-router-dom';

export const InteractionCreatePage: React.FC = () => {
  const [searchParams] = useSearchParams();
  
  // ä» URL å‚æ•°è·å– customerId å’Œ productId
  const customerIdFromQuery = searchParams.get('customerId');
  const productIdFromQuery = searchParams.get('productId'); // NEW: æ·»åŠ  productId æ”¯æŒ
  const prefillCustomerId = customerIdFromQuery || undefined;
  const prefillProductId = productIdFromQuery || undefined; // NEW: æ·»åŠ  prefillProductId

  return (
    <MainLayout title="åˆ›å»ºäº’åŠ¨è®°å½•">
      <Card variant="default" className="w-full">
        <div className="p-monday-6">
          <h2 className="text-monday-2xl font-semibold text-monday-text mb-monday-6">
            åˆ›å»ºäº’åŠ¨è®°å½•
          </h2>
          <InteractionCreateForm 
            prefillCustomerId={prefillCustomerId}
            prefillProductId={prefillProductId} // NEW: ä¼ é€’ prefillProductId
          />
        </div>
      </Card>
    </MainLayout>
  );
};
```

```tsx
// InteractionCreateForm.tsx
interface InteractionCreateFormProps {
  onSuccess?: () => void;
  onCancel?: () => void;
  prefillCustomerId?: string;
  prefillProductId?: string; // NEW: æ·»åŠ  prefillProductId prop
}

export const InteractionCreateForm: React.FC<InteractionCreateFormProps> = ({
  onSuccess,
  onCancel,
  prefillCustomerId,
  prefillProductId, // NEW: æ·»åŠ  prefillProductId
}) => {
  // ... existing code ...

  // NEW: é¢„å¡«å……äº§å“ä¿¡æ¯ï¼ˆç±»ä¼¼ prefillCustomerId çš„å¤„ç†ï¼‰
  useEffect(() => {
    if (prefillProductId && !selectedProduct) {
      const loadProduct = async () => {
        try {
          const product = await productsService.getProduct(prefillProductId);
          // éªŒè¯äº§å“çŠ¶æ€ï¼ˆåªé¢„å¡«å…… active çŠ¶æ€çš„äº§å“ï¼‰
          if (product.status === 'active') {
            setSelectedProduct(product);
          } else {
            toast.warn('è¯¥äº§å“ä¸æ˜¯æ´»è·ƒçŠ¶æ€');
          }
        } catch (error) {
          console.error('Failed to load product', error);
          toast.error('åŠ è½½äº§å“ä¿¡æ¯å¤±è´¥');
        }
      };
      loadProduct();
    }
  }, [prefillProductId, selectedProduct]);

  // ... rest of component ...
};
```

### é™„ä»¶æ˜¾ç¤ºå®ç°ç¤ºä¾‹ï¼ˆCRITICAL - å¿…é¡»ä¿®å¤ï¼‰

```tsx
// ProductCustomerInteractionHistory.tsx
import { PhotoPreview } from '../../attachments/components/PhotoPreview';
import { Attachment } from '../../attachments/services/attachments.service';
import { useState } from 'react';

// ä» CustomerTimeline å¤åˆ¶ getFileIcon å’Œ formatFileSize å‡½æ•°
const getFileIcon = (attachment: FileAttachment): string => {
  if (attachment.fileType === 'photo' || attachment.mimeType?.startsWith('image/')) {
    return 'ğŸ–¼ï¸';
  }
  if (attachment.mimeType === 'application/pdf' || attachment.fileName.endsWith('.pdf')) {
    return 'ğŸ“„';
  }
  if (attachment.mimeType?.includes('word') || 
      attachment.fileName.endsWith('.docx') || 
      attachment.fileName.endsWith('.doc')) {
    return 'ğŸ“';
  }
  if (attachment.mimeType?.includes('excel') || 
      attachment.fileName.endsWith('.xlsx') || 
      attachment.fileName.endsWith('.xls')) {
    return 'ğŸ“Š';
  }
  return 'ğŸ“';
};

const formatFileSize = (bytes: number): string => {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  if (bytes < 1024 * 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
  return `${(bytes / (1024 * 1024 * 1024)).toFixed(1)} GB`;
};

const InteractionCard: React.FC<{ interaction: Interaction }> = ({ interaction }) => {
  const [selectedPhotoIndex, setSelectedPhotoIndex] = useState<number | null>(null);
  const [photoAttachments, setPhotoAttachments] = useState<Attachment[]>([]);

  /**
   * Handle document attachment click - download document safely
   * 
   * @param attachment - File attachment to download
   */
  const handleDocumentClick = (attachment: FileAttachment) => {
    const link = document.createElement('a');
    link.href = attachment.fileUrl;
    link.download = attachment.fileName;
    link.target = '_blank';
    link.rel = 'noopener noreferrer';
    link.click();
  };

  /**
   * Handle photo click - open photo preview
   * 
   * @param attachment - Photo attachment that was clicked
   * @param allAttachments - All attachments for the interaction
   */
  const handlePhotoClick = (attachment: FileAttachment, allAttachments: FileAttachment[]) => {
    const photos = allAttachments.filter(
      (a) => a.fileType === 'photo' || a.mimeType?.startsWith('image/'),
    );
    const index = photos.findIndex((a) => a.id === attachment.id);
    if (index !== -1) {
      const photoAttachmentsAsAttachment: Attachment[] = photos.map((p) => ({
        id: p.id,
        fileName: p.fileName,
        fileUrl: p.fileUrl,
        fileSize: p.fileSize,
        fileType: p.fileType,
        mimeType: p.mimeType,
        storageProvider: 'timeline',
        storageKey: p.id,
        createdAt: new Date(),
        createdBy: '',
      }));
      setPhotoAttachments(photoAttachmentsAsAttachment);
      setSelectedPhotoIndex(index);
    }
  };

  const handlePhotoNext = () => {
    if (selectedPhotoIndex !== null && selectedPhotoIndex < photoAttachments.length - 1) {
      setSelectedPhotoIndex(selectedPhotoIndex + 1);
    }
  };

  const handlePhotoPrevious = () => {
    if (selectedPhotoIndex !== null && selectedPhotoIndex > 0) {
      setSelectedPhotoIndex(selectedPhotoIndex - 1);
    }
  };

  return (
    <>
      <Card variant="outlined" className="p-monday-4">
        {/* ... interaction card content ... */}
        
        {/* é™„ä»¶åˆ—è¡¨ - å¤ç”¨ Story 4.8 çš„å®ç° */}
        {interaction.attachments && interaction.attachments.length > 0 && (
          <div className="mt-monday-3 pt-monday-3 border-t border-gray-200">
            <div className="text-monday-xs text-monday-text-secondary mb-monday-2">é™„ä»¶ï¼š</div>
            <div className="flex flex-wrap gap-monday-2">
              {interaction.attachments.map((attachment) => {
                const isPhoto =
                  attachment.fileType === 'photo' || attachment.mimeType?.startsWith('image/');

                if (isPhoto) {
                  // ç…§ç‰‡é™„ä»¶ï¼šæ˜¾ç¤ºç¼©ç•¥å›¾
                  return (
                    <button
                      key={attachment.id}
                      onClick={() => handlePhotoClick(attachment, interaction.attachments)}
                      className="relative w-16 h-16 rounded overflow-hidden border border-gray-200 hover:border-primary-blue transition-colors"
                      aria-label={`æŸ¥çœ‹ç…§ç‰‡: ${attachment.fileName}`}
                    >
                      <img
                        src={attachment.fileUrl}
                        alt={attachment.fileName}
                        className="w-full h-full object-cover"
                        onError={(e) => {
                          const target = e.currentTarget;
                          target.style.display = 'none';
                          const fallback = target.nextElementSibling as HTMLElement;
                          if (fallback) {
                            fallback.classList.remove('hidden');
                          }
                        }}
                      />
                      <span className="hidden absolute inset-0 flex items-center justify-center text-2xl bg-gray-100">
                        {getFileIcon(attachment)}
                      </span>
                    </button>
                  );
                } else {
                  // æ–‡æ¡£é™„ä»¶ï¼šæ˜¾ç¤ºå›¾æ ‡å’Œæ–‡ä»¶å
                  return (
                    <a
                      key={attachment.id}
                      href={attachment.fileUrl}
                      download={attachment.fileName}
                      onClick={(e) => {
                        e.preventDefault();
                        handleDocumentClick(attachment);
                      }}
                      className="flex items-center gap-monday-2 px-monday-3 py-monday-2 bg-gray-50 rounded hover:bg-gray-100 transition-colors"
                    >
                      <span className="text-lg">{getFileIcon(attachment)}</span>
                      <div className="flex flex-col">
                        <span className="text-monday-xs font-medium">{attachment.fileName}</span>
                        <span className="text-monday-xs text-gray-500">
                          {formatFileSize(attachment.fileSize)}
                        </span>
                      </div>
                    </a>
                  );
                }
              })}
            </div>
          </div>
        )}
      </Card>

      {/* Photo Preview Modal */}
      {selectedPhotoIndex !== null && photoAttachments.length > 0 && (
        <PhotoPreview
          photos={photoAttachments}
          currentIndex={selectedPhotoIndex}
          onClose={() => {
            setSelectedPhotoIndex(null);
            setPhotoAttachments([]);
          }}
          onNext={handlePhotoNext}
          onPrevious={handlePhotoPrevious}
        />
      )}
    </>
  );
};
```

## Project Structure

```
fenghua-backend/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ products/
â”‚       â”œâ”€â”€ product-customer-interaction-history.controller.ts (GET /api/products/:productId/interactions)
â”‚       â”œâ”€â”€ product-customer-interaction-history.service.ts (ä¸šåŠ¡é€»è¾‘)
â”‚       â””â”€â”€ dto/
â”‚           â””â”€â”€ product-customer-interaction-history.dto.ts (DTO å®šä¹‰)

fenghua-frontend/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ products/
â”‚       â”œâ”€â”€ components/
â”‚       â”‚   â”œâ”€â”€ ProductCustomerInteractionHistory.tsx (äº’åŠ¨è®°å½•ç»„ä»¶)
â”‚       â”‚   â””â”€â”€ ProductCustomerAssociation.tsx (å®¢æˆ·å…³è”ç»„ä»¶ï¼ŒåŒ…å«"æŸ¥çœ‹äº’åŠ¨è®°å½•"æŒ‰é’®)
â”‚       â””â”€â”€ ProductCustomerInteractionHistoryPage.tsx (äº’åŠ¨è®°å½•é¡µé¢)
```

## Dependencies

**ç°æœ‰ä¾èµ–ï¼š**
- `@tanstack/react-query` - ç”¨äºæ•°æ®è·å–å’Œç¼“å­˜
- `react-router-dom` - ç”¨äºè·¯ç”±å¯¼èˆª

**æ— éœ€æ–°å¢ä¾èµ–ï¼š**
- æ‰€æœ‰å¿…éœ€çš„åŠŸèƒ½éƒ½å·²å®ç°ï¼Œåªéœ€éªŒè¯å’Œå®Œå–„

## Validation Issues and Fixes

### Critical Issues (Must Fix)

1. **é™„ä»¶æ˜¾ç¤ºæœªå¤ç”¨ Story 4.8 çš„å®ç°**
   - **é—®é¢˜**: å½“å‰å®ç°è¿‡äºç®€å•ï¼Œæ‰€æœ‰é™„ä»¶ä½¿ç”¨ç›¸åŒçš„æ˜¾ç¤ºæ–¹å¼
   - **ä¿®å¤**: å®Œå…¨å¤ç”¨ `CustomerTimeline` ç»„ä»¶çš„é™„ä»¶æ˜¾ç¤ºé€»è¾‘
   - **å‚è€ƒ**: `fenghua-frontend/src/customers/components/CustomerTimeline.tsx` (ç¬¬ 292-356 è¡Œ)

2. **InteractionCreateForm ä¸æ”¯æŒ productId é¢„å¡«å……**
   - **é—®é¢˜**: ä»…æ”¯æŒ `customerId` é¢„å¡«å……ï¼Œä¸æ”¯æŒ `productId`
   - **ä¿®å¤**: æ·»åŠ  `prefillProductId` prop å’Œç›¸å…³å¤„ç†é€»è¾‘

3. **ç©ºçŠ¶æ€æŒ‰é’®æ ·å¼ä¸ç¬¦åˆè¦æ±‚**
   - **é—®é¢˜**: å½“å‰ä¸º `variant="secondary"`ï¼Œåº”ä¸º `variant="primary"`
   - **ä¿®å¤**: æ”¹ä¸º `variant="primary"`

### Medium Priority Issues (Should Fix)

4. **åç«¯ API å¯èƒ½ä¸æ”¯æŒæ’åºåŠŸèƒ½**
   - **é—®é¢˜**: AC5 è¦æ±‚æ”¯æŒæ’åºï¼Œä½†åç«¯å¯èƒ½ä¸æ”¯æŒ `sortOrder` å‚æ•°
   - **ä¿®å¤**: åœ¨ DTOã€Service å’Œ Controller ä¸­æ·»åŠ  `sortOrder` å‚æ•°æ”¯æŒ

5. **é”™è¯¯æ¶ˆæ¯æœªä½¿ç”¨ç»Ÿä¸€å¸¸é‡**
   - **é—®é¢˜**: ç¡¬ç¼–ç é”™è¯¯æ¶ˆæ¯ï¼Œæœªä½¿ç”¨ `error-messages.ts`
   - **ä¿®å¤**: æ·»åŠ  `PRODUCT_INTERACTION_ERRORS` å¸¸é‡å¹¶æ›¿æ¢æ‰€æœ‰ç¡¬ç¼–ç æ¶ˆæ¯

### Low Priority Issues (Nice to Have)

6. **æ–‡ä»¶å¤§å°æ ¼å¼åŒ–ä¸ä¸€è‡´**
   - **é—®é¢˜**: ä½¿ç”¨ `(attachment.fileSize / 1024).toFixed(1) KB`ï¼Œæœªä½¿ç”¨ `formatFileSize`
   - **ä¿®å¤**: ä½¿ç”¨ `formatFileSize` å·¥å…·å‡½æ•°

7. **ç¼ºå°‘ JSDoc æ³¨é‡Š**
   - **é—®é¢˜**: å‡½æ•°ç¼ºå°‘ JSDoc æ³¨é‡Š
   - **ä¿®å¤**: æ·»åŠ å®Œæ•´çš„ JSDoc æ³¨é‡Š

## References

- **Epic 4:** äº’åŠ¨è®°å½•æ ¸å¿ƒåŠŸèƒ½
- **FR27:** å‰ç«¯ä¸“å‘˜å¯ä»¥æŸ¥çœ‹æŸä¸ªäº§å“ä¸é‡‡è´­å•†çš„æ‰€æœ‰äº’åŠ¨è®°å½•ï¼›åç«¯ä¸“å‘˜å¯ä»¥æŸ¥çœ‹æŸä¸ªäº§å“ä¸ä¾›åº”å•†çš„æ‰€æœ‰äº’åŠ¨è®°å½•ï¼›æ€»ç›‘å’Œç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æŸä¸ªäº§å“çš„æ‰€æœ‰äº’åŠ¨è®°å½•
- **Story 2.5:** äº§å“ä¸å®¢æˆ·äº’åŠ¨å†å²æŸ¥çœ‹ï¼ˆå·²å®ç°åç«¯ API å’Œå‰ç«¯ç»„ä»¶ï¼‰
- **Story 3.5:** å®¢æˆ·äº§å“äº’åŠ¨å†å²æŸ¥çœ‹ï¼ˆå‚è€ƒå®ç°ï¼‰
- **Story 4.8:** äº’åŠ¨å†å²æŸ¥çœ‹ï¼ˆ**å¿…é¡»å‚è€ƒé™„ä»¶æ˜¾ç¤ºå’Œç…§ç‰‡é¢„è§ˆå®ç°**ï¼‰
  - **å…³é”®å‚è€ƒ**: `fenghua-frontend/src/customers/components/CustomerTimeline.tsx` (é™„ä»¶æ˜¾ç¤ºé€»è¾‘)
  - **å…³é”®å‚è€ƒ**: `fenghua-frontend/src/attachments/components/PhotoPreview.tsx` (ç…§ç‰‡é¢„è§ˆç»„ä»¶)
- **Story 4.5:** ç”Ÿäº§è¿›åº¦ç…§ç‰‡ä¸Šä¼ ï¼ˆPhotoPreview ç»„ä»¶ï¼‰
- **Story 4.6:** å‘è´§å‰éªŒæ”¶ç…§ç‰‡ä¸Šä¼ ï¼ˆç…§ç‰‡é¢„è§ˆå’Œåˆ‡æ¢ï¼‰

## Dev Agent Record

### Agent Model Used

Auto (Cursor AI)

### Debug Log References

### Completion Notes List

**å®ç°å®Œæˆï¼ˆ2025-01-03ï¼‰ï¼š**

1. **åç«¯ API æ’åºåŠŸèƒ½** âœ…
   - åœ¨ `ProductCustomerInteractionQueryDto` ä¸­æ·»åŠ äº† `sortOrder?: 'asc' | 'desc'` å­—æ®µ
   - åœ¨ `ProductCustomerInteractionHistoryService` ä¸­å®ç°äº†æ’åºé€»è¾‘
   - SQL æŸ¥è¯¢æ”¯æŒåŠ¨æ€æ’åºï¼ˆ`ORDER BY pci.interaction_date ${sortOrder === 'asc' ? 'ASC' : 'DESC'}`ï¼‰

2. **é™„ä»¶æ˜¾ç¤ºåŠŸèƒ½ä¿®å¤ï¼ˆCRITICALï¼‰** âœ…
   - å®Œå…¨å¤ç”¨äº† Story 4.8 çš„é™„ä»¶æ˜¾ç¤ºé€»è¾‘
   - ç…§ç‰‡é™„ä»¶ï¼šæ˜¾ç¤ºç¼©ç•¥å›¾ï¼Œç‚¹å‡»æŸ¥çœ‹å¤§å›¾ï¼ˆä½¿ç”¨ `PhotoPreview` ç»„ä»¶ï¼‰
   - æ–‡æ¡£é™„ä»¶ï¼šä½¿ç”¨ `getFileIcon` æ˜¾ç¤ºå›¾æ ‡ï¼Œä½¿ç”¨ `formatFileSize` æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
   - æ·»åŠ äº†ç…§ç‰‡é¢„è§ˆçŠ¶æ€ç®¡ç†å’Œå¯¼èˆªåŠŸèƒ½
   - ä½¿ç”¨ `ErrorBoundary` åŒ…è£… `PhotoPreview` ç»„ä»¶

3. **InteractionCreateForm æ”¯æŒ productId é¢„å¡«å……ï¼ˆHIGHï¼‰** âœ…
   - æ›´æ–°äº† `InteractionCreatePage` ä» URL å‚æ•°è·å– `productId`
   - æ›´æ–°äº† `InteractionCreateForm` æ·»åŠ  `prefillProductId` prop
   - æ·»åŠ äº† `useEffect` åŠ è½½å¹¶è®¾ç½®äº§å“ä¿¡æ¯ï¼ˆéªŒè¯äº§å“çŠ¶æ€ä¸º activeï¼‰

4. **ç©ºçŠ¶æ€æŒ‰é’®æ ·å¼ä¿®å¤ï¼ˆHIGHï¼‰** âœ…
   - å°†æŒ‰é’®æ ·å¼ä» `variant="secondary"` æ”¹ä¸º `variant="primary"`

5. **å‰ç«¯æ’åºåŠŸèƒ½ï¼ˆMEDIUMï¼‰** âœ…
   - æ·»åŠ äº†æ’åºé€‰æ‹©å™¨ï¼ˆåˆ‡æ¢æŒ‰é’®ï¼š"æœ€æ–°çš„åœ¨å‰" / "æœ€æ—§çš„åœ¨å‰"ï¼‰
   - å°† `sortOrder` å‚æ•°ä¼ é€’ç»™åç«¯ API
   - æ›´æ–°äº† React Query ç¼“å­˜é”®ä»¥åŒ…å« `sortOrder`

6. **ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯å¸¸é‡ï¼ˆMEDIUMï¼‰** âœ…
   - åœ¨ `error-messages.ts` ä¸­æ·»åŠ äº† `PRODUCT_INTERACTION_ERRORS` éƒ¨åˆ†
   - æ›¿æ¢äº†æ‰€æœ‰ç¡¬ç¼–ç çš„é”™è¯¯æ¶ˆæ¯ä¸ºå¸¸é‡

7. **JSDoc æ³¨é‡Šï¼ˆLOWï¼‰** âœ…
   - ä¸ºæ‰€æœ‰ä¸»è¦å‡½æ•°æ·»åŠ äº† JSDoc æ³¨é‡Š
   - åŒ…æ‹¬ `getFileIcon`, `handleDocumentClick`, `handlePhotoClick`, `handlePhotoNext`, `handlePhotoPrevious` ç­‰

### File List

**åç«¯æ–‡ä»¶ï¼š**
- `fenghua-backend/src/products/dto/product-customer-interaction-history.dto.ts` - æ·»åŠ äº† `sortOrder` å­—æ®µå’Œ `@IsIn` éªŒè¯
- `fenghua-backend/src/products/product-customer-interaction-history.service.ts` - å®ç°äº†æ’åºé€»è¾‘
- `fenghua-backend/src/products/product-customer-interaction-history.controller.ts` - ä¼ é€’ `sortOrder` å‚æ•°

**å‰ç«¯æ–‡ä»¶ï¼š**
- `fenghua-frontend/src/products/components/ProductCustomerInteractionHistory.tsx` - å®Œå…¨é‡å†™äº†é™„ä»¶æ˜¾ç¤ºé€»è¾‘ï¼Œæ·»åŠ äº†æ’åºåŠŸèƒ½å’Œç…§ç‰‡é¢„è§ˆï¼Œæ·»åŠ äº† UUID éªŒè¯å’Œ `getTimeLabel` å‡½æ•°
- `fenghua-frontend/src/interactions/pages/InteractionCreatePage.tsx` - æ·»åŠ äº† `productId` é¢„å¡«å……æ”¯æŒ
- `fenghua-frontend/src/interactions/components/InteractionCreateForm.tsx` - æ·»åŠ äº† `prefillProductId` prop å’Œå¤„ç†é€»è¾‘ï¼Œä¿®å¤äº† useEffect ä¾èµ–é¡¹
- `fenghua-frontend/src/common/constants/error-messages.ts` - æ·»åŠ äº† `PRODUCT_INTERACTION_ERRORS` å¸¸é‡ï¼ˆåŒ…æ‹¬ `NO_INTERACTIONS` å’Œ `NO_INTERACTIONS_IN_STAGE`ï¼‰

## Change Log

**ä»£ç å®¡æŸ¥ä¿®å¤ï¼ˆ2025-01-03ï¼‰ï¼š**
- **Issue #1 (HIGH):** åœ¨åç«¯ DTO ä¸­æ·»åŠ äº† `@IsIn(['asc', 'desc'])` éªŒè¯ï¼Œç¡®ä¿ `sortOrder` å‚æ•°åªèƒ½æ¥å—æœ‰æ•ˆå€¼
- **Issue #2 (MEDIUM):** åœ¨ `error-messages.ts` ä¸­æ·»åŠ äº† `NO_INTERACTIONS` å’Œ `NO_INTERACTIONS_IN_STAGE` å¸¸é‡ï¼Œæ›¿æ¢äº†ç¡¬ç¼–ç çš„ç©ºçŠ¶æ€æ¶ˆæ¯
- **Issue #3 (MEDIUM):** æ·»åŠ äº† `getTimeLabel` å‡½æ•°åˆ° `ProductCustomerInteractionHistory.tsx`ï¼Œç»Ÿä¸€æ—¶é—´æ ¼å¼åŒ–æ˜¾ç¤ºï¼ˆä¸ Story 4.8 ä¿æŒä¸€è‡´ï¼‰
- **Issue #4 (MEDIUM):** æ·»åŠ äº† `productId` å’Œ `customerId` çš„ UUID æ ¼å¼éªŒè¯ï¼Œé˜²æ­¢æ— æ•ˆ API è°ƒç”¨
- **Issue #5 (MEDIUM):** åœ¨ `InteractionCreateForm.tsx` ä¸­æ·»åŠ äº† eslint-disable æ³¨é‡Šï¼Œè¯´æ˜ `productsService` æ˜¯ç¨³å®šçš„ï¼Œä¸éœ€è¦æ·»åŠ åˆ°ä¾èµ–é¡¹

