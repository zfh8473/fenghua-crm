---
stepsCompleted: [1, 2]
inputDocuments: ['prd.md', 'architecture.md', 'ux-design-specification.md']
---

# fenghua-crm - Epic Breakdown

## Overview

This document provides the complete epic and story breakdown for fenghua-crm, decomposing the requirements from the PRD, UX Design if it exists, and Architecture requirements into implementable stories.

## Requirements Inventory

### Functional Requirements

FR1: 管理员可以创建、编辑和删除产品对象

FR2: 所有用户可以根据产品名称、产品HS编码或产品类别搜索产品

FR3: 所有用户可以查看产品的详细信息（名称、代码、类别、描述、规格等）

FR4: 前端专员可以查看某个产品与哪些采购商有关联；后端专员可以查看某个产品与哪些供应商有关联；总监和管理员可以查看某个产品与哪些客户（供应商/采购商）有关联

FR5: 前端专员可以查看某个产品与某个采购商的完整互动历史（按时间顺序）；后端专员可以查看某个产品与某个供应商的完整互动历史（按时间顺序）；总监和管理员可以查看某个产品与某个客户的完整互动历史（按时间顺序）

FR6: 前端专员可以查看某个产品与采购商的完整业务流程（从询价到订单完成）；后端专员可以查看某个产品与供应商的完整业务流程（从询价到订单完成）；总监和管理员可以查看某个产品的完整业务流程（从询价到订单完成）

FR7: 所有用户可以在记录互动时关联产品（必填项）

FR8: 系统可以自动验证产品关联的完整性（确保所有互动都关联到产品）

FR9: 前端专员可以根据采购商名称、采购商代码或客户类型搜索采购商；后端专员可以根据供应商名称、供应商代码或客户类型搜索供应商；总监和管理员可以根据客户名称、客户代码或客户类型搜索客户

FR10: 前端专员可以查看采购商的详细信息（名称、地址、联系方式、行业、规模等）；后端专员可以查看供应商的详细信息（名称、地址、联系方式、行业、规模等）；总监和管理员可以查看客户的详细信息（名称、地址、联系方式、行业、规模等）

FR11: 前端专员可以创建、编辑和删除采购商记录；后端专员可以创建、编辑和删除供应商记录；总监和管理员可以创建、编辑和删除客户记录

FR12: 前端专员只能查看和管理采购商类型的客户

FR13: 后端专员只能查看和管理供应商类型的客户

FR14: 总监和管理员可以查看和管理所有类型的客户

FR15: 前端专员可以查看某个采购商与哪些产品有关联；后端专员可以查看某个供应商与哪些产品有关联；总监和管理员可以查看某个客户与哪些产品有关联

FR16: 前端专员可以查看某个采购商针对某个产品的完整互动历史；后端专员可以查看某个供应商针对某个产品的完整互动历史；总监和管理员可以查看某个客户针对某个产品的完整互动历史

FR17: 前端专员可以查看采购商的时间线视图（所有互动按时间顺序显示）；后端专员可以查看供应商的时间线视图（所有互动按时间顺序显示）；总监和管理员可以查看客户的时间线视图（所有互动按时间顺序显示）

FR18: 系统可以根据客户类型（供应商/采购商）自动过滤数据访问

FR19: 前端专员可以记录与采购商的互动（初步接触、产品询价、报价、接受/拒绝报价、签署订单、完成订单）

FR20: 后端专员可以记录与供应商的互动（询价产品、接收报价、产品规格确认、生产进度跟进、发货前验收）

FR21: 所有用户可以在记录互动时关联产品（必填项）

FR22: 所有用户可以在记录互动时添加文本描述、时间、状态等信息

FR23: 所有用户可以在记录互动时上传附件（照片、文档等）

FR24: 后端专员可以在记录生产进度跟进时上传生产照片

FR25: 后端专员可以在记录发货前验收时上传验收照片（支持多张照片）

FR26: 前端专员可以查看某个采购商的所有互动记录（按时间顺序）；后端专员可以查看某个供应商的所有互动记录（按时间顺序）；总监和管理员可以查看某个客户的所有互动记录（按时间顺序）

FR27: 前端专员可以查看某个产品与采购商的所有互动记录（按时间顺序）；后端专员可以查看某个产品与供应商的所有互动记录（按时间顺序）；总监和管理员可以查看某个产品的所有互动记录（按时间顺序）

FR28: 前端专员可以查看某个采购商针对某个产品的所有互动记录（按时间顺序）；后端专员可以查看某个供应商针对某个产品的所有互动记录（按时间顺序）；总监和管理员可以查看某个客户针对某个产品的所有互动记录（按时间顺序）

FR29: 所有用户可以编辑和删除自己创建的互动记录

FR30: 系统可以自动记录互动的时间戳

FR31: 系统可以自动记录互动的创建者和修改者

FR32: 前端专员可以使用快速记录功能快速记录采购商互动（减少数据录入工作量）；后端专员可以使用快速记录功能快速记录供应商互动（减少数据录入工作量）；总监和管理员可以使用快速记录功能快速记录客户互动（减少数据录入工作量）

FR33: 前端专员可以使用快速记录模板（预设的采购商互动类型和字段）；后端专员可以使用快速记录模板（预设的供应商互动类型和字段）；总监和管理员可以使用快速记录模板（预设的互动类型和字段）

FR34: 前端专员可以在快速记录时选择产品（必填项）；后端专员可以在快速记录时选择产品（必填项）；总监和管理员可以在快速记录时选择产品（必填项）

FR35: 系统可以在快速记录时自动关联当前用户和当前时间

FR36: 系统可以在快速记录时提供产品自动完成功能（输入产品名称时自动提示）

FR37: 系统可以在快速记录时提供客户自动完成功能（前端专员输入采购商名称时自动提示采购商，后端专员输入供应商名称时自动提示供应商，总监和管理员输入客户名称时自动提示所有客户）

FR38: 总监和管理员可以从 Excel 文件（CSV 和基本 Excel 格式）批量导入客户数据

FR39: 系统可以在导入前验证数据格式和完整性

FR40: 系统可以在导入时检测和报告数据错误

FR41: 系统可以在导入时提供数据清洗建议（自动修复常见错误）

FR42: 总监和管理员可以预览导入结果（数据映射关系）后再确认导入

FR43: 系统可以在导入过程中显示导入进度

FR44: 系统可以在导入失败时提供详细的错误报告

FR45: 系统可以支持部分成功导入（部分记录导入成功，部分失败）

FR46: 总监和管理员可以导出数据（JSON 或 CSV 格式）

FR47: 总监和管理员可以导出所有数据（JSON 或 CSV 格式）

FR48: 系统可以在导出时验证数据完整性

FR49: 前端专员可以根据采购商名称、采购商代码、客户类型搜索采购商（支持模糊搜索）；后端专员可以根据供应商名称、供应商代码、客户类型搜索供应商（支持模糊搜索）；总监和管理员可以根据客户名称、客户代码、客户类型搜索客户（支持模糊搜索）

FR50: 所有用户可以根据产品名称、产品HS编码、产品类别搜索产品（支持模糊搜索）

FR51: 前端专员可以根据互动类型、互动时间、互动状态搜索采购商相关的互动记录；后端专员可以根据互动类型、互动时间、互动状态搜索供应商相关的互动记录；总监和管理员可以根据互动类型、互动时间、互动状态搜索所有互动记录

FR52: 前端专员可以组合多个搜索条件进行高级搜索（采购商 + 产品 + 互动类型 + 时间范围）；后端专员可以组合多个搜索条件进行高级搜索（供应商 + 产品 + 互动类型 + 时间范围）；总监和管理员可以组合多个搜索条件进行高级搜索（客户 + 产品 + 互动类型 + 时间范围）

FR53: 前端专员只能搜索采购商相关的数据

FR54: 后端专员只能搜索供应商相关的数据

FR55: 总监和管理员可以搜索所有数据

FR56: 前端专员可以查看采购商搜索结果的时间线视图；后端专员可以查看供应商搜索结果的时间线视图；总监和管理员可以查看搜索结果的时间线视图

FR57: 前端专员可以对采购商搜索结果进行排序（按时间、按采购商、按产品等）；后端专员可以对供应商搜索结果进行排序（按时间、按供应商、按产品等）；总监和管理员可以对搜索结果进行排序（按时间、按客户、按产品等）

FR58: 前端专员可以对采购商搜索结果进行筛选（按产品类别、按互动类型等）；后端专员可以对供应商搜索结果进行筛选（按产品类别、按互动类型等）；总监和管理员可以对搜索结果进行筛选（按客户类型、按产品类别、按互动类型等）

FR59: 系统可以根据用户角色（管理员、总监、前端专员、后端专员）自动过滤数据访问

FR60: 前端专员只能访问采购商类型的数据（客户、互动、订单等）

FR61: 后端专员只能访问供应商类型的数据（客户、互动、订单等）

FR62: 总监可以访问所有数据，但不能管理用户

FR63: 管理员可以访问所有数据，并可以管理用户

FR64: 系统可以验证所有数据访问操作的权限

FR65: 系统可以记录所有权限相关的操作（访问、权限授予、权限撤销等）

FR70: 总监和管理员可以查看业务仪表板（业务概览和关键指标）

FR71: 总监和管理员可以查看产品关联分析（哪些产品与哪些客户有关联，订单转化率等）

FR72: 总监和管理员可以查看客户分析（客户订单量、订单金额、订单频率等）

FR73: 总监和管理员可以查看供应商分析（供应商交货及时率、质量问题率等）

FR74: 总监和管理员可以查看采购商分析（采购商订单量、订单金额、订单频率等）

FR75: 总监和管理员可以查看业务趋势分析（订单量趋势、客户增长趋势等）

FR76: 总监和管理员可以导出分析结果（报表、图表等）

FR77: 系统可以自动计算关键业务指标（订单转化率、客户流失率、交货及时率等）

FR78: 管理员可以创建、编辑和删除用户账户

FR79: 管理员可以为用户分配角色（管理员、总监、前端专员、后端专员）

FR80: 管理员可以配置系统设置（数据保留策略、备份策略等）

FR81: 管理员可以查看系统日志和审计日志

FR82: 管理员可以查看数据备份状态

FR83: 管理员可以执行数据恢复操作

FR84: 管理员可以查看系统健康状态（数据库连接、服务状态等）

FR85: 系统可以自动执行每日数据备份

FR86: 系统可以自动验证备份数据的完整性

FR87: 系统可以自动记录所有系统操作（数据访问、数据修改、权限操作等）

FR88: 系统可以自动加密敏感数据（客户信息、订单信息、财务信息等）

FR89: 系统可以自动使用 HTTPS 传输所有数据

FR90: 系统可以自动记录所有数据访问操作（谁访问了什么数据，什么时候访问）

FR91: 系统可以自动记录所有数据修改操作（谁修改了什么数据，什么时候修改，修改前和修改后的值）

FR92: 系统可以自动记录所有权限操作（权限授予、撤销等）

FR93: 管理员可以查询审计日志（按用户、按时间、按操作类型等）

FR94: 系统可以自动加密存储敏感数据

FR95: 系统可以自动使用安全传输协议（HTTPS/TLS 1.2+）

FR96: 系统可以自动管理加密密钥（密钥生成、密钥轮换、密钥存储）

FR97: 前端专员可以请求导出自己相关的采购商数据（GDPR 要求）；后端专员可以请求导出自己相关的供应商数据（GDPR 要求）；总监和管理员可以请求导出自己相关的所有数据（GDPR 要求）

FR98: 系统可以在 30 天内完成数据导出请求

FR99: 前端专员可以请求删除自己相关的采购商数据（GDPR 要求）；后端专员可以请求删除自己相关的供应商数据（GDPR 要求）；总监和管理员可以请求删除自己相关的所有数据（GDPR 要求）

FR100: 系统可以自动删除过期数据（根据数据保留策略）

FR101: 前端专员可以在采购商相关的互动记录中添加评论（团队协作）；后端专员可以在供应商相关的互动记录中添加评论（团队协作）；总监和管理员可以在所有互动记录中添加评论（团队协作）

FR102: 前端专员可以查看采购商相关互动记录的评论历史；后端专员可以查看供应商相关互动记录的评论历史；总监和管理员可以查看所有互动记录的评论历史

FR113: 前端专员可以批量发送报价给多个采购商（针对同一产品）

FR114: 前端专员可以批量选择多条采购商相关记录进行操作（批量编辑、批量删除等）；后端专员可以批量选择多条供应商相关记录进行操作（批量编辑、批量删除等）；总监和管理员可以批量选择多条记录进行操作（批量编辑、批量删除等）

FR115: 系统可以在用户手动录入数据时验证数据格式和完整性

FR116: 系统可以自动验证产品-客户-互动关联的数据完整性（确保所有互动都关联到产品和客户）

FR117: 系统可以在操作失败时提供错误信息和恢复建议

FR118: 系统可以在网络中断时自动保存用户输入（防止数据丢失）

FR119: 系统可以检测和处理数据冲突（多个用户同时修改同一条记录）

FR120: 系统可以在导入部分成功时，允许用户查看成功和失败的记录，并提供重新导入失败记录的功能

FR121: 系统可以在导入时检测和合并重复数据（基于客户名称、客户代码等）

FR122: 系统可以在记录互动时自动建议可能关联的产品（基于历史数据）

FR123: 系统可以在记录互动时自动建议可能关联的客户（基于历史数据）

FR126: 系统可以为新用户提供产品关联功能的引导和帮助

FR127: 系统可以为用户提供快捷操作入口（常用操作快速访问）

FR128: 系统可以为用户提供上下文帮助（在需要时显示帮助信息）

FR129: 所有用户可以设置个人偏好（默认视图、提醒偏好、显示偏好等）

FR130: 所有用户可以自定义快捷操作入口（选择常用操作）

FR131: 系统可以通过 GraphQL API 提供所有功能能力（供第三方集成使用）

FR132: 系统可以支持第三方系统集成（通过 API 或 Webhook）

FR133: 系统可以接收来自第三方系统的数据（通过 Webhook 或 API）

FR134: 总监和管理员可以在导出数据时选择导出格式（JSON、CSV、Excel 等）

FR135: 总监和管理员可以在导出数据时选择导出的字段（自定义导出内容）

FR136: 系统可以自动提醒用户跟进客户（基于跟进时间设置）

FR137: 系统可以自动提醒后端专员跟进生产进度（基于生产计划）

FR138: 系统可以自动提醒后端专员进行发货前验收（基于发货计划）

FR139: 系统可以自动提醒用户处理待办事项

FR140: 所有用户可以设置提醒偏好（提醒方式、提醒时间等）

FR141: 系统可以支持从 Excel 文件迁移历史数据到 CRM 系统

FR142: 管理员可以通过用户界面查看数据备份状态和执行数据恢复操作

FR143: 管理员可以通过用户界面查看系统健康状态（数据库连接、服务状态等）

FR144: 系统可以通过 GraphQL API 提供版本控制能力（支持 API 版本管理）

FR145: 管理员可以查看系统错误日志和异常记录

FR146: 管理员可以查看数据导入历史（导入时间、导入文件、导入结果等）

FR147: 管理员可以查看用户活动日志（用户登录、操作记录等）

FR148: 总监和管理员可以通过图表和可视化方式查看业务分析结果

FR149: 所有用户可以访问帮助文档和用户指南

### NonFunctional Requirements

**Performance（性能）:**
- 用户操作响应时间：客户查找 < 10秒，产品-客户关联查询 < 15秒，简单互动记录 < 30秒，复杂互动记录 < 2分钟，业务报表生成 < 1分钟，业务概览查看 < 30秒
- 系统响应时间：GraphQL API < 500ms (P95)，页面首次加载 < 2秒，搜索查询 < 1秒 (P95)
- 数据库查询性能：简单查询 < 100ms (P95)，复杂查询 < 1秒 (P95)
- 数据导入性能：Excel 数据导入 < 5分钟/1000条记录
- 并发支持：至少50个用户同时在线，至少20个用户同时进行数据操作，至少100个并发API请求
- 缓存策略：常用数据查询响应时间提升 > 50%

**Security（安全）:**
- 数据加密：所有敏感数据使用 AES-256 加密，所有数据传输使用 HTTPS/TLS 1.2+，加密密钥自动管理
- 访问控制：实现基于角色的访问控制（RBAC），支持4种角色，前端/后端专员数据完全隔离，所有数据访问操作都需要进行权限验证，数据库层实现 Row Level Security (RLS)
- API 安全：API 支持限流保护（每分钟最多1000个请求/用户），API 支持版本控制
- 审计和合规：系统自动记录所有数据访问、修改、权限操作，审计日志保留1年（可配置），符合 GDPR 和《个人信息保护法》要求
- 数据备份和恢复：系统自动执行每日数据备份，备份数据保留30天，系统自动验证备份数据的完整性，管理员可以执行数据恢复操作，数据恢复操作完成时间 < 30分钟
- 数据保留策略：业务数据保留策略可配置（默认保留7年）

**Reliability（可靠性）:**
- 系统可用性：系统正常运行时间 > 99.5%（月度），计划内维护窗口：每月最多4小时，计划外停机时间 < 0.5%（月度）
- 数据完整性：数据丢失率 < 0.1%，所有业务操作都有审计记录，系统支持从备份恢复数据
- 错误处理：系统自动记录所有错误和异常，操作失败时提供错误信息和恢复建议，网络中断时自动保存用户输入，系统可以检测和处理数据冲突
- 监控和告警：系统提供监控和告警功能，关键指标异常时自动告警，管理员可以查看系统健康状态和错误日志

**Scalability（可扩展性）:**
- 用户增长支持：系统支持从10个用户扩展到100个用户，性能下降 < 10%
- 数据增长支持：系统支持从1000条记录扩展到100,000条记录，查询性能下降 < 20%，系统支持数据量增长10倍，系统性能保持稳定
- 功能扩展支持：系统架构支持新功能模块的添加，GraphQL API 设计支持版本控制

**Integration（集成）:**
- API 集成：系统通过 GraphQL API 提供所有功能能力，GraphQL API 支持版本控制，API 响应时间 < 500ms (P95)
- 外部服务集成：系统支持第三方系统集成（通过 API 或 Webhook），系统可以接收来自第三方系统的数据，集成失败时提供错误处理和重试机制
- 未来集成考虑（Growth 阶段）：邮件系统集成，AI 服务集成

**Maintainability（可维护性）:**
- 代码质量：系统代码结构清晰，新功能模块添加时间 < 2周，系统代码测试覆盖率 > 80%，关键业务功能测试覆盖率 > 95%
- 部署和维护：系统支持热部署（Growth 阶段），系统提供完整的 API 文档和用户文档，API 文档覆盖率 > 90%
- 文档完整性：系统提供完整的 API 文档和用户文档，用户文档包括用户指南、管理员指南、开发者指南

### Additional Requirements

**From Architecture Document:**
- **Starter Template:** Twenty CRM (NestJS + React + TypeScript + PostgreSQL + GraphQL) - This impacts Epic 1 Story 1
- **Infrastructure:** Docker-based deployment (Twenty CRM standard), multi-container setup (server, database, redis, worker)
- **Data Model:** Use Twenty CRM custom objects + relationship fields, establish composite indexes
- **Permission Filtering:** GraphQL Resolver (primary) + PostgreSQL RLS (defense), avoid duplicate filtering
- **Caching Strategy:** Multi-layer caching (React Query + Redis)
- **Excel Import:** Asynchronous processing (Bull Queue) for large files
- **Mobile Network Handling:** Pure online recording with mobile network support, automatic retry mechanism, gallery upload support
- **Error Handling:** Layered error handling (User/Business/System layers), automatic retry with exponential backoff
- **Monitoring & Logging:** Structured logging (Winston), performance monitoring, business metrics, alerting
- **Deployment Strategy:** Brief downtime acceptable (MVP), hot deployment (Growth)
- **Data Migration:** Asynchronous Excel import, real-time validation, data cleaning, product association validation
- **Soft Delete:** Mark records as "inactive" instead of deleting, preserve historical records
- **API Versioning:** GraphQL API supports version control

**From UX Design Document:**
- **Responsive Design:** Support desktop and mobile viewing, mobile-first approach (MVP core), desktop second, tablet support
- **Accessibility:** WCAG 2.1 Level AA (MVP), Level AAA (Growth), color contrast ratios, keyboard navigation, screen reader support, touch target sizes (64x64px core, 56x56px general, 48x48px nav)
- **Browser/Device Compatibility:** Support modern browsers (Chrome, Firefox, Safari, Edge), mobile browsers (iOS Safari, Chrome Mobile)
- **User Interaction Patterns:** Quick record floating button, product selector component, multi-view toggle, mobile online recording with automatic retry
- **Animation/Transition Requirements:** Micro-animations for feedback, smooth transitions between views, loading states
- **Error Handling UX:** User-friendly error messages, recovery suggestions, network status feedback, automatic retry status indication
- **Design System:** Based on Twenty CRM design system + Tailwind CSS customization
- **Visual Design:** Soft color system (professional blue + soft blue-purple), responsive typography, 4px base unit spacing
- **Mobile Optimization:** Mobile-optimized touch targets, gallery upload from phone, network retry mechanism

### FR Coverage Map

FR1: Epic 2 - 产品管理：管理员创建、编辑和删除产品
FR2: Epic 2 - 产品管理：所有用户搜索产品
FR3: Epic 2 - 产品管理：所有用户查看产品详细信息
FR4: Epic 2 - 产品管理：查看产品与客户的关联（按角色）
FR5: Epic 2 - 产品管理：查看产品与客户的完整互动历史
FR6: Epic 2 - 产品管理：查看产品与客户的完整业务流程
FR7: Epic 4 - 互动记录：记录互动时关联产品（必填）
FR8: Epic 2 - 产品管理：自动验证产品关联完整性
FR9: Epic 3 - 客户管理：搜索客户（按角色）
FR10: Epic 3 - 客户管理：查看客户详细信息（按角色）
FR11: Epic 3 - 客户管理：创建、编辑和删除客户记录（按角色）
FR12: Epic 3 - 客户管理：前端专员只能查看和管理采购商
FR13: Epic 3 - 客户管理：后端专员只能查看和管理供应商
FR14: Epic 3 - 客户管理：总监和管理员查看和管理所有客户
FR15: Epic 3 - 客户管理：查看客户与产品的关联（按角色）
FR16: Epic 3 - 客户管理：查看客户针对产品的完整互动历史
FR17: Epic 3 - 客户管理：查看客户的时间线视图
FR18: Epic 3 - 客户管理：根据客户类型自动过滤数据访问
FR19: Epic 4 - 互动记录：前端专员记录与采购商的互动
FR20: Epic 4 - 互动记录：后端专员记录与供应商的互动
FR21: Epic 4 - 互动记录：记录互动时关联产品（必填）
FR22: Epic 4 - 互动记录：记录互动时添加文本描述、时间、状态
FR23: Epic 4 - 互动记录：记录互动时上传附件
FR24: Epic 4 - 互动记录：后端专员上传生产照片
FR25: Epic 4 - 互动记录：后端专员上传验收照片（多张）
FR26: Epic 4 - 互动记录：查看客户的所有互动记录（按角色）
FR27: Epic 4 - 互动记录：查看产品与客户的所有互动记录
FR28: Epic 4 - 互动记录：查看客户针对产品的所有互动记录
FR29: Epic 4 - 互动记录：编辑和删除自己创建的互动记录
FR30: Epic 4 - 互动记录：自动记录互动的时间戳
FR31: Epic 4 - 互动记录：自动记录互动的创建者和修改者
FR32: Epic 5 - 快速记录：使用快速记录功能（按角色）
FR33: Epic 5 - 快速记录：使用快速记录模板（按角色）
FR34: Epic 5 - 快速记录：快速记录时选择产品（必填）
FR35: Epic 5 - 快速记录：自动关联当前用户和当前时间
FR36: Epic 5 - 快速记录：提供产品自动完成功能
FR37: Epic 5 - 快速记录：提供客户自动完成功能（按角色）
FR38: Epic 7 - 数据导入导出：从 Excel 批量导入客户数据
FR39: Epic 7 - 数据导入导出：导入前验证数据格式和完整性
FR40: Epic 7 - 数据导入导出：导入时检测和报告数据错误
FR41: Epic 7 - 数据导入导出：导入时提供数据清洗建议
FR42: Epic 7 - 数据导入导出：预览导入结果后再确认导入
FR43: Epic 7 - 数据导入导出：导入过程中显示导入进度
FR44: Epic 7 - 数据导入导出：导入失败时提供详细错误报告
FR45: Epic 7 - 数据导入导出：支持部分成功导入
FR46: Epic 7 - 数据导入导出：导出数据（JSON 或 CSV）
FR47: Epic 7 - 数据导入导出：导出所有数据（JSON 或 CSV）
FR48: Epic 7 - 数据导入导出：导出时验证数据完整性
FR49: Epic 6 - 搜索和查询：搜索客户（支持模糊搜索，按角色）
FR50: Epic 6 - 搜索和查询：搜索产品（支持模糊搜索）
FR51: Epic 6 - 搜索和查询：搜索互动记录（按角色）
FR52: Epic 6 - 搜索和查询：组合多个搜索条件进行高级搜索
FR53: Epic 6 - 搜索和查询：前端专员只能搜索采购商相关数据
FR54: Epic 6 - 搜索和查询：后端专员只能搜索供应商相关数据
FR55: Epic 6 - 搜索和查询：总监和管理员可以搜索所有数据
FR56: Epic 6 - 搜索和查询：查看搜索结果的时间线视图
FR57: Epic 6 - 搜索和查询：对搜索结果进行排序
FR58: Epic 6 - 搜索和查询：对搜索结果进行筛选
FR59: Epic 3 - 客户管理：根据用户角色自动过滤数据访问
FR60: Epic 3 - 客户管理：前端专员只能访问采购商类型数据
FR61: Epic 3 - 客户管理：后端专员只能访问供应商类型数据
FR62: Epic 3 - 客户管理：总监可以访问所有数据但不能管理用户
FR63: Epic 3 - 客户管理：管理员可以访问所有数据并管理用户
FR64: Epic 3 - 客户管理：验证所有数据访问操作的权限
FR65: Epic 3 - 客户管理：记录所有权限相关的操作
FR70: Epic 9 - 业务分析：查看业务仪表板
FR71: Epic 9 - 业务分析：查看产品关联分析
FR72: Epic 9 - 业务分析：查看客户分析
FR73: Epic 9 - 业务分析：查看供应商分析
FR74: Epic 9 - 业务分析：查看采购商分析
FR75: Epic 9 - 业务分析：查看业务趋势分析
FR76: Epic 9 - 业务分析：导出分析结果
FR77: Epic 9 - 业务分析：自动计算关键业务指标
FR78: Epic 1 - 系统基础设置：创建、编辑和删除用户账户
FR79: Epic 1 - 系统基础设置：为用户分配角色
FR80: Epic 1 - 系统基础设置：配置系统设置
FR81: Epic 1 - 系统基础设置：查看系统日志和审计日志
FR82: Epic 1 - 系统基础设置：查看数据备份状态
FR83: Epic 1 - 系统基础设置：执行数据恢复操作
FR84: Epic 1 - 系统基础设置：查看系统健康状态
FR85: Epic 1 - 系统基础设置：自动执行每日数据备份
FR86: Epic 1 - 系统基础设置：自动验证备份数据完整性
FR87: Epic 1 - 系统基础设置：自动记录所有系统操作
FR88: Epic 1 - 系统基础设置：自动加密敏感数据
FR89: Epic 1 - 系统基础设置：自动使用 HTTPS 传输所有数据
FR90: Epic 9 - 数据安全和合规：自动记录所有数据访问操作
FR91: Epic 9 - 数据安全和合规：自动记录所有数据修改操作
FR92: Epic 9 - 数据安全和合规：自动记录所有权限操作
FR93: Epic 9 - 数据安全和合规：查询审计日志
FR94: Epic 9 - 数据安全和合规：自动加密存储敏感数据
FR95: Epic 9 - 数据安全和合规：自动使用安全传输协议
FR96: Epic 9 - 数据安全和合规：自动管理加密密钥
FR97: Epic 9 - 数据安全和合规：请求导出相关数据（GDPR）
FR98: Epic 9 - 数据安全和合规：30天内完成数据导出请求
FR99: Epic 9 - 数据安全和合规：请求删除相关数据（GDPR）
FR100: Epic 9 - 数据安全和合规：自动删除过期数据
FR101: Epic 10 - 协作功能：在互动记录中添加评论（团队协作）
FR102: Epic 10 - 协作功能：查看互动记录的评论历史
FR113: Epic 11 - 批量操作：批量发送报价给多个采购商（针对同一产品）
FR114: Epic 11 - 批量操作：批量选择多条记录进行操作
FR115: 横切关注点 - 数据验证和错误处理：手动录入数据时验证数据格式和完整性（分配到 Epic 3, Epic 4, Epic 5）
FR116: 横切关注点 - 数据验证和错误处理：自动验证产品-客户-互动关联的数据完整性（分配到 Epic 4）
FR117: 横切关注点 - 数据验证和错误处理：操作失败时提供错误信息和恢复建议（所有 Epic）
FR118: 横切关注点 - 数据验证和错误处理：网络中断时自动保存用户输入（分配到 Epic 4, Epic 5）
FR119: 横切关注点 - 数据验证和错误处理：检测和处理数据冲突（分配到 Epic 4, Epic 5）
FR120: Epic 7 - 数据导入导出：导入部分成功时查看成功和失败记录
FR121: Epic 7 - 数据导入导出：导入时检测和合并重复数据
FR122: Epic 12 - 智能建议和自动化：记录互动时自动建议可能关联的产品
FR123: Epic 12 - 智能建议和自动化：记录互动时自动建议可能关联的客户
FR126: Epic 13 - 用户引导和个性化：为新用户提供产品关联功能的引导和帮助
FR127: Epic 13 - 用户引导和个性化：为用户提供快捷操作入口
FR128: Epic 13 - 用户引导和个性化：为用户提供上下文帮助
FR129: Epic 13 - 用户引导和个性化：设置个人偏好
FR130: Epic 13 - 用户引导和个性化：自定义快捷操作入口
FR131: Epic 14 - API 和集成：通过 GraphQL API 提供所有功能能力
FR132: Epic 14 - API 和集成：支持第三方系统集成
FR133: Epic 14 - API 和集成：接收来自第三方系统的数据
FR134: Epic 7 - 数据导入导出：导出数据时选择导出格式
FR135: Epic 7 - 数据导入导出：导出数据时选择导出的字段
FR136: Epic 15 - 通知和提醒：自动提醒用户跟进客户
FR137: Epic 15 - 通知和提醒：自动提醒后端专员跟进生产进度
FR138: Epic 15 - 通知和提醒：自动提醒后端专员进行发货前验收
FR139: Epic 15 - 通知和提醒：自动提醒用户处理待办事项
FR140: Epic 15 - 通知和提醒：设置提醒偏好
FR141: Epic 7 - 数据导入导出：支持从 Excel 文件迁移历史数据
FR142: Epic 1 - 系统基础设置：通过用户界面查看数据备份状态和执行数据恢复操作
FR143: Epic 1 - 系统基础设置：通过用户界面查看系统健康状态
FR144: Epic 14 - API 和集成：通过 GraphQL API 提供版本控制能力
FR145: Epic 1 - 系统基础设置：查看系统错误日志和异常记录
FR146: Epic 7 - 数据导入导出：查看数据导入历史
FR147: Epic 1 - 系统基础设置：查看用户活动日志
FR148: Epic 8 - 业务分析：通过图表和可视化方式查看业务分析结果
FR149: Epic 13 - 用户引导和个性化：访问帮助文档和用户指南

## Epic List

**Epic 0: Linear + Data-Dense Minimalism 设计系统基础设施** (新增，最高优先级)

## Epic 0: Linear + Data-Dense Minimalism 设计系统基础设施

**Epic Goal:** 建立 Linear + Data-Dense Minimalism 设计系统基础设施，为所有后续功能开发提供统一的视觉语言和组件库。

**优先级：** 最高（在 Epic 2 之前完成）

**依赖关系：** 无（其他 Epic 依赖此 Epic）

**价值主张：**
- 为用户提供现代化、一致的界面体验
- 为开发团队提供可复用的组件库
- 提升后续开发效率 20-30%
- 避免未来大规模重构（节省 20-29 天）

### Story 0.1: Tailwind CSS 基础设施

As a **开发团队**,
I want **Tailwind CSS 基础设施配置完成**,
So that **后续开发可以直接使用 Tailwind 工具类进行样式开发**.

**Acceptance Criteria:**

**Given** 项目使用 React + TypeScript + Vite
**When** 开发团队安装和配置 Tailwind CSS
**Then** Tailwind CSS 成功安装（tailwindcss, postcss, autoprefixer）
**And** 创建 tailwind.config.js 配置文件
**And** 创建 postcss.config.js 配置文件
**And** 更新 index.css 为 Tailwind 基础样式
**And** Vite 配置支持 Tailwind CSS 处理
**And** 开发环境可以正常使用 Tailwind 类名

### Story 0.2: 设计 Token 系统

As a **开发团队**,
I want **设计 Token 系统建立**,
So that **所有组件可以使用统一的设计变量，确保视觉一致性**.

**Acceptance Criteria:**

**Given** Tailwind CSS 已配置
**When** 开发团队创建设计 Token 系统
**Then** 创建 src/styles/theme.ts 文件
**And** 定义颜色系统（Linear 风格：深色背景、渐变、模糊）
**And** 定义间距系统（统一的间距 scale）
**And** 定义字体系统（无衬线字体、字号 scale）
**And** 定义阴影和模糊系统（backdrop-filter、box-shadow）
**And** 所有 Token 在 Tailwind 配置中可用
**And** 支持深色模式（Linear 风格）

### Story 0.3: 核心 UI 组件库

As a **开发团队**,
I want **核心 UI 组件库完成**,
So that **后续 Stories 可以直接使用这些组件，提升开发效率**.

**Acceptance Criteria:**

**Given** 设计 Token 系统已建立
**When** 开发团队创建核心 UI 组件
**Then** 创建 src/components/ui/ 目录结构
**And** 实现按钮组件（Linear 风格：渐变、微动效）
**And** 实现输入框组件（极细描边、外发光）
**And** 实现卡片组件（玻璃态效果、模糊背景）
**And** 实现表格组件（数据密集、高信息密度）
**And** 所有组件使用设计 Token
**And** 所有组件支持响应式设计
**And** 组件文档完整（JSDoc 注释）

### Story 0.4: 已完成的 Stories UI 改造

As a **开发团队**,
I want **已完成的 Stories UI 改造完成**,
So that **所有已完成的页面使用新设计系统，保持一致性**.

**Acceptance Criteria:**

**Given** 核心 UI 组件库已完成
**When** 开发团队改造已完成的 Stories UI
**Then** 改造 Story 1-1（Twenty CRM 初始部署）的 UI
**And** 改造 Story 1-2（用户认证系统）的 UI
**And** 改造 Story 1-3（用户账户管理）的 UI
**And** 改造 Story 1-4（角色管理系统）的 UI
**And** 所有改造后的页面使用新设计系统
**And** 所有功能保持不变（只改样式）
**And** 所有页面通过回归测试

### Story 0.5: 设计系统文档

As a **开发团队和用户**,
I want **设计系统文档完整**,
So that **团队成员可以快速了解和使用设计系统**.

**Acceptance Criteria:**

**Given** 设计系统和组件库已完成
**When** 开发团队创建设计系统文档
**Then** 创建组件库文档（组件使用指南）
**And** 创建设计 Token 文档（颜色、间距、字体等）
**And** 创建布局指南（三栏布局、响应式设计）
**And** 创建最佳实践文档（何时使用哪个组件）
**And** 文档包含代码示例
**And** 文档可访问（在项目中或在线）

---

## Epic List

**总计：15 个 Epic（Epic 15 为 Growth 阶段）**

**横切关注点说明：**
- **数据验证和错误处理（FR115-FR121）**：作为横切关注点，贯穿所有 Epic。FR115 分配到 Epic 3, 4, 5；FR116 分配到 Epic 4；FR117 分配到所有 Epic；FR118, FR119 分配到 Epic 4, 5；FR120, FR121 已分配到 Epic 7。
- **移动端支持**：已融入到 Epic 4（互动记录）和 Epic 5（快速记录）中，包括移动端在线记录、相册上传、网络重试机制。

### Epic 1: 系统基础设置和用户管理
用户成果：系统可以成功部署，管理员可以管理用户账户和角色，配置系统设置，查看系统健康状态和日志
**FRs covered:** FR78, FR79, FR80, FR81, FR82, FR83, FR84, FR85, FR86, FR87, FR88, FR89, FR142, FR143, FR145, FR147
**Implementation Notes:** Twenty CRM starter setup, Docker deployment, user authentication, role management, system monitoring

### Epic 2: 产品管理
用户成果：管理员可以创建和管理产品，维护产品类别和HS编码映射关系，所有用户可以搜索和查看产品信息，查看产品与客户的关联关系
**FRs covered:** FR1, FR2, FR3, FR4, FR5, FR6, FR8
**Implementation Notes:** Twenty CRM custom objects, product-customer relationships, composite indexes, product association validation, dynamic product category management, category-HS code bidirectional sync, product specifications table-based input

### Epic 3: 客户管理和数据隔离
用户成果：用户可以创建和管理客户（按角色隔离），查看客户与产品的关联，系统自动根据角色过滤数据访问
**FRs covered:** FR9, FR10, FR11, FR12, FR13, FR14, FR15, FR16, FR17, FR18, FR59, FR60, FR61, FR62, FR63, FR64, FR65
**Implementation Notes:** Role-based data isolation, GraphQL Resolver filtering, PostgreSQL RLS, customer type filtering, data validation (FR115, FR117)

### Epic 4: 互动记录核心功能
用户成果：用户可以记录与客户的互动，关联产品，上传附件（照片、文档），查看互动历史。支持移动端在线记录，从相册上传照片，网络不稳定时自动重试
**FRs covered:** FR19, FR20, FR21, FR22, FR23, FR24, FR25, FR26, FR27, FR28, FR29, FR30, FR31
**Implementation Notes:** Product-customer-interaction data model, file upload, timestamp tracking, creator/modifier tracking, mobile responsive design, gallery upload, automatic retry mechanism, mobile network support, data validation (FR116, FR117, FR118, FR119)

### Epic 5: 快速记录功能
用户成果：用户可以快速记录互动，减少数据录入工作量，使用模板和自动完成功能。支持移动端快速记录，移动端优化的界面和交互
**FRs covered:** FR32, FR33, FR34, FR35, FR36, FR37
**Implementation Notes:** Quick record form, auto-completion, templates, smart pre-fill, mobile responsive design, mobile-optimized touch targets, data validation (FR115, FR117, FR118, FR119)

### Epic 6: 搜索和查询
用户成果：用户可以搜索和查询客户、产品、互动记录，支持高级搜索、过滤和排序
**FRs covered:** FR49, FR50, FR51, FR52, FR53, FR54, FR55, FR56, FR57, FR58
**Implementation Notes:** Fuzzy search, advanced filtering, sorting, timeline views, role-based search filtering

### Epic 7: 数据导入导出
用户成果：管理员可以从 Excel 导入历史数据，导出数据用于备份和分析，支持多种格式
**FRs covered:** FR38, FR39, FR40, FR41, FR42, FR43, FR44, FR45, FR46, FR47, FR48, FR120, FR121, FR134, FR135, FR141, FR146
**Implementation Notes:** Asynchronous Excel import (Bull Queue), data validation, progress tracking, export formats (JSON, CSV, Excel), import history, partial success handling, duplicate detection

### Epic 8: 业务分析和仪表板
用户成果：总监和管理员可以查看业务概览、关键指标和分析报表，通过图表可视化业务数据
**FRs covered:** FR70, FR71, FR72, FR73, FR74, FR75, FR76, FR77, FR148
**Implementation Notes:** Business dashboard, analytics, chart visualization, key metrics calculation

### Epic 9: 数据安全和合规
用户成果：系统符合 GDPR 和《个人信息保护法》要求，提供完整审计跟踪，自动加密敏感数据
**FRs covered:** FR90, FR91, FR92, FR93, FR94, FR95, FR96, FR97, FR98, FR99, FR100
**Implementation Notes:** Data encryption (AES-256), audit logging, GDPR compliance, data retention policies, encryption key management

### Epic 10: 协作功能
用户成果：用户可以在互动记录中添加评论进行团队协作，查看评论历史
**FRs covered:** FR101, FR102
**Implementation Notes:** Comments system, team collaboration features

### Epic 11: 批量操作
用户成果：用户可以执行批量操作（批量发送报价、批量编辑、批量删除等），提升操作效率
**FRs covered:** FR113, FR114
**Implementation Notes:** Batch operations, bulk quote sending, bulk edit/delete

### Epic 12: 智能建议和自动化
用户成果：系统可以自动建议可能关联的产品和客户，提升记录效率
**FRs covered:** FR122, FR123
**Implementation Notes:** Smart suggestions based on historical data, auto-completion enhancement

### Epic 13: 用户引导和个性化
用户成果：新用户可以获得引导和帮助，所有用户可以自定义个人偏好和快捷操作
**FRs covered:** FR126, FR127, FR128, FR129, FR130, FR149
**Implementation Notes:** User onboarding, help documentation, personalization settings, quick access customization

### Epic 14: API 和集成
用户成果：系统通过 GraphQL API 提供所有功能，支持第三方集成和 Webhook
**FRs covered:** FR131, FR132, FR133, FR144
**Implementation Notes:** GraphQL API, API versioning, webhook support, third-party integration

### Epic 15: 通知和提醒（Growth 阶段）
用户成果：系统可以自动提醒用户跟进客户、处理待办事项，用户可以设置提醒偏好
**FRs covered:** FR136, FR137, FR138, FR139, FR140
**Implementation Notes:** Notification system, reminder preferences (Growth stage feature)

## Epic 1: 系统基础设置和用户管理

用户成果：系统可以成功部署，管理员可以管理用户账户和角色，配置系统设置，查看系统健康状态和日志

### Story 1.1: Twenty CRM 初始部署和配置

As a **系统管理员**,
I want **部署和配置 Twenty CRM 基础环境**,
So that **系统可以正常运行，为后续功能开发提供基础平台**.

**Acceptance Criteria:**

**Given** 系统管理员有 Docker 和必要的开发环境
**When** 执行部署脚本或按照部署指南操作
**Then** Twenty CRM 系统成功启动，所有容器（server, db, redis, worker）运行正常
**And** 系统可以通过浏览器访问，显示 Twenty CRM 登录页面
**And** 数据库连接正常，Redis 连接正常
**And** 环境变量配置正确（SERVER_URL, APP_SECRET, STORAGE_TYPE 等）
**And** 系统日志显示无错误

**Given** Twenty CRM 系统已部署
**When** 访问系统健康检查端点
**Then** 系统返回健康状态为正常
**And** 数据库连接状态为正常
**And** Redis 连接状态为正常

**Implementation Notes:**
- 使用 Twenty CRM 官方 Docker Compose 配置
- 确保所有必需的环境变量已配置
- 验证 PostgreSQL 和 Redis 连接
- 参考架构文档中的部署策略

---

### Story 1.2: 用户认证系统

As a **所有用户**,
I want **使用用户名和密码登录系统**,
So that **我可以访问系统并执行我的角色权限范围内的操作**.

**Acceptance Criteria:**

**Given** 用户账户已创建（由管理员创建）
**When** 用户在登录页面输入正确的用户名和密码
**Then** 系统验证用户凭据
**And** 用户成功登录，跳转到系统主页
**And** 系统生成并返回 JWT token
**And** 用户的角色信息被正确加载

**Given** 用户在登录页面输入错误的用户名或密码
**When** 用户点击登录按钮
**Then** 系统显示错误消息"用户名或密码错误"
**And** 用户保持在登录页面
**And** 系统不生成 token

**Given** 用户已登录
**When** 用户点击登出按钮
**Then** 用户成功登出，JWT token 被清除
**And** 用户被重定向到登录页面
**And** 用户无法再访问需要认证的页面

**Given** 用户尝试访问需要认证的页面但未登录
**When** 系统检测到未认证的请求
**Then** 用户被重定向到登录页面
**And** 系统保存原始请求 URL，登录后可以重定向回去

**Implementation Notes:**
- 使用 Twenty CRM 的 JWT 认证机制
- 实现基于角色的访问控制（RBAC）
- 确保 token 安全存储和传输
- 参考架构文档中的认证和安全决策

---

### Story 1.3: 用户账户管理

As a **系统管理员**,
I want **创建、编辑和删除用户账户**,
So that **我可以管理系统用户，为新员工创建账户，为离职员工删除账户**.

**Acceptance Criteria:**

**Given** 管理员已登录系统
**When** 管理员在用户管理页面点击"创建新用户"
**Then** 系统显示用户创建表单
**And** 表单包含必填字段：用户名、邮箱、密码、角色
**And** 表单包含可选字段：姓名、部门、联系方式等

**Given** 管理员填写用户创建表单
**When** 管理员提交表单，所有必填字段已填写且格式正确
**Then** 系统创建新用户账户
**And** 用户账户信息保存到数据库
**And** 系统显示成功消息"用户创建成功"
**And** 新用户出现在用户列表中

**Given** 管理员填写用户创建表单
**When** 管理员提交表单，但必填字段缺失或格式错误（如邮箱格式不正确）
**Then** 系统显示验证错误消息
**And** 用户账户不被创建
**And** 表单保持填写状态，允许用户修正错误

**Given** 用户账户已存在
**When** 管理员在用户列表中选择用户并点击"编辑"
**Then** 系统显示用户编辑表单，预填充现有用户信息
**And** 管理员可以修改用户信息（姓名、邮箱、角色等，但不能修改用户名）
**And** 管理员提交修改后，系统更新用户信息并显示成功消息

**Given** 用户账户已存在
**When** 管理员在用户列表中选择用户并点击"删除"
**Then** 系统显示确认对话框"确定要删除用户 [用户名] 吗？"
**And** 管理员确认删除后，系统执行软删除（标记为 deleted_at）
**And** 用户账户从用户列表中移除（但数据保留用于审计）
**And** 系统显示成功消息"用户删除成功"

**Given** 管理员尝试删除自己的账户
**When** 管理员选择自己的账户并点击"删除"
**Then** 系统显示错误消息"不能删除自己的账户"
**And** 用户账户不被删除

**Implementation Notes:**
- 使用软删除策略（deleted_at 字段），保留历史数据用于审计
- 实现数据验证（邮箱格式、密码强度等）
- 参考 FR78: 管理员可以创建、编辑和删除用户账户
- 参考架构文档中的软删除决策

---

### Story 1.4: 角色管理系统

As a **系统管理员**,
I want **为用户分配角色（管理员、总监、前端专员、后端专员）**,
So that **我可以控制用户的数据访问权限，确保数据隔离和安全性**.

**Acceptance Criteria:**

**Given** 系统已预定义 4 种角色：管理员、总监、前端专员、后端专员
**When** 管理员在用户创建或编辑表单中选择角色
**Then** 系统显示角色下拉列表，包含所有可用角色
**And** 每个角色有清晰的描述说明其权限范围

**Given** 管理员为用户分配角色
**When** 管理员选择角色并保存
**Then** 用户角色信息保存到数据库
**And** 用户的权限根据角色自动设置
**And** 系统显示成功消息"角色分配成功"

**Given** 用户已分配角色
**When** 用户登录系统
**Then** 系统根据用户角色加载相应的权限
**And** 用户只能访问其角色权限范围内的功能和数据
**And** 前端/后端专员只能访问对应类型的客户数据（采购商/供应商）

**Given** 管理员修改用户的角色
**When** 管理员将用户角色从"前端专员"改为"后端专员"
**Then** 系统更新用户角色
**And** 用户下次登录时，权限根据新角色更新
**And** 系统记录角色变更操作到审计日志（FR65）

**Implementation Notes:**
- 使用 Twenty CRM 的 RBAC 机制
- 实现角色与权限的映射关系
- 参考 FR79: 管理员可以为用户分配角色
- 参考架构文档中的权限过滤策略（GraphQL Resolver + PostgreSQL RLS）
- 确保角色变更时数据访问权限正确更新

---

### Story 1.5: 系统设置管理

As a **系统管理员**,
I want **配置系统设置（数据保留策略、备份策略等）**,
So that **我可以根据业务需求定制系统行为，确保数据安全和合规**.

**Acceptance Criteria:**

**Given** 管理员已登录系统
**When** 管理员访问系统设置页面
**Then** 系统显示系统设置表单
**And** 表单包含可配置项：数据保留策略（默认 7 年）、备份策略、系统参数等

**Given** 管理员修改数据保留策略
**When** 管理员将数据保留策略从默认值修改为其他值（如 5 年或 10 年）
**Then** 系统保存新的数据保留策略配置
**And** 系统显示成功消息"系统设置已更新"
**And** 新的保留策略在下次数据清理任务时生效

**Given** 管理员修改备份策略
**When** 管理员配置备份频率（每日、每周等）和备份保留天数（默认 30 天）
**Then** 系统保存备份策略配置
**And** 系统根据配置自动执行备份任务
**And** 系统显示成功消息"备份策略已更新"

**Given** 管理员修改系统设置
**When** 管理员提交无效的配置值（如保留天数小于 0）
**Then** 系统显示验证错误消息
**And** 配置不被保存
**And** 表单保持填写状态，允许管理员修正错误

**Given** 系统设置已配置
**When** 系统执行自动任务（数据清理、备份等）
**Then** 系统使用配置的设置值
**And** 系统记录任务执行结果到日志

**Implementation Notes:**
- 使用数据库表或配置文件存储系统设置
- 实现设置验证和默认值
- 参考 FR80: 管理员可以配置系统设置
- 确保设置变更被记录到审计日志

---

### Story 1.6: 系统监控和日志查看

As a **系统管理员**,
I want **查看系统健康状态、系统日志和错误日志**,
So that **我可以监控系统运行状态，及时发现和解决问题**.

**Acceptance Criteria:**

**Given** 管理员已登录系统
**When** 管理员访问系统监控页面
**Then** 系统显示系统健康状态面板
**And** 面板显示：数据库连接状态、Redis 连接状态、服务运行状态
**And** 每个状态项显示为"正常"或"异常"，异常时显示红色警告

**Given** 管理员查看系统日志
**When** 管理员访问系统日志页面
**Then** 系统显示日志列表，按时间倒序排列
**And** 每条日志显示：时间戳、日志级别（error, warn, info, debug）、消息内容、用户 ID（如果有）
**And** 管理员可以按日志级别、时间范围、用户 ID 过滤日志
**And** 管理员可以搜索日志内容

**Given** 管理员查看错误日志
**When** 管理员访问错误日志页面
**Then** 系统显示所有错误和异常记录
**And** 每条错误记录显示：时间戳、错误类型、错误消息、堆栈跟踪（开发环境）、相关用户 ID
**And** 管理员可以按错误类型、时间范围过滤错误
**And** 管理员可以查看错误详情

**Given** 管理员查看审计日志
**When** 管理员访问审计日志页面
**Then** 系统显示所有审计记录（数据访问、数据修改、权限操作等）
**And** 每条审计记录显示：时间戳、操作类型、操作者、操作对象、操作详情
**And** 管理员可以按操作类型、操作者、时间范围查询审计日志
**And** 审计日志保留 1 年（可配置）

**Given** 系统发生错误
**When** 系统记录错误到日志
**Then** 错误信息包含：错误代码、错误消息、上下文信息、用户 ID、时间戳
**And** 错误被正确分类（系统错误、业务错误、用户错误）
**And** 管理员可以在错误日志页面查看该错误

**Implementation Notes:**
- 使用 Winston 进行结构化日志记录
- 实现日志级别过滤和搜索功能
- 参考 FR81: 管理员可以查看系统日志和审计日志
- 参考 FR145: 管理员可以查看系统错误日志和异常记录
- 参考 FR147: 管理员可以查看用户活动日志
- 参考架构文档中的监控和日志策略

---

### Story 1.7: 数据备份和恢复

As a **系统管理员**,
I want **系统自动执行数据备份，我可以查看备份状态和执行数据恢复**,
So that **我可以保护数据安全，在数据丢失时能够快速恢复**.

**Acceptance Criteria:**

**Given** 系统已配置备份策略
**When** 系统到达备份时间（每日自动备份）
**Then** 系统自动执行数据备份任务
**And** 备份数据保存到配置的存储位置
**And** 系统验证备份数据的完整性
**And** 系统记录备份操作到日志（备份时间、备份文件、备份状态）

**Given** 管理员已登录系统
**When** 管理员访问数据备份页面
**Then** 系统显示备份状态信息
**And** 显示最近一次备份时间、备份状态（成功/失败）、备份文件大小
**And** 显示备份历史列表（最近 30 天的备份记录）
**And** 管理员可以查看每个备份的详细信息

**Given** 备份任务执行失败
**When** 系统检测到备份失败
**Then** 系统记录错误信息到日志
**And** 系统发送告警通知给管理员（如果配置了告警）
**And** 备份状态页面显示失败状态和错误原因

**Given** 管理员需要恢复数据
**When** 管理员在备份页面选择备份文件并点击"恢复"
**Then** 系统显示确认对话框"确定要从备份 [备份时间] 恢复数据吗？此操作将覆盖当前数据。"
**And** 管理员确认后，系统执行数据恢复操作
**And** 系统显示恢复进度
**And** 恢复完成后，系统显示成功消息"数据恢复成功"
**And** 恢复操作完成时间 < 30 分钟（从备份恢复）

**Given** 管理员执行数据恢复
**When** 系统执行恢复操作
**Then** 系统在恢复前创建当前数据的快照备份（防止恢复失败）
**And** 系统验证备份文件的完整性
**And** 系统执行恢复操作，覆盖当前数据
**And** 系统验证恢复后的数据完整性
**And** 系统记录恢复操作到审计日志

**Given** 系统执行自动备份
**When** 备份任务完成
**Then** 系统自动清理超过保留期的备份（默认保留 30 天）
**And** 系统记录清理操作到日志

**Implementation Notes:**
- 使用 PostgreSQL 的备份工具（pg_dump）或 Twenty CRM 的备份机制
- 实现备份任务调度（使用 cron 或任务队列）
- 参考 FR82: 管理员可以查看数据备份状态
- 参考 FR83: 管理员可以执行数据恢复操作
- 参考 FR85: 系统可以自动执行每日数据备份
- 参考 FR86: 系统可以自动验证备份数据的完整性
- 参考 FR142: 管理员可以通过用户界面查看数据备份状态和执行数据恢复操作
- 确保备份和恢复操作被记录到审计日志

---

## Epic 2: 产品管理

用户成果：管理员可以创建和管理产品，维护产品类别和HS编码映射关系，所有用户可以搜索和查看产品信息，查看产品与客户的关联关系

### Story 2.1: 产品创建和管理

As a **系统管理员**,
I want **创建、编辑和删除产品对象**,
So that **我可以管理系统中的产品信息，为业务互动提供产品基础数据**.

**Acceptance Criteria:**

**Given** 管理员已登录系统
**When** 管理员访问产品管理页面
**Then** 系统显示产品列表
**And** 管理员可以点击"创建新产品"按钮

**Given** 管理员点击"创建新产品"
**When** 系统显示产品创建表单
**Then** 表单包含必填字段：产品名称、产品HS编码、产品类别
**And** 表单包含可选字段：产品描述、产品规格、产品图片等
**And** 系统提供产品类别下拉列表（从预定义类别中选择）

**Given** 管理员填写产品创建表单
**When** 管理员提交表单，所有必填字段已填写且格式正确
**Then** 系统使用 Twenty CRM Custom Objects API 创建产品对象
**And** 产品信息保存到数据库
**And** 系统显示成功消息"产品创建成功"
**And** 新产品出现在产品列表中

**Given** 管理员填写产品创建表单
**When** 管理员提交表单，但必填字段缺失或产品HS编码格式不正确
**Then** 系统显示验证错误消息（如"产品名称不能为空"、"HS编码格式不正确"）
**And** 产品不被创建
**And** 表单保持填写状态，允许管理员修正错误

**Given** 产品已存在
**When** 管理员在产品列表中选择产品并点击"编辑"
**Then** 系统显示产品编辑表单，预填充现有产品信息
**And** 管理员可以修改产品信息（名称、描述、规格等，但不能修改产品HS编码）
**And** 管理员提交修改后，系统更新产品信息并显示成功消息

**Given** 产品已存在且有关联的互动记录
**When** 管理员尝试删除产品
**Then** 系统显示确认对话框"确定要删除产品 [产品名称] 吗？"
**And** 系统检查产品是否有关联的互动记录
**And** 如果有关联记录，系统执行软删除（标记为 inactive），保留历史记录
**And** 如果无关联记录，系统可以执行硬删除
**And** 产品从产品列表中移除（或标记为 inactive）
**And** 系统显示成功消息"产品删除成功"

**Given** 产品被标记为 inactive
**When** 用户搜索产品
**Then** inactive 产品默认不显示在搜索结果中
**And** 管理员可以选择显示 inactive 产品

**Implementation Notes:**
- 使用 Twenty CRM Custom Objects API 创建产品对象
- 实现软删除策略（标记为 inactive），保留历史互动记录
- 参考 FR1: 管理员可以创建、编辑和删除产品对象
- 参考架构文档中的产品关联数据模型（ADR-002）
- 确保产品删除时不影响历史互动记录

---

### Story 2.2: 产品搜索功能

As a **所有用户**,
I want **根据产品名称、产品HS编码或产品类别搜索产品**,
So that **我可以快速找到需要的产品信息**.

**Acceptance Criteria:**

**Given** 用户已登录系统
**When** 用户访问产品搜索页面或在产品列表页面使用搜索框
**Then** 系统显示搜索输入框
**And** 搜索框支持按产品名称、产品HS编码、产品类别搜索

**Given** 用户在搜索框输入产品名称（支持模糊搜索）
**When** 用户输入产品名称的部分字符（如"不锈钢"）
**Then** 系统实时显示匹配的产品列表（输入后自动搜索，无需点击搜索按钮）
**And** 匹配的产品按相关性排序（完全匹配优先，部分匹配其次）
**And** 搜索结果响应时间 < 1 秒（P95）

**Given** 用户在搜索框输入产品HS编码
**When** 用户输入完整的或部分 HS 编码
**Then** 系统显示匹配的产品列表
**And** 完全匹配的 HS 编码优先显示

**Given** 用户选择产品类别进行搜索
**When** 用户从类别下拉列表中选择类别（如"电子产品"）
**Then** 系统显示该类别下的所有产品
**And** 产品列表按产品名称排序

**Given** 用户进行搜索
**When** 搜索结果为空
**Then** 系统显示空状态提示"未找到匹配的产品"
**And** 系统提供建议"尝试使用不同的搜索关键词"

**Given** 用户进行搜索
**When** 搜索结果数量较多（> 20 条）
**Then** 系统使用分页显示结果
**And** 每页显示 20 条产品
**And** 用户可以翻页查看更多结果

**Implementation Notes:**
- 实现模糊搜索功能（使用 PostgreSQL 的 LIKE 或全文搜索）
- 优化搜索性能，使用数据库索引（产品名称、HS编码、类别）
- 参考 FR2: 所有用户可以根据产品名称、产品HS编码或产品类别搜索产品
- 参考 FR50: 所有用户可以根据产品名称、产品HS编码、产品类别搜索产品（支持模糊搜索）
- 实现搜索结果的实时更新（debounce 优化）

---

### Story 2.3: 产品详情查看

As a **所有用户**,
I want **查看产品的详细信息**,
So that **我可以了解产品的完整信息，包括名称、代码、类别、描述、规格等**.

**Acceptance Criteria:**

**Given** 用户已登录系统
**When** 用户在产品列表或搜索结果中点击产品
**Then** 系统显示产品详情页面
**And** 页面显示产品的完整信息：产品名称、产品HS编码、产品类别、产品描述、产品规格等

**Given** 用户查看产品详情
**When** 产品有图片
**Then** 系统显示产品图片
**And** 用户可以点击图片查看大图

**Given** 用户查看产品详情
**When** 产品信息不完整（某些字段为空）
**Then** 系统显示可用信息
**And** 空字段不显示或显示为"未设置"

**Given** 用户查看产品详情
**When** 用户是管理员
**Then** 系统显示"编辑"和"删除"按钮
**And** 管理员可以编辑或删除产品

**Given** 用户查看产品详情
**When** 用户是普通用户（前端/后端专员、总监）
**Then** 系统不显示"编辑"和"删除"按钮
**And** 用户只能查看产品信息

**Implementation Notes:**
- 使用 Twenty CRM Custom Objects API 获取产品详情
- 实现产品信息的完整显示
- 参考 FR3: 所有用户可以查看产品的详细信息
- 确保产品详情页面响应式设计，支持移动端查看

---

### Story 2.4: 产品与客户关联查看（按角色）

As a **前端专员/后端专员/总监/管理员**,
I want **查看某个产品与哪些客户有关联**,
So that **我可以了解产品的客户关系，分析产品的业务情况**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统
**When** 前端专员查看产品详情页面
**Then** 系统显示"关联的采购商"部分
**And** 系统只显示该产品关联的采购商类型客户
**And** 系统不显示供应商类型客户

**Given** 后端专员已登录系统
**When** 后端专员查看产品详情页面
**Then** 系统显示"关联的供应商"部分
**And** 系统只显示该产品关联的供应商类型客户
**And** 系统不显示采购商类型客户

**Given** 总监或管理员已登录系统
**When** 总监或管理员查看产品详情页面
**Then** 系统显示"关联的客户"部分
**And** 系统显示该产品关联的所有客户（包括采购商和供应商）
**And** 客户列表按客户类型分组显示

**Given** 用户查看产品与客户的关联
**When** 产品有关联的客户
**Then** 系统显示客户列表，每个客户显示：客户名称、客户类型、关联的互动数量
**And** 用户可以点击客户名称查看客户详情
**And** 用户可以点击"查看互动历史"查看该产品与该客户的完整互动记录

**Given** 用户查看产品与客户的关联
**When** 产品没有关联的客户
**Then** 系统显示空状态"该产品尚未与任何客户关联"
**And** 系统提供提示"记录互动时关联此产品，即可建立关联关系"

**Given** 用户查看产品与客户的关联
**When** 关联的客户数量较多（> 10 个）
**Then** 系统使用分页或滚动加载显示客户列表
**And** 系统显示关联客户总数

**Implementation Notes:**
- 使用 Twenty CRM Relationship Fields 查询产品与客户的关联
- 实现基于角色的数据过滤（前端专员只看到采购商，后端专员只看到供应商）
- 参考 FR4: 前端专员可以查看某个产品与哪些采购商有关联；后端专员可以查看某个产品与哪些供应商有关联；总监和管理员可以查看某个产品与哪些客户（供应商/采购商）有关联
- 参考架构文档中的权限过滤策略（GraphQL Resolver + PostgreSQL RLS）
- 优化查询性能，使用复合索引（product_id + customer_type）

---

### Story 2.5: 产品与客户互动历史查看

As a **前端专员/后端专员/总监/管理员**,
I want **查看某个产品与某个客户的完整互动历史**,
So that **我可以了解该产品与该客户的业务往来情况，跟踪业务进展**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统
**When** 前端专员在产品详情页面选择某个采购商，点击"查看互动历史"
**Then** 系统显示该产品与该采购商的完整互动历史
**And** 互动记录按时间顺序排列（最新的在前）
**And** 每条互动记录显示：互动类型、互动时间、互动描述、创建者等

**Given** 后端专员已登录系统
**When** 后端专员在产品详情页面选择某个供应商，点击"查看互动历史"
**Then** 系统显示该产品与该供应商的完整互动历史
**And** 互动记录按时间顺序排列
**And** 系统只显示后端专员有权限查看的互动记录

**Given** 总监或管理员已登录系统
**When** 总监或管理员在产品详情页面选择某个客户，点击"查看互动历史"
**Then** 系统显示该产品与该客户的完整互动历史
**And** 系统显示所有类型的互动记录（采购商和供应商的互动）

**Given** 用户查看产品与客户的互动历史
**When** 互动记录包含附件（照片、文档等）
**Then** 系统在互动记录中显示附件图标
**And** 用户可以点击附件查看或下载

**Given** 用户查看产品与客户的互动历史
**When** 互动历史记录较多（> 20 条）
**Then** 系统使用分页或滚动加载显示互动记录
**And** 系统显示互动记录总数

**Given** 用户查看产品与客户的互动历史
**When** 没有互动记录
**Then** 系统显示空状态"该产品与该客户尚未有任何互动记录"
**And** 系统提供"记录新互动"按钮，用户可以快速记录互动

**Implementation Notes:**
- 使用 Twenty CRM Relationship Fields 查询产品-客户-互动关联
- 实现基于角色的数据过滤
- 参考 FR5: 前端专员可以查看某个产品与某个采购商的完整互动历史（按时间顺序）；后端专员可以查看某个产品与某个供应商的完整互动历史（按时间顺序）；总监和管理员可以查看某个产品与某个客户的完整互动历史（按时间顺序）
- 优化查询性能，使用复合索引（product_id + customer_id + created_at）
- 实现互动记录的排序和分页

---

### Story 2.6: 产品业务流程查看

As a **前端专员/后端专员/总监/管理员**,
I want **查看某个产品与客户的完整业务流程**,
So that **我可以了解该产品的业务进展，从询价到订单完成的完整流程**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统
**When** 前端专员在产品详情页面选择某个采购商，点击"查看业务流程"
**Then** 系统显示该产品与该采购商的完整业务流程视图
**And** 业务流程按阶段显示：初步接触 → 产品询价 → 报价 → 接受/拒绝报价 → 签署订单 → 完成订单
**And** 每个阶段显示：阶段状态（已完成/进行中/未开始）、完成时间、相关互动记录

**Given** 后端专员已登录系统
**When** 后端专员在产品详情页面选择某个供应商，点击"查看业务流程"
**Then** 系统显示该产品与该供应商的完整业务流程视图
**And** 业务流程按阶段显示：询价产品 → 接收报价 → 产品规格确认 → 生产进度跟进 → 发货前验收
**And** 每个阶段显示：阶段状态、完成时间、相关互动记录

**Given** 总监或管理员已登录系统
**When** 总监或管理员在产品详情页面选择某个客户，点击"查看业务流程"
**Then** 系统显示该产品与该客户的完整业务流程视图
**And** 系统根据客户类型显示相应的业务流程（采购商显示采购流程，供应商显示供应流程）

**Given** 用户查看产品业务流程
**When** 业务流程有多个阶段已完成
**Then** 系统以时间线或流程图形式显示业务流程
**And** 已完成的阶段显示为绿色，进行中的阶段显示为黄色，未开始的阶段显示为灰色
**And** 用户可以点击每个阶段查看详细的互动记录

**Given** 用户查看产品业务流程
**When** 业务流程尚未开始（没有任何互动记录）
**Then** 系统显示空状态"该产品与该客户尚未开始业务流程"
**And** 系统提供"开始业务流程"提示，引导用户记录第一次互动

**Implementation Notes:**
- 基于互动记录构建业务流程视图
- 实现业务流程的阶段识别和状态判断
- 参考 FR6: 前端专员可以查看某个产品与采购商的完整业务流程（从询价到订单完成）；后端专员可以查看某个产品与供应商的完整业务流程（从询价到订单完成）；总监和管理员可以查看某个产品的完整业务流程（从询价到订单完成）
- 使用时间线或流程图组件展示业务流程
- 优化查询性能，减少数据库查询次数

---

### Story 2.7: 产品关联完整性验证

As a **系统**,
I want **自动验证产品关联的完整性**,
So that **确保所有互动记录都正确关联到产品，保证数据完整性和业务逻辑正确性**.

---

### Story 2.8: 产品类别管理

As a **系统管理员**,
I want **创建、编辑和删除产品类别，并维护类别与HS编码的映射关系**,
So that **我可以灵活管理产品类别，系统能够自动关联类别和HS编码，提升产品创建效率**.

**Acceptance Criteria:**

**Given** 管理员已登录系统
**When** 管理员访问产品管理页面
**Then** 系统显示"类别管理"入口
**And** 管理员可以点击进入类别管理页面

**Given** 管理员进入类别管理页面
**When** 系统显示类别列表
**Then** 列表显示所有产品类别（名称、HS编码、描述、使用统计）
**And** 每个类别显示使用该类别的产品数量
**And** 管理员可以创建、编辑、删除类别

**Given** 管理员创建新类别
**When** 管理员填写类别名称和HS编码
**Then** 系统验证类别名称和HS编码的唯一性
**And** 系统验证HS编码格式
**And** 类别创建成功后出现在列表中

**Given** 管理员尝试删除类别
**When** 类别被产品使用
**Then** 系统阻止删除并显示使用统计
**And** 系统提示"请先删除或修改使用该类别的产品"

**Given** 类别管理功能已实现
**When** 管理员在产品创建表单中选择类别
**Then** 系统自动填充对应的HS编码
**And** 当管理员输入HS编码时，系统自动查找并填充对应的类别（如果存在）

**Implementation Notes:**
- 创建 `product_categories` 数据库表
- 实现类别CRUD操作
- 实现类别使用统计查询
- 实现类别-HS编码双向联动（Story 2.1集成）
- 参考会议记录：meeting-notes-2025-12-29-product-management-enhancements.md

**Acceptance Criteria:**

**Given** 用户创建互动记录
**When** 用户提交互动记录表单
**Then** 系统验证产品关联字段是否已填写
**And** 如果产品关联字段为空，系统显示验证错误"产品关联是必填项"
**And** 互动记录不被创建

**Given** 用户创建互动记录
**When** 用户选择产品并提交表单
**Then** 系统验证所选产品是否存在且为 active 状态
**And** 如果产品不存在或为 inactive，系统显示验证错误"所选产品无效"
**And** 互动记录不被创建

**Given** 系统执行数据验证任务
**When** 系统检查所有互动记录
**Then** 系统识别所有未关联产品的互动记录
**And** 系统生成验证报告，列出所有不符合规则的数据
**And** 系统记录验证结果到日志

**Given** 系统检测到数据完整性问题
**When** 系统发现互动记录缺少产品关联
**Then** 系统标记该记录为"需要修复"
**And** 系统通知管理员或相关用户
**And** 系统在验证报告中显示该问题

**Given** 管理员查看数据验证报告
**When** 管理员访问数据验证页面
**Then** 系统显示验证结果摘要：总记录数、符合规则数、不符合规则数
**And** 系统显示不符合规则的记录列表
**And** 管理员可以查看每条记录的详细信息
**And** 管理员可以手动修复不符合规则的记录

**Implementation Notes:**
- 在创建互动记录时进行实时验证
- 实现定期数据完整性检查任务（后台任务）
- 参考 FR8: 系统可以自动验证产品关联的完整性（确保所有互动都关联到产品）
- 参考横切关注点 FR116: 自动验证产品-客户-互动关联的数据完整性
- 使用数据库约束和业务逻辑验证双重保障
- 确保验证性能不影响正常业务操作

---

## Epic 3: 客户管理和数据隔离

用户成果：用户可以创建和管理客户（按角色隔离），查看客户与产品的关联，系统自动根据角色过滤数据访问

### Story 3.1: 客户创建和管理（按角色）

As a **前端专员/后端专员/总监/管理员**,
I want **创建、编辑和删除客户记录**,
So that **我可以管理我负责的客户信息，建立和维护客户关系**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统
**When** 前端专员访问客户管理页面
**Then** 系统只显示采购商类型的客户
**And** 系统不显示供应商类型的客户
**And** 前端专员可以点击"创建新采购商"按钮

**Given** 后端专员已登录系统
**When** 后端专员访问客户管理页面
**Then** 系统只显示供应商类型的客户
**And** 系统不显示采购商类型的客户
**And** 后端专员可以点击"创建新供应商"按钮

**Given** 总监或管理员已登录系统
**When** 总监或管理员访问客户管理页面
**Then** 系统显示所有类型的客户（采购商和供应商）
**And** 系统提供客户类型筛选功能
**And** 总监或管理员可以点击"创建新客户"按钮

**Given** 用户点击"创建新客户"
**When** 系统显示客户创建表单
**Then** 表单包含必填字段：客户名称、客户代码、客户类型
**And** 表单包含可选字段：地址、联系方式、行业、规模、备注等
**And** 前端专员只能选择"采购商"类型，后端专员只能选择"供应商"类型，总监和管理员可以选择任意类型

**Given** 用户填写客户创建表单
**When** 用户提交表单，所有必填字段已填写且格式正确
**Then** 系统使用 Twenty CRM Custom Objects API 创建客户对象
**And** 客户信息保存到数据库，客户类型字段正确设置
**And** 系统显示成功消息"客户创建成功"
**And** 新客户出现在客户列表中
**And** 系统根据用户角色自动过滤显示（前端专员只看到采购商，后端专员只看到供应商）

**Given** 用户填写客户创建表单
**When** 用户提交表单，但必填字段缺失或客户代码格式不正确
**Then** 系统显示验证错误消息（如"客户名称不能为空"、"客户代码格式不正确"）
**And** 客户不被创建
**And** 表单保持填写状态，允许用户修正错误

**Given** 客户已存在
**When** 用户在客户列表中选择客户并点击"编辑"
**Then** 系统显示客户编辑表单，预填充现有客户信息
**And** 用户只能编辑自己角色权限范围内的客户
**And** 前端专员不能编辑供应商，后端专员不能编辑采购商
**And** 用户提交修改后，系统更新客户信息并显示成功消息

**Given** 客户已存在且有关联的互动记录
**When** 用户尝试删除客户
**Then** 系统显示确认对话框"确定要删除客户 [客户名称] 吗？"
**And** 系统检查客户是否有关联的互动记录
**And** 如果有关联记录，系统执行软删除（标记为 inactive），保留历史记录
**And** 如果无关联记录，系统可以执行硬删除
**And** 客户从客户列表中移除（或标记为 inactive）
**And** 系统显示成功消息"客户删除成功"

**Implementation Notes:**
- 使用 Twenty CRM Custom Objects API 创建客户对象
- 实现基于角色的数据过滤（GraphQL Resolver + PostgreSQL RLS）
- 实现软删除策略（标记为 inactive），保留历史互动记录
- 参考 FR11: 前端专员可以创建、编辑和删除采购商记录；后端专员可以创建、编辑和删除供应商记录；总监和管理员可以创建、编辑和删除客户记录
- 参考 FR12: 前端专员只能查看和管理采购商类型的客户
- 参考 FR13: 后端专员只能查看和管理供应商类型的客户
- 参考 FR14: 总监和管理员可以查看和管理所有类型的客户
- 参考横切关注点 FR115: 手动录入数据时验证数据格式和完整性
- 参考横切关注点 FR117: 操作失败时提供错误信息和恢复建议
- 确保客户删除时不影响历史互动记录

---

### Story 3.2: 客户搜索功能（按角色）

As a **前端专员/后端专员/总监/管理员**,
I want **根据客户名称、客户代码或客户类型搜索客户**,
So that **我可以快速找到需要的客户信息**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统
**When** 前端专员在客户搜索框输入搜索关键词
**Then** 系统只搜索采购商类型的客户
**And** 系统不搜索供应商类型的客户
**And** 搜索结果只显示采购商

**Given** 后端专员已登录系统
**When** 后端专员在客户搜索框输入搜索关键词
**Then** 系统只搜索供应商类型的客户
**And** 系统不搜索采购商类型的客户
**And** 搜索结果只显示供应商

**Given** 总监或管理员已登录系统
**When** 总监或管理员在客户搜索框输入搜索关键词
**Then** 系统搜索所有类型的客户（采购商和供应商）
**And** 搜索结果可以按客户类型筛选

**Given** 用户在搜索框输入客户名称（支持模糊搜索）
**When** 用户输入客户名称的部分字符（如"ABC"）
**Then** 系统实时显示匹配的客户列表（输入后自动搜索，debounce 优化）
**And** 匹配的客户按相关性排序（完全匹配优先，部分匹配其次）
**And** 搜索结果响应时间 < 1 秒（P95）
**And** 系统根据用户角色自动过滤结果（前端专员只看到采购商，后端专员只看到供应商）

**Given** 用户在搜索框输入客户代码
**When** 用户输入完整的或部分客户代码
**Then** 系统显示匹配的客户列表
**And** 完全匹配的客户代码优先显示

**Given** 用户选择客户类型进行搜索
**When** 前端专员选择"采购商"类型
**Then** 系统显示所有采购商类型的客户
**And** 后端专员选择"供应商"类型，系统显示所有供应商类型的客户
**And** 总监或管理员可以选择任意类型或"全部"

**Given** 用户进行搜索
**When** 搜索结果为空
**Then** 系统显示空状态"未找到匹配的客户"
**And** 系统提供建议"尝试使用不同的搜索关键词"

**Given** 用户进行搜索
**When** 搜索结果数量较多（> 20 条）
**Then** 系统使用分页显示结果
**And** 每页显示 20 条客户
**And** 用户可以翻页查看更多结果

**Implementation Notes:**
- 实现模糊搜索功能（使用 PostgreSQL 的 LIKE 或全文搜索）
- 优化搜索性能，使用数据库索引（客户名称、客户代码、客户类型）
- 实现基于角色的搜索过滤（GraphQL Resolver 层过滤）
- 参考 FR9: 前端专员可以根据采购商名称、采购商代码或客户类型搜索采购商；后端专员可以根据供应商名称、供应商代码或客户类型搜索供应商；总监和管理员可以根据客户名称、客户代码或客户类型搜索客户
- 参考 FR49: 前端专员可以根据采购商名称、采购商代码、客户类型搜索采购商（支持模糊搜索）；后端专员可以根据供应商名称、供应商代码、客户类型搜索供应商（支持模糊搜索）；总监和管理员可以根据客户名称、客户代码、客户类型搜索客户（支持模糊搜索）
- 实现搜索结果的实时更新（debounce 优化）

---

### Story 3.3: 客户详情查看（按角色）

As a **前端专员/后端专员/总监/管理员**,
I want **查看客户的详细信息**,
So that **我可以了解客户的完整信息，包括名称、地址、联系方式、行业、规模等**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统
**When** 前端专员在客户列表或搜索结果中点击采购商
**Then** 系统显示采购商详情页面
**And** 页面显示客户的完整信息：客户名称、客户代码、客户类型（采购商）、地址、联系方式、行业、规模等
**And** 系统不显示供应商类型的客户详情

**Given** 后端专员已登录系统
**When** 后端专员在客户列表或搜索结果中点击供应商
**Then** 系统显示供应商详情页面
**And** 页面显示客户的完整信息
**And** 系统不显示采购商类型的客户详情

**Given** 总监或管理员已登录系统
**When** 总监或管理员在客户列表或搜索结果中点击客户
**Then** 系统显示客户详情页面
**And** 系统显示所有类型的客户详情（采购商和供应商）

**Given** 用户查看客户详情
**When** 客户信息不完整（某些字段为空）
**Then** 系统显示可用信息
**And** 空字段不显示或显示为"未设置"

**Given** 用户查看客户详情
**When** 用户是管理员
**Then** 系统显示"编辑"和"删除"按钮
**And** 管理员可以编辑或删除客户

**Given** 用户查看客户详情
**When** 用户是前端专员或后端专员
**Then** 系统根据用户角色显示相应的操作按钮
**And** 前端专员可以编辑和删除采购商，后端专员可以编辑和删除供应商

**Given** 用户查看客户详情
**When** 用户是总监
**Then** 系统显示"编辑"和"删除"按钮
**And** 总监可以编辑和删除所有类型的客户，但不能管理用户

**Implementation Notes:**
- 使用 Twenty CRM Custom Objects API 获取客户详情
- 实现基于角色的数据访问控制
- 参考 FR10: 前端专员可以查看采购商的详细信息；后端专员可以查看供应商的详细信息；总监和管理员可以查看客户的详细信息
- 确保客户详情页面响应式设计，支持移动端查看

---

### Story 3.4: 客户与产品关联查看（按角色）

As a **前端专员/后端专员/总监/管理员**,
I want **查看某个客户与哪些产品有关联**,
So that **我可以了解该客户的产品关系，分析客户的业务情况**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统
**When** 前端专员在采购商详情页面查看"关联的产品"部分
**Then** 系统显示该采购商关联的所有产品列表
**And** 每个产品显示：产品名称、产品HS编码、关联的互动数量
**And** 用户可以点击产品名称查看产品详情
**And** 用户可以点击"查看互动历史"查看该采购商与该产品的完整互动记录

**Given** 后端专员已登录系统
**When** 后端专员在供应商详情页面查看"关联的产品"部分
**Then** 系统显示该供应商关联的所有产品列表
**And** 每个产品显示：产品名称、产品HS编码、关联的互动数量
**And** 用户可以点击产品名称查看产品详情
**And** 用户可以点击"查看互动历史"查看该供应商与该产品的完整互动记录

**Given** 总监或管理员已登录系统
**When** 总监或管理员在客户详情页面查看"关联的产品"部分
**Then** 系统显示该客户关联的所有产品列表
**And** 系统显示所有类型的客户（采购商和供应商）关联的产品

**Given** 用户查看客户与产品的关联
**When** 客户有关联的产品
**Then** 产品列表按关联的互动数量排序（互动最多的在前）
**And** 如果产品数量较多（> 10 个），系统使用分页或滚动加载显示

**Given** 用户查看客户与产品的关联
**When** 客户没有关联的产品
**Then** 系统显示空状态"该客户尚未与任何产品关联"
**And** 系统提供提示"记录互动时关联产品，即可建立关联关系"

**Implementation Notes:**
- 使用 Twenty CRM Relationship Fields 查询客户与产品的关联
- 实现基于角色的数据过滤
- 参考 FR15: 前端专员可以查看某个采购商与哪些产品有关联；后端专员可以查看某个供应商与哪些产品有关联；总监和管理员可以查看某个客户与哪些产品有关联
- 优化查询性能，使用复合索引（customer_id + product_id）

---

### Story 3.5: 客户产品互动历史查看（按角色）

As a **前端专员/后端专员/总监/管理员**,
I want **查看某个客户针对某个产品的完整互动历史**,
So that **我可以了解该客户与该产品的业务往来情况，跟踪业务进展**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统
**When** 前端专员在采购商详情页面选择某个产品，点击"查看互动历史"
**Then** 系统显示该采购商针对该产品的完整互动历史
**And** 互动记录按时间顺序排列（最新的在前）
**And** 每条互动记录显示：互动类型、互动时间、互动描述、创建者等
**And** 系统只显示前端专员有权限查看的互动记录

**Given** 后端专员已登录系统
**When** 后端专员在供应商详情页面选择某个产品，点击"查看互动历史"
**Then** 系统显示该供应商针对该产品的完整互动历史
**And** 互动记录按时间顺序排列
**And** 系统只显示后端专员有权限查看的互动记录

**Given** 总监或管理员已登录系统
**When** 总监或管理员在客户详情页面选择某个产品，点击"查看互动历史"
**Then** 系统显示该客户针对该产品的完整互动历史
**And** 系统显示所有类型的互动记录

**Given** 用户查看客户产品互动历史
**When** 互动记录包含附件（照片、文档等）
**Then** 系统在互动记录中显示附件图标
**And** 用户可以点击附件查看或下载

**Given** 用户查看客户产品互动历史
**When** 互动历史记录较多（> 20 条）
**Then** 系统使用分页或滚动加载显示互动记录
**And** 系统显示互动记录总数

**Given** 用户查看客户产品互动历史
**When** 没有互动记录
**Then** 系统显示空状态"该客户与该产品尚未有任何互动记录"
**And** 系统提供"记录新互动"按钮，用户可以快速记录互动

**Implementation Notes:**
- 使用 Twenty CRM Relationship Fields 查询客户-产品-互动关联
- 实现基于角色的数据过滤
- 参考 FR16: 前端专员可以查看某个采购商针对某个产品的完整互动历史；后端专员可以查看某个供应商针对某个产品的完整互动历史；总监和管理员可以查看某个客户针对某个产品的完整互动历史
- 优化查询性能，使用复合索引（customer_id + product_id + created_at）
- 实现互动记录的排序和分页

---

### Story 3.6: 客户时间线视图（按角色）

As a **前端专员/后端专员/总监/管理员**,
I want **查看客户的时间线视图（所有互动按时间顺序显示）**,
So that **我可以按时间顺序查看该客户的所有业务互动，了解客户关系的发展历程**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统
**When** 前端专员在采购商详情页面点击"时间线视图"
**Then** 系统显示该采购商的所有互动记录
**And** 互动记录按时间顺序排列（最新的在前或最旧的在前，用户可选择）
**And** 每条互动记录显示：互动时间、互动类型、关联的产品、互动描述、创建者等
**And** 系统以时间线形式展示，每条记录显示在对应的时间点上

**Given** 后端专员已登录系统
**When** 后端专员在供应商详情页面点击"时间线视图"
**Then** 系统显示该供应商的所有互动记录
**And** 互动记录按时间顺序排列
**And** 系统只显示后端专员有权限查看的互动记录

**Given** 总监或管理员已登录系统
**When** 总监或管理员在客户详情页面点击"时间线视图"
**Then** 系统显示该客户的所有互动记录
**And** 系统显示所有类型的互动记录（采购商和供应商的互动）

**Given** 用户查看客户时间线视图
**When** 时间线记录较多（> 50 条）
**Then** 系统使用虚拟滚动或分页加载显示记录
**And** 系统显示互动记录总数
**And** 用户可以按时间范围筛选（如最近一周、最近一月、最近一年）

**Given** 用户查看客户时间线视图
**When** 用户点击某条互动记录
**Then** 系统显示该互动记录的详细信息
**And** 用户可以查看该互动关联的产品信息
**And** 用户可以查看该互动的附件（如果有）

**Given** 用户查看客户时间线视图
**When** 没有互动记录
**Then** 系统显示空状态"该客户尚未有任何互动记录"
**And** 系统提供"记录新互动"按钮

**Implementation Notes:**
- 使用时间线组件展示互动记录
- 实现基于角色的数据过滤
- 参考 FR17: 前端专员可以查看采购商的时间线视图；后端专员可以查看供应商的时间线视图；总监和管理员可以查看客户的时间线视图
- 优化查询性能，使用索引（customer_id + created_at）
- 实现时间线记录的虚拟滚动或分页加载

---

### Story 3.7: 基于角色的数据访问过滤

As a **系统**,
I want **根据用户角色自动过滤数据访问**,
So that **确保前端专员只能访问采购商数据，后端专员只能访问供应商数据，实现数据隔离**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统
**When** 前端专员访问任何数据（客户、互动、产品关联等）
**Then** 系统在 GraphQL Resolver 层自动过滤数据
**And** 系统只返回采购商类型的数据
**And** 系统不返回供应商类型的数据
**And** 前端专员无法通过任何方式访问供应商数据

**Given** 后端专员已登录系统
**When** 后端专员访问任何数据（客户、互动、产品关联等）
**Then** 系统在 GraphQL Resolver 层自动过滤数据
**And** 系统只返回供应商类型的数据
**And** 系统不返回采购商类型的数据
**And** 后端专员无法通过任何方式访问采购商数据

**Given** 总监已登录系统
**When** 总监访问任何数据
**Then** 系统返回所有类型的数据（采购商和供应商）
**And** 系统不进行数据过滤
**And** 总监可以访问所有数据，但不能管理用户

**Given** 管理员已登录系统
**When** 管理员访问任何数据
**Then** 系统返回所有类型的数据
**And** 系统不进行数据过滤
**And** 管理员可以访问所有数据，并可以管理用户

**Given** 系统执行数据查询
**When** 系统在 GraphQL Resolver 层过滤数据
**Then** 系统根据用户角色自动添加过滤条件
**And** 前端专员的查询自动添加 `customer_type = 'buyer'` 条件
**And** 后端专员的查询自动添加 `customer_type = 'supplier'` 条件
**And** 总监和管理员的查询不添加过滤条件

**Given** 系统在数据库层执行查询
**When** 系统使用 PostgreSQL RLS（Row Level Security）
**Then** RLS 策略作为防御层，确保即使 Resolver 层过滤失效，数据库层也会过滤数据
**And** 前端专员无法通过直接数据库查询访问供应商数据
**And** 后端专员无法通过直接数据库查询访问采购商数据

**Given** 用户尝试访问无权限的数据
**When** 前端专员尝试通过 API 查询供应商数据
**Then** 系统在 Resolver 层拦截请求
**And** 系统返回空结果或权限错误
**And** 系统记录该访问尝试到审计日志

**Implementation Notes:**
- 实现 GraphQL Resolver 层的权限过滤（主要过滤层）
- 实现 PostgreSQL RLS（Row Level Security）作为防御层
- 参考 FR18: 系统可以根据客户类型（供应商/采购商）自动过滤数据访问
- 参考 FR59: 系统可以根据用户角色（管理员、总监、前端专员、后端专员）自动过滤数据访问
- 参考 FR60: 前端专员只能访问采购商类型的数据
- 参考 FR61: 后端专员只能访问供应商类型的数据
- 参考 FR62: 总监可以访问所有数据，但不能管理用户
- 参考 FR63: 管理员可以访问所有数据，并可以管理用户
- 参考 FR64: 系统可以验证所有数据访问操作的权限
- 参考架构文档中的权限过滤策略（ADR-001: GraphQL Resolver + PostgreSQL RLS）
- 确保权限过滤在所有数据访问点都生效（客户、互动、产品关联等）

---

### Story 3.8: 权限操作审计日志

As a **系统**,
I want **记录所有权限相关的操作**,
So that **我可以追踪权限变更历史，确保数据安全和合规**.

**Acceptance Criteria:**

**Given** 系统执行权限相关操作
**When** 管理员为用户分配角色
**Then** 系统记录操作到审计日志
**And** 日志包含：操作时间、操作者、操作类型（角色分配）、目标用户、新角色、旧角色

**Given** 系统执行权限相关操作
**When** 系统检测到用户尝试访问无权限的数据
**Then** 系统记录访问尝试到审计日志
**And** 日志包含：访问时间、用户ID、用户角色、尝试访问的数据类型、访问结果（被拒绝）

**Given** 系统执行权限相关操作
**When** 系统验证数据访问权限
**Then** 系统记录权限验证结果到审计日志（可选，用于调试）
**And** 日志包含：验证时间、用户ID、用户角色、访问的数据类型、验证结果

**Given** 管理员查看审计日志
**When** 管理员访问审计日志页面
**Then** 系统显示所有权限相关的操作记录
**And** 管理员可以按操作类型、操作者、时间范围查询日志
**And** 管理员可以查看每条日志的详细信息

**Given** 系统记录权限操作
**When** 审计日志记录生成
**Then** 日志格式统一，包含所有必需字段
**And** 日志保存到数据库，保留 1 年（可配置）
**And** 日志不可被普通用户修改或删除

**Implementation Notes:**
- 实现权限操作的审计日志记录
- 使用结构化日志格式（Winston）
- 参考 FR65: 系统可以记录所有权限相关的操作（访问、权限授予、权限撤销等）
- 参考架构文档中的审计日志策略
- 确保审计日志的完整性和不可篡改性

---

## Epic 4: 互动记录核心功能

用户成果：用户可以记录与客户的互动，关联产品，上传附件（照片、文档），查看互动历史。支持移动端在线记录，从相册上传照片，网络不稳定时自动重试

### Story 4.1: 互动记录创建（前端专员 - 采购商互动）

As a **前端专员**,
I want **记录与采购商的互动**,
So that **我可以完整记录与采购商的业务往来，包括初步接触、产品询价、报价、接受/拒绝报价、签署订单、完成订单等**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统
**When** 前端专员访问互动记录页面或点击"记录新互动"
**Then** 系统显示互动记录创建表单
**And** 表单包含必填字段：客户（采购商）、产品、互动类型、互动时间
**And** 表单包含可选字段：互动描述、状态、附件等
**And** 客户选择器只显示采购商类型的客户

**Given** 前端专员填写互动记录表单
**When** 前端专员选择采购商、产品、互动类型（初步接触、产品询价、报价、接受/拒绝报价、签署订单、完成订单），填写互动描述和互动时间
**Then** 系统验证所有必填字段已填写
**And** 系统验证产品关联已填写（FR7, FR21）
**And** 系统验证所选客户是采购商类型
**And** 系统验证所选产品存在且为 active 状态

**Given** 前端专员提交互动记录表单
**When** 所有验证通过
**Then** 系统使用 Twenty CRM Custom Objects API 创建互动记录
**And** 互动记录保存到数据库，正确关联到产品和客户
**And** 系统自动记录创建者（前端专员）和时间戳（FR30, FR31）
**And** 系统显示成功消息"互动记录创建成功"
**And** 新互动记录出现在互动历史列表中

**Given** 前端专员提交互动记录表单
**When** 必填字段缺失或验证失败
**Then** 系统显示验证错误消息（如"产品关联是必填项"、"所选客户必须是采购商类型"）
**And** 互动记录不被创建
**And** 表单保持填写状态，允许前端专员修正错误

**Given** 前端专员创建互动记录
**When** 系统保存互动记录
**Then** 系统验证产品-客户-互动关联的完整性（FR116）
**And** 如果验证失败，系统显示错误消息并阻止保存

**Implementation Notes:**
- 使用 Twenty CRM Custom Objects API 创建互动记录
- 实现产品关联验证（必填项）
- 实现基于角色的客户过滤（前端专员只能选择采购商）
- 参考 FR19: 前端专员可以记录与采购商的互动（初步接触、产品询价、报价、接受/拒绝报价、签署订单、完成订单）
- 参考 FR21: 所有用户可以在记录互动时关联产品（必填项）
- 参考 FR30: 系统可以自动记录互动的时间戳
- 参考 FR31: 系统可以自动记录互动的创建者和修改者
- 参考横切关注点 FR116: 自动验证产品-客户-互动关联的数据完整性
- 参考横切关注点 FR117: 操作失败时提供错误信息和恢复建议
- 确保互动记录创建时正确建立产品-客户-互动关联关系

---

### Story 4.2: 互动记录创建（后端专员 - 供应商互动）

As a **后端专员**,
I want **记录与供应商的互动**,
So that **我可以完整记录与供应商的业务往来，包括询价产品、接收报价、产品规格确认、生产进度跟进、发货前验收等**.

**Acceptance Criteria:**

**Given** 后端专员已登录系统
**When** 后端专员访问互动记录页面或点击"记录新互动"
**Then** 系统显示互动记录创建表单
**And** 表单包含必填字段：客户（供应商）、产品、互动类型、互动时间
**And** 表单包含可选字段：互动描述、状态、附件等
**And** 客户选择器只显示供应商类型的客户

**Given** 后端专员填写互动记录表单
**When** 后端专员选择供应商、产品、互动类型（询价产品、接收报价、产品规格确认、生产进度跟进、发货前验收），填写互动描述和互动时间
**Then** 系统验证所有必填字段已填写
**And** 系统验证产品关联已填写（FR7, FR21）
**And** 系统验证所选客户是供应商类型
**And** 系统验证所选产品存在且为 active 状态

**Given** 后端专员提交互动记录表单
**When** 所有验证通过
**Then** 系统使用 Twenty CRM Custom Objects API 创建互动记录
**And** 互动记录保存到数据库，正确关联到产品和客户
**And** 系统自动记录创建者（后端专员）和时间戳（FR30, FR31）
**And** 系统显示成功消息"互动记录创建成功"
**And** 新互动记录出现在互动历史列表中

**Given** 后端专员提交互动记录表单
**When** 必填字段缺失或验证失败
**Then** 系统显示验证错误消息（如"产品关联是必填项"、"所选客户必须是供应商类型"）
**And** 互动记录不被创建
**And** 表单保持填写状态，允许后端专员修正错误

**Given** 后端专员创建互动记录
**When** 系统保存互动记录
**Then** 系统验证产品-客户-互动关联的完整性（FR116）
**And** 如果验证失败，系统显示错误消息并阻止保存

**Implementation Notes:**
- 使用 Twenty CRM Custom Objects API 创建互动记录
- 实现产品关联验证（必填项）
- 实现基于角色的客户过滤（后端专员只能选择供应商）
- 参考 FR20: 后端专员可以记录与供应商的互动（询价产品、接收报价、产品规格确认、生产进度跟进、发货前验收）
- 参考 FR21: 所有用户可以在记录互动时关联产品（必填项）
- 参考 FR30: 系统可以自动记录互动的时间戳
- 参考 FR31: 系统可以自动记录互动的创建者和修改者
- 参考横切关注点 FR116: 自动验证产品-客户-互动关联的数据完整性
- 参考横切关注点 FR117: 操作失败时提供错误信息和恢复建议

---

### Story 4.3: 互动记录附加信息

As a **所有用户**,
I want **在记录互动时添加文本描述、时间、状态等信息**,
So that **我可以提供详细的互动信息，便于后续查看和分析**.

**Acceptance Criteria:**

**Given** 用户填写互动记录表单
**When** 用户在"互动描述"字段输入文本描述
**Then** 系统支持多行文本输入
**And** 系统支持文本格式化（可选，如加粗、列表等）
**And** 系统显示字符计数（可选）

**Given** 用户填写互动记录表单
**When** 用户选择互动时间
**Then** 系统提供日期时间选择器
**And** 系统默认选择当前时间，用户可以修改
**And** 系统验证时间不能是未来时间（业务规则，可选）

**Given** 用户填写互动记录表单
**When** 用户选择互动状态
**Then** 系统根据互动类型显示相应的状态选项
**And** 前端专员的互动状态包括：进行中、已完成、已取消等
**And** 后端专员的互动状态包括：进行中、已完成、已取消、需要跟进等

**Given** 用户填写互动记录表单
**When** 用户填写所有信息并提交
**Then** 系统保存所有附加信息到互动记录
**And** 系统在互动历史中正确显示这些信息

**Implementation Notes:**
- 实现富文本编辑器（可选，基础版本可以是纯文本）
- 实现日期时间选择器
- 参考 FR22: 所有用户可以在记录互动时添加文本描述、时间、状态等信息
- 确保附加信息的存储和显示

---

### Story 4.4: 互动记录附件上传（桌面端）

As a **所有用户**,
I want **在记录互动时上传附件（照片、文档等）**,
So that **我可以保存与互动相关的文件，如合同、报价单、产品照片等**.

**Acceptance Criteria:**

**Given** 用户填写互动记录表单
**When** 用户点击"上传附件"按钮
**Then** 系统显示文件选择对话框
**And** 系统支持选择多种文件类型：图片（JPG, PNG, GIF）、文档（PDF, DOC, DOCX, XLS, XLSX）等
**And** 系统显示文件大小限制（如单个文件最大 10MB）

**Given** 用户选择文件上传
**When** 用户选择文件并确认
**Then** 系统开始上传文件
**And** 系统显示上传进度条
**And** 系统在上传过程中显示文件名和上传进度百分比

**Given** 文件上传成功
**When** 文件上传完成
**Then** 系统将文件保存到存储系统（Twenty CRM 的文件存储）
**And** 系统在互动记录表单中显示已上传的文件列表
**And** 每个文件显示：文件名、文件大小、上传时间、预览图标（如果是图片）
**And** 用户可以点击文件名查看或下载文件
**And** 用户可以删除已上传的文件（在上传后、提交前）

**Given** 文件上传失败
**When** 文件上传过程中网络中断或文件过大
**Then** 系统显示错误消息（如"文件上传失败，请重试"或"文件大小超过限制"）
**And** 系统提供"重试"按钮
**And** 用户可以重新选择文件上传

**Given** 用户提交互动记录
**When** 互动记录包含附件
**Then** 系统保存互动记录和附件关联关系
**And** 附件在互动历史中正确显示
**And** 用户可以查看和下载附件

**Implementation Notes:**
- 使用 Twenty CRM 的文件上传机制
- 实现文件上传进度显示
- 实现文件类型和大小验证
- 参考 FR23: 所有用户可以在记录互动时上传附件（照片、文档等）
- 确保文件上传的安全性和性能

---

### Story 4.5: 生产进度跟进照片上传（后端专员）

As a **后端专员**,
I want **在记录生产进度跟进时上传生产照片**,
So that **我可以记录生产现场情况，为后续验收提供依据**.

**Acceptance Criteria:**

**Given** 后端专员填写生产进度跟进互动记录
**When** 后端专员点击"上传生产照片"按钮
**Then** 系统显示照片选择对话框
**And** 系统支持选择多张照片（最多 10 张）
**And** 系统支持从电脑选择照片文件

**Given** 后端专员选择照片上传
**When** 后端专员选择照片并确认
**Then** 系统开始上传照片
**And** 系统显示上传进度条
**And** 系统自动压缩照片（如果照片过大），减少上传时间

**Given** 照片上传成功
**When** 照片上传完成
**Then** 系统将照片保存到存储系统
**And** 系统在表单中显示已上传的照片缩略图
**And** 后端专员可以点击缩略图查看大图
**And** 后端专员可以删除已上传的照片（在上传后、提交前）

**Given** 后端专员提交生产进度跟进记录
**When** 记录包含生产照片
**Then** 系统保存互动记录和照片关联关系
**And** 照片在互动历史中正确显示
**And** 用户可以查看照片大图

**Implementation Notes:**
- 实现多照片上传功能
- 实现照片自动压缩（优化上传性能）
- 实现照片预览功能
- 参考 FR24: 后端专员可以在记录生产进度跟进时上传生产照片
- 确保照片上传的性能和用户体验

---

### Story 4.6: 发货前验收照片上传（后端专员，支持多张）

As a **后端专员**,
I want **在记录发货前验收时上传多张验收照片**,
So that **我可以从多个角度记录验收情况，确保验收记录的完整性**.

**Acceptance Criteria:**

**Given** 后端专员填写发货前验收互动记录
**When** 后端专员点击"上传验收照片"按钮
**Then** 系统显示照片选择对话框
**And** 系统支持选择多张照片（最多 20 张）
**And** 系统支持从电脑选择照片文件
**And** 系统支持拖拽上传照片

**Given** 后端专员选择多张照片上传
**When** 后端专员选择照片并确认
**Then** 系统开始批量上传照片
**And** 系统显示每张照片的上传进度
**And** 系统显示总体上传进度
**And** 系统自动压缩照片（如果照片过大）

**Given** 照片上传成功
**When** 所有照片上传完成
**Then** 系统将照片保存到存储系统
**And** 系统在表单中显示已上传的照片网格视图
**And** 后端专员可以点击照片查看大图
**And** 后端专员可以拖拽照片调整顺序
**And** 后端专员可以为每张照片添加标注（可选，如"正面"、"侧面"、"问题区域"等）
**And** 后端专员可以删除已上传的照片

**Given** 后端专员提交发货前验收记录
**When** 记录包含多张验收照片
**Then** 系统保存互动记录和照片关联关系
**And** 照片按上传顺序或用户调整后的顺序保存
**And** 照片在互动历史中正确显示，支持查看大图和切换照片

**Implementation Notes:**
- 实现多照片批量上传功能
- 实现照片拖拽排序功能
- 实现照片标注功能（可选）
- 参考 FR25: 后端专员可以在记录发货前验收时上传验收照片（支持多张照片）
- 优化批量上传性能，支持并发上传

---

### Story 4.7: 移动端互动记录创建（支持相册上传）

As a **后端专员**,
I want **在移动端记录互动（生产进度、验收等），从相册选择照片上传**,
So that **我可以在工厂现场使用手机记录互动，无需回到办公室**.

**Acceptance Criteria:**

**Given** 后端专员在移动端访问系统
**When** 后端专员点击"记录新互动"按钮
**Then** 系统显示移动端优化的互动记录表单
**And** 表单布局适配移动端屏幕，大按钮、清晰的输入框
**And** 表单包含必填字段：客户（供应商）、产品、互动类型、互动时间
**And** 表单包含可选字段：互动描述、状态、照片等

**Given** 后端专员在移动端填写互动记录
**When** 后端专员选择客户和产品
**Then** 系统显示移动端优化的选择器
**And** 选择器支持搜索和快速选择
**And** 系统只显示供应商类型的客户

**Given** 后端专员在移动端上传照片
**When** 后端专员点击"上传照片"按钮
**Then** 系统显示移动端照片选择选项
**And** 系统提供"从相册选择"选项（使用手机原生相册）
**And** 系统支持选择多张照片（最多 20 张）
**And** 系统不支持直接拍照（使用手机原生相机，从相册选择上传）

**Given** 后端专员从相册选择照片
**When** 后端专员选择照片并确认
**Then** 系统开始上传照片
**And** 系统显示上传进度（每张照片的进度和总体进度）
**And** 系统自动压缩照片，减少上传流量
**And** 系统在网络不稳定时自动重试上传

**Given** 后端专员在移动端提交互动记录
**When** 网络连接正常
**Then** 系统成功保存互动记录和照片
**And** 系统显示成功消息"互动记录创建成功"
**And** 新互动记录出现在互动历史列表中

**Given** 后端专员在移动端提交互动记录
**When** 网络不稳定，上传失败
**Then** 系统显示网络状态提示"网络连接中，请稍候"
**And** 系统自动重试上传（最多 3 次，指数退避）
**And** 如果重试成功，系统保存记录并显示成功消息
**And** 如果重试失败，系统显示错误消息"上传失败，请稍后重试或稍后在办公室完成记录"
**And** 系统提供"稍后重试"选项

**Given** 后端专员在移动端查看上传状态
**When** 系统显示上传状态
**Then** 系统显示清晰的状态指示：连接中、上传中、上传成功、上传失败
**And** 用户可以随时查看上传进度

**Implementation Notes:**
- 实现移动端响应式设计
- 实现从相册选择照片上传（使用 HTML5 file input）
- 实现移动端网络重试机制（自动重试，指数退避）
- 实现照片自动压缩（减少流量消耗）
- 参考移动端支持需求（已融入 Epic 4）
- 参考架构文档中的移动端网络处理策略（ADR-003）
- 参考横切关注点 FR118: 网络中断时自动保存用户输入
- 参考横切关注点 FR119: 检测和处理数据冲突
- 确保移动端体验流畅，网络不稳定时提供清晰的反馈

---

### Story 4.8: 互动历史查看（按角色）

As a **前端专员/后端专员/总监/管理员**,
I want **查看客户的所有互动记录**,
So that **我可以了解与客户的完整业务往来历史**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统
**When** 前端专员在采购商详情页面查看"互动历史"
**Then** 系统显示该采购商的所有互动记录
**And** 互动记录按时间顺序排列（最新的在前）
**And** 每条互动记录显示：互动类型、互动时间、关联的产品、互动描述、创建者等
**And** 系统只显示前端专员有权限查看的互动记录

**Given** 后端专员已登录系统
**When** 后端专员在供应商详情页面查看"互动历史"
**Then** 系统显示该供应商的所有互动记录
**And** 互动记录按时间顺序排列
**And** 系统只显示后端专员有权限查看的互动记录

**Given** 总监或管理员已登录系统
**When** 总监或管理员在客户详情页面查看"互动历史"
**Then** 系统显示该客户的所有互动记录
**And** 系统显示所有类型的互动记录

**Given** 用户查看互动历史
**When** 互动记录包含附件（照片、文档等）
**Then** 系统在互动记录中显示附件图标或缩略图
**And** 用户可以点击附件查看或下载
**And** 如果是照片，用户可以查看大图

**Given** 用户查看互动历史
**When** 互动历史记录较多（> 20 条）
**Then** 系统使用分页或滚动加载显示互动记录
**And** 系统显示互动记录总数

**Given** 用户查看互动历史
**When** 没有互动记录
**Then** 系统显示空状态"该客户尚未有任何互动记录"
**And** 系统提供"记录新互动"按钮

**Implementation Notes:**
- 实现基于角色的数据过滤
- 实现互动记录的排序和分页
- 参考 FR26: 前端专员可以查看某个采购商的所有互动记录；后端专员可以查看某个供应商的所有互动记录；总监和管理员可以查看某个客户的所有互动记录
- 优化查询性能，使用索引（customer_id + created_at）

---

### Story 4.9: 产品与客户互动记录查看（按角色）

As a **前端专员/后端专员/总监/管理员**,
I want **查看某个产品与客户的所有互动记录**,
So that **我可以了解该产品与客户的业务往来情况**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统
**When** 前端专员在产品详情页面选择某个采购商，点击"查看互动记录"
**Then** 系统显示该产品与该采购商的所有互动记录
**And** 互动记录按时间顺序排列
**And** 系统只显示前端专员有权限查看的互动记录

**Given** 后端专员已登录系统
**When** 后端专员在产品详情页面选择某个供应商，点击"查看互动记录"
**Then** 系统显示该产品与该供应商的所有互动记录
**And** 互动记录按时间顺序排列
**And** 系统只显示后端专员有权限查看的互动记录

**Given** 总监或管理员已登录系统
**When** 总监或管理员在产品详情页面选择某个客户，点击"查看互动记录"
**Then** 系统显示该产品与该客户的所有互动记录
**And** 系统显示所有类型的互动记录

**Given** 用户查看产品与客户的互动记录
**When** 互动记录包含附件
**Then** 系统在互动记录中显示附件
**And** 用户可以查看和下载附件

**Given** 用户查看产品与客户的互动记录
**When** 互动记录较多（> 20 条）
**Then** 系统使用分页或滚动加载显示互动记录
**And** 系统显示互动记录总数

**Implementation Notes:**
- 使用 Twenty CRM Relationship Fields 查询产品-客户-互动关联
- 实现基于角色的数据过滤
- 参考 FR27: 前端专员可以查看某个产品与采购商的所有互动记录；后端专员可以查看某个产品与供应商的所有互动记录；总监和管理员可以查看某个产品的所有互动记录
- 优化查询性能，使用复合索引（product_id + customer_id + created_at）

---

### Story 4.10: 客户产品互动记录查看（按角色）

As a **前端专员/后端专员/总监/管理员**,
I want **查看某个客户针对某个产品的所有互动记录**,
So that **我可以了解该客户与该产品的业务往来情况**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统
**When** 前端专员在采购商详情页面选择某个产品，点击"查看互动记录"
**Then** 系统显示该采购商针对该产品的所有互动记录
**And** 互动记录按时间顺序排列
**And** 系统只显示前端专员有权限查看的互动记录

**Given** 后端专员已登录系统
**When** 后端专员在供应商详情页面选择某个产品，点击"查看互动记录"
**Then** 系统显示该供应商针对该产品的所有互动记录
**And** 互动记录按时间顺序排列
**And** 系统只显示后端专员有权限查看的互动记录

**Given** 总监或管理员已登录系统
**When** 总监或管理员在客户详情页面选择某个产品，点击"查看互动记录"
**Then** 系统显示该客户针对该产品的所有互动记录
**And** 系统显示所有类型的互动记录

**Given** 用户查看客户产品互动记录
**When** 互动记录包含附件
**Then** 系统在互动记录中显示附件
**And** 用户可以查看和下载附件

**Given** 用户查看客户产品互动记录
**When** 互动记录较多（> 20 条）
**Then** 系统使用分页或滚动加载显示互动记录
**And** 系统显示互动记录总数

**Implementation Notes:**
- 使用 Twenty CRM Relationship Fields 查询客户-产品-互动关联
- 实现基于角色的数据过滤
- 参考 FR28: 前端专员可以查看某个采购商针对某个产品的所有互动记录；后端专员可以查看某个供应商针对某个产品的所有互动记录；总监和管理员可以查看某个客户针对某个产品的所有互动记录
- 优化查询性能，使用复合索引（customer_id + product_id + created_at）

---

### Story 4.11: 互动记录编辑和删除

As a **所有用户**,
I want **编辑和删除自己创建的互动记录**,
So that **我可以修正错误或删除不需要的记录**.

**Acceptance Criteria:**

**Given** 用户已创建互动记录
**When** 用户在互动历史列表中选择自己创建的互动记录，点击"编辑"
**Then** 系统显示互动记录编辑表单，预填充现有信息
**And** 用户可以修改互动描述、互动时间、状态、附件等
**And** 用户不能修改客户和产品关联（业务规则，如需修改应删除后重新创建）

**Given** 用户编辑互动记录
**When** 用户提交修改
**Then** 系统验证修改后的数据
**And** 系统更新互动记录
**And** 系统自动记录修改者和修改时间（FR31）
**And** 系统显示成功消息"互动记录更新成功"

**Given** 用户已创建互动记录
**When** 用户在互动历史列表中选择自己创建的互动记录，点击"删除"
**Then** 系统显示确认对话框"确定要删除这条互动记录吗？"
**And** 用户确认删除后，系统执行软删除（标记为 deleted_at）
**And** 互动记录从列表中移除（但数据保留用于审计）
**And** 系统显示成功消息"互动记录删除成功"

**Given** 用户尝试编辑或删除其他用户创建的互动记录
**When** 用户点击"编辑"或"删除"按钮
**Then** 系统显示权限错误"您只能编辑/删除自己创建的互动记录"
**And** 系统不执行编辑或删除操作

**Given** 用户删除互动记录
**When** 系统执行软删除
**Then** 系统记录删除操作到审计日志
**And** 系统保留互动记录数据用于历史追溯

**Implementation Notes:**
- 实现软删除策略（标记为 deleted_at）
- 实现基于创建者的权限控制
- 参考 FR29: 所有用户可以编辑和删除自己创建的互动记录
- 参考 FR31: 系统可以自动记录互动的创建者和修改者
- 确保删除操作被记录到审计日志

---

## Epic 5: 快速记录功能

用户成果：用户可以快速记录互动，减少数据录入工作量，使用模板和自动完成功能。支持移动端快速记录，移动端优化的界面和交互

### Story 5.1: 快速记录表单（基础功能）

As a **前端专员/后端专员/总监/管理员**,
I want **使用快速记录功能快速记录互动**,
So that **我可以减少数据录入工作量，提高记录效率**.

**Acceptance Criteria:**

**Given** 用户已登录系统
**When** 用户点击快速记录浮动按钮（桌面端）或快速记录入口（移动端）
**Then** 系统显示快速记录表单（模态框或侧边栏）
**And** 表单包含最少必填字段：产品、客户、互动类型、时间
**And** 表单包含可选字段：互动描述、状态、附件等
**And** 表单设计简洁，减少输入工作量

**Given** 用户填写快速记录表单
**When** 用户选择产品、客户、互动类型，填写互动时间
**Then** 系统验证所有必填字段已填写
**And** 系统验证产品关联已填写（FR34）
**And** 系统根据用户角色自动过滤客户类型（前端专员只看到采购商，后端专员只看到供应商）

**Given** 用户提交快速记录表单
**When** 所有验证通过
**Then** 系统创建互动记录
**And** 系统自动关联当前用户和当前时间（FR35）
**And** 系统显示成功消息"记录创建成功"
**And** 快速记录表单自动关闭或重置，准备下一次记录

**Given** 用户提交快速记录表单
**When** 必填字段缺失
**Then** 系统显示验证错误消息
**And** 表单保持填写状态，高亮显示缺失字段

**Implementation Notes:**
- 实现快速记录浮动按钮（桌面端）和快速记录入口（移动端）
- 实现快速记录表单（模态框或侧边栏）
- 参考 FR32: 前端专员可以使用快速记录功能快速记录采购商互动；后端专员可以使用快速记录功能快速记录供应商互动；总监和管理员可以使用快速记录功能快速记录客户互动
- 参考 FR34: 前端专员可以在快速记录时选择产品（必填项）；后端专员可以在快速记录时选择产品（必填项）；总监和管理员可以在快速记录时选择产品（必填项）
- 参考 FR35: 系统可以在快速记录时自动关联当前用户和当前时间
- 参考横切关注点 FR115: 手动录入数据时验证数据格式和完整性
- 参考横切关注点 FR117: 操作失败时提供错误信息和恢复建议
- 确保快速记录表单响应式设计，支持移动端

---

### Story 5.2: 产品自动完成功能

As a **所有用户**,
I want **在快速记录时使用产品自动完成功能**,
So that **我可以快速选择产品，无需手动输入完整产品名称**.

**Acceptance Criteria:**

**Given** 用户在快速记录表单中选择产品
**When** 用户在产品输入框输入产品名称的部分字符（如"不锈钢"）
**Then** 系统实时显示匹配的产品列表（输入后自动搜索，debounce 优化）
**And** 匹配的产品按相关性排序（完全匹配优先，部分匹配其次）
**And** 每个产品显示：产品名称、产品HS编码、产品类别
**And** 用户可以选择产品，系统自动填充产品信息

**Given** 用户使用产品自动完成
**When** 用户输入产品名称
**Then** 系统在 3 秒内显示匹配结果（FR36 目标）
**And** 搜索结果响应时间 < 1 秒（P95）
**And** 如果无匹配结果，系统显示"未找到匹配的产品"

**Given** 用户使用产品自动完成
**When** 用户选择产品
**Then** 系统自动填充产品信息到表单
**And** 产品字段显示为已选择状态
**And** 用户可以清除选择，重新选择产品

**Given** 用户在移动端使用产品自动完成
**When** 用户在移动端产品输入框输入
**Then** 系统显示移动端优化的产品选择器
**And** 选择器支持触摸操作
**And** 选择器支持滚动浏览产品列表

**Implementation Notes:**
- 实现产品自动完成功能（使用 React Query 缓存产品列表）
- 实现模糊搜索和实时搜索
- 优化搜索性能，使用数据库索引
- 参考 FR36: 系统可以在快速记录时提供产品自动完成功能（输入产品名称时自动提示）
- 参考 UX 设计规范中的产品选择器组件设计
- 确保自动完成功能在桌面端和移动端都流畅工作

---

### Story 5.3: 客户自动完成功能（按角色）

As a **前端专员/后端专员/总监/管理员**,
I want **在快速记录时使用客户自动完成功能**,
So that **我可以快速选择客户，无需手动输入完整客户名称**.

**Acceptance Criteria:**

**Given** 前端专员在快速记录表单中选择客户
**When** 前端专员在客户输入框输入采购商名称的部分字符
**Then** 系统实时显示匹配的采购商列表
**And** 系统不显示供应商类型的客户
**And** 每个客户显示：客户名称、客户代码、客户类型
**And** 前端专员可以选择采购商，系统自动填充客户信息

**Given** 后端专员在快速记录表单中选择客户
**When** 后端专员在客户输入框输入供应商名称的部分字符
**Then** 系统实时显示匹配的供应商列表
**And** 系统不显示采购商类型的客户
**And** 后端专员可以选择供应商，系统自动填充客户信息

**Given** 总监或管理员在快速记录表单中选择客户
**When** 总监或管理员在客户输入框输入客户名称的部分字符
**Then** 系统实时显示匹配的所有客户列表（包括采购商和供应商）
**And** 客户列表按客户类型分组显示
**And** 总监或管理员可以选择任意客户，系统自动填充客户信息

**Given** 用户使用客户自动完成
**When** 用户输入客户名称
**Then** 系统在 3 秒内显示匹配结果
**And** 搜索结果响应时间 < 1 秒（P95）
**And** 如果无匹配结果，系统显示"未找到匹配的客户"

**Given** 用户使用客户自动完成
**When** 用户选择客户
**Then** 系统自动填充客户信息到表单
**And** 客户字段显示为已选择状态
**And** 用户可以清除选择，重新选择客户

**Given** 用户在移动端使用客户自动完成
**When** 用户在移动端客户输入框输入
**Then** 系统显示移动端优化的客户选择器
**And** 选择器支持触摸操作
**And** 选择器支持滚动浏览客户列表

**Implementation Notes:**
- 实现客户自动完成功能（使用 React Query 缓存客户列表）
- 实现基于角色的客户过滤（前端专员只看到采购商，后端专员只看到供应商）
- 实现模糊搜索和实时搜索
- 优化搜索性能，使用数据库索引
- 参考 FR37: 系统可以在快速记录时提供客户自动完成功能（前端专员输入采购商名称时自动提示采购商，后端专员输入供应商名称时自动提示供应商，总监和管理员输入客户名称时自动提示所有客户）
- 参考 UX 设计规范中的客户选择器组件设计
- 确保自动完成功能在桌面端和移动端都流畅工作

---

### Story 5.4: 快速记录模板

As a **前端专员/后端专员/总监/管理员**,
I want **使用快速记录模板**,
So that **我可以使用预设的互动类型和字段，进一步减少数据录入工作量**.

**Acceptance Criteria:**

**Given** 用户已登录系统
**When** 用户打开快速记录表单
**Then** 系统显示"使用模板"选项
**And** 系统根据用户角色显示相应的模板列表
**And** 前端专员的模板包括：初步接触模板、产品询价模板、报价模板、订单模板等
**And** 后端专员的模板包括：询价产品模板、接收报价模板、生产进度模板、验收模板等

**Given** 用户选择快速记录模板
**When** 用户从模板列表中选择模板（如"产品询价模板"）
**Then** 系统自动填充模板预设的字段值
**And** 模板预设互动类型、默认描述、默认状态等
**And** 用户可以修改模板填充的值
**And** 用户仍需选择产品、客户等必填字段

**Given** 用户使用模板创建记录
**When** 用户选择模板并填写必填字段后提交
**Then** 系统创建互动记录
**And** 记录包含模板预设的信息
**And** 系统显示成功消息"记录创建成功"

**Given** 用户使用模板
**When** 用户选择模板后修改字段值
**Then** 系统保存用户修改的值
**And** 模板预设的值被用户修改的值覆盖

**Implementation Notes:**
- 实现快速记录模板功能
- 实现模板的创建和管理（可选，MVP 可以使用预定义模板）
- 参考 FR33: 前端专员可以使用快速记录模板（预设的采购商互动类型和字段）；后端专员可以使用快速记录模板（预设的供应商互动类型和字段）；总监和管理员可以使用快速记录模板（预设的互动类型和字段）
- 确保模板功能简单易用，不增加复杂度

---

### Story 5.5: 快速记录移动端优化

As a **后端专员**,
I want **在移动端使用快速记录功能**,
So that **我可以在工厂现场快速记录互动，无需回到办公室**.

**Acceptance Criteria:**

**Given** 后端专员在移动端访问系统
**When** 后端专员点击快速记录入口（底部导航或浮动按钮）
**Then** 系统显示移动端优化的快速记录表单
**And** 表单布局适配移动端屏幕，大按钮、清晰的输入框
**And** 表单支持触摸操作，输入框足够大（符合触摸目标要求）

**Given** 后端专员在移动端填写快速记录
**When** 后端专员选择产品
**Then** 系统显示移动端优化的产品选择器
**And** 选择器支持搜索和快速选择
**And** 选择器支持触摸操作

**Given** 后端专员在移动端填写快速记录
**When** 后端专员选择客户（供应商）
**Then** 系统显示移动端优化的客户选择器
**And** 选择器只显示供应商类型的客户
**And** 选择器支持搜索和快速选择

**Given** 后端专员在移动端提交快速记录
**When** 网络连接正常
**Then** 系统成功保存互动记录
**And** 系统显示成功消息"记录创建成功"
**And** 快速记录表单自动关闭或重置

**Given** 后端专员在移动端提交快速记录
**When** 网络不稳定，提交失败
**Then** 系统显示网络状态提示"网络连接中，请稍候"
**And** 系统自动重试提交（最多 3 次，指数退避）
**And** 如果重试成功，系统保存记录并显示成功消息
**And** 如果重试失败，系统显示错误消息"提交失败，请稍后重试或稍后在办公室完成记录"
**And** 系统提供"稍后重试"选项

**Given** 后端专员在移动端使用快速记录
**When** 系统显示快速记录表单
**Then** 表单支持移动端优化的交互
**And** 表单支持键盘输入优化（移动端键盘类型适配）
**And** 表单支持触摸手势（如滑动关闭）

**Implementation Notes:**
- 实现移动端响应式快速记录表单
- 实现移动端优化的产品/客户选择器
- 实现移动端网络重试机制
- 参考移动端支持需求（已融入 Epic 5）
- 参考架构文档中的移动端网络处理策略（ADR-003）
- 参考横切关注点 FR118: 网络中断时自动保存用户输入
- 参考横切关注点 FR119: 检测和处理数据冲突
- 确保移动端快速记录体验流畅，网络不稳定时提供清晰的反馈

---

### Story 5.6: 快速记录智能预填充

As a **所有用户**,
I want **系统在快速记录时智能预填充常用信息**,
So that **我可以进一步减少数据录入工作量，提高记录效率**.

**Acceptance Criteria:**

**Given** 用户打开快速记录表单
**When** 用户之前记录过互动
**Then** 系统智能预填充常用信息（基于历史数据）
**And** 系统预填充最近使用的产品（如果适用）
**And** 系统预填充最近使用的客户（如果适用）
**And** 系统预填充当前时间
**And** 用户可以修改预填充的值

**Given** 用户使用智能预填充
**When** 系统预填充信息
**Then** 预填充准确率 > 80%（基于历史数据）
**And** 用户可以一键清除所有预填充信息
**And** 用户可以修改单个预填充字段

**Given** 用户使用智能预填充
**When** 用户选择产品后
**Then** 系统可以基于产品历史数据预填充常用的客户（可选）
**And** 系统可以基于产品历史数据预填充常用的互动类型（可选）
**And** 用户可以接受或修改预填充的值

**Given** 用户使用智能预填充
**When** 用户选择客户后
**Then** 系统可以基于客户历史数据预填充常用的产品（可选）
**And** 系统可以基于客户历史数据预填充常用的互动类型（可选）
**And** 用户可以接受或修改预填充的值

**Implementation Notes:**
- 实现智能预填充功能（基于用户历史数据）
- 实现预填充准确率优化（使用缓存和算法）
- 参考 UX 设计规范中的智能预填充设计
- 确保预填充功能不干扰用户操作，用户可以轻松修改或清除
- 预填充功能作为增强功能，不影响核心快速记录功能

---

## Epic 6: 搜索和查询

用户成果：用户可以搜索和查询客户、产品、互动记录，支持高级搜索、过滤和排序

### Story 6.1: 客户搜索功能（按角色）

As a **前端专员/后端专员/总监/管理员**,
I want **搜索客户**,
So that **我可以快速找到我需要的客户信息**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统
**When** 前端专员在搜索框中输入采购商名称、代码或选择客户类型
**Then** 系统只显示采购商类型的客户搜索结果（FR49）
**And** 搜索结果支持模糊匹配（如输入"北京"可以找到"北京XX公司"）
**And** 搜索结果包含采购商的名称、代码、联系人等关键信息
**And** 搜索结果按相关性排序（完全匹配优先）

**Given** 后端专员已登录系统
**When** 后端专员在搜索框中输入供应商名称、代码或选择客户类型
**Then** 系统只显示供应商类型的客户搜索结果（FR49）
**And** 搜索结果支持模糊匹配
**And** 搜索结果包含供应商的名称、代码、联系人等关键信息

**Given** 总监或管理员已登录系统
**When** 总监或管理员在搜索框中输入客户名称、代码或选择客户类型
**Then** 系统显示所有客户类型的搜索结果（FR49）
**And** 搜索结果支持模糊匹配
**And** 搜索结果包含客户的名称、代码、联系人、客户类型等关键信息

**Given** 用户执行客户搜索
**When** 用户输入搜索关键词
**Then** 系统在 3 秒内显示搜索结果
**And** 搜索结果响应时间 < 1 秒（P95）
**And** 如果无匹配结果，系统显示"未找到匹配的客户"

**Given** 用户查看搜索结果
**When** 用户点击搜索结果中的客户
**Then** 系统跳转到客户详情页面
**And** 系统显示客户的完整信息

**Implementation Notes:**
- 实现客户搜索功能（使用 PostgreSQL 全文搜索或 LIKE 查询）
- 实现基于角色的搜索结果过滤（前端专员只看到采购商，后端专员只看到供应商）
- 实现模糊匹配和相关性排序
- 优化搜索性能，使用数据库索引
- 参考 FR49: 前端专员可以根据采购商名称、采购商代码、客户类型搜索采购商（支持模糊搜索）；后端专员可以根据供应商名称、供应商代码、客户类型搜索供应商（支持模糊搜索）；总监和管理员可以根据客户名称、客户代码、客户类型搜索客户（支持模糊搜索）
- 参考横切关注点 FR115: 手动录入数据时验证数据格式和完整性
- 确保搜索功能在桌面端和移动端都流畅工作

---

### Story 6.2: 产品搜索功能

As a **所有用户**,
I want **搜索产品**,
So that **我可以快速找到我需要的产品信息**.

**Acceptance Criteria:**

**Given** 用户已登录系统
**When** 用户在搜索框中输入产品名称、HS编码或选择产品类别
**Then** 系统显示匹配的产品搜索结果（FR50）
**And** 搜索结果支持模糊匹配（如输入"不锈钢"可以找到"不锈钢水杯"）
**And** 搜索结果包含产品名称、HS编码、类别、描述等关键信息
**And** 搜索结果按相关性排序（完全匹配优先）

**Given** 用户执行产品搜索
**When** 用户输入搜索关键词
**Then** 系统在 3 秒内显示搜索结果
**And** 搜索结果响应时间 < 1 秒（P95）
**And** 如果无匹配结果，系统显示"未找到匹配的产品"

**Given** 用户查看搜索结果
**When** 用户点击搜索结果中的产品
**Then** 系统跳转到产品详情页面
**And** 系统显示产品的完整信息

**Given** 用户执行产品搜索
**When** 用户输入 HS 编码
**Then** 系统支持精确匹配和部分匹配（如输入"7323"可以找到"7323.93"）
**And** 系统优先显示精确匹配的结果

**Implementation Notes:**
- 实现产品搜索功能（使用 PostgreSQL 全文搜索或 LIKE 查询）
- 实现模糊匹配和相关性排序
- 优化搜索性能，使用数据库索引（product_name, hs_code）
- 参考 FR50: 所有用户可以根据产品名称、产品HS编码、产品类别搜索产品（支持模糊搜索）
- 确保搜索功能在桌面端和移动端都流畅工作

---

### Story 6.3: 互动记录搜索功能（按角色）

As a **前端专员/后端专员/总监/管理员**,
I want **搜索互动记录**,
So that **我可以快速找到我需要的互动历史**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统
**When** 前端专员在搜索界面选择互动类型、时间范围或互动状态
**Then** 系统只显示采购商相关的互动记录搜索结果（FR51）
**And** 搜索结果包含互动类型、时间、描述、关联客户、关联产品等信息
**And** 搜索结果按时间倒序排列（最新的在前）

**Given** 后端专员已登录系统
**When** 后端专员在搜索界面选择互动类型、时间范围或互动状态
**Then** 系统只显示供应商相关的互动记录搜索结果（FR51）
**And** 搜索结果包含互动类型、时间、描述、关联客户、关联产品等信息
**And** 搜索结果按时间倒序排列

**Given** 总监或管理员已登录系统
**When** 总监或管理员在搜索界面选择互动类型、时间范围或互动状态
**Then** 系统显示所有互动记录搜索结果（FR51）
**And** 搜索结果包含互动类型、时间、描述、关联客户、关联产品、客户类型等信息
**And** 搜索结果按时间倒序排列

**Given** 用户执行互动记录搜索
**When** 用户选择搜索条件
**Then** 系统在 3 秒内显示搜索结果
**And** 搜索结果响应时间 < 1 秒（P95）
**And** 如果无匹配结果，系统显示"未找到匹配的互动记录"

**Given** 用户查看搜索结果
**When** 用户点击搜索结果中的互动记录
**Then** 系统跳转到互动记录详情页面
**And** 系统显示互动记录的完整信息

**Implementation Notes:**
- 实现互动记录搜索功能（使用 PostgreSQL 查询）
- 实现基于角色的搜索结果过滤（前端专员只看到采购商互动，后端专员只看到供应商互动）
- 实现时间范围、互动类型、互动状态等搜索条件
- 优化搜索性能，使用数据库索引（customer_id, product_id, interaction_type, created_at）
- 参考 FR51: 前端专员可以根据互动类型、互动时间、互动状态搜索采购商相关的互动记录；后端专员可以根据互动类型、互动时间、互动状态搜索供应商相关的互动记录；总监和管理员可以根据互动类型、互动时间、互动状态搜索所有互动记录
- 确保搜索功能在桌面端和移动端都流畅工作

---

### Story 6.4: 高级搜索功能（组合条件）

As a **前端专员/后端专员/总监/管理员**,
I want **使用高级搜索功能组合多个搜索条件**,
So that **我可以精确地找到我需要的特定记录**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统并进入高级搜索界面
**When** 前端专员选择多个搜索条件（例如：特定采购商、特定产品、特定互动类型、特定时间范围）
**Then** 系统只显示符合所有条件的采购商相关互动记录（FR52, FR53）
**And** 搜索结果包含互动类型、时间、描述、关联客户、关联产品等信息
**And** 系统显示使用的搜索条件摘要

**Given** 后端专员已登录系统并进入高级搜索界面
**When** 后端专员选择多个搜索条件（例如：特定供应商、特定产品、特定互动类型、特定时间范围）
**Then** 系统只显示符合所有条件的供应商相关互动记录（FR52, FR54）
**And** 搜索结果包含互动类型、时间、描述、关联客户、关联产品等信息

**Given** 总监或管理员已登录系统并进入高级搜索界面
**When** 总监或管理员选择多个搜索条件（例如：特定客户、特定产品、特定互动类型、特定时间范围）
**Then** 系统显示符合所有条件的所有互动记录（FR52, FR55）
**And** 搜索结果包含互动类型、时间、描述、关联客户、关联产品、客户类型等信息

**Given** 用户使用高级搜索
**When** 用户选择多个搜索条件
**Then** 系统支持条件组合（AND 逻辑）
**And** 系统支持条件清除（用户可以清除单个条件或所有条件）
**And** 系统显示搜索条件预览

**Given** 用户使用高级搜索
**When** 用户执行搜索
**Then** 系统在 3 秒内显示搜索结果
**And** 搜索结果响应时间 < 2 秒（P95，因为条件更复杂）
**And** 如果无匹配结果，系统显示"未找到匹配的记录"和搜索条件建议

**Given** 用户使用高级搜索
**When** 用户保存搜索条件
**Then** 系统允许用户保存常用搜索条件（可选功能）
**And** 用户可以快速使用保存的搜索条件

**Implementation Notes:**
- 实现高级搜索功能（支持多条件组合）
- 实现搜索条件保存功能（可选）
- 优化复杂查询性能，使用数据库索引和查询优化
- 参考 FR52: 前端专员可以使用高级搜索功能组合多个搜索条件（采购商 + 产品 + 互动类型 + 时间范围）搜索采购商相关的互动记录；后端专员可以使用高级搜索功能组合多个搜索条件（供应商 + 产品 + 互动类型 + 时间范围）搜索供应商相关的互动记录；总监和管理员可以使用高级搜索功能组合多个搜索条件（客户 + 产品 + 互动类型 + 时间范围）搜索所有互动记录
- 参考 FR53, FR54, FR55: 不同角色的高级搜索范围
- 确保高级搜索功能在桌面端和移动端都流畅工作

---

### Story 6.5: 搜索结果时间线视图

As a **所有用户**,
I want **查看搜索结果的时间线视图**,
So that **我可以直观地了解搜索到的互动记录的发生顺序**.

**Acceptance Criteria:**

**Given** 用户已执行搜索并获得结果
**When** 用户切换到"时间线"视图
**Then** 系统显示搜索结果中的所有互动记录，按时间倒序排列（FR56）
**And** 时间线视图包含互动类型、时间、简要描述、关联产品、关联客户等信息
**And** 时间线视图以时间轴形式展示，清晰显示时间顺序

**Given** 用户查看时间线视图
**When** 用户滚动时间线
**Then** 系统支持无限滚动或分页加载
**And** 系统显示时间标记（如"今天"、"昨天"、"本周"、"本月"等）
**And** 系统高亮显示当前查看的时间段

**Given** 用户查看时间线视图
**When** 用户点击时间线中的互动记录
**Then** 系统显示互动记录的详细信息（模态框或跳转详情页）
**And** 用户可以查看互动记录的完整信息

**Given** 用户在移动端查看时间线视图
**When** 用户在移动端访问时间线
**Then** 系统显示移动端优化的时间线视图
**And** 时间线视图适配移动端屏幕
**And** 时间线视图支持触摸操作

**Implementation Notes:**
- 实现搜索结果时间线视图
- 实现时间线视图的响应式设计（桌面端和移动端）
- 参考 FR56: 所有用户可以查看搜索结果的时间线视图（所有互动记录按时间顺序显示）
- 参考 UX 设计规范中的时间线组件设计
- 优化时间线视图的性能，使用虚拟滚动（如果记录很多）

---

### Story 6.6: 搜索结果排序

As a **所有用户**,
I want **对搜索结果进行排序**,
So that **我可以根据我的需求组织和查看搜索结果**.

**Acceptance Criteria:**

**Given** 用户已执行搜索并获得结果
**When** 用户选择排序方式（例如：按时间倒序、按客户名称升序、按产品HS编码降序）
**Then** 系统根据选择的排序方式重新排列搜索结果（FR57）
**And** 系统显示当前使用的排序方式
**And** 用户可以切换排序方式

**Given** 用户对搜索结果排序
**When** 用户选择排序方式
**Then** 系统支持的排序方式包括：
  - 按时间排序（升序/降序）
  - 按客户名称排序（升序/降序）
  - 按产品名称排序（升序/降序）
  - 按产品HS编码排序（升序/降序）
  - 按互动类型排序（升序/降序）

**Given** 用户对搜索结果排序
**When** 用户选择排序方式
**Then** 系统立即应用排序，无需重新搜索
**And** 排序响应时间 < 500ms（P95）
**And** 排序结果正确显示

**Given** 用户在移动端对搜索结果排序
**When** 用户在移动端选择排序方式
**Then** 系统显示移动端优化的排序选择器
**And** 排序选择器支持触摸操作

**Implementation Notes:**
- 实现搜索结果排序功能
- 实现多种排序方式（时间、客户、产品、互动类型等）
- 优化排序性能，使用数据库索引
- 参考 FR57: 所有用户可以对搜索结果进行排序（按时间、按客户、按产品等）
- 确保排序功能在桌面端和移动端都流畅工作

---

### Story 6.7: 搜索结果筛选

As a **所有用户**,
I want **对搜索结果进行筛选**,
So that **我可以进一步缩小范围，只查看我感兴趣的记录**.

**Acceptance Criteria:**

**Given** 用户已执行搜索并获得结果
**When** 用户选择筛选条件（例如：只显示"产品询价"类型的互动，只显示"不锈钢水杯"产品类别的互动）
**Then** 系统根据选择的筛选条件过滤搜索结果（FR58）
**And** 筛选条件支持多选和组合
**And** 系统显示当前使用的筛选条件
**And** 用户可以清除筛选条件

**Given** 用户对搜索结果筛选
**When** 用户选择筛选条件
**Then** 系统支持的筛选条件包括：
  - 按客户类型筛选（采购商/供应商）
  - 按产品类别筛选
  - 按互动类型筛选
  - 按互动状态筛选
  - 按时间范围筛选
  - 按创建者筛选

**Given** 用户对搜索结果筛选
**When** 用户选择多个筛选条件
**Then** 系统支持条件组合（AND 逻辑）
**And** 系统显示筛选后的结果数量
**And** 筛选响应时间 < 500ms（P95）

**Given** 用户对搜索结果筛选
**When** 用户清除筛选条件
**Then** 系统恢复显示所有搜索结果
**And** 系统显示原始搜索结果数量

**Given** 用户在移动端对搜索结果筛选
**When** 用户在移动端选择筛选条件
**Then** 系统显示移动端优化的筛选器
**And** 筛选器支持触摸操作
**And** 筛选器支持多选

**Implementation Notes:**
- 实现搜索结果筛选功能
- 实现多种筛选条件（客户类型、产品类别、互动类型、互动状态等）
- 实现筛选条件的多选和组合
- 优化筛选性能，使用数据库索引
- 参考 FR58: 所有用户可以对搜索结果进行筛选（按客户类型、按产品类别、按互动类型等）
- 确保筛选功能在桌面端和移动端都流畅工作

---

## Epic 7: 数据导入导出

用户成果：管理员可以从 Excel 导入历史数据，导出数据用于备份和分析，支持多种格式

### Story 7.1: 客户数据批量导入（Excel/CSV）

As a **总监或管理员**,
I want **从 Excel 文件（CSV 和基本 Excel 格式）批量导入客户数据**,
So that **我可以快速将历史客户数据迁移到 CRM 系统**.

**Acceptance Criteria:**

**Given** 总监或管理员已登录系统并进入数据导入界面
**When** 总监或管理员上传一个包含客户数据的 Excel 或 CSV 文件
**Then** 系统在导入前验证文件格式和数据完整性（FR39）
**And** 系统支持 CSV 格式（.csv）
**And** 系统支持基本 Excel 格式（.xlsx, .xls）
**And** 系统显示文件大小限制（如最大 50MB）

**Given** 总监或管理员上传文件
**When** 文件格式验证通过
**Then** 系统解析文件内容
**And** 系统显示数据映射预览界面，允许总监或管理员确认 Excel 列与 CRM 字段的映射关系（FR42）
**And** 系统自动识别常见的列名映射（如"客户名称"映射到"name"）
**And** 总监或管理员可以手动调整映射关系

**Given** 总监或管理员确认数据映射
**When** 系统开始导入
**Then** 系统在导入前检测并报告数据错误（例如：必填字段缺失、格式错误），并提供数据清洗建议（FR40, FR41）
**And** 系统显示数据验证结果（成功记录数、失败记录数、错误详情）
**And** 总监或管理员可以查看错误详情并决定是否继续导入

**Given** 总监或管理员确认导入
**When** 系统开始异步处理导入任务（架构：Bull Queue）
**Then** 系统显示导入进度（FR43）
**And** 系统显示当前处理进度（如"已处理 100/500 条记录"）
**And** 系统显示预计剩余时间
**And** 系统支持导入任务的后台处理，用户可以关闭页面

**Given** 系统完成导入
**When** 导入任务完成
**Then** 系统显示导入结果摘要（成功记录数、失败记录数）
**And** 系统支持部分成功导入（部分记录导入成功，部分失败）（FR45）
**And** 系统提供详细的错误报告（FR44）
**And** 总监或管理员可以下载失败记录的 Excel 文件，修正后重新导入

**Implementation Notes:**
- 实现 Excel/CSV 文件上传和解析（使用 xlsx 或 csv-parser 库）
- 实现数据映射预览界面
- 实现数据验证和错误检测
- 实现异步导入任务（使用 Bull Queue）
- 实现导入进度跟踪
- 参考 FR38: 总监和管理员可以从 Excel 文件（CSV 和基本 Excel 格式）批量导入客户数据
- 参考 FR39: 系统可以在导入前验证数据格式和完整性
- 参考 FR40: 系统可以在导入时检测和报告数据错误
- 参考 FR41: 系统可以在导入时提供数据清洗建议（自动修复常见错误）
- 参考 FR42: 总监和管理员可以预览导入结果（数据映射关系）后再确认导入
- 参考 FR43: 系统可以在导入过程中显示导入进度
- 参考 FR44: 系统可以在导入失败时提供详细的错误报告
- 参考 FR45: 系统可以支持部分成功导入（部分记录导入成功，部分失败）
- 参考横切关注点 FR115: 手动录入数据时验证数据格式和完整性
- 参考横切关注点 FR117: 操作失败时提供错误信息和恢复建议
- 参考横切关注点 FR121: 导入时检测和合并重复数据
- 参考横切关注点 FR134: 导出数据时支持多种格式（JSON、CSV、Excel 等）
- 参考横切关注点 FR135: 导出数据时允许选择要导出的字段
- 参考横切关注点 FR141: 支持从 Excel 文件迁移历史数据到 CRM 系统
- 参考横切关注点 FR146: 导入历史记录和错误报告
- 确保导入功能稳定可靠，处理大量数据时性能良好

---

### Story 7.2: 产品数据批量导入（Excel/CSV）

As a **总监或管理员**,
I want **从 Excel 文件批量导入产品数据**,
So that **我可以快速将历史产品数据迁移到 CRM 系统**.

**Acceptance Criteria:**

**Given** 总监或管理员已登录系统并进入数据导入界面
**When** 总监或管理员选择"导入产品数据"，上传包含产品数据的 Excel 或 CSV 文件
**Then** 系统在导入前验证文件格式和数据完整性（FR39）
**And** 系统支持 CSV 和 Excel 格式
**And** 系统验证必填字段（产品名称、HS编码等）

**Given** 总监或管理员上传产品数据文件
**When** 文件格式验证通过
**Then** 系统解析文件内容
**And** 系统显示数据映射预览界面，允许总监或管理员确认 Excel 列与 CRM 字段的映射关系（FR42）
**And** 系统自动识别常见的列名映射（如"产品名称"映射到"name"，"HS编码"映射到"hs_code"）

**Given** 总监或管理员确认数据映射
**When** 系统开始导入
**Then** 系统在导入前检测并报告数据错误（例如：HS编码格式错误、必填字段缺失），并提供数据清洗建议（FR40, FR41）
**And** 系统显示数据验证结果

**Given** 总监或管理员确认导入
**When** 系统开始异步处理导入任务
**Then** 系统显示导入进度（FR43）
**And** 系统显示当前处理进度和预计剩余时间

**Given** 系统完成导入
**When** 导入任务完成
**Then** 系统显示导入结果摘要（成功记录数、失败记录数）
**And** 系统支持部分成功导入（FR45）
**And** 系统提供详细的错误报告（FR44）
**And** 系统在导入时检测和合并重复产品（基于 HS 编码或产品名称），并提供合并预览（FR121）

**Implementation Notes:**
- 实现产品数据导入功能（复用客户导入的基础设施）
- 实现产品数据验证（HS编码格式、必填字段等）
- 实现重复产品检测和合并
- 参考 FR38-FR45: 产品导入使用与客户导入相同的功能要求
- 参考横切关注点 FR121: 导入时检测和合并重复数据
- 确保产品导入功能稳定可靠

---

### Story 7.3: 互动记录数据批量导入（Excel/CSV）

As a **总监或管理员**,
I want **从 Excel 文件批量导入互动记录数据**,
So that **我可以快速将历史互动记录迁移到 CRM 系统**.

**Acceptance Criteria:**

**Given** 总监或管理员已登录系统并进入数据导入界面
**When** 总监或管理员选择"导入互动记录数据"，上传包含互动记录的 Excel 或 CSV 文件
**Then** 系统在导入前验证文件格式和数据完整性（FR39）
**And** 系统支持 CSV 和 Excel 格式
**And** 系统验证必填字段（客户、产品、互动类型、时间等）

**Given** 总监或管理员上传互动记录数据文件
**When** 文件格式验证通过
**Then** 系统解析文件内容
**And** 系统显示数据映射预览界面，允许总监或管理员确认 Excel 列与 CRM 字段的映射关系（FR42）
**And** 系统自动识别常见的列名映射（如"客户名称"映射到"customer"，"产品名称"映射到"product"）

**Given** 总监或管理员确认数据映射
**When** 系统开始导入
**Then** 系统在导入前检测并报告数据错误（例如：客户不存在、产品不存在、时间格式错误），并提供数据清洗建议（FR40, FR41）
**And** 系统验证客户和产品的关联关系
**And** 系统显示数据验证结果

**Given** 总监或管理员确认导入
**When** 系统开始异步处理导入任务
**Then** 系统显示导入进度（FR43）
**And** 系统显示当前处理进度和预计剩余时间

**Given** 系统完成导入
**When** 导入任务完成
**Then** 系统显示导入结果摘要（成功记录数、失败记录数）
**And** 系统支持部分成功导入（FR45）
**And** 系统提供详细的错误报告（FR44）
**And** 系统验证导入的互动记录正确关联到客户和产品（FR116）

**Implementation Notes:**
- 实现互动记录数据导入功能（复用客户导入的基础设施）
- 实现互动记录数据验证（客户关联、产品关联、时间格式等）
- 实现关联关系验证（确保客户和产品存在）
- 参考 FR38-FR45: 互动记录导入使用与客户导入相同的功能要求
- 参考横切关注点 FR116: 自动验证产品-客户-互动关联的数据完整性
- 确保互动记录导入功能稳定可靠

---

### Story 7.4: 数据导出功能（JSON/CSV/Excel）

As a **总监或管理员**,
I want **导出客户、产品、互动记录等数据，并选择导出格式**,
So that **我可以进行数据备份、离线分析或与其他系统集成**.

**Acceptance Criteria:**

**Given** 总监或管理员已登录系统并进入数据导出界面
**When** 总监或管理员选择要导出的数据类型（客户、产品、互动记录）和范围（所有数据或筛选后的数据）
**Then** 系统允许总监或管理员选择导出格式（JSON、CSV、Excel 等）（FR46, FR47, FR134）
**And** 系统显示每种格式的说明（如"JSON 适用于程序处理，CSV 适用于 Excel 打开"）

**Given** 总监或管理员选择导出格式和范围
**When** 总监或管理员点击"导出"按钮
**Then** 系统在导出前验证数据完整性（FR48）
**And** 系统显示导出进度（如果数据量大）
**And** 系统开始生成导出文件

**Given** 系统完成导出
**When** 导出文件生成完成
**Then** 系统提供下载链接
**And** 系统显示导出文件大小和记录数
**And** 导出文件包含所有选定的数据
**And** 导出文件格式正确，可以正常打开

**Given** 总监或管理员导出数据
**When** 导出数据量很大（> 10000 条记录）
**Then** 系统使用异步任务处理导出（Bull Queue）
**And** 系统显示导出进度
**And** 系统在导出完成后发送通知（站内通知或邮件）

**Given** 总监或管理员导出数据
**When** 导出失败
**Then** 系统显示错误消息
**And** 系统提供错误详情和恢复建议（FR117）

**Implementation Notes:**
- 实现数据导出功能（支持 JSON、CSV、Excel 格式）
- 实现导出格式选择
- 实现数据完整性验证
- 实现异步导出任务（处理大数据量）
- 参考 FR46: 总监和管理员可以导出数据（JSON 或 CSV 格式）
- 参考 FR47: 总监和管理员可以导出数据（Excel 格式）
- 参考 FR48: 系统可以在导出前验证数据完整性
- 参考横切关注点 FR134: 导出数据时支持多种格式（JSON、CSV、Excel 等）
- 参考横切关注点 FR117: 操作失败时提供错误信息和恢复建议
- 确保导出功能稳定可靠，处理大量数据时性能良好

---

### Story 7.5: 自定义字段导出

As a **总监或管理员**,
I want **选择要导出的字段**,
So that **我可以只导出我需要的字段，减少文件大小**.

**Acceptance Criteria:**

**Given** 总监或管理员已登录系统并进入数据导出界面
**When** 总监或管理员选择要导出的数据类型（客户、产品、互动记录）
**Then** 系统显示该数据类型的所有可用字段列表
**And** 系统默认选择所有字段
**And** 总监或管理员可以取消选择不需要的字段

**Given** 总监或管理员选择导出字段
**When** 总监或管理员选择部分字段
**Then** 系统只导出选定的字段
**And** 系统显示选定的字段数量
**And** 系统显示导出文件大小估算

**Given** 总监或管理员导出数据
**When** 导出文件生成完成
**Then** 导出文件只包含选定的字段
**And** 导出文件格式正确，字段顺序与选择顺序一致

**Implementation Notes:**
- 实现自定义字段导出功能
- 实现字段选择界面
- 参考横切关注点 FR135: 导出数据时允许选择要导出的字段
- 确保字段选择功能直观易用

---

### Story 7.6: 导入历史记录和错误报告

As a **总监或管理员**,
I want **查看导入历史记录和详细的错误报告**,
So that **我可以了解导入任务的执行情况，并修正导入错误**.

**Acceptance Criteria:**

**Given** 总监或管理员已登录系统并进入数据导入界面
**When** 总监或管理员查看"导入历史"模块
**Then** 系统显示所有历史导入任务列表（FR146）
**And** 导入历史列表包含：导入时间、导入文件、导入状态（成功/失败/部分成功）、导入记录数、成功数、失败数
**And** 导入历史列表按时间倒序排列（最新的在前）

**Given** 总监或管理员查看导入历史
**When** 总监或管理员点击某个导入任务
**Then** 系统显示该导入任务的详细信息
**And** 系统显示导入结果摘要（成功记录数、失败记录数）
**And** 对于"部分成功"或"失败"的任务，系统显示详细的错误报告（FR44, FR45, FR120）
**And** 错误报告列出所有失败的记录及其错误原因

**Given** 总监或管理员查看错误报告
**When** 导入任务有失败的记录
**Then** 系统显示失败记录的详细信息（行号、数据内容、错误原因）
**And** 总监或管理员可以下载失败记录的 Excel 文件
**And** 总监或管理员可以修正失败记录后重新导入

**Given** 总监或管理员查看导入历史
**When** 导入历史记录较多（> 50 条）
**Then** 系统使用分页或滚动加载显示导入历史
**And** 系统支持按时间范围、按状态筛选导入历史

**Implementation Notes:**
- 实现导入历史记录功能
- 实现错误报告功能
- 实现失败记录下载功能
- 参考 FR44: 系统可以在导入失败时提供详细的错误报告
- 参考 FR45: 系统可以支持部分成功导入（部分记录导入成功，部分失败）
- 参考横切关注点 FR120: 导入时提供详细的错误报告和修正建议
- 参考横切关注点 FR146: 导入历史记录和错误报告
- 确保导入历史记录功能完整，便于用户追踪和修正导入错误

---

## Epic 8: 业务分析和仪表板

用户成果：总监和管理员可以查看业务概览、关键指标和分析报表，通过图表可视化业务数据

### Story 8.1: 业务仪表板概览

As a **总监或管理员**,
I want **查看业务仪表板，快速了解业务概览和关键指标**,
So that **我可以及时掌握公司运营状况**.

**Acceptance Criteria:**

**Given** 总监或管理员已登录系统
**When** 总监或管理员访问"业务仪表板"模块
**Then** 系统显示一个包含关键业务指标（例如：客户总数、产品总数、互动总数、待处理任务数）的概览视图（FR70）
**And** 仪表板通过图表和可视化方式展示数据（FR148）
**And** 仪表板数据实时更新或在指定时间间隔内更新（如每 5 分钟）
**And** 仪表板布局清晰，关键指标突出显示

**Given** 总监或管理员查看业务仪表板
**When** 仪表板加载
**Then** 系统显示加载状态
**And** 系统在 3 秒内显示仪表板内容
**And** 如果数据加载失败，系统显示错误消息

**Given** 总监或管理员查看业务仪表板
**When** 仪表板显示关键指标
**Then** 关键指标包括：
  - 客户总数（采购商数量、供应商数量）
  - 产品总数
  - 互动记录总数
  - 待处理任务数（可选）
  - 本月新增客户数
  - 本月新增互动记录数

**Given** 总监或管理员查看业务仪表板
**When** 仪表板显示图表
**Then** 系统使用图表库（如 Chart.js 或 Recharts）展示数据
**And** 图表支持交互（如悬停显示详情、点击钻取）
**And** 图表响应式设计，适配不同屏幕尺寸

**Implementation Notes:**
- 实现业务仪表板页面
- 实现关键指标计算和展示
- 实现图表可视化（使用 Chart.js 或 Recharts）
- 实现数据实时更新机制（轮询或 WebSocket）
- 参考 FR70: 总监和管理员可以查看业务仪表板，快速了解业务概览和关键指标
- 参考 FR148: 系统可以通过图表和可视化方式查看业务分析结果
- 确保仪表板性能良好，数据加载快速

---

### Story 8.2: 产品关联分析

As a **总监或管理员**,
I want **查看产品关联分析，了解哪些产品与哪些客户关联，以及订单转化率等**,
So that **我可以优化产品策略和销售效率**.

**Acceptance Criteria:**

**Given** 总监或管理员已登录系统并访问"业务仪表板"
**When** 总监或管理员点击"产品关联分析"模块
**Then** 系统显示产品与客户的关联关系图或列表，包括：
  - 哪些产品与哪些客户（采购商/供应商）关联最多（FR71）
  - 产品的订单转化率（FR71, FR77）
  - 产品的销售额贡献（如果系统有订单数据）
**And** 分析结果通过图表和可视化方式展示（FR148）

**Given** 总监或管理员查看产品关联分析
**When** 系统显示产品关联数据
**Then** 系统显示产品关联热力图或关系图
**And** 系统显示产品关联统计表（产品名称、关联客户数、订单转化率等）
**And** 系统支持按产品类别、按时间范围筛选分析数据

**Given** 总监或管理员查看产品关联分析
**When** 系统计算订单转化率
**Then** 系统计算订单转化率 = (订单数 / 互动记录数) × 100%
**And** 系统显示转化率趋势图（按时间）
**And** 系统高亮显示高转化率产品和低转化率产品

**Given** 总监或管理员查看产品关联分析
**When** 分析数据量很大（> 1000 条记录）
**Then** 系统使用分页或虚拟滚动显示数据
**And** 系统支持导出分析结果（PDF、CSV、图片）

**Implementation Notes:**
- 实现产品关联分析功能
- 实现产品关联关系图（使用 D3.js 或类似库）
- 实现订单转化率计算
- 实现数据筛选和导出功能
- 参考 FR71: 总监和管理员可以查看产品关联分析，了解哪些产品与哪些客户关联，以及订单转化率等
- 参考 FR77: 系统可以计算和分析业务指标（订单转化率、客户流失率、供应商交货及时率等）
- 参考 FR148: 系统可以通过图表和可视化方式查看业务分析结果
- 确保分析功能性能良好，处理大量数据时响应快速

---

### Story 8.3: 客户分析

As a **总监或管理员**,
I want **查看客户分析，了解客户订单量、订单金额、订单频率等**,
So that **我可以评估客户价值，制定精准的客户维护策略**.

**Acceptance Criteria:**

**Given** 总监或管理员已登录系统并访问"业务仪表板"
**When** 总监或管理员点击"客户分析"模块
**Then** 系统显示客户的详细分析数据，包括：
  - 客户订单量、订单金额、订单频率（FR72, FR77）
  - 客户生命周期价值（如果系统有订单数据）
  - 客户流失率（FR77）
**And** 分析结果通过图表和可视化方式展示（FR148）

**Given** 总监或管理员查看客户分析
**When** 系统显示客户分析数据
**Then** 系统显示客户分析图表（如客户订单量柱状图、客户订单金额饼图）
**And** 系统显示客户分析统计表（客户名称、订单量、订单金额、订单频率、流失风险等）
**And** 系统支持按客户类型（采购商/供应商）、按时间范围筛选分析数据

**Given** 总监或管理员查看客户分析
**When** 系统计算客户流失率
**Then** 系统计算客户流失率 = (流失客户数 / 总客户数) × 100%
**And** 系统定义流失客户（如：超过 90 天无互动记录的客户）
**And** 系统显示流失率趋势图（按时间）
**And** 系统高亮显示高价值客户和流失风险客户

**Given** 总监或管理员查看客户分析
**When** 分析数据量很大（> 1000 条记录）
**Then** 系统使用分页或虚拟滚动显示数据
**And** 系统支持导出分析结果（PDF、CSV、图片）

**Implementation Notes:**
- 实现客户分析功能
- 实现客户分析图表（使用 Chart.js 或 Recharts）
- 实现客户流失率计算
- 实现数据筛选和导出功能
- 参考 FR72: 总监和管理员可以查看客户分析，了解客户订单量、订单金额、订单频率等
- 参考 FR77: 系统可以计算和分析业务指标（订单转化率、客户流失率、供应商交货及时率等）
- 参考 FR148: 系统可以通过图表和可视化方式查看业务分析结果
- 确保分析功能性能良好，处理大量数据时响应快速

---

### Story 8.4: 供应商分析

As a **总监或管理员**,
I want **查看供应商分析，了解供应商交货及时率、质量问题率等**,
So that **我可以评估供应商绩效，优化供应链管理**.

**Acceptance Criteria:**

**Given** 总监或管理员已登录系统并访问"业务仪表板"
**When** 总监或管理员点击"供应商分析"模块
**Then** 系统显示供应商的详细分析数据，包括：
  - 供应商交货及时率（FR73, FR77）
  - 供应商质量问题率（如果系统有验收数据）
  - 供应商合作时长
**And** 分析结果通过图表和可视化方式展示（FR148）

**Given** 总监或管理员查看供应商分析
**When** 系统显示供应商分析数据
**Then** 系统显示供应商分析图表（如供应商交货及时率柱状图、供应商质量问题率饼图）
**And** 系统显示供应商分析统计表（供应商名称、交货及时率、质量问题率、合作时长等）
**And** 系统支持按时间范围筛选分析数据

**Given** 总监或管理员查看供应商分析
**When** 系统计算供应商交货及时率
**Then** 系统计算交货及时率 = (按时交货次数 / 总交货次数) × 100%
**And** 系统基于发货前验收记录和订单数据计算交货及时率
**And** 系统显示交货及时率趋势图（按时间）
**And** 系统高亮显示高绩效供应商和低绩效供应商

**Given** 总监或管理员查看供应商分析
**When** 分析数据量很大（> 1000 条记录）
**Then** 系统使用分页或虚拟滚动显示数据
**And** 系统支持导出分析结果（PDF、CSV、图片）

**Implementation Notes:**
- 实现供应商分析功能
- 实现供应商分析图表（使用 Chart.js 或 Recharts）
- 实现供应商交货及时率计算（基于发货前验收记录）
- 实现数据筛选和导出功能
- 参考 FR73: 总监和管理员可以查看供应商分析，了解供应商交货及时率、质量问题率等
- 参考 FR77: 系统可以计算和分析业务指标（订单转化率、客户流失率、供应商交货及时率等）
- 参考 FR148: 系统可以通过图表和可视化方式查看业务分析结果
- 确保分析功能性能良好，处理大量数据时响应快速

---

### Story 8.5: 采购商分析

As a **总监或管理员**,
I want **查看采购商分析，了解采购商订单量、订单金额、订单频率等**,
So that **我可以评估采购商价值，制定精准的销售策略**.

**Acceptance Criteria:**

**Given** 总监或管理员已登录系统并访问"业务仪表板"
**When** 总监或管理员点击"采购商分析"模块
**Then** 系统显示采购商的详细分析数据，包括：
  - 采购商订单量、订单金额、订单频率（FR74, FR77）
  - 采购商活跃度（基于互动记录频率）
  - 采购商流失风险（基于最后互动时间）
**And** 分析结果通过图表和可视化方式展示（FR148）

**Given** 总监或管理员查看采购商分析
**When** 系统显示采购商分析数据
**Then** 系统显示采购商分析图表（如采购商订单量柱状图、采购商订单金额饼图）
**And** 系统显示采购商分析统计表（采购商名称、订单量、订单金额、订单频率、活跃度、流失风险等）
**And** 系统支持按时间范围筛选分析数据

**Given** 总监或管理员查看采购商分析
**When** 系统计算采购商活跃度
**Then** 系统计算活跃度 = (最近 30 天互动记录数 / 总互动记录数) × 100%
**And** 系统显示活跃度趋势图（按时间）
**And** 系统高亮显示高活跃度采购商和低活跃度采购商

**Given** 总监或管理员查看采购商分析
**When** 分析数据量很大（> 1000 条记录）
**Then** 系统使用分页或虚拟滚动显示数据
**And** 系统支持导出分析结果（PDF、CSV、图片）

**Implementation Notes:**
- 实现采购商分析功能
- 实现采购商分析图表（使用 Chart.js 或 Recharts）
- 实现采购商活跃度计算
- 实现数据筛选和导出功能
- 参考 FR74: 总监和管理员可以查看采购商分析，了解采购商订单量、订单金额、订单频率等
- 参考 FR77: 系统可以计算和分析业务指标（订单转化率、客户流失率、供应商交货及时率等）
- 参考 FR148: 系统可以通过图表和可视化方式查看业务分析结果
- 确保分析功能性能良好，处理大量数据时响应快速

---

### Story 8.6: 业务趋势分析

As a **总监或管理员**,
I want **查看业务趋势分析（订单量趋势、客户增长趋势等）**,
So that **我可以预测未来业务走向，制定战略决策**.

**Acceptance Criteria:**

**Given** 总监或管理员已登录系统并访问"业务仪表板"
**When** 总监或管理员点击"业务趋势分析"模块
**Then** 系统显示关键业务指标的历史趋势图，例如：
  - 订单量月度/季度/年度趋势（FR75）
  - 客户增长趋势（新增客户数按时间）
  - 销售额趋势（如果系统有订单数据）
**And** 分析结果通过图表和可视化方式展示（FR148）

**Given** 总监或管理员查看业务趋势分析
**When** 系统显示趋势图
**Then** 系统显示折线图或面积图展示趋势
**And** 系统支持选择时间范围（最近 7 天、最近 30 天、最近 3 个月、最近 1 年等）
**And** 系统支持选择时间粒度（按天、按周、按月、按季度、按年）
**And** 系统支持多指标对比（如同时显示订单量趋势和客户增长趋势）

**Given** 总监或管理员查看业务趋势分析
**When** 系统显示趋势数据
**Then** 系统显示趋势统计（如"本月订单量较上月增长 10%"）
**And** 系统显示趋势预测（可选，基于历史数据预测未来趋势）
**And** 系统高亮显示关键时间节点（如峰值、低谷）

**Given** 总监或管理员查看业务趋势分析
**When** 分析数据量很大（> 1000 条记录）
**Then** 系统使用数据聚合优化性能（如按月聚合数据）
**And** 系统支持导出分析结果（PDF、CSV、图片）

**Implementation Notes:**
- 实现业务趋势分析功能
- 实现趋势图（使用 Chart.js 或 Recharts）
- 实现时间范围和时间粒度选择
- 实现数据聚合和性能优化
- 参考 FR75: 总监和管理员可以查看业务趋势分析（订单量趋势、客户增长趋势等）
- 参考 FR148: 系统可以通过图表和可视化方式查看业务分析结果
- 确保趋势分析功能性能良好，处理大量历史数据时响应快速

---

### Story 8.7: 分析结果导出

As a **总监或管理员**,
I want **导出分析结果（报表、图表等）**,
So that **我可以分享分析报告或进行离线处理**.

**Acceptance Criteria:**

**Given** 总监或管理员已登录系统并查看业务分析结果
**When** 总监或管理员点击"导出"按钮
**Then** 系统允许选择导出格式（例如：PDF、CSV、图片），并生成可下载的分析报告或图表（FR76）
**And** 导出的报表内容与界面显示一致
**And** 系统在操作失败时提供错误信息和恢复建议（FR117）

**Given** 总监或管理员导出分析结果
**When** 用户选择导出格式
**Then** 系统支持的导出格式包括：
  - PDF（适用于完整报告）
  - CSV（适用于数据表格）
  - PNG/JPEG（适用于图表）
  - Excel（适用于数据表格）

**Given** 总监或管理员导出分析结果
**When** 系统生成导出文件
**Then** 系统显示导出进度（如果文件较大）
**And** 系统在导出完成后提供下载链接
**And** 导出文件包含分析结果的所有关键信息

**Given** 总监或管理员导出分析结果
**When** 导出失败
**Then** 系统显示错误消息
**And** 系统提供错误详情和恢复建议（FR117）

**Implementation Notes:**
- 实现分析结果导出功能（支持 PDF、CSV、图片、Excel 格式）
- 实现导出格式选择
- 实现导出文件生成（使用 jsPDF、html2canvas 等库）
- 参考 FR76: 总监和管理员可以导出分析结果（报表、图表等）
- 参考 FR148: 系统可以通过图表和可视化方式查看业务分析结果
- 参考横切关注点 FR117: 操作失败时提供错误信息和恢复建议
- 确保导出功能稳定可靠，生成的文件格式正确

---

## Epic 9: 数据安全和合规

用户成果：系统符合 GDPR 和《个人信息保护法》要求，提供完整审计跟踪，自动加密敏感数据

### Story 9.1: 数据访问审计日志

As a **管理员**,
I want **查看所有数据访问操作记录**,
So that **我可以审计谁在何时访问了什么数据，确保数据安全**.

**Acceptance Criteria:**

**Given** 用户成功访问了客户详情页
**When** 用户查看客户数据
**Then** 系统自动记录该"数据访问"操作到审计日志，包括用户ID、时间、访问的资源（客户ID）、操作结果（成功/失败）（FR90）
**And** 审计日志记录包含：操作类型（数据访问）、用户ID、资源类型（客户）、资源ID、操作时间、操作结果

**Given** 管理员查看审计日志
**When** 管理员在系统管理界面访问审计日志模块
**Then** 系统显示所有数据访问操作记录，支持按用户、按时间、按资源类型进行查询（FR90, FR93）
**And** 审计日志列表按时间倒序排列（最新的在前）
**And** 审计日志列表包含：操作类型、用户、资源类型、资源ID、操作时间、操作结果

**Given** 管理员查看审计日志
**When** 审计日志记录较多（> 1000 条）
**Then** 系统使用分页或滚动加载显示审计日志
**And** 系统支持按时间范围、按用户、按资源类型筛选审计日志
**And** 系统支持导出审计日志（CSV、Excel 格式）

**Given** 用户尝试访问无权限的数据
**When** 系统阻止该访问
**Then** 系统自动记录该"无权限访问"操作到审计日志，包括用户ID、时间、尝试访问的资源、操作结果（失败）
**And** 审计日志记录包含失败原因（如"无权限访问供应商数据"）

**Implementation Notes:**
- 实现数据访问审计日志功能
- 实现审计日志记录（使用 Winston 或类似库）
- 实现审计日志查询和筛选
- 实现审计日志导出功能
- 参考 FR90: 系统可以记录所有数据访问操作（谁在何时访问了什么数据）
- 参考 FR93: 系统可以查询和导出审计日志
- 确保审计日志的完整性和不可篡改性
- 确保审计日志记录性能良好，不影响系统正常操作

---

### Story 9.2: 数据修改审计日志

As a **管理员**,
I want **查看所有数据修改操作记录**,
So that **我可以审计谁在何时修改了什么数据，确保数据完整性**.

**Acceptance Criteria:**

**Given** 用户成功修改了产品名称
**When** 用户保存产品信息
**Then** 系统自动记录该"数据修改"操作到审计日志，包括用户ID、时间、修改的资源（产品ID）、修改前的值、修改后的值（FR91）
**And** 审计日志记录包含：操作类型（数据修改）、用户ID、资源类型（产品）、资源ID、修改字段、修改前的值、修改后的值、操作时间、操作结果

**Given** 管理员查看审计日志
**When** 管理员在系统管理界面访问审计日志模块
**Then** 系统显示所有数据修改操作记录，支持按用户、按时间、按资源类型进行查询（FR91, FR93）
**And** 审计日志列表按时间倒序排列
**And** 审计日志列表包含：操作类型、用户、资源类型、资源ID、修改字段、修改前的值、修改后的值、操作时间

**Given** 管理员查看数据修改审计日志
**When** 管理员点击某个修改记录
**Then** 系统显示该修改记录的详细信息
**And** 系统显示修改前后的值对比（高亮显示差异）
**And** 系统显示修改原因（如果用户填写了修改原因）

**Given** 用户删除数据
**When** 用户执行软删除操作
**Then** 系统自动记录该"数据删除"操作到审计日志，包括用户ID、时间、删除的资源、删除前的值
**And** 审计日志记录包含删除原因（如果用户填写了删除原因）

**Implementation Notes:**
- 实现数据修改审计日志功能
- 实现修改前后值对比
- 实现审计日志查询和筛选
- 参考 FR91: 系统可以记录所有数据修改操作（谁在何时修改了什么数据，修改前后的值）
- 参考 FR93: 系统可以查询和导出审计日志
- 确保审计日志的完整性和不可篡改性
- 确保审计日志记录性能良好，不影响系统正常操作

---

### Story 9.3: 敏感数据加密存储

As a **系统**,
I want **自动加密存储敏感数据（客户信息、订单信息、财务信息等）**,
So that **确保数据在静止状态下的安全性，符合合规要求**.

**Acceptance Criteria:**

**Given** 系统接收到敏感数据（例如：客户的银行账号）
**When** 系统将数据存储到数据库
**Then** 系统使用 AES-256 加密算法对敏感数据进行加密存储（FR94）
**And** 加密密钥由系统自动管理（生成、轮换、存储），确保密钥安全（FR96）
**And** 只有授权用户通过系统访问时，数据才会被解密显示

**Given** 用户访问包含敏感数据的记录
**When** 用户有权限访问该记录
**Then** 系统自动解密敏感数据并显示给用户
**And** 用户无法直接访问数据库中的加密数据
**And** 系统记录敏感数据访问操作到审计日志

**Given** 系统管理加密密钥
**When** 系统需要轮换加密密钥
**Then** 系统自动生成新的加密密钥
**And** 系统使用新密钥加密新数据，旧密钥继续用于解密旧数据
**And** 系统定期轮换加密密钥（如每 90 天）

**Given** 系统存储敏感数据
**When** 系统识别敏感数据字段
**Then** 系统自动识别以下敏感数据字段：
  - 客户银行账号
  - 客户身份证号
  - 订单金额（可选）
  - 其他标记为敏感的数据字段
**And** 系统自动加密这些字段的数据

**Implementation Notes:**
- 实现敏感数据加密存储功能（使用 AES-256 加密算法）
- 实现加密密钥管理（生成、轮换、存储）
- 实现敏感数据自动识别和加密
- 实现敏感数据解密和显示
- 参考 FR94: 系统可以自动加密存储敏感数据（客户信息、订单信息、财务信息等）
- 参考 FR96: 系统可以自动管理加密密钥（生成、轮换、存储）
- 确保加密功能安全可靠，密钥管理符合最佳实践
- 确保加密/解密性能良好，不影响系统正常操作

---

### Story 9.4: 安全传输协议（HTTPS/TLS）

As a **系统**,
I want **使用 HTTPS/TLS 1.2+ 传输所有数据**,
So that **确保数据在传输过程中的安全性，防止数据被窃听或篡改**.

**Acceptance Criteria:**

**Given** 用户通过浏览器访问 CRM 系统
**When** 用户与系统进行任何数据交互
**Then** 所有数据传输都通过 HTTPS/TLS 1.2+ 协议进行加密（FR95）
**And** 浏览器地址栏显示安全锁图标，表示连接安全
**And** 系统拒绝所有 HTTP 连接，强制重定向到 HTTPS

**Given** 系统配置 HTTPS/TLS
**When** 系统部署到生产环境
**Then** 系统使用有效的 SSL/TLS 证书
**And** 系统支持 TLS 1.2 或更高版本
**And** 系统禁用不安全的加密套件

**Given** 用户通过移动端访问系统
**When** 用户与系统进行数据交互
**Then** 所有数据传输都通过 HTTPS/TLS 1.2+ 协议进行加密
**And** 移动端应用验证服务器证书，防止中间人攻击

**Given** 系统使用 HTTPS/TLS
**When** 系统处理 API 请求
**Then** 所有 GraphQL API 请求都通过 HTTPS 传输
**And** 系统验证客户端证书（如果配置了客户端证书认证）

**Implementation Notes:**
- 实现 HTTPS/TLS 配置（在生产环境部署时）
- 实现 SSL/TLS 证书管理
- 实现 HTTP 到 HTTPS 的重定向
- 参考 FR95: 系统可以使用 HTTPS/TLS 1.2+ 传输所有数据
- 确保 HTTPS/TLS 配置符合安全最佳实践
- 注意：此功能主要在部署和运维阶段实现，不在应用代码中实现

---

### Story 9.5: GDPR 数据导出请求（按角色）

As a **前端专员/后端专员/总监/管理员**,
I want **请求导出自己相关的数据**,
So that **我可以履行 GDPR 规定的数据主体权利**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统
**When** 前端专员在个人设置或数据管理界面发起"导出我的采购商数据"请求
**Then** 系统在 30 天内生成包含该前端专员所有相关采购商数据的导出文件（FR97, FR98）
**And** 导出文件格式为通用可读格式（例如：JSON, CSV）
**And** 前端专员无法请求导出供应商数据
**And** 系统发送通知（站内通知或邮件）告知前端专员导出文件已准备好

**Given** 后端专员已登录系统
**When** 后端专员在个人设置或数据管理界面发起"导出我的供应商数据"请求
**Then** 系统在 30 天内生成包含该后端专员所有相关供应商数据的导出文件（FR97, FR98）
**And** 导出文件格式为通用可读格式（例如：JSON, CSV）
**And** 后端专员无法请求导出采购商数据
**And** 系统发送通知告知后端专员导出文件已准备好

**Given** 总监或管理员已登录系统
**When** 总监或管理员在个人设置或数据管理界面发起"导出我的所有数据"请求
**Then** 系统在 30 天内生成包含该总监或管理员所有相关数据的导出文件（FR97, FR98）
**And** 导出文件格式为通用可读格式（例如：JSON, CSV）
**And** 系统发送通知告知总监或管理员导出文件已准备好

**Given** 用户请求导出数据
**When** 系统生成导出文件
**Then** 导出文件包含用户相关的所有数据：
  - 用户创建的客户记录
  - 用户创建的互动记录
  - 用户创建的产品记录（如果适用）
  - 用户的活动日志
**And** 导出文件结构清晰，易于理解

**Given** 用户请求导出数据
**When** 导出文件生成完成
**Then** 系统提供下载链接（有效期 7 天）
**And** 用户可以通过下载链接下载导出文件
**And** 系统记录数据导出请求到审计日志

**Implementation Notes:**
- 实现 GDPR 数据导出请求功能
- 实现基于角色的数据导出（前端专员只导出采购商数据，后端专员只导出供应商数据）
- 实现数据导出文件生成（JSON、CSV 格式）
- 实现导出文件下载和通知
- 参考 FR97: 系统可以在 30 天内响应用户的数据导出请求（GDPR 数据主体权利）
- 参考 FR98: 系统可以以通用可读格式（JSON, CSV）导出用户数据
- 确保数据导出功能符合 GDPR 要求
- 确保数据导出功能性能良好，处理大量数据时响应快速

---

### Story 9.6: GDPR 数据删除请求（按角色）

As a **前端专员/后端专员/总监/管理员**,
I want **请求删除自己相关的数据**,
So that **我可以履行 GDPR 规定的数据主体权利**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统
**When** 前端专员在个人设置或数据管理界面发起"删除我的采购商数据"请求
**Then** 系统在收到请求后，根据数据保留策略和业务规则，软删除或匿名化该前端专员所有相关采购商数据（FR99）
**And** 系统记录删除操作到审计日志
**And** 前端专员无法请求删除供应商数据
**And** 系统发送通知告知前端专员删除操作已完成

**Given** 后端专员已登录系统
**When** 后端专员在个人设置或数据管理界面发起"删除我的供应商数据"请求
**Then** 系统在收到请求后，根据数据保留策略和业务规则，软删除或匿名化该后端专员所有相关供应商数据（FR99）
**And** 系统记录删除操作到审计日志
**And** 后端专员无法请求删除采购商数据
**And** 系统发送通知告知后端专员删除操作已完成

**Given** 总监或管理员已登录系统
**When** 总监或管理员在个人设置或数据管理界面发起"删除我的所有数据"请求
**Then** 系统在收到请求后，根据数据保留策略和业务规则，软删除或匿名化该总监或管理员所有相关数据（FR99）
**And** 系统记录删除操作到审计日志
**And** 系统发送通知告知总监或管理员删除操作已完成

**Given** 用户请求删除数据
**When** 系统执行删除操作
**Then** 系统根据数据保留策略决定删除方式：
  - 如果数据在保留期内，系统执行软删除（标记为 deleted_at）
  - 如果数据超过保留期，系统执行硬删除（从数据库删除）
  - 如果数据需要保留（如财务数据），系统执行匿名化（移除个人标识信息）
**And** 系统记录删除原因和删除时间

**Given** 用户请求删除数据
**When** 删除操作完成
**Then** 系统显示删除结果摘要（已删除的记录数、已匿名化的记录数）
**And** 系统发送通知告知用户删除操作已完成
**And** 系统记录数据删除请求到审计日志

**Implementation Notes:**
- 实现 GDPR 数据删除请求功能
- 实现基于角色的数据删除（前端专员只删除采购商数据，后端专员只删除供应商数据）
- 实现数据删除策略（软删除、硬删除、匿名化）
- 实现数据保留策略检查
- 参考 FR99: 系统可以在收到用户请求后删除或匿名化用户数据（GDPR 数据主体权利）
- 确保数据删除功能符合 GDPR 要求
- 确保数据删除功能安全可靠，防止误删除

---

### Story 9.7: 数据保留策略和自动删除

As a **管理员**,
I want **配置数据保留策略，并让系统自动删除过期数据**,
So that **我可以管理数据生命周期，符合合规要求，并优化存储空间**.

**Acceptance Criteria:**

**Given** 管理员已登录系统并进入系统设置界面
**When** 管理员配置"业务数据保留策略"（例如：默认保留 7 年）
**Then** 系统保存该策略，并根据策略自动识别过期数据（FR100）
**And** 系统显示策略配置界面，允许管理员设置：
  - 客户数据保留期限（如 7 年）
  - 产品数据保留期限（如永久保留）
  - 互动记录保留期限（如 7 年）
  - 审计日志保留期限（如 10 年）

**Given** 系统检测到有过期数据
**When** 系统执行每日维护任务
**Then** 系统自动软删除所有过期数据（FR100）
**And** 系统记录自动删除操作到审计日志
**And** 系统显示自动删除结果摘要（已删除的记录数、删除时间）

**Given** 系统执行自动删除
**When** 系统删除过期数据
**Then** 系统根据数据保留策略执行删除：
  - 如果数据超过保留期限，系统执行软删除（标记为 deleted_at）
  - 如果数据超过保留期限 + 额外保留期（如 30 天），系统执行硬删除（从数据库删除）
**And** 系统不删除标记为"重要"的数据（即使超过保留期限）

**Given** 管理员查看数据保留策略
**When** 管理员在系统设置界面查看数据保留策略
**Then** 系统显示当前配置的数据保留策略
**And** 系统显示即将过期的数据统计（如"30 天后将有 100 条记录过期"）
**And** 系统显示最近自动删除操作的记录

**Implementation Notes:**
- 实现数据保留策略配置功能
- 实现自动删除任务（使用 Cron Job 或类似机制）
- 实现过期数据识别和删除
- 实现数据保留策略检查
- 参考 FR100: 系统可以根据数据保留策略自动删除过期数据
- 确保自动删除功能安全可靠，防止误删除
- 确保自动删除功能性能良好，处理大量数据时不影响系统性能

---

## Epic 10: 协作功能

用户成果：用户可以在互动记录中添加评论进行团队协作，查看评论历史

### Story 10.1: 互动记录评论（按角色）

As a **前端专员/后端专员/总监/管理员**,
I want **在互动记录中添加评论**,
So that **我可以与团队成员就特定互动进行讨论和协作**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统并查看某个采购商的互动记录
**When** 前端专员在互动记录详情页的评论区输入评论并提交
**Then** 系统保存评论，并显示评论内容、评论者、评论时间（FR101）
**And** 评论只对有权限查看该互动记录的用户可见
**And** 前端专员无法在供应商相关的互动记录中添加评论

**Given** 后端专员已登录系统并查看某个供应商的互动记录
**When** 后端专员在互动记录详情页的评论区输入评论并提交
**Then** 系统保存评论，并显示评论内容、评论者、评论时间（FR101）
**And** 评论只对有权限查看该互动记录的用户可见
**And** 后端专员无法在采购商相关的互动记录中添加评论

**Given** 总监或管理员已登录系统并查看任何互动记录
**When** 总监或管理员在互动记录详情页的评论区输入评论并提交
**Then** 系统保存评论，并显示评论内容、评论者、评论时间（FR101）
**And** 评论只对有权限查看该互动记录的用户可见

**Given** 用户添加评论
**When** 用户在评论区输入评论
**Then** 系统支持多行文本输入
**And** 系统支持文本格式化（可选，如加粗、列表等）
**And** 系统显示字符计数（可选）
**And** 系统验证评论内容不为空

**Given** 用户提交评论
**When** 评论内容验证通过
**Then** 系统保存评论到数据库
**And** 系统自动记录评论者（当前用户）和评论时间
**And** 系统显示成功消息"评论已添加"
**And** 评论立即显示在评论区

**Given** 用户提交评论
**When** 评论内容为空或验证失败
**Then** 系统显示验证错误消息（如"评论内容不能为空"）
**And** 评论不被保存

**Implementation Notes:**
- 实现互动记录评论功能
- 实现基于角色的评论权限控制（前端专员只能评论采购商互动，后端专员只能评论供应商互动）
- 实现评论的创建和显示
- 参考 FR101: 所有用户可以在互动记录中添加评论（前端专员只能评论采购商相关的互动记录，后端专员只能评论供应商相关的互动记录，总监和管理员可以评论所有互动记录）
- 确保评论功能简单易用，支持团队协作

---

### Story 10.2: 互动记录评论历史查看（按角色）

As a **前端专员/后端专员/总监/管理员**,
I want **查看互动记录的评论历史**,
So that **我可以回顾团队讨论，了解决策过程**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统并查看某个采购商的互动记录
**When** 前端专员查看互动记录详情页的评论区
**Then** 系统显示该互动记录的所有评论，按时间倒序排列（FR102）
**And** 评论历史包含评论内容、评论者、评论时间
**And** 前端专员无法查看供应商相关互动记录的评论历史

**Given** 后端专员已登录系统并查看某个供应商的互动记录
**When** 后端专员查看互动记录详情页的评论区
**Then** 系统显示该互动记录的所有评论，按时间倒序排列（FR102）
**And** 评论历史包含评论内容、评论者、评论时间
**And** 后端专员无法查看采购商相关互动记录的评论历史

**Given** 总监或管理员已登录系统并查看任何互动记录
**When** 总监或管理员查看互动记录详情页的评论区
**Then** 系统显示该互动记录的所有评论，按时间倒序排列（FR102）
**And** 评论历史包含评论内容、评论者、评论时间、客户类型等信息

**Given** 用户查看评论历史
**When** 评论历史记录较多（> 20 条）
**Then** 系统使用分页或滚动加载显示评论
**And** 系统显示评论总数
**And** 系统支持实时更新（新评论自动显示）

**Given** 用户查看评论历史
**When** 没有评论
**Then** 系统显示空状态"暂无评论"
**And** 系统提供"添加评论"按钮

**Given** 用户查看评论历史
**When** 用户查看评论
**Then** 系统显示评论的完整信息：
  - 评论内容
  - 评论者（姓名、头像）
  - 评论时间（相对时间，如"2 小时前"）
  - 评论编辑时间（如果评论被编辑过）

**Implementation Notes:**
- 实现评论历史查看功能
- 实现基于角色的评论权限控制
- 实现评论的排序和分页
- 实现评论的实时更新（可选，使用 WebSocket 或轮询）
- 参考 FR102: 所有用户可以查看互动记录的评论历史（前端专员只能查看采购商相关互动记录的评论历史，后端专员只能查看供应商相关互动记录的评论历史，总监和管理员可以查看所有互动记录的评论历史）
- 确保评论历史功能简单易用，支持团队协作

---

### Story 10.3: 评论编辑和删除

As a **所有用户**,
I want **编辑和删除自己创建的评论**,
So that **我可以修正错误或删除不需要的评论**.

**Acceptance Criteria:**

**Given** 用户已创建评论
**When** 用户在评论历史中选择自己创建的评论，点击"编辑"
**Then** 系统显示评论编辑表单，预填充现有评论内容
**And** 用户可以修改评论内容
**And** 系统验证修改后的评论内容不为空

**Given** 用户编辑评论
**When** 用户提交修改
**Then** 系统验证修改后的数据
**And** 系统更新评论内容
**And** 系统自动记录编辑时间
**And** 系统显示成功消息"评论已更新"
**And** 评论显示"已编辑"标记

**Given** 用户已创建评论
**When** 用户在评论历史中选择自己创建的评论，点击"删除"
**Then** 系统显示确认对话框"确定要删除这条评论吗？"
**And** 用户确认删除后，系统执行软删除（标记为 deleted_at）
**And** 评论从列表中移除（但数据保留用于审计）
**And** 系统显示成功消息"评论已删除"

**Given** 用户尝试编辑或删除其他用户创建的评论
**When** 用户点击"编辑"或"删除"按钮
**Then** 系统显示权限错误"您只能编辑/删除自己创建的评论"
**And** 系统不执行编辑或删除操作

**Given** 用户删除评论
**When** 系统执行软删除
**Then** 系统记录删除操作到审计日志
**And** 系统保留评论数据用于历史追溯

**Implementation Notes:**
- 实现评论编辑和删除功能
- 实现基于创建者的权限控制
- 实现软删除策略（标记为 deleted_at）
- 参考横切关注点 FR117: 操作失败时提供错误信息和恢复建议
- 确保评论编辑和删除功能安全可靠，防止误操作

---

## Epic 11: 批量操作

用户成果：用户可以执行批量操作（批量发送报价、批量编辑、批量删除等），提升操作效率

### Story 11.1: 批量发送报价（前端专员）

As a **前端专员**,
I want **批量发送报价给多个采购商（针对同一产品）**,
So that **我可以高效地处理多个采购商的报价需求**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统并进入采购商列表或产品详情页
**When** 前端专员选择多个采购商，并点击"批量发送报价"按钮
**Then** 系统显示报价发送表单，允许前端专员选择产品、填写报价内容、设置有效期等（FR113）
**And** 系统验证所有选中的采购商都是采购商类型
**And** 系统验证产品已选择

**Given** 前端专员填写批量报价表单
**When** 前端专员选择产品、填写报价内容、设置有效期等
**Then** 系统验证所有必填字段已填写
**And** 系统显示将发送报价的采购商列表（预览）
**And** 前端专员可以移除选中的采购商（在发送前）

**Given** 前端专员提交批量报价
**When** 所有验证通过
**Then** 系统为每个选中的采购商生成独立的报价记录
**And** 系统在发送报价后，自动记录"发送报价"互动到每个采购商的互动历史中
**And** 系统显示成功消息"已成功向 X 个采购商发送报价"
**And** 系统显示发送结果摘要（成功数、失败数）

**Given** 前端专员提交批量报价
**When** 部分采购商发送失败
**Then** 系统显示部分成功消息"已成功向 X 个采购商发送报价，Y 个失败"
**And** 系统显示失败采购商列表和失败原因
**And** 前端专员可以重试失败的发送

**Given** 前端专员提交批量报价
**When** 必填字段缺失或验证失败
**Then** 系统显示验证错误消息
**And** 批量报价不被发送

**Implementation Notes:**
- 实现批量发送报价功能
- 实现批量操作表单
- 实现批量操作结果处理（成功/失败）
- 参考 FR113: 前端专员可以批量发送报价给多个采购商（针对同一产品）
- 参考横切关注点 FR117: 操作失败时提供错误信息和恢复建议
- 确保批量操作功能稳定可靠，处理大量数据时性能良好

---

### Story 11.2: 批量选择和操作记录（按角色）

As a **前端专员/后端专员/总监/管理员**,
I want **批量选择多条记录进行操作（批量编辑、批量删除等）**,
So that **我可以高效地管理我的数据**.

**Acceptance Criteria:**

**Given** 前端专员已登录系统并查看采购商列表、产品列表或互动记录列表
**When** 前端专员选择多条采购商相关记录（例如：多个采购商、多个采购商互动记录）
**Then** 系统显示批量操作菜单，包含"批量编辑"、"批量删除"等选项（FR114）
**And** 系统显示已选择的记录数量
**And** 前端专员可以取消选择记录
**And** 前端专员无法批量选择和操作供应商相关记录

**Given** 后端专员已登录系统并查看供应商列表、产品列表或互动记录列表
**When** 后端专员选择多条供应商相关记录（例如：多个供应商、多个供应商互动记录）
**Then** 系统显示批量操作菜单，包含"批量编辑"、"批量删除"等选项（FR114）
**And** 系统显示已选择的记录数量
**And** 后端专员可以取消选择记录
**And** 后端专员无法批量选择和操作采购商相关记录

**Given** 总监或管理员已登录系统并查看任何列表
**When** 总监或管理员选择多条记录
**Then** 系统显示批量操作菜单，包含"批量编辑"、"批量删除"等选项（FR114）
**And** 系统显示已选择的记录数量
**And** 总监或管理员可以取消选择记录

**Given** 用户执行批量编辑操作
**When** 用户选择多条记录并点击"批量编辑"
**Then** 系统显示批量编辑表单，允许用户修改选中记录的公共字段
**And** 系统显示将修改的记录列表（预览）
**And** 用户可以选择要修改的字段（如状态、标签等）

**Given** 用户提交批量编辑
**When** 所有验证通过
**Then** 系统批量更新所有选中的记录
**And** 系统显示成功消息"已成功更新 X 条记录"
**And** 系统显示更新结果摘要（成功数、失败数）
**And** 系统记录批量操作到审计日志

**Given** 用户执行批量删除操作
**When** 用户选择多条记录并点击"批量删除"
**Then** 系统显示确认对话框"确定要删除选中的 X 条记录吗？此操作不可撤销"
**And** 用户确认删除后，系统执行软删除（标记为 deleted_at）
**And** 记录从列表中移除（但数据保留用于审计）
**And** 系统显示成功消息"已成功删除 X 条记录"
**And** 系统记录批量操作到审计日志

**Given** 用户执行批量操作
**When** 批量操作失败
**Then** 系统显示错误消息
**And** 系统提供错误详情和恢复建议（FR117）
**And** 系统显示部分成功结果（如果有部分记录操作成功）

**Implementation Notes:**
- 实现批量选择和操作功能
- 实现批量编辑功能
- 实现批量删除功能
- 实现基于角色的批量操作权限控制
- 参考 FR114: 前端专员可以批量选择和操作采购商相关记录（批量编辑、批量删除等）；后端专员可以批量选择和操作供应商相关记录（批量编辑、批量删除等）；总监和管理员可以批量选择和操作所有记录（批量编辑、批量删除等）
- 参考横切关注点 FR117: 操作失败时提供错误信息和恢复建议
- 确保批量操作功能稳定可靠，处理大量数据时性能良好
- 确保批量操作有适当的确认机制，防止误操作

---

## Epic 12: 智能建议和自动化

用户成果：系统可以自动建议可能关联的产品和客户，提升记录效率

### Story 12.1: 互动记录产品智能建议

As a **所有用户**,
I want **在记录互动时，系统能根据历史数据自动建议可能关联的产品**,
So that **我可以快速准确地关联产品，减少手动查找和输入**.

**Acceptance Criteria:**

**Given** 用户已登录系统并打开互动记录表单
**When** 用户选择客户后，在产品关联字段中
**Then** 系统根据该客户的历史互动记录，自动建议最常关联的产品列表（FR122）
**And** 建议列表按关联频率排序（最常关联的产品在前）
**And** 建议列表显示产品名称、HS编码、关联次数等信息
**And** 用户可以从建议列表中选择产品，或继续手动搜索

**Given** 用户使用产品智能建议
**When** 系统显示建议列表
**Then** 系统显示最多 10 个建议产品（避免列表过长）
**And** 系统显示"查看更多"选项（如果建议产品超过 10 个）
**And** 建议列表实时更新，反映最新的互动模式

**Given** 用户使用产品智能建议
**When** 客户没有历史互动记录
**Then** 系统显示空状态"该客户暂无历史互动记录，无法提供产品建议"
**And** 用户可以手动搜索和选择产品

**Given** 用户使用产品智能建议
**When** 用户从建议列表中选择产品
**Then** 系统自动填充产品信息到表单
**And** 产品字段显示为已选择状态
**And** 用户可以清除选择，重新选择产品

**Given** 用户使用产品智能建议
**When** 系统计算产品建议
**Then** 系统在 1 秒内显示建议列表
**And** 建议计算响应时间 < 500ms（P95）
**And** 系统使用缓存优化建议计算性能

**Implementation Notes:**
- 实现产品智能建议功能（基于历史互动记录）
- 实现建议算法（计算产品关联频率）
- 实现建议列表缓存和性能优化
- 参考 FR122: 系统可以根据历史数据自动建议可能关联的产品（在记录互动时）
- 确保智能建议功能性能良好，不影响表单加载速度
- 确保智能建议准确率 > 70%（基于历史数据）

---

### Story 12.2: 互动记录客户智能建议

As a **所有用户**,
I want **在记录互动时，系统能根据历史数据自动建议可能关联的客户**,
So that **我可以快速准确地关联客户，减少手动查找和输入**.

**Acceptance Criteria:**

**Given** 用户已登录系统并打开互动记录表单
**When** 用户选择产品后，在客户关联字段中
**Then** 系统根据该产品的历史互动记录，自动建议最常关联的客户列表（FR123）
**And** 建议列表按关联频率排序（最常关联的客户在前）
**And** 建议列表显示客户名称、客户代码、关联次数等信息
**And** 用户可以从建议列表中选择客户，或继续手动搜索

**Given** 前端专员使用客户智能建议
**When** 系统显示建议列表
**Then** 系统只显示采购商类型的客户建议
**And** 系统不显示供应商类型的客户建议

**Given** 后端专员使用客户智能建议
**When** 系统显示建议列表
**Then** 系统只显示供应商类型的客户建议
**And** 系统不显示采购商类型的客户建议

**Given** 总监或管理员使用客户智能建议
**When** 系统显示建议列表
**Then** 系统显示所有类型的客户建议（采购商和供应商）
**And** 系统按客户类型分组显示建议

**Given** 用户使用客户智能建议
**When** 系统显示建议列表
**Then** 系统显示最多 10 个建议客户（避免列表过长）
**And** 系统显示"查看更多"选项（如果建议客户超过 10 个）
**And** 建议列表实时更新，反映最新的互动模式

**Given** 用户使用客户智能建议
**When** 产品没有历史互动记录
**Then** 系统显示空状态"该产品暂无历史互动记录，无法提供客户建议"
**And** 用户可以手动搜索和选择客户

**Given** 用户使用客户智能建议
**When** 用户从建议列表中选择客户
**Then** 系统自动填充客户信息到表单
**And** 客户字段显示为已选择状态
**And** 用户可以清除选择，重新选择客户

**Given** 用户使用客户智能建议
**When** 系统计算客户建议
**Then** 系统在 1 秒内显示建议列表
**And** 建议计算响应时间 < 500ms（P95）
**And** 系统使用缓存优化建议计算性能

**Implementation Notes:**
- 实现客户智能建议功能（基于历史互动记录）
- 实现建议算法（计算客户关联频率）
- 实现基于角色的客户建议过滤（前端专员只看到采购商，后端专员只看到供应商）
- 实现建议列表缓存和性能优化
- 参考 FR123: 系统可以根据历史数据自动建议可能关联的客户（在记录互动时，前端专员只看到采购商建议，后端专员只看到供应商建议，总监和管理员看到所有客户建议）
- 确保智能建议功能性能良好，不影响表单加载速度
- 确保智能建议准确率 > 70%（基于历史数据）

---

## Epic 13: 用户引导和个性化

用户成果：新用户可以获得引导和帮助，所有用户可以自定义个人偏好和快捷操作

### Story 13.1: 新用户产品关联引导

As a **新用户**,
I want **在首次使用产品关联功能时获得引导和帮助**,
So that **我可以快速理解如何正确关联产品，顺利开始工作**.

**Acceptance Criteria:**

**Given** 新用户首次登录系统
**When** 新用户首次尝试记录互动并关联产品
**Then** 系统显示一个简短的产品关联功能引导教程（例如：气泡提示、分步指南），解释产品关联的重要性、操作步骤和最佳实践（FR126）
**And** 引导教程包含：
  - 产品关联的重要性说明
  - 如何选择产品（自动完成功能）
  - 产品关联的最佳实践
**And** 用户可以跳过或完成引导
**And** 引导完成后不再重复显示

**Given** 新用户完成产品关联引导
**When** 新用户完成引导教程
**Then** 系统记录用户已完成产品关联引导
**And** 系统不再显示产品关联引导
**And** 系统显示"欢迎使用产品关联功能"的提示

**Given** 新用户跳过产品关联引导
**When** 新用户点击"跳过"按钮
**Then** 系统关闭引导教程
**And** 系统记录用户已跳过产品关联引导
**And** 系统在用户设置中提供"重新查看引导"选项

**Implementation Notes:**
- 实现新用户引导功能（使用 React Joyride 或类似库）
- 实现引导教程内容（产品关联功能说明）
- 实现引导完成状态记录
- 参考 FR126: 新用户可以在首次使用产品关联功能时获得引导和帮助
- 确保引导教程简洁明了，不干扰用户操作
- 确保引导教程可以跳过和重新查看

---

### Story 13.2: 快捷操作入口

As a **所有用户**,
I want **快速访问常用操作**,
So that **我可以提高工作效率，减少导航时间**.

**Acceptance Criteria:**

**Given** 用户已登录系统
**When** 用户查看系统界面
**Then** 系统在显眼位置提供快捷操作入口（例如：侧边栏、顶部导航栏），包含"快速记录"、"查看我的任务"、"导入数据"等常用操作（FR127）
**And** 快捷操作入口可根据用户角色显示不同的默认选项
**And** 前端专员的快捷操作包括：快速记录采购商互动、查看我的采购商、搜索采购商等
**And** 后端专员的快捷操作包括：快速记录供应商互动、查看我的供应商、搜索供应商等
**And** 总监和管理员的快捷操作包括：快速记录互动、查看业务仪表板、数据导入导出等

**Given** 用户使用快捷操作入口
**When** 用户点击快捷操作按钮
**Then** 系统立即跳转到相应的功能页面或打开相应的功能模块
**And** 系统响应时间 < 500ms（P95）

**Given** 用户查看快捷操作入口
**When** 系统显示快捷操作列表
**Then** 系统显示操作图标、操作名称、操作描述（可选）
**And** 快捷操作列表支持触摸操作（移动端）
**And** 快捷操作列表支持键盘快捷键（桌面端，可选）

**Implementation Notes:**
- 实现快捷操作入口功能
- 实现基于角色的快捷操作配置
- 实现快捷操作响应式设计（桌面端和移动端）
- 参考 FR127: 所有用户可以快速访问常用操作（快捷操作入口）
- 确保快捷操作入口直观易用，提高用户效率

---

### Story 13.3: 上下文帮助

As a **所有用户**,
I want **在需要时获得上下文帮助**,
So that **我可以快速解决遇到的问题，无需离开当前页面**.

**Acceptance Criteria:**

**Given** 用户在某个功能模块（例如：数据导入界面）遇到疑问
**When** 用户点击"帮助"图标或悬停在某个字段上
**Then** 系统显示与当前上下文相关的帮助信息（例如：数据导入格式要求、字段说明），无需跳转页面（FR128）
**And** 帮助信息简洁明了，提供操作指引
**And** 帮助信息以工具提示、模态框或侧边栏形式显示

**Given** 用户查看上下文帮助
**When** 系统显示帮助信息
**Then** 帮助信息包含：
  - 功能说明
  - 操作步骤
  - 常见问题
  - 相关链接（可选）
**And** 帮助信息支持搜索（如果帮助内容较多）

**Given** 用户在表单字段上悬停
**When** 用户悬停在字段标签或帮助图标上
**Then** 系统显示该字段的说明信息（例如：字段用途、格式要求、示例值）
**And** 工具提示自动消失（当鼠标移开时）

**Given** 用户查看上下文帮助
**When** 帮助信息较长
**Then** 系统使用模态框或侧边栏显示完整帮助信息
**And** 用户可以关闭帮助信息，返回原页面

**Implementation Notes:**
- 实现上下文帮助功能（使用工具提示、模态框或侧边栏）
- 实现帮助内容管理（可以存储在数据库或配置文件中）
- 实现帮助信息搜索功能（可选）
- 参考 FR128: 所有用户可以在需要时获得上下文帮助（无需离开当前页面）
- 确保帮助信息准确、及时、易于理解

---

### Story 13.4: 个人偏好设置

As a **所有用户**,
I want **设置个人偏好（默认视图、提醒偏好、显示偏好等）**,
So that **我可以根据自己的习惯定制系统界面和行为**.

**Acceptance Criteria:**

**Given** 用户已登录系统并进入个人设置界面
**When** 用户修改默认视图（例如：客户列表默认显示时间线视图）、提醒偏好（例如：关闭所有提醒）、显示偏好（例如：深色模式）
**Then** 系统保存用户的个人偏好设置（FR129）
**And** 用户的界面和系统行为根据设置立即生效
**And** 系统显示成功消息"偏好设置已保存"

**Given** 用户设置个人偏好
**When** 用户修改偏好设置
**Then** 系统支持的偏好设置包括：
  - 默认视图（列表视图、时间线视图、卡片视图等）
  - 提醒偏好（站内通知、邮件通知、关闭提醒等）
  - 显示偏好（深色模式、浅色模式、字体大小等）
  - 语言偏好（中文、英文等，如果系统支持多语言）

**Given** 用户设置个人偏好
**When** 用户保存偏好设置
**Then** 系统验证偏好设置的有效性
**And** 系统保存偏好设置到数据库（用户配置表）
**And** 系统在用户下次登录时应用偏好设置

**Given** 用户查看个人偏好设置
**When** 用户在个人设置界面查看偏好设置
**Then** 系统显示当前的所有偏好设置
**And** 用户可以修改任何偏好设置
**And** 用户可以重置偏好设置为默认值

**Implementation Notes:**
- 实现个人偏好设置功能
- 实现偏好设置的存储和加载
- 实现偏好设置的实时应用
- 参考 FR129: 所有用户可以设置个人偏好（默认视图、提醒偏好、显示偏好等）
- 确保偏好设置功能简单易用，不影响系统性能

---

### Story 13.5: 快捷操作自定义

As a **所有用户**,
I want **自定义快捷操作入口**,
So that **我可以根据自己的工作习惯，将最常用的功能放到快捷入口**.

**Acceptance Criteria:**

**Given** 用户已登录系统并进入个人设置界面
**When** 用户在"快捷操作自定义"模块中选择或拖拽常用功能到快捷入口区域
**Then** 系统保存用户的自定义设置（FR130）
**And** 快捷入口立即更新，显示用户选择的功能
**And** 系统显示成功消息"快捷操作已更新"

**Given** 用户自定义快捷操作
**When** 用户选择快捷操作
**Then** 系统显示可用的功能列表（根据用户角色过滤）
**And** 用户可以选择最多 10 个快捷操作（避免列表过长）
**And** 用户可以拖拽调整快捷操作的顺序

**Given** 用户自定义快捷操作
**When** 用户保存自定义设置
**Then** 系统验证快捷操作的有效性（确保用户有权限访问选中的功能）
**And** 系统保存快捷操作配置到数据库
**And** 系统在用户下次登录时应用快捷操作配置

**Given** 用户查看快捷操作自定义
**When** 用户在个人设置界面查看快捷操作配置
**Then** 系统显示当前的快捷操作列表
**And** 用户可以添加、删除、重新排序快捷操作
**And** 用户可以重置快捷操作为默认配置

**Implementation Notes:**
- 实现快捷操作自定义功能
- 实现拖拽排序功能（使用 react-beautiful-dnd 或类似库）
- 实现快捷操作配置的存储和加载
- 参考 FR130: 所有用户可以自定义快捷操作入口（选择常用功能到快捷入口）
- 确保快捷操作自定义功能简单易用，提高用户效率

---

### Story 13.6: 帮助文档和用户指南

As a **所有用户**,
I want **访问完整的帮助文档和用户指南**,
So that **我可以系统学习系统功能，解决复杂问题**.

**Acceptance Criteria:**

**Given** 用户已登录系统
**When** 用户点击"帮助中心"或"用户指南"链接
**Then** 系统跳转到包含完整帮助文档和用户指南的页面（FR149）
**And** 帮助文档内容结构清晰，支持搜索
**And** 帮助文档包含：
  - 系统功能介绍
  - 操作指南
  - 常见问题
  - 视频教程（可选）

**Given** 用户查看帮助文档
**When** 用户在帮助文档页面
**Then** 系统显示帮助文档目录（侧边栏或顶部导航）
**And** 用户可以点击目录跳转到相应的章节
**And** 系统支持全文搜索帮助文档

**Given** 用户搜索帮助文档
**When** 用户在搜索框中输入关键词
**Then** 系统显示匹配的帮助文档结果
**And** 搜索结果按相关性排序
**And** 用户可以点击搜索结果查看详细内容

**Given** 用户查看帮助文档
**When** 帮助文档内容较长
**Then** 系统使用分页或滚动加载显示内容
**And** 系统支持打印帮助文档（可选）

**Implementation Notes:**
- 实现帮助文档和用户指南页面
- 实现帮助文档搜索功能
- 实现帮助文档内容管理（可以存储在数据库或 Markdown 文件中）
- 参考 FR149: 所有用户可以访问帮助文档和用户指南
- 确保帮助文档内容完整、准确、易于理解
- 确保帮助文档易于维护和更新

---

## Epic 14: API 和集成

用户成果：系统通过 GraphQL API 提供所有功能，支持第三方集成和 Webhook

### Story 14.1: GraphQL API 核心功能暴露

As a **开发者**,
I want **通过 GraphQL API 访问所有核心功能（客户、产品、互动记录的增删改查）**,
So that **我可以为第三方系统提供集成能力**.

**Acceptance Criteria:**

**Given** 开发者拥有有效的 API 密钥和权限
**When** 开发者通过 GraphQL API 发送查询或变更请求
**Then** 系统返回客户、产品、互动记录的增删改查结果（FR131）
**And** API 响应时间 < 500ms（NFR：性能）
**And** API 遵循 GraphQL 规范，提供清晰的 Schema 定义
**And** 系统在操作失败时提供错误信息和恢复建议（FR117）

**Given** 开发者使用 GraphQL API 查询客户
**When** 开发者发送客户查询请求
**Then** 系统返回客户数据（根据开发者权限过滤）
**And** 系统支持查询客户列表、单个客户详情、客户关联数据等
**And** 系统支持分页、排序、筛选等查询参数

**Given** 开发者使用 GraphQL API 查询产品
**When** 开发者发送产品查询请求
**Then** 系统返回产品数据
**And** 系统支持查询产品列表、单个产品详情、产品关联数据等
**And** 系统支持分页、排序、筛选等查询参数

**Given** 开发者使用 GraphQL API 查询互动记录
**When** 开发者发送互动记录查询请求
**Then** 系统返回互动记录数据（根据开发者权限过滤）
**And** 系统支持查询互动记录列表、单个互动记录详情、互动记录关联数据等
**And** 系统支持分页、排序、筛选等查询参数

**Given** 开发者使用 GraphQL API 创建、更新、删除数据
**When** 开发者发送变更请求
**Then** 系统验证请求数据的格式和完整性
**And** 系统验证开发者的权限（确保有权限执行操作）
**And** 系统执行变更操作并返回结果
**And** 系统记录 API 操作到审计日志

**Given** 开发者使用 GraphQL API
**When** API 请求失败
**Then** 系统返回清晰的错误信息（错误代码、错误消息、错误详情）
**And** 系统提供错误恢复建议（FR117）

**Implementation Notes:**
- 实现 GraphQL API（使用 Apollo Server 或类似框架）
- 实现 GraphQL Schema 定义（客户、产品、互动记录等）
- 实现 API 认证和授权（API 密钥、JWT Token 等）
- 实现 API 权限控制（基于角色的数据过滤）
- 实现 API 错误处理和日志记录
- 参考 FR131: 系统可以通过 GraphQL API 提供所有功能能力（客户、产品、互动记录的增删改查）
- 参考横切关注点 FR117: 操作失败时提供错误信息和恢复建议
- 确保 API 性能良好，响应时间符合要求
- 确保 API 安全可靠，防止未授权访问

---

### Story 14.2: 第三方系统集成支持

As a **管理员**,
I want **配置第三方系统集成（例如：ERP 系统、邮件营销系统）**,
So that **我可以扩展 CRM 功能，实现数据互通**.

**Acceptance Criteria:**

**Given** 管理员已登录系统并进入集成设置界面
**When** 管理员选择一个第三方系统并配置集成参数（例如：API Key, Webhook URL）
**Then** 系统保存集成配置，并尝试建立连接（FR132）
**And** 系统提供集成状态显示（连接成功/失败）
**And** 系统在集成失败时提供错误信息和恢复建议（FR117）

**Given** 管理员配置第三方系统集成
**When** 管理员填写集成配置
**Then** 系统支持的集成配置包括：
  - 集成名称
  - API Key / API Secret
  - Webhook URL
  - 集成类型（ERP、邮件营销、其他）
  - 同步方向（单向、双向）
  - 同步频率（实时、定时）

**Given** 管理员配置第三方系统集成
**When** 管理员保存集成配置
**Then** 系统验证集成配置的有效性（测试连接）
**And** 系统保存集成配置到数据库
**And** 系统显示集成状态（已连接、未连接、错误）

**Given** 管理员查看第三方系统集成
**When** 管理员在集成设置界面查看集成列表
**Then** 系统显示所有已配置的集成
**And** 系统显示每个集成的状态、最后同步时间、同步记录数等信息
**And** 管理员可以编辑、删除、启用/禁用集成

**Given** 第三方系统集成运行
**When** 集成执行数据同步
**Then** 系统记录同步操作到日志
**And** 系统显示同步结果（成功数、失败数）
**And** 系统在同步失败时发送通知（站内通知或邮件）

**Implementation Notes:**
- 实现第三方系统集成配置功能
- 实现集成连接测试
- 实现集成状态监控
- 实现集成日志记录
- 参考 FR132: 系统可以支持第三方系统集成（例如：ERP 系统、邮件营销系统）
- 参考横切关注点 FR117: 操作失败时提供错误信息和恢复建议
- 确保集成功能稳定可靠，支持多种第三方系统

---

### Story 14.3: Webhook 数据接收

As a **系统**,
I want **接收来自第三方系统的数据（通过 Webhook 或 API）**,
So that **我可以实时同步外部数据，保持数据一致性**.

**Acceptance Criteria:**

**Given** 第三方系统配置了 Webhook，并在数据变更时发送通知
**When** 系统接收到来自第三方系统的 Webhook 请求
**Then** 系统解析请求内容，并根据预设规则更新 CRM 数据（FR133）
**And** 系统记录 Webhook 接收日志，包括请求内容、处理结果
**And** 系统在处理失败时提供错误处理和重试机制（NFR：集成）

**Given** 系统接收 Webhook 请求
**When** 系统验证 Webhook 请求
**Then** 系统验证 Webhook 签名（如果配置了签名验证）
**And** 系统验证请求来源（IP 白名单或域名验证）
**And** 系统验证请求格式（JSON 格式、必需字段等）

**Given** 系统处理 Webhook 请求
**When** 系统解析请求内容
**Then** 系统根据 Webhook 类型执行相应的处理逻辑：
  - 客户数据同步（创建、更新、删除客户）
  - 产品数据同步（创建、更新、删除产品）
  - 订单数据同步（创建、更新订单）
**And** 系统验证数据格式和完整性
**And** 系统执行数据更新操作

**Given** 系统处理 Webhook 请求
**When** 处理成功
**Then** 系统返回成功响应（HTTP 200）
**And** 系统记录处理结果到日志
**And** 系统更新集成状态（最后同步时间、同步记录数）

**Given** 系统处理 Webhook 请求
**When** 处理失败
**Then** 系统返回错误响应（HTTP 400/500）
**And** 系统记录错误详情到日志
**And** 系统实现重试机制（最多重试 3 次，指数退避）
**And** 系统发送错误通知（站内通知或邮件）

**Implementation Notes:**
- 实现 Webhook 接收端点（使用 Express 或类似框架）
- 实现 Webhook 请求验证（签名验证、来源验证）
- 实现 Webhook 数据处理逻辑
- 实现 Webhook 重试机制
- 实现 Webhook 日志记录
- 参考 FR133: 系统可以接收来自第三方系统的数据（通过 Webhook 或 API）
- 确保 Webhook 功能安全可靠，防止恶意请求
- 确保 Webhook 处理性能良好，响应时间符合要求

---

### Story 14.4: GraphQL API 版本控制

As a **开发者**,
I want **GraphQL API 支持版本控制**,
So that **我可以平滑升级 API，确保向后兼容性**.

**Acceptance Criteria:**

**Given** 开发者使用 GraphQL API
**When** 系统发布新的 API 版本
**Then** 旧版本 API 仍然可用，并提供明确的弃用通知（FR144）
**And** 开发者可以通过 URL 或 Header 指定 API 版本
**And** API 文档清晰说明版本差异和迁移指南

**Given** 开发者使用 GraphQL API
**When** 开发者通过 URL 指定 API 版本（例如：/api/v1/graphql）
**Then** 系统使用指定版本的 API Schema
**And** 系统返回符合该版本的 API 响应
**And** 如果版本不存在，系统返回错误信息

**Given** 开发者使用 GraphQL API
**When** 开发者通过 Header 指定 API 版本（例如：X-API-Version: v1）
**Then** 系统使用指定版本的 API Schema
**And** 系统返回符合该版本的 API 响应

**Given** 开发者使用旧版本 API
**When** 旧版本 API 被标记为弃用
**Then** 系统在 API 响应中包含弃用警告（Deprecation Warning）
**And** 系统在 API 文档中说明弃用时间和替代方案
**And** 系统在弃用期限到期前至少提前 3 个月通知开发者

**Given** 开发者查看 API 文档
**When** 开发者访问 API 文档
**Then** 系统显示所有可用的 API 版本
**And** 系统显示每个版本的 Schema 定义
**And** 系统显示版本差异和迁移指南

**Implementation Notes:**
- 实现 GraphQL API 版本控制（使用 URL 路径或 Header）
- 实现 API 版本管理（版本号、弃用策略）
- 实现 API 文档版本化
- 参考 FR144: 系统可以通过 GraphQL API 提供版本控制能力
- 确保 API 版本控制策略清晰，向后兼容性良好
- 确保 API 文档完整、准确、易于理解

---

## Epic 15: 通知和提醒（Growth 阶段）

用户成果：系统可以自动提醒用户跟进客户、处理待办事项，用户可以设置提醒偏好

### Story 15.1: 客户跟进自动提醒

As a **所有用户**,
I want **系统自动提醒我跟进客户**,
So that **我可以及时与客户保持联系，不错过任何销售机会**.

**Acceptance Criteria:**

**Given** 用户在互动记录中设置了"下次跟进时间"
**When** 到达设定的跟进时间
**Then** 系统通过站内通知或邮件自动提醒用户跟进该客户（FR136）
**And** 提醒内容包含客户名称、上次互动时间、建议跟进内容
**And** 用户可以点击提醒直接跳转到客户详情页

**Given** 系统发送客户跟进提醒
**When** 系统检查需要提醒的客户
**Then** 系统每天定时检查（如每天上午 9 点）
**And** 系统查找所有设置了"下次跟进时间"且时间已到的互动记录
**And** 系统为每个需要跟进的客户生成提醒通知

**Given** 用户收到客户跟进提醒
**When** 用户查看提醒
**Then** 系统显示提醒详情：
  - 客户名称
  - 上次互动时间
  - 上次互动类型
  - 建议跟进内容（基于上次互动）
  - 客户详情链接

**Given** 用户处理客户跟进提醒
**When** 用户点击提醒并完成跟进
**Then** 系统标记提醒为"已处理"
**And** 系统记录跟进操作
**And** 系统不再重复发送该提醒

**Given** 用户未处理客户跟进提醒
**When** 提醒超过 24 小时未处理
**Then** 系统发送第二次提醒（可选，根据用户偏好）
**And** 系统标记提醒为"待处理"

**Implementation Notes:**
- 实现客户跟进提醒功能（使用 Cron Job 或类似机制）
- 实现提醒通知系统（站内通知、邮件通知）
- 实现提醒状态管理（待处理、已处理、已忽略）
- 参考 FR136: 系统可以自动提醒用户跟进客户
- 参考 FR140: 用户可以设置提醒偏好（提醒方式、提醒时间等）
- 确保提醒功能准确及时，不影响系统性能

---

### Story 15.2: 生产进度自动提醒

As a **后端专员**,
I want **系统自动提醒我跟进生产进度**,
So that **我可以及时掌握产品生产状态，确保按时交货**.

**Acceptance Criteria:**

**Given** 后端专员在生产进度记录中设置了"预计完成日期"或"关键节点日期"
**When** 到达设定的提醒日期前（例如：提前 2 天）
**Then** 系统通过站内通知或邮件自动提醒后端专员跟进生产进度（FR137）
**And** 提醒内容包含产品名称、供应商名称、当前进度、预计完成日期
**And** 后端专员可以点击提醒直接跳转到生产进度详情页

**Given** 系统发送生产进度提醒
**When** 系统检查需要提醒的生产进度
**Then** 系统每天定时检查（如每天上午 9 点）
**And** 系统查找所有设置了"预计完成日期"或"关键节点日期"且时间即将到达的生产进度记录
**And** 系统为每个需要跟进的生产进度生成提醒通知

**Given** 后端专员收到生产进度提醒
**When** 后端专员查看提醒
**Then** 系统显示提醒详情：
  - 产品名称
  - 供应商名称
  - 当前进度
  - 预计完成日期
  - 关键节点信息
  - 生产进度详情链接

**Given** 后端专员处理生产进度提醒
**When** 后端专员点击提醒并更新生产进度
**Then** 系统标记提醒为"已处理"
**And** 系统记录跟进操作
**And** 系统不再重复发送该提醒

**Given** 后端专员未处理生产进度提醒
**When** 提醒超过 24 小时未处理
**Then** 系统发送第二次提醒（可选，根据用户偏好）
**And** 系统标记提醒为"待处理"

**Implementation Notes:**
- 实现生产进度提醒功能（使用 Cron Job 或类似机制）
- 实现提醒通知系统（站内通知、邮件通知）
- 实现提醒状态管理
- 参考 FR137: 系统可以自动提醒后端专员跟进生产进度
- 参考 FR140: 用户可以设置提醒偏好
- 确保提醒功能准确及时，不影响系统性能

---

### Story 15.3: 发货前验收自动提醒

As a **后端专员**,
I want **系统自动提醒我进行发货前验收**,
So that **我可以确保在发货前完成质量检查**.

**Acceptance Criteria:**

**Given** 后端专员在订单或生产计划中设置了"预计发货日期"
**When** 到达设定的提醒日期前（例如：提前 3 天）
**Then** 系统通过站内通知或邮件自动提醒后端专员进行发货前验收（FR138）
**And** 提醒内容包含产品名称、供应商名称、预计发货日期
**And** 后端专员可以点击提醒直接跳转到验收记录界面

**Given** 系统发送发货前验收提醒
**When** 系统检查需要提醒的发货前验收
**Then** 系统每天定时检查（如每天上午 9 点）
**And** 系统查找所有设置了"预计发货日期"且时间即将到达的订单或生产计划
**And** 系统为每个需要验收的订单生成提醒通知

**Given** 后端专员收到发货前验收提醒
**When** 后端专员查看提醒
**Then** 系统显示提醒详情：
  - 产品名称
  - 供应商名称
  - 预计发货日期
  - 订单信息
  - 验收记录链接

**Given** 后端专员处理发货前验收提醒
**When** 后端专员点击提醒并完成验收记录
**Then** 系统标记提醒为"已处理"
**And** 系统记录验收操作
**And** 系统不再重复发送该提醒

**Given** 后端专员未处理发货前验收提醒
**When** 提醒超过 24 小时未处理
**Then** 系统发送第二次提醒（可选，根据用户偏好）
**And** 系统标记提醒为"待处理"

**Implementation Notes:**
- 实现发货前验收提醒功能（使用 Cron Job 或类似机制）
- 实现提醒通知系统（站内通知、邮件通知）
- 实现提醒状态管理
- 参考 FR138: 系统可以自动提醒后端专员进行发货前验收
- 参考 FR140: 用户可以设置提醒偏好
- 确保提醒功能准确及时，不影响系统性能

---

### Story 15.4: 待办事项自动提醒

As a **所有用户**,
I want **系统自动提醒我处理待办事项**,
So that **我可以及时完成任务，提高工作效率**.

**Acceptance Criteria:**

**Given** 用户在系统中创建了待办事项并设置了截止日期
**When** 到达待办事项的截止日期前（例如：提前 1 天）
**Then** 系统通过站内通知或邮件自动提醒用户处理该待办事项（FR139）
**And** 提醒内容包含待办事项名称、截止日期、关联客户/产品
**And** 用户可以点击提醒直接跳转到待办事项详情页

**Given** 系统发送待办事项提醒
**When** 系统检查需要提醒的待办事项
**Then** 系统每天定时检查（如每天上午 9 点）
**And** 系统查找所有设置了截止日期且时间即将到达的待办事项
**And** 系统为每个需要处理的待办事项生成提醒通知

**Given** 用户收到待办事项提醒
**When** 用户查看提醒
**Then** 系统显示提醒详情：
  - 待办事项名称
  - 截止日期
  - 关联客户/产品
  - 待办事项描述
  - 待办事项详情链接

**Given** 用户处理待办事项提醒
**When** 用户点击提醒并完成待办事项
**Then** 系统标记提醒为"已处理"
**And** 系统记录完成操作
**And** 系统不再重复发送该提醒

**Given** 用户未处理待办事项提醒
**When** 提醒超过 24 小时未处理
**Then** 系统发送第二次提醒（可选，根据用户偏好）
**And** 系统标记提醒为"待处理"

**Implementation Notes:**
- 实现待办事项提醒功能（使用 Cron Job 或类似机制）
- 实现提醒通知系统（站内通知、邮件通知）
- 实现提醒状态管理
- 参考 FR139: 系统可以自动提醒用户处理待办事项
- 参考 FR140: 用户可以设置提醒偏好
- 确保提醒功能准确及时，不影响系统性能

---

### Story 15.5: 提醒偏好设置

As a **所有用户**,
I want **设置提醒偏好（提醒方式、提醒时间等）**,
So that **我可以根据自己的习惯接收提醒，避免干扰**.

**Acceptance Criteria:**

**Given** 用户已登录系统并进入个人设置界面
**When** 用户在"提醒偏好"模块中修改提醒方式（例如：只接收站内通知，不接收邮件）、提醒时间（例如：每天上午 9 点统一提醒）
**Then** 系统保存用户的提醒偏好设置（FR140）
**And** 所有自动提醒都根据用户的偏好设置发送
**And** 系统显示成功消息"提醒偏好已保存"

**Given** 用户设置提醒偏好
**When** 用户修改提醒方式
**Then** 系统支持的提醒方式包括：
  - 站内通知（默认开启）
  - 邮件通知（可选）
  - 短信通知（可选，如果系统支持）
**And** 用户可以选择只接收站内通知、只接收邮件通知、或同时接收两种通知

**Given** 用户设置提醒偏好
**When** 用户修改提醒时间
**Then** 系统支持的提醒时间设置包括：
  - 统一提醒时间（如每天上午 9 点）
  - 实时提醒（立即发送）
  - 自定义提醒时间（如每天上午 9 点和下午 3 点）
**And** 用户可以为不同类型的提醒设置不同的提醒时间

**Given** 用户设置提醒偏好
**When** 用户修改提醒类型偏好
**Then** 系统支持的提醒类型包括：
  - 客户跟进提醒（默认开启）
  - 生产进度提醒（仅后端专员）
  - 发货前验收提醒（仅后端专员）
  - 待办事项提醒（默认开启）
**And** 用户可以选择开启或关闭特定类型的提醒

**Given** 用户设置提醒偏好
**When** 用户保存偏好设置
**Then** 系统验证偏好设置的有效性
**And** 系统保存偏好设置到数据库
**And** 系统在用户下次登录时应用偏好设置

**Implementation Notes:**
- 实现提醒偏好设置功能
- 实现偏好设置的存储和加载
- 实现偏好设置的实时应用
- 参考 FR140: 用户可以设置提醒偏好（提醒方式、提醒时间等）
- 确保提醒偏好设置功能简单易用，不影响系统性能

---

## Epic 16: 移除 Twenty CRM 依赖，实现原生技术栈

**用户成果：** 系统完全独立，无需 Docker 容器，支持 Vercel 部署，移除所有集成问题

**Epic 描述：**
移除 Twenty CRM 依赖，使用原生技术栈（NestJS + PostgreSQL + NextAuth.js）实现所有功能，支持 Vercel Serverless 部署。

**决策原因：**
1. 部署限制：Twenty CRM 需要 Docker 容器，无法部署到 Vercel
2. 集成问题：每次开发都遇到集成问题，影响开发效率
3. 长期收益：移除依赖后，开发速度提升，部署简化

**参考文档：**
- 重构计划：`_bmad-output/refactoring-plan-remove-twenty-dependency-2025-12-26.md`
- 架构文档：`docs/api-integration-architecture.md`

**Stories：**
- Story 16.1: 数据库设计和迁移脚本
- Story 16.2: 替换认证系统
- Story 16.3: 替换用户和角色管理
- Story 16.4: 替换客户和联系人管理
- Story 16.5: 更新产品和互动记录
- Story 16.6: 移除 Twenty 依赖和清理

---

### Story 16.1: 数据库设计和迁移脚本

As a **开发团队**,
I want **设计新数据库 Schema 并创建迁移脚本**,
So that **系统可以存储用户、角色、客户和联系人数据，无需依赖 Twenty CRM 数据库**.

**Acceptance Criteria:**

1. **Given** 需要替代 Twenty CRM 的数据模型
   **When** 开发团队设计新数据库 Schema
   **Then** 创建 `users` 表（用户信息、密码哈希、邮箱验证等）
   **And** 创建 `roles` 表（角色定义）
   **And** 创建 `user_roles` 表（用户角色关联，多对多）
   **And** 创建 `companies` 表（客户信息，支持供应商/采购商类型）
   **And** 创建 `people` 表（联系人信息，关联到客户）
   **And** 所有表包含必要的索引（性能优化）
   **And** 所有表包含审计字段（created_at, updated_at, deleted_at, created_by, updated_by）

2. **Given** 新数据库 Schema 已设计
   **When** 开发团队创建数据库迁移脚本
   **Then** 创建 `004-create-users-and-roles-tables.sql` 迁移脚本
   **And** 创建 `005-create-companies-and-people-tables.sql` 迁移脚本
   **And** 创建 `006-remove-workspace-dependencies.sql` 迁移脚本（更新现有表）
   **And** 所有迁移脚本可以成功执行
   **And** 所有迁移脚本支持回滚（如果可能）

3. **Given** 需要从 Twenty CRM 数据库迁移数据
   **When** 开发团队创建数据迁移脚本
   **Then** 创建 `migrate-from-twenty.ts` 脚本
   **And** 脚本可以导出用户数据（从 `core.user` 表）
   **And** 脚本可以导出角色数据（从 `core.role` 表）
   **And** 脚本可以导出客户数据（从 `core.company` 表）
   **And** 脚本可以导出联系人数据（从 `core.person` 表）
   **And** 脚本可以转换数据格式并导入到新表
   **And** 脚本验证数据完整性（外键关联、数据一致性）

**Implementation Notes:**
- 参考重构计划阶段 1：数据库设计和迁移脚本
- 数据库 Schema 设计参考：`_bmad-output/refactoring-plan-remove-twenty-dependency-2025-12-26.md`
- 迁移脚本位置：`fenghua-backend/migrations/`
- 数据迁移脚本位置：`fenghua-backend/scripts/migrate-from-twenty.ts`
- 确保所有迁移脚本可以独立执行
- 确保数据迁移脚本支持回滚（如果可能）

---

### Story 16.2: 替换认证系统

As a **所有用户**,
I want **使用原生认证系统登录**,
So that **系统可以独立运行，无需依赖 Twenty CRM 的认证服务**.

**Acceptance Criteria:**

1. **Given** 用户需要登录系统
   **When** 用户使用邮箱和密码登录
   **Then** 系统验证用户凭据（查询 `users` 表，验证密码哈希）
   **And** 系统生成 JWT token（包含用户 ID、邮箱、角色）
   **And** 系统返回 token 和用户信息
   **And** 系统更新用户最后登录时间
   **And** 前端可以存储 token 并用于后续请求

2. **Given** 用户已登录
   **When** 用户访问需要认证的 API 端点
   **Then** 系统验证 JWT token（使用 `JwtService.verify()`）
   **And** 系统查询用户信息（从 `users` 表，包含角色）
   **And** 系统返回用户信息（如果 token 有效）
   **And** 系统拒绝请求（如果 token 无效或过期）

3. **Given** 需要用户注册功能（可选）
   **When** 用户提供邮箱、密码、姓名等信息
   **Then** 系统验证邮箱唯一性
   **And** 系统加密密码（使用 bcrypt）
   **And** 系统创建用户记录（在 `users` 表）
   **And** 系统分配默认角色（如果需要）
   **And** 系统生成 JWT token 并返回

**Implementation Notes:**
- 参考重构计划阶段 2：替换认证系统
- 重构 `fenghua-backend/src/auth/auth.service.ts`：
  - 移除 `TwentyClientService` 依赖
  - 使用 `PrismaService` 查询 `users` 表
  - 使用 `JwtService` 生成和验证 token
  - 使用 bcrypt 加密和验证密码
- 更新 `fenghua-backend/src/auth/auth.module.ts`：
  - 移除 `TwentyClientModule` 导入
  - 添加 `PrismaModule` 导入
  - 添加 `JwtModule` 配置
- 更新 `fenghua-backend/src/auth/auth.controller.ts`：
  - 更新登录端点使用新的 `AuthService`
  - 添加注册端点（如果需要）
- 更新 `fenghua-frontend/src/auth/auth.service.ts`：
  - 更新登录 API 调用
  - 更新 token 存储逻辑
- 环境变量：添加 `JWT_SECRET` 和 `JWT_EXPIRES_IN`

---

### Story 16.3: 替换用户和角色管理

As a **管理员**,
I want **管理用户和角色**,
So that **系统可以独立管理用户账户和权限，无需依赖 Twenty CRM**.

**Acceptance Criteria:**

1. **Given** 管理员需要查看用户列表
   **When** 管理员访问用户管理页面
   **Then** 系统显示所有用户（从 `users` 表查询，包含角色信息）
   **And** 系统支持按角色筛选用户
   **And** 系统支持搜索用户（按邮箱、姓名）
   **And** 系统显示用户基本信息（邮箱、姓名、角色、创建时间）

2. **Given** 管理员需要创建用户
   **When** 管理员提供用户信息（邮箱、密码、姓名、角色）
   **Then** 系统验证邮箱唯一性
   **And** 系统加密密码（使用 bcrypt）
   **And** 系统创建用户记录（在 `users` 表）
   **And** 系统分配角色（在 `user_roles` 表）
   **And** 系统返回创建的用户信息

3. **Given** 管理员需要更新用户
   **When** 管理员修改用户信息（姓名、角色等）
   **Then** 系统更新用户记录（在 `users` 表）
   **And** 系统更新角色关联（在 `user_roles` 表）
   **And** 系统返回更新后的用户信息

4. **Given** 管理员需要删除用户
   **When** 管理员删除用户
   **Then** 系统软删除用户（设置 `deleted_at` 字段）
   **And** 系统保留用户数据（用于审计）

5. **Given** 管理员需要管理角色
   **When** 管理员查看角色列表
   **Then** 系统显示所有角色（从 `roles` 表查询）
   **And** 系统显示角色描述
   **And** 系统支持分配角色给用户
   **And** 系统支持移除用户角色

**Implementation Notes:**
- 参考重构计划阶段 3：替换用户和角色管理
- 重构 `fenghua-backend/src/users/users.service.ts`：
  - 移除 `TwentyClientService` 依赖
  - 使用 `PrismaService` 查询 `users` 和 `user_roles` 表
  - 实现用户 CRUD 操作
- 重构 `fenghua-backend/src/roles/roles.service.ts`：
  - 移除 `TwentyClientService` 依赖
  - 使用 `PrismaService` 查询 `roles` 和 `user_roles` 表
  - 实现角色分配和移除
- 更新模块导入：移除 `TwentyClientModule`，添加 `PrismaModule`
- 初始化角色数据：创建 `007-seed-roles.sql` 迁移脚本（插入默认角色）

---

### Story 16.4: 替换客户和联系人管理

As a **所有用户**,
I want **管理客户和联系人**,
So that **系统可以独立管理客户数据，无需依赖 Twenty CRM**.

**Acceptance Criteria:**

1. **Given** 用户需要查看客户列表
   **When** 用户访问客户管理页面
   **Then** 系统显示客户列表（从 `companies` 表查询）
   **And** 系统根据用户角色过滤客户（前端专员只看到采购商，后端专员只看到供应商）
   **And** 系统支持按客户类型筛选（供应商/采购商）
   **And** 系统支持搜索客户（按名称、域名、行业）
   **And** 系统显示客户基本信息（名称、类型、行业、规模、联系方式）

2. **Given** 用户需要创建客户
   **When** 用户提供客户信息（名称、类型、地址、联系方式等）
   **Then** 系统验证必填字段（名称、客户类型）
   **And** 系统创建客户记录（在 `companies` 表）
   **And** 系统记录创建者（`created_by` 字段）
   **And** 系统返回创建的客户信息

3. **Given** 用户需要更新客户
   **When** 用户修改客户信息
   **Then** 系统更新客户记录（在 `companies` 表）
   **And** 系统记录更新者（`updated_by` 字段）
   **And** 系统返回更新后的客户信息

4. **Given** 用户需要删除客户
   **When** 用户删除客户
   **Then** 系统软删除客户（设置 `deleted_at` 字段）
   **And** 系统保留客户数据（用于审计）

5. **Given** 用户需要管理联系人
   **When** 用户查看联系人列表（按客户）
   **Then** 系统显示联系人列表（从 `people` 表查询，关联到客户）
   **And** 系统支持创建、更新、删除联系人
   **And** 系统验证联系人必填字段（姓名、关联客户）

**Implementation Notes:**
- 参考重构计划阶段 4：替换客户和联系人管理
- 创建 `fenghua-backend/src/companies/companies.service.ts`：
  - 使用 `PrismaService` 查询 `companies` 表
  - 实现客户 CRUD 操作
  - 实现数据隔离（根据用户角色过滤）
- 创建 `fenghua-backend/src/people/people.service.ts`：
  - 使用 `PrismaService` 查询 `people` 表
  - 实现联系人 CRUD 操作
- 创建控制器和模块：
  - `fenghua-backend/src/companies/companies.controller.ts`
  - `fenghua-backend/src/companies/companies.module.ts`
  - `fenghua-backend/src/people/people.controller.ts`
  - `fenghua-backend/src/people/people.module.ts`
- 更新前端：创建或更新客户和联系人管理页面

---

### Story 16.5: 更新产品和互动记录

As a **所有用户**,
I want **产品和互动记录正常工作**,
So that **系统可以独立运行，无需依赖 Twenty CRM 的 workspace 概念**.

**Acceptance Criteria:**

1. **Given** 产品和互动记录表已存在
   **When** 开发团队更新表结构
   **Then** 移除 `workspace_id` 字段（从 `products` 表）
   **And** 移除 `workspace_id` 字段（从 `product_customer_interactions` 表）
   **And** 移除 `workspace_id` 字段（从 `file_attachments` 表）
   **And** 添加 `created_by` 和 `updated_by` 字段（如果不存在）
   **And** 更新 `customer_id` 外键关联到新的 `companies` 表

2. **Given** 产品服务需要更新
   **When** 开发团队重构 `ProductsService`
   **Then** 移除 `getWorkspaceId()` 方法
   **And** 移除对 `TwentyClientService` 的依赖
   **And** 使用 `userId` 替代 `workspaceId` 进行数据隔离
   **And** 所有产品查询使用 `created_by` 字段过滤

3. **Given** 互动记录服务需要更新
   **When** 开发团队重构互动记录服务
   **Then** 更新 `customer_id` 外键关联到新的 `companies` 表
   **And** 移除 `workspace_id` 依赖
   **And** 所有互动记录查询正常工作

**Implementation Notes:**
- 参考重构计划阶段 5：更新产品和互动记录
- 执行迁移脚本：`006-remove-workspace-dependencies.sql`
- 更新 `fenghua-backend/src/products/products.service.ts`：
  - 移除 `getWorkspaceId()` 方法
  - 移除 `TwentyClientService` 依赖
  - 使用 `created_by` 字段进行数据隔离
- 更新互动记录服务（如果存在）：
  - 更新 `customer_id` 外键关联
  - 移除 `workspace_id` 依赖

---

### Story 16.6: 移除 Twenty 依赖和清理

As a **开发团队**,
I want **移除所有 Twenty CRM 依赖**,
So that **系统完全独立，代码库干净，无过时依赖**.

**Acceptance Criteria:**

1. **Given** 所有功能已迁移到原生技术栈
   **When** 开发团队清理代码
   **Then** 删除 `fenghua-backend/src/services/twenty-client/twenty-client.service.ts`
   **And** 删除 `fenghua-backend/src/services/twenty-client/twenty-client.module.ts`
   **And** 删除 `fenghua-backend/src/services/twenty-client/README.md`
   **And** 从 `fenghua-backend/src/app.module.ts` 移除 `TwentyClientModule` 导入

2. **Given** 环境变量需要更新
   **When** 开发团队更新环境变量配置
   **Then** 从 `.env.development` 移除 `TWENTY_API_URL`
   **And** 从 `.env.development` 移除 `TWENTY_API_TOKEN`
   **And** 从 `.env.development` 移除 `TWENTY_ORIGIN`
   **And** 从 `.env.development` 移除 `TWENTY_DATABASE_URL`
   **And** 保留 `DATABASE_URL`（fenghua-crm 数据库）
   **And** 确保 `JWT_SECRET` 已配置

3. **Given** 依赖需要更新
   **When** 开发团队更新 `package.json`
   **Then** 移除 `graphql-request`（如果不再需要）
   **And** 验证所有依赖都是必需的
   **And** 运行 `npm install` 确保依赖正确

4. **Given** 应用需要验证
   **When** 开发团队测试应用
   **Then** 应用可以正常启动（无编译错误）
   **And** 所有 API 端点正常工作
   **And** 所有测试通过
   **And** 构建过程无错误

**Implementation Notes:**
- 参考重构计划阶段 6：移除 Twenty 依赖和清理
- 删除所有 Twenty 相关代码
- 更新所有导入语句
- 更新环境变量文档
- 更新 `package.json`
- 运行完整测试套件
- 更新文档（已完成）

---

