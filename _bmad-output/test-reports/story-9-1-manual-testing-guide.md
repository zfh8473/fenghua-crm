# Story 9.1 手动测试指南

**Story:** 数据访问审计日志  
**日期:** 2026-01-12  
**测试者:** [测试人员姓名]

---

## 测试环境准备

1. **数据库迁移**
   - 运行迁移脚本：`fenghua-backend/migrations/028-add-data-access-audit-fields.sql`
   - 确认 `audit_logs` 表已添加 `ip_address` 和 `user_agent` 字段

2. **后端服务**
   - 确保后端服务正在运行
   - 确认 `AuditModule` 已正确注册
   - 确认拦截器已应用到相关控制器

3. **前端服务**
   - 确保前端服务正在运行
   - 确认路由 `/audit-logs` 已配置

---

## 测试用例

### TC1: 数据访问操作自动记录（成功访问）

**前置条件:**
- 用户已登录系统
- 系统中有客户、产品、互动记录数据

**测试步骤:**
1. 以任意用户身份登录系统
2. 访问客户详情页：`/customers/:id`（替换为实际客户ID）
3. 访问产品详情页：`/products/:id`（替换为实际产品ID）
4. 访问互动记录详情页：`/interactions/:id`（替换为实际互动记录ID）

**预期结果:**
- 每个访问操作都应该在审计日志中记录
- 审计日志记录包含：
  - 操作类型：`DATA_ACCESS`
  - 资源类型：`CUSTOMER`、`PRODUCT`、`INTERACTION`
  - 资源ID：对应的资源ID
  - 操作结果：`SUCCESS`
  - 用户ID：当前登录用户ID
  - IP地址：用户的IP地址（如果可用）
  - 用户代理：用户的浏览器信息（如果可用）
  - 操作时间：当前时间戳

**验证方法:**
- 以管理员身份登录
- 访问 `/audit-logs` 页面
- 筛选 `action = DATA_ACCESS`
- 确认上述访问操作都已记录

---

### TC2: 无权限访问记录

**前置条件:**
- 用户已登录系统（非管理员）
- 系统中有供应商客户数据（仅管理员可访问）

**测试步骤:**
1. 以前端专员或后端专员身份登录系统
2. 尝试访问供应商客户详情页（应该被权限系统阻止）

**预期结果:**
- 审计日志中应该记录一次失败的访问操作
- 审计日志记录包含：
  - 操作类型：`DATA_ACCESS`
  - 资源类型：`CUSTOMER`
  - 资源ID：尝试访问的客户ID
  - 操作结果：`FAILED`
  - 失败原因：包含"Permission denied"或类似信息
  - 用户ID：当前登录用户ID

**验证方法:**
- 以管理员身份登录
- 访问 `/audit-logs` 页面
- 筛选 `action = DATA_ACCESS` 和 `operationResult = FAILED`
- 确认无权限访问操作已记录

---

### TC3: 审计日志查询和筛选

**前置条件:**
- 系统中已有审计日志记录
- 用户以管理员身份登录

**测试步骤:**
1. 访问 `/audit-logs` 页面
2. 测试按操作类型筛选：
   - 选择 `action = DATA_ACCESS`
   - 确认只显示数据访问日志
3. 测试按资源类型筛选：
   - 选择 `entityType = CUSTOMER`
   - 确认只显示客户相关的日志
4. 测试按用户筛选：
   - 输入操作者邮箱
   - 确认只显示该用户的日志
5. 测试按时间范围筛选：
   - 选择开始日期和结束日期
   - 确认只显示该时间范围内的日志

**预期结果:**
- 所有筛选功能正常工作
- 筛选结果准确
- 分页功能正常（如果记录数 > limit）

**验证方法:**
- 手动验证筛选结果
- 检查分页控件是否显示正确的页数和总数

---

### TC4: 审计日志详情查看

**前置条件:**
- 系统中已有审计日志记录
- 用户以管理员身份登录

**测试步骤:**
1. 访问 `/audit-logs` 页面
2. 点击任意一条审计日志记录

**预期结果:**
- 弹出详情对话框
- 详情对话框显示：
  - 操作类型（中文标签）
  - 操作结果（成功/失败）
  - 资源类型（中文标签）
  - 资源ID
  - 用户ID
  - 操作者邮箱
  - 操作时间（格式化显示）
  - IP地址（如果可用）
  - 用户代理（如果可用）
  - 失败原因（如果操作失败）
  - 元数据（如果有）

**验证方法:**
- 手动验证详情对话框内容
- 确认所有字段都正确显示

---

### TC5: 审计日志导出

**前置条件:**
- 系统中已有审计日志记录
- 用户以管理员身份登录

**测试步骤:**
1. 访问 `/audit-logs` 页面
2. 应用筛选条件（可选）
3. 点击"导出 CSV"按钮
4. 点击"导出 Excel"按钮

**预期结果:**
- CSV 文件成功下载
- Excel 文件成功下载
- 导出的文件包含：
  - 操作类型
  - 用户ID
  - 用户邮箱
  - 资源类型
  - 资源ID
  - 操作时间
  - 操作结果
  - 失败原因
  - IP地址
  - 用户代理
- 导出的数据与当前筛选条件匹配

**验证方法:**
- 打开导出的文件
- 验证数据格式和内容
- 确认筛选条件已应用

---

### TC6: 性能测试

**前置条件:**
- 系统中有大量审计日志记录（> 1000 条）
- 用户以管理员身份登录

**测试步骤:**
1. 访问 `/audit-logs` 页面
2. 记录页面加载时间
3. 应用筛选条件
4. 记录筛选响应时间
5. 切换分页
6. 记录分页响应时间

**预期结果:**
- 页面加载时间 < 2 秒
- 筛选响应时间 < 2 秒
- 分页响应时间 < 1 秒
- 审计日志记录操作不影响主业务性能（访问客户/产品/互动记录详情页的响应时间正常）

**验证方法:**
- 使用浏览器开发者工具测量响应时间
- 对比有无审计日志记录时的业务操作响应时间

---

### TC7: 错误处理

**前置条件:**
- 用户以管理员身份登录

**测试步骤:**
1. 模拟数据库连接失败（可选，需要特殊配置）
2. 访问 `/audit-logs` 页面
3. 尝试导出审计日志

**预期结果:**
- 如果数据库连接失败，审计日志记录失败不应影响主业务
- 前端显示友好的错误消息
- 错误信息记录到系统日志

**验证方法:**
- 检查系统日志
- 验证主业务操作仍然正常

---

## 测试结果总结

| 测试用例 | 状态 | 备注 |
|---------|------|------|
| TC1: 数据访问操作自动记录（成功） | ⬜ 通过 / ⬜ 失败 | |
| TC2: 无权限访问记录 | ⬜ 通过 / ⬜ 失败 | |
| TC3: 审计日志查询和筛选 | ⬜ 通过 / ⬜ 失败 | |
| TC4: 审计日志详情查看 | ⬜ 通过 / ⬜ 失败 | |
| TC5: 审计日志导出 | ⬜ 通过 / ⬜ 失败 | |
| TC6: 性能测试 | ⬜ 通过 / ⬜ 失败 | |
| TC7: 错误处理 | ⬜ 通过 / ⬜ 失败 | |

---

## 已知问题

[记录测试过程中发现的任何问题]

---

## 测试人员签名

**测试人员:** _________________  
**日期:** _________________

