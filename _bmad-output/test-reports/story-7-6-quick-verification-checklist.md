# Story 7.6 å¿«é€ŸéªŒè¯æ¸…å•

**Story:** 7-6-import-history-and-error-reports  
**éªŒè¯æ—¥æœŸ:** 2025-01-08

---

## âœ… ä»£ç å®ç°éªŒè¯ï¼ˆå·²å®Œæˆï¼‰

### åç«¯å®ç° âœ…
- [x] æ•°æ®åº“è¿ç§»æ–‡ä»¶å·²åˆ›å»º (`020-add-error-details-to-import-history.sql`)
- [x] å¯¼å…¥å†å²æŸ¥è¯¢ API æ”¯æŒæ‰€æœ‰ç­›é€‰å‚æ•°
- [x] å¯¼å…¥ä»»åŠ¡è¯¦æƒ… API å·²å®ç°
- [x] é”™è¯¯è¯¦æƒ…æŸ¥è¯¢ API ä½¿ç”¨æ•°æ®åº“çº§åˆ†é¡µ
- [x] Redis ç¼“å­˜å®ç°ï¼ˆå¯é€‰ï¼‰
- [x] ç»Ÿè®¡ä¿¡æ¯ API å·²å®ç°
- [x] é”™è¯¯æŠ¥å‘Šä¸‹è½½æ”¯æŒ Excel å’Œ CSV
- [x] é‡æ–°å¯¼å…¥ API å·²å®ç°
- [x] Customers processor ä¿å­˜é”™è¯¯è¯¦æƒ…
- [x] Products processor ä¿å­˜é”™è¯¯è¯¦æƒ…ï¼ˆå·²ä¿®å¤ï¼‰
- [x] Interactions processor ä¿å­˜é”™è¯¯è¯¦æƒ…ï¼ˆå·²ä¿®å¤ï¼‰

### å‰ç«¯å®ç° âœ…
- [x] ImportHistory ç»„ä»¶æ”¯æŒæ‰€æœ‰ç­›é€‰åŠŸèƒ½
- [x] ImportTaskDetail ç»„ä»¶å·²åˆ›å»º
- [x] ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºå·²å®ç°
- [x] é‡æ–°å¯¼å…¥åŠŸèƒ½å·²é›†æˆ
- [x] æ‰€æœ‰ API è°ƒç”¨å·²å®ç°

---

## ğŸ§ª æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤

### æµ‹è¯• 1: å¯¼å…¥å†å²åˆ—è¡¨æ˜¾ç¤º (AC1)

**å‰ç½®æ¡ä»¶:**
- å·²æœ‰è‡³å°‘ä¸€ä¸ªå¯¼å…¥ä»»åŠ¡ï¼ˆæˆåŠŸã€å¤±è´¥ã€éƒ¨åˆ†æˆåŠŸå„ä¸€ä¸ªï¼‰

**æµ‹è¯•æ­¥éª¤:**
1. ç™»å½•ç³»ç»Ÿï¼ˆæ€»ç›‘æˆ–ç®¡ç†å‘˜è§’è‰²ï¼‰
2. å¯¼èˆªåˆ°æ•°æ®å¯¼å…¥ç•Œé¢
3. æŸ¥çœ‹"å¯¼å…¥å†å²"æ¨¡å—

**éªŒè¯ç‚¹:**
- [ ] æ˜¾ç¤ºæ‰€æœ‰å†å²å¯¼å…¥ä»»åŠ¡åˆ—è¡¨
- [ ] åˆ—è¡¨åŒ…å«ï¼šå¯¼å…¥æ—¶é—´ã€å¯¼å…¥æ–‡ä»¶ã€å¯¼å…¥çŠ¶æ€ã€å¯¼å…¥è®°å½•æ•°ã€æˆåŠŸæ•°ã€å¤±è´¥æ•°
- [ ] åˆ—è¡¨æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
- [ ] æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯å¡ç‰‡ï¼ˆæ€»ä»»åŠ¡æ•°ã€æˆåŠŸ/å¤±è´¥/éƒ¨åˆ†æˆåŠŸ/å¤„ç†ä¸­æ•°é‡ï¼‰
- [ ] æ˜¾ç¤ºå¯¼å…¥ç±»å‹åˆ—

---

### æµ‹è¯• 2: å¯¼å…¥ä»»åŠ¡è¯¦æƒ…æŸ¥çœ‹ (AC2)

**æµ‹è¯•æ­¥éª¤:**
1. åœ¨å¯¼å…¥å†å²åˆ—è¡¨ä¸­ï¼Œç‚¹å‡»æŸä¸ªå¯¼å…¥ä»»åŠ¡çš„"æŸ¥çœ‹è¯¦æƒ…"æŒ‰é’®
2. æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…å¼¹çª—

**éªŒè¯ç‚¹:**
- [ ] æ˜¾ç¤ºä»»åŠ¡åŸºæœ¬ä¿¡æ¯ï¼ˆæ–‡ä»¶åã€çŠ¶æ€ã€å¼€å§‹æ—¶é—´ã€å®Œæˆæ—¶é—´ï¼‰
- [ ] æ˜¾ç¤ºå¯¼å…¥ç»“æœæ‘˜è¦ï¼ˆæ€»è®°å½•æ•°ã€æˆåŠŸæ•°ã€å¤±è´¥æ•°ï¼‰
- [ ] å¯¹äº"éƒ¨åˆ†æˆåŠŸ"æˆ–"å¤±è´¥"çš„ä»»åŠ¡ï¼Œæ˜¾ç¤ºé”™è¯¯è¯¦æƒ…åˆ—è¡¨
- [ ] é”™è¯¯è¯¦æƒ…åŒ…å«ï¼šè¡Œå·ã€æ•°æ®å†…å®¹ã€é”™è¯¯åŸå› 

---

### æµ‹è¯• 3: é”™è¯¯æŠ¥å‘Šè¯¦ç»†ä¿¡æ¯ (AC3)

**æµ‹è¯•æ­¥éª¤:**
1. æ‰“å¼€ä¸€ä¸ªåŒ…å«å¤±è´¥è®°å½•çš„ä»»åŠ¡è¯¦æƒ…
2. æŸ¥çœ‹é”™è¯¯è¯¦æƒ…åˆ—è¡¨
3. ç‚¹å‡»"å±•å¼€"æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
4. ç‚¹å‡»"ä¸‹è½½ Excel"æŒ‰é’®
5. ç‚¹å‡»"ä¸‹è½½ CSV"æŒ‰é’®
6. ç‚¹å‡»"é‡æ–°å¯¼å…¥"æŒ‰é’®

**éªŒè¯ç‚¹:**
- [ ] é”™è¯¯è¯¦æƒ…åˆ—è¡¨æ­£ç¡®æ˜¾ç¤º
- [ ] å¯ä»¥å±•å¼€/æŠ˜å é”™è¯¯è¯¦æƒ…
- [ ] ä¸‹è½½çš„ Excel æ–‡ä»¶åŒ…å«å®Œæ•´é”™è¯¯ä¿¡æ¯
- [ ] ä¸‹è½½çš„ CSV æ–‡ä»¶åŒ…å«å®Œæ•´é”™è¯¯ä¿¡æ¯
- [ ] é‡æ–°å¯¼å…¥åŠŸèƒ½åˆ›å»ºæ–°ä»»åŠ¡
- [ ] é‡æ–°å¯¼å…¥ä¿ç•™åŸå§‹é”™è¯¯ä¿¡æ¯

---

### æµ‹è¯• 4: å¯¼å…¥å†å²ç­›é€‰å’Œåˆ†é¡µ (AC4)

**æµ‹è¯•æ­¥éª¤:**
1. æµ‹è¯•çŠ¶æ€ç­›é€‰
   - é€‰æ‹©"å…¨éƒ¨çŠ¶æ€"
   - é€‰æ‹©"å·²å®Œæˆ"
   - é€‰æ‹©"å¤±è´¥"
   - é€‰æ‹©"éƒ¨åˆ†æˆåŠŸ"
   - é€‰æ‹©"å¤„ç†ä¸­"

2. æµ‹è¯•å¯¼å…¥ç±»å‹ç­›é€‰
   - é€‰æ‹©"å…¨éƒ¨ç±»å‹"
   - é€‰æ‹©"å®¢æˆ·"
   - é€‰æ‹©"äº§å“"
   - é€‰æ‹©"äº’åŠ¨è®°å½•"

3. æµ‹è¯•æ—¶é—´èŒƒå›´ç­›é€‰
   - é€‰æ‹©å¼€å§‹æ—¥æœŸ
   - é€‰æ‹©ç»“æŸæ—¥æœŸ
   - éªŒè¯ç­›é€‰ç»“æœ

4. æµ‹è¯•æœç´¢åŠŸèƒ½
   - è¾“å…¥æ–‡ä»¶åæœç´¢
   - è¾“å…¥ä»»åŠ¡ ID æœç´¢
   - éªŒè¯æœç´¢ç»“æœ

5. æµ‹è¯•åˆ†é¡µ
   - å¦‚æœæœ‰ > 50 æ¡è®°å½•ï¼ŒéªŒè¯åˆ†é¡µæ§ä»¶
   - ç‚¹å‡»"ä¸Šä¸€é¡µ"å’Œ"ä¸‹ä¸€é¡µ"
   - éªŒè¯åˆ†é¡µæ•°æ®æ­£ç¡®

**éªŒè¯ç‚¹:**
- [ ] æ‰€æœ‰ç­›é€‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] ç­›é€‰ç»“æœæ­£ç¡®
- [ ] æœç´¢åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] åˆ†é¡µåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] ç»Ÿè®¡ä¿¡æ¯æ ¹æ®ç­›é€‰æ¡ä»¶æ›´æ–°

---

### æµ‹è¯• 5: éƒ¨åˆ†æˆåŠŸå¯¼å…¥åœºæ™¯

**æµ‹è¯•æ­¥éª¤:**
1. åˆ›å»ºä¸€ä¸ªåŒ…å«æœ‰æ•ˆå’Œæ— æ•ˆæ•°æ®çš„å¯¼å…¥æ–‡ä»¶
2. æ‰§è¡Œå¯¼å…¥
3. æŸ¥çœ‹å¯¼å…¥ç»“æœ

**éªŒè¯ç‚¹:**
- [ ] å¯¼å…¥çŠ¶æ€æ˜¾ç¤ºä¸º"éƒ¨åˆ†æˆåŠŸ"
- [ ] æˆåŠŸæ•°å’Œå¤±è´¥æ•°æ­£ç¡®
- [ ] é”™è¯¯è¯¦æƒ…æ­£ç¡®ä¿å­˜
- [ ] å¯ä»¥æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
- [ ] å¯ä»¥é‡æ–°å¯¼å…¥å¤±è´¥è®°å½•

---

### æµ‹è¯• 6: é”™è¯¯è¯¦æƒ…æŸ¥è¯¢æ€§èƒ½

**æµ‹è¯•æ­¥éª¤:**
1. åˆ›å»ºä¸€ä¸ªåŒ…å«å¤§é‡é”™è¯¯è®°å½•ï¼ˆ> 1000 æ¡ï¼‰çš„å¯¼å…¥
2. æŸ¥çœ‹é”™è¯¯è¯¦æƒ…
3. æµ‹è¯•åˆ†é¡µåŠŸèƒ½

**éªŒè¯ç‚¹:**
- [ ] é”™è¯¯è¯¦æƒ…æŸ¥è¯¢å“åº”æ—¶é—´åˆç†
- [ ] åˆ†é¡µåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] ä¸ä¼šå¯¼è‡´å†…å­˜é—®é¢˜

---

### æµ‹è¯• 7: é‡æ–°å¯¼å…¥åŠŸèƒ½

**æµ‹è¯•æ­¥éª¤:**
1. æ‰¾åˆ°ä¸€ä¸ªåŒ…å«å¤±è´¥è®°å½•çš„ä»»åŠ¡
2. ç‚¹å‡»"é‡æ–°å¯¼å…¥"æŒ‰é’®
3. æŸ¥çœ‹æ–°åˆ›å»ºçš„å¯¼å…¥ä»»åŠ¡

**éªŒè¯ç‚¹:**
- [ ] é‡æ–°å¯¼å…¥åˆ›å»ºæ–°ä»»åŠ¡
- [ ] æ–°ä»»åŠ¡åªåŒ…å«å¤±è´¥è®°å½•
- [ ] é”™è¯¯ä¿¡æ¯æ­£ç¡®ä¿ç•™
- [ ] å¯ä»¥æˆåŠŸå¯¼å…¥ä¿®æ­£åçš„æ•°æ®

---

## ğŸ” API ç«¯ç‚¹æµ‹è¯•

### ä½¿ç”¨ curl æˆ– Postman æµ‹è¯•

#### 1. è·å–å¯¼å…¥å†å²
```bash
GET /api/import/customers/history?limit=20&offset=0&status=partial&startDate=2025-01-01&endDate=2025-01-08&importType=CUSTOMER&search=test
Authorization: Bearer {token}
```

#### 2. è·å–ä»»åŠ¡è¯¦æƒ…
```bash
GET /api/import/customers/tasks/{taskId}/details
Authorization: Bearer {token}
```

#### 3. è·å–é”™è¯¯è¯¦æƒ…
```bash
GET /api/import/customers/tasks/{taskId}/errors?limit=50&offset=0
Authorization: Bearer {token}
```

#### 4. è·å–ç»Ÿè®¡ä¿¡æ¯
```bash
GET /api/import/customers/history/stats?startDate=2025-01-01&endDate=2025-01-08
Authorization: Bearer {token}
```

#### 5. ä¸‹è½½é”™è¯¯æŠ¥å‘Š
```bash
GET /api/import/customers/reports/{taskId}?format=xlsx
Authorization: Bearer {token}
```

#### 6. é‡æ–°å¯¼å…¥
```bash
POST /api/import/customers/retry/{taskId}
Authorization: Bearer {token}
```

---

## âœ… éªŒè¯ç»“æœ

**ä»£ç å®ç°:** âœ… å®Œæ•´  
**åŠŸèƒ½å®ç°:** âœ… å®Œæ•´  
**ä»£ç å®¡æŸ¥ä¿®å¤:** âœ… å®Œæˆ  
**å‡†å¤‡éƒ¨ç½²:** âœ… æ˜¯

**å»ºè®®:** å®Œæˆä¸Šè¿°æ‰‹åŠ¨æµ‹è¯•åï¼Œå¯ä»¥éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒè¿›è¡Œè¿›ä¸€æ­¥éªŒè¯ã€‚

