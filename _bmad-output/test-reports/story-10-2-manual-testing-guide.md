# Story 10-2 手动测试指南

**Story:** 10-2-interaction-record-comment-history  
**测试日期:** 2026-01-14  
**测试类型:** 手动功能测试

---

## 测试环境准备

### 前置条件

1. **数据库迁移:**
   - 确保已运行 `fenghua-backend/migrations/034-create-interaction-comments-table.sql`
   - 验证 `interaction_comments` 表已创建

2. **后端服务:**
   - 启动后端服务：`cd fenghua-backend && npm run start:dev`
   - 验证服务运行在 `http://localhost:3000`（或配置的端口）

3. **前端服务:**
   - 启动前端服务：`cd fenghua-frontend && npm run dev`
   - 验证服务运行在 `http://localhost:5173`（或配置的端口）

4. **测试数据:**
   - 至少有一个互动记录（用于测试评论功能）
   - 至少有两个用户账号（用于测试多用户场景）

---

## 测试场景

### 场景 1: 基本轮询功能测试

**目标:** 验证轮询机制正常工作

**步骤:**
1. 使用用户 A 登录系统
2. 导航到互动记录详情页（`/interactions/:id`）
3. 等待评论列表加载完成
4. 使用用户 B（另一个浏览器/标签页）登录系统
5. 在同一个互动记录中添加一条新评论
6. 观察用户 A 的页面（应该在 5 秒内自动显示新评论）

**预期结果:**
- ✅ 新评论自动出现在列表顶部（无需刷新页面）
- ✅ 如果用户 A 不在页面顶部，显示"查看新评论"按钮
- ✅ 评论总数自动更新

**验证点:**
- [ ] 新评论在 5-10 秒内自动显示
- [ ] 新评论显示在列表顶部
- [ ] 评论总数正确更新
- [ ] 没有重复的评论

---

### 场景 2: 页面可见性检测测试

**目标:** 验证页面隐藏时轮询暂停，可见时恢复

**步骤:**
1. 使用用户 A 登录并打开互动记录详情页
2. 等待评论列表加载完成
3. 切换到另一个浏览器标签页（使当前标签页隐藏）
4. 使用用户 B 添加一条新评论
5. 等待 10 秒
6. 切换回用户 A 的标签页（使页面可见）
7. 观察是否立即检查新评论

**预期结果:**
- ✅ 页面隐藏时，轮询暂停（不会发送请求）
- ✅ 页面可见时，立即检查新评论
- ✅ 新评论在页面可见后很快显示

**验证点:**
- [ ] 页面隐藏时，网络请求停止（可通过浏览器开发者工具 Network 标签验证）
- [ ] 页面可见时，立即发送检查请求
- [ ] 新评论在页面可见后显示

---

### 场景 3: 错误处理和重试测试

**目标:** 验证错误处理和重试机制

**步骤:**
1. 使用用户 A 登录并打开互动记录详情页
2. 等待评论列表加载完成
3. 停止后端服务（模拟网络错误）
4. 观察前端错误提示
5. 等待 10-15 秒
6. 重新启动后端服务
7. 观察是否自动恢复轮询

**预期结果:**
- ✅ 网络错误时显示错误提示
- ✅ 自动重试（指数退避：1s, 2s, 4s）
- ✅ 连续 3 次失败后暂停轮询并显示错误消息
- ✅ 服务恢复后，页面可见时自动恢复轮询

**验证点:**
- [ ] 错误提示正确显示
- [ ] 重试机制工作（可通过 Network 标签观察重试间隔）
- [ ] 连续失败后暂停轮询
- [ ] 服务恢复后自动恢复

---

### 场景 4: 滚动位置保持测试

**目标:** 验证新评论添加时滚动位置保持

**步骤:**
1. 使用用户 A 登录并打开互动记录详情页
2. 等待评论列表加载完成
3. 滚动页面到中间位置（不在顶部）
4. 使用用户 B 添加一条新评论
5. 观察用户 A 的页面

**预期结果:**
- ✅ 新评论添加到列表顶部
- ✅ 用户当前的滚动位置保持不变
- ✅ 显示"查看新评论"按钮（如果滚动位置 > 100px）

**验证点:**
- [ ] 滚动位置保持不变
- [ ] "查看新评论"按钮正确显示
- [ ] 点击按钮后平滑滚动到顶部

---

### 场景 5: 分页场景测试

**目标:** 验证分页时轮询行为

**步骤:**
1. 确保互动记录有超过 20 条评论
2. 使用用户 A 登录并打开互动记录详情页
3. 点击"加载更多"按钮，加载第二页
4. 使用用户 B 添加一条新评论
5. 观察用户 A 的页面

**预期结果:**
- ✅ 在第二页时，轮询被禁用（因为 `pollingEnabled = page === 1`）
- ✅ 新评论不会自动显示（因为不在第一页）
- ✅ 返回第一页时，轮询恢复

**验证点:**
- [ ] 在第二页时，轮询停止（可通过 Network 标签验证）
- [ ] 返回第一页时，轮询恢复
- [ ] 新评论在返回第一页后显示

---

### 场景 6: 后端 API since 参数测试

**目标:** 验证 `since` 参数功能

**步骤:**
1. 使用 API 测试工具（如 Postman 或 curl）
2. 获取互动记录的评论列表（不带 `since` 参数）
3. 记录最新评论的 `createdAt` 时间
4. 添加一条新评论
5. 使用 `since` 参数（值为步骤 3 的时间）再次获取评论列表
6. 验证只返回新评论

**API 请求示例:**
```bash
# 获取所有评论
GET /api/interactions/{interactionId}/comments?page=1&limit=20

# 获取 since 之后的评论
GET /api/interactions/{interactionId}/comments?page=1&limit=20&since=2026-01-14T10:00:00Z
```

**预期结果:**
- ✅ 不带 `since` 参数时，返回所有评论
- ✅ 带 `since` 参数时，只返回该时间之后的评论
- ✅ 日期验证正确（拒绝未来时间、拒绝 100 年前的时间）

**验证点:**
- [ ] `since` 参数正确过滤评论
- [ ] 日期验证工作正常
- [ ] 错误消息清晰

---

### 场景 7: 性能测试

**目标:** 验证性能优化

**步骤:**
1. 打开浏览器开发者工具（Network 标签）
2. 使用用户 A 登录并打开互动记录详情页
3. 观察网络请求
4. 等待 30 秒，观察轮询请求

**预期结果:**
- ✅ 轮询请求间隔为 5 秒
- ✅ 请求使用 `since` 参数（轻量级查询）
- ✅ 页面隐藏时，请求停止
- ✅ 请求响应时间合理（< 500ms）

**验证点:**
- [ ] 轮询间隔正确（5 秒）
- [ ] 请求包含 `since` 参数
- [ ] 页面隐藏时请求停止
- [ ] 响应时间合理

---

## 测试检查清单

### 功能检查

- [ ] 新评论自动显示（无需刷新）
- [ ] 新评论显示在列表顶部
- [ ] 评论总数正确更新
- [ ] "查看新评论"按钮正确显示和隐藏
- [ ] 点击"查看新评论"按钮平滑滚动到顶部
- [ ] 滚动位置保持功能正常
- [ ] 评论计数显示正确

### 性能检查

- [ ] 轮询间隔为 5 秒
- [ ] 页面隐藏时轮询暂停
- [ ] 页面可见时轮询恢复
- [ ] 使用轻量级查询（`since` 参数）
- [ ] 没有不必要的重新渲染

### 错误处理检查

- [ ] 网络错误时显示错误提示
- [ ] 指数退避重试工作正常
- [ ] 连续失败后暂停轮询
- [ ] 错误消息清晰友好

### 边界情况检查

- [ ] 没有评论时，轮询不启动
- [ ] 在第二页时，轮询被禁用
- [ ] 组件卸载时，轮询停止
- [ ] 多个标签页同时打开时，每个标签页独立轮询

---

## 已知问题和限制

1. **轮询仅在第一页启用:** 这是设计决策，避免在分页场景下产生混乱
2. **轮询间隔固定为 5 秒:** 当前不可配置，但可以通过修改代码调整
3. **新评论检测基于时间戳:** 如果系统时钟不同步，可能影响检测准确性（但已通过 ID 去重处理）

---

## 测试结果记录

**测试日期:** ___________  
**测试人员:** ___________  
**测试环境:** ___________

### 测试结果

| 场景 | 状态 | 备注 |
|------|------|------|
| 场景 1: 基本轮询功能 | ⬜ 通过 / ⬜ 失败 | |
| 场景 2: 页面可见性检测 | ⬜ 通过 / ⬜ 失败 | |
| 场景 3: 错误处理和重试 | ⬜ 通过 / ⬜ 失败 | |
| 场景 4: 滚动位置保持 | ⬜ 通过 / ⬜ 失败 | |
| 场景 5: 分页场景 | ⬜ 通过 / ⬜ 失败 | |
| 场景 6: 后端 API since 参数 | ⬜ 通过 / ⬜ 失败 | |
| 场景 7: 性能测试 | ⬜ 通过 / ⬜ 失败 | |

### 发现的问题

1. 
2. 
3. 

---

## 快速测试命令

### 后端 API 测试

```bash
# 获取评论列表（不带 since）
curl -X GET "http://localhost:3000/api/interactions/{interactionId}/comments?page=1&limit=20" \
  -H "Authorization: Bearer {token}"

# 获取评论列表（带 since）
curl -X GET "http://localhost:3000/api/interactions/{interactionId}/comments?page=1&limit=20&since=2026-01-14T10:00:00Z" \
  -H "Authorization: Bearer {token}"

# 测试日期验证（应该返回 400）
curl -X GET "http://localhost:3000/api/interactions/{interactionId}/comments?since=2099-01-01T00:00:00Z" \
  -H "Authorization: Bearer {token}"
```

---

**测试完成后，请记录测试结果并报告任何发现的问题。**
