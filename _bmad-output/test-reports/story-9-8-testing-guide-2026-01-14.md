# Story 9-8 Epic 9 回归测试执行指南

**创建日期：** 2026-01-14  
**Story：** 9-8-epic-9-regression-testing  
**用途：** 指导 Epic 9 回归测试的执行

---

## 🚀 快速开始

### 1. 启动测试环境

```bash
# 启动后端服务（终端 1）
cd fenghua-backend
npm run start:dev

# 等待后端启动完成
# 应该看到：Nest application successfully started
# 服务运行在：http://localhost:3001

# 启动前端服务（终端 2）
cd fenghua-frontend
npm run dev

# 等待前端启动完成
# 应该看到：Local: http://localhost:3005 (或 http://localhost:5173)
```

### 2. 验证服务状态

```bash
# 验证后端服务
curl http://localhost:3001/api/health

# 验证前端服务
# 打开浏览器访问：http://localhost:3005
```

### 3. 准备测试账号

需要准备以下角色的测试用户（如果不存在，需要先创建）：

- **管理员账号（ADMIN）：** 用于测试管理功能和审计日志查看
- **前端专员账号（FRONTEND_SPECIALIST）：** 用于测试采购商数据权限
- **后端专员账号（BACKEND_SPECIALIST）：** 用于测试供应商数据权限
- **总监账号（DIRECTOR）：** 用于测试所有数据权限

### 4. 准备测试数据

**审计日志测试数据：**
```bash
# 运行审计日志种子脚本（如果存在）
cd fenghua-backend
npm run seed:audit-logs
```

**加密测试数据：**
- 创建包含敏感字段的客户记录（银行账号、身份证号）
- 验证数据库中为密文，API 返回为明文

**GDPR 测试数据：**
```bash
# 运行 GDPR 测试数据种子脚本（如果存在）
cd fenghua-backend
npm run seed:gdpr-test-data
```

**数据保留测试数据：**
```bash
# 运行数据保留测试数据种子脚本（如果存在）
cd fenghua-backend
npm run seed:retention-test-data
```

---

## 📋 测试执行流程

### 阶段 1：关键安全功能测试（优先级最高）

#### Task 1: Story 9-1 和 9-2 回归测试（审计日志）

**测试时间：** 2-3 小时

**1.1 数据访问审计日志测试（Story 9-1）：**

**功能测试：**
1. **验证所有 GET 请求都被记录：**
   - 使用管理员账号登录
   - 访问客户详情页：`GET /api/companies/:id`
   - 访问产品详情页：`GET /api/products/:id`
   - 访问互动记录详情页：`GET /api/interactions/:id`
   - 访问审计日志页面：`http://localhost:3005/audit-logs`
   - 验证：所有 GET 请求都被记录到审计日志，操作类型为 `DATA_ACCESS`

2. **验证审计日志包含完整信息：**
   - 查看审计日志详情
   - 验证：包含用户ID、时间、资源类型、资源ID、操作结果

3. **验证审计日志查询功能：**
   - 按用户筛选：选择不同用户，验证筛选结果
   - 按时间筛选：选择时间范围，验证筛选结果
   - 按操作类型筛选：选择 `DATA_ACCESS`，验证筛选结果
   - 验证：查询功能正常工作，筛选结果准确

4. **验证审计日志导出功能：**
   - 点击"导出 CSV"按钮
   - 验证：导出文件包含所有审计日志记录，格式正确

5. **验证权限控制：**
   - 使用非管理员账号登录
   - 尝试访问审计日志页面：`http://localhost:3005/audit-logs`
   - 验证：非管理员用户无法访问审计日志（返回 403 或重定向）

**性能测试：**
1. **高并发场景测试：**
   - 使用性能测试工具（Artillery 或 k6）发送 100 并发 GET 请求
   - 验证：所有请求都被记录到审计日志，无丢失
   - 验证：审计日志记录延迟 < 10ms

2. **查询性能测试：**
   - 确保数据库中有 1000+ 条审计日志记录
   - 执行复杂查询（多条件筛选）
   - 验证：查询时间 < 1 秒

**安全测试：**
1. **验证审计日志不可篡改：**
   - 尝试直接修改数据库中的审计日志记录
   - 验证：审计日志表为只读或只追加（如果实现了）

2. **验证审计日志访问权限控制：**
   - 使用不同角色账号尝试访问审计日志 API
   - 验证：只有管理员可以访问

**1.2 数据修改审计日志测试（Story 9-2）：**

**功能测试：**
1. **验证所有 POST/PUT/DELETE 请求都被记录：**
   - 创建客户：`POST /api/companies`
   - 更新客户：`PUT /api/companies/:id`
   - 删除客户：`DELETE /api/companies/:id`（软删除）
   - 访问审计日志页面
   - 验证：所有 POST/PUT/DELETE 请求都被记录，操作类型为 `DATA_MODIFICATION` 或 `DATA_DELETION`

2. **验证审计日志包含修改前后的数据对比：**
   - 查看修改记录的详情
   - 验证：包含 `old_value` 和 `new_value`，显示修改前后的值对比

3. **验证审计日志查询功能：**
   - 按资源类型筛选：选择 `CUSTOMER`、`PRODUCT`、`INTERACTION`
   - 按操作类型筛选：选择 `DATA_MODIFICATION`、`DATA_DELETION`
   - 验证：查询功能正常工作

4. **验证审计日志导出功能：**
   - 导出包含修改记录的审计日志
   - 验证：导出文件包含修改前后的值对比

---

#### Task 2: Story 9-3 回归测试（敏感数据加密）

**测试时间：** 2-3 小时

**功能测试：**
1. **验证敏感字段正确加密存储：**
   - 创建包含敏感字段的客户记录（银行账号、身份证号）
   - 直接查询数据库：`SELECT bank_account, id_number FROM companies WHERE id = ?`
   - 验证：数据库中为密文（不是原始明文）

2. **验证授权用户能正确解密数据：**
   - 通过 API 获取客户详情：`GET /api/companies/:id`
   - 验证：API 返回的数据为明文（已解密）

3. **验证未授权用户无法访问解密数据：**
   - 使用无权限用户尝试访问包含敏感数据的记录
   - 验证：返回 403 或数据被过滤

4. **验证密钥轮换后历史数据仍可解密：**
   - 创建包含敏感字段的记录（使用旧密钥加密）
   - 执行密钥轮换
   - 通过 API 获取记录
   - 验证：历史数据仍能正确解密

5. **验证加密字段的查询功能：**
   - 使用哈希值查询：`SELECT * FROM companies WHERE bank_account_hash = ?`
   - 验证：查询功能正常工作

**性能测试：**
1. **单个字段加密时间：**
   - 创建包含敏感字段的记录，记录加密时间
   - 验证：加密时间 < 1ms

2. **单个字段解密时间：**
   - 获取包含敏感字段的记录，记录解密时间
   - 验证：解密时间 < 1ms

3. **批量加密性能：**
   - 批量创建 100 条包含敏感字段的记录
   - 验证：总时间 < 100ms

4. **API 响应时间影响：**
   - 测试包含加密字段的 API 响应时间
   - 验证：响应时间增加 < 10%

**安全测试：**
1. **验证加密算法正确实现：**
   - 检查加密实现代码
   - 验证：使用 AES-256-GCM 算法

2. **验证密钥存储安全：**
   - 检查开发环境和生产环境的密钥存储方案
   - 验证：生产环境使用密钥管理服务（AWS KMS, Azure Key Vault 等）

3. **验证密钥轮换机制安全：**
   - 执行密钥轮换
   - 验证：新密钥正确生成，旧密钥保留用于解密历史数据

4. **验证敏感数据访问审计日志记录：**
   - 访问包含敏感数据的记录
   - 查看审计日志
   - 验证：敏感数据访问被记录到审计日志

---

### 阶段 2：GDPR 合规功能测试（高优先级）

#### Task 3: Story 9-4 回归测试（安全传输协议）

**测试时间：** 1 小时

**功能测试：**
1. **验证所有 API 端点强制使用 HTTPS：**
   - 尝试使用 HTTP 访问 API：`http://localhost:3001/api/companies`
   - 验证：自动重定向到 HTTPS 或返回错误

2. **验证 HTTP 请求自动重定向到 HTTPS：**
   - 使用 HTTP 访问前端应用：`http://localhost:3005`
   - 验证：自动重定向到 HTTPS

3. **验证 TLS 版本正确：**
   - 使用 SSL Labs 或类似工具检查 TLS 版本
   - 验证：使用 TLS 1.2 或更高版本

4. **验证证书有效性：**
   - 检查 SSL 证书
   - 验证：证书有效且未过期

**安全测试：**
1. **验证中间人攻击防护：**
   - 使用安全测试工具（OWASP ZAP）测试
   - 验证：HTTPS 配置正确，防止中间人攻击

2. **验证证书链验证正确：**
   - 检查证书链
   - 验证：证书链完整且有效

3. **验证 HSTS 配置：**
   - 检查 HTTP 响应头
   - 验证：包含 `Strict-Transport-Security` 头

---

#### Task 4: Story 9-5 回归测试（GDPR 数据导出请求）

**测试时间：** 2-3 小时

**功能测试：**
1. **验证数据导出请求创建功能：**
   - 使用前端专员账号登录
   - 访问 GDPR 导出页面：`http://localhost:3005/gdpr/export`
   - 选择导出格式（JSON 或 CSV）
   - 点击"创建导出请求"
   - 验证：导出请求创建成功，状态为 `PENDING` 或 `QUEUED`

2. **验证导出文件包含所有相关数据：**
   - 等待导出完成（状态变为 `COMPLETED`）
   - 下载导出文件
   - 验证：文件包含客户、互动记录、产品、活动日志等所有相关数据

3. **验证导出文件格式正确：**
   - 检查 JSON 格式：验证 JSON 结构正确
   - 检查 CSV 格式：验证 CSV 格式正确，包含所有字段

4. **验证下载链接有效期：**
   - 创建导出请求
   - 等待 7 天后尝试下载
   - 验证：下载链接已过期，无法下载

5. **验证 30 天时限合规：**
   - 创建导出请求
   - 检查定时任务是否监控 30 天期限
   - 验证：超过 30 天未完成时记录到审计日志

**权限测试：**
1. **验证不同角色的导出权限：**
   - **前端专员：** 只能导出采购商数据（customerType = 'BUYER'）
   - **后端专员：** 只能导出供应商数据（customerType = 'SUPPLIER'）
   - **总监/管理员：** 可以导出所有数据
   - 验证：每个角色只能导出符合其权限的数据

2. **验证用户只能导出自己的数据：**
   - 使用用户 A 创建导出请求
   - 使用用户 B 尝试访问用户 A 的导出请求
   - 验证：用户 B 无法访问用户 A 的导出请求（返回 403）

**安全测试：**
1. **验证下载链接安全性：**
   - 测试无效令牌：使用无效令牌尝试下载
   - 测试用户所有权：使用用户 A 的令牌，但尝试下载用户 B 的文件
   - 测试令牌过期：使用过期令牌尝试下载
   - 验证：所有安全验证都正确工作

2. **验证导出文件存储安全：**
   - 检查导出文件存储目录权限
   - 验证：文件存储在受保护的目录，只有授权用户可以访问

3. **验证导出操作的审计日志记录：**
   - 创建导出请求
   - 查看审计日志
   - 验证：导出请求创建、完成、失败都被记录到审计日志

**性能测试：**
1. **大数据量导出性能：**
   - 创建包含 > 10000 条记录的导出请求
   - 验证：导出处理时间合理，不影响系统性能

2. **异步处理性能：**
   - 创建多个导出请求
   - 验证：异步处理不影响系统性能

---

#### Task 5: Story 9-6 回归测试（GDPR 数据删除请求）

**测试时间：** 2-3 小时

**功能测试：**
1. **验证数据删除请求创建功能：**
   - 使用前端专员账号登录
   - 访问 GDPR 删除页面：`http://localhost:3005/gdpr/deletion`
   - 选择删除范围（采购商数据）
   - 输入确认信息："确认删除"
   - 点击"创建删除请求"
   - 验证：删除请求创建成功，状态为 `PENDING` 或 `QUEUED`

2. **验证删除操作正确执行：**
   - 等待删除完成（状态变为 `COMPLETED`）
   - 检查相关数据：
     - 客户记录：软删除（deleted_at 已设置）或硬删除
     - 互动记录：软删除或硬删除
     - 产品关联：已删除关联关系
   - 验证：删除操作正确执行

3. **验证删除结果统计和反馈：**
   - 查看删除请求详情
   - 验证：包含删除结果统计（deletedCount, anonymizedCount, failedCount）

4. **验证删除确认机制：**
   - 尝试不输入确认信息创建删除请求
   - 验证：删除请求创建失败，要求输入确认信息

**权限测试：**
1. **验证不同角色的删除权限：**
   - **前端专员：** 只能删除采购商数据
   - **后端专员：** 只能删除供应商数据
   - **总监/管理员：** 可以删除所有数据
   - 验证：每个角色只能删除符合其权限的数据

2. **验证用户只能删除自己的数据：**
   - 使用用户 A 创建删除请求
   - 使用用户 B 尝试访问用户 A 的删除请求
   - 验证：用户 B 无法访问用户 A 的删除请求

**数据一致性测试：**
1. **验证删除操作后数据一致性：**
   - 执行删除操作
   - 检查相关表的数据：
     - `companies` 表：客户记录已删除或匿名化
     - `product_customer_interactions` 表：互动记录已删除
     - `product_customer_associations` 表：关联关系已删除
   - 验证：所有相关数据正确级联删除或匿名化

2. **验证外键约束处理：**
   - 尝试删除有外键引用的记录
   - 验证：外键约束正确处理，不会导致删除失败

3. **验证数据保留策略检查：**
   - 尝试删除在保留期内的数据
   - 验证：根据数据保留策略决定删除方式（软删除/硬删除/匿名化）

**安全测试：**
1. **验证删除操作的不可逆性：**
   - 执行硬删除操作
   - 验证：数据已从数据库永久删除，无法恢复

2. **验证删除操作的审计日志记录：**
   - 执行删除操作
   - 查看审计日志
   - 验证：删除操作被记录到审计日志

3. **验证删除请求的审计日志记录：**
   - 创建删除请求
   - 查看审计日志
   - 验证：删除请求创建、完成、失败、部分完成都被记录到审计日志

**性能测试：**
1. **大数据量删除性能：**
   - 创建包含 > 10000 条记录的删除请求
   - 验证：删除处理时间合理，不影响系统性能

2. **异步处理性能：**
   - 创建多个删除请求
   - 验证：异步处理不影响系统性能

---

### 阶段 3：数据管理功能测试（中优先级）

#### Task 6: Story 9-7 回归测试（数据保留策略）

**测试时间：** 2-3 小时

**功能测试：**
1. **验证保留策略配置保存和读取：**
   - 使用管理员账号登录
   - 访问系统设置页面：`http://localhost:3005/settings`
   - 配置数据保留策略：
     - 客户数据保留期限：2555 天（7 年）
     - 产品数据保留期限：-1（永久保留）
     - 互动记录保留期限：2555 天（7 年）
     - 审计日志保留期限：3650 天（10 年）
   - 保存配置
   - 刷新页面
   - 验证：配置正确保存和读取

2. **验证过期数据识别逻辑：**
   - 访问数据保留统计页面：`http://localhost:3005/settings?tab=data-retention`
   - 查看即将过期数据统计
   - 验证：统计数据显示正确（30 天、60 天、90 天后过期的数据数量）

3. **验证自动删除任务执行：**
   - 等待自动删除任务执行（每日 2:00 AM）或手动触发
   - 检查过期数据：
     - 软删除：`deleted_at` 已设置
     - 硬删除：数据已从数据库删除
   - 验证：自动删除任务正确执行

4. **验证统计和报告功能：**
   - 查看策略配置显示
   - 查看即将过期数据统计
   - 查看清理历史记录
   - 验证：所有统计和报告功能正常工作

**数据一致性测试：**
1. **验证软删除 → 硬删除流程：**
   - 创建过期数据（created_at 超过保留期限）
   - 等待第一次自动删除任务执行（软删除）
   - 等待额外保留期（30 天）后，第二次自动删除任务执行（硬删除）
   - 验证：软删除 → 硬删除流程正确

2. **验证外键约束处理：**
   - 创建有外键引用的过期数据
   - 等待自动删除任务执行
   - 验证：有外键引用的记录被跳过，记录警告日志

3. **验证事务管理：**
   - 创建大量过期数据（> 1000 条）
   - 执行自动删除任务
   - 验证：批次删除使用事务，确保原子性

**安全测试：**
1. **验证只有管理员可以配置保留策略：**
   - 使用非管理员账号尝试访问保留策略配置
   - 验证：非管理员用户无法访问（返回 403）

2. **验证自动删除操作的审计日志记录：**
   - 执行自动删除任务
   - 查看审计日志
   - 验证：自动删除操作被记录到审计日志（操作类型：`DATA_RETENTION_CLEANUP`）

**性能测试：**
1. **大数据量删除性能：**
   - 创建 > 10000 条过期数据
   - 执行自动删除任务
   - 验证：删除任务在 1 小时内完成

2. **批次处理性能：**
   - 验证批次处理（每批 1000 条）不影响系统性能
   - 验证：系统负载正常，不影响正常业务操作

---

#### Task 7: 集成测试和端到端测试

**测试时间：** 2-3 小时

**集成测试：**
1. **审计日志与业务功能集成：**
   - 执行正常的业务流程（创建客户、创建产品、创建互动记录）
   - 查看审计日志
   - 验证：审计日志不影响正常业务流程，所有操作都被正确记录

2. **加密服务与数据存储集成：**
   - 创建包含敏感字段的记录
   - 通过 API 获取记录
   - 验证：加密服务与业务服务正确集成，数据正确加密/解密

3. **密钥管理服务集成：**
   - 执行密钥轮换
   - 访问历史数据
   - 验证：密钥管理服务正确集成，历史数据仍可解密

**端到端测试：**
1. **GDPR 导出功能端到端：**
   - 用户登录 → 创建导出请求 → 等待处理 → 下载文件 → 验证文件内容
   - 验证：完整的导出流程正常工作

2. **GDPR 删除功能端到端：**
   - 用户登录 → 创建删除请求 → 确认删除 → 等待处理 → 验证删除结果
   - 验证：完整的删除流程正常工作

3. **数据保留策略集成：**
   - 配置保留策略 → 创建测试数据 → 等待自动删除任务执行 → 验证删除结果
   - 验证：自动删除任务与数据保留策略正确集成

---

## 🛠️ 测试工具

### 浏览器工具
- **Chrome DevTools：** 用于调试和性能分析
- **Network 标签页：** 用于验证 API 请求和响应
- **Application 标签页：** 用于检查 localStorage、sessionStorage

### API 测试工具
- **Postman 或 Insomnia：** 用于 API 测试
- **curl：** 用于命令行 API 测试

### 性能测试工具
- **Artillery：** 用于负载测试
- **k6：** 用于性能测试

### 安全测试工具
- **OWASP ZAP：** 用于安全扫描
- **Burp Suite：** 用于安全测试

---

## 📊 测试结果记录

### 测试用例执行记录

对于每个测试用例，记录：
- **测试用例ID：** TC-9.X.Y
- **测试用例名称：** 简短描述
- **执行结果：** ✅ PASS / ❌ FAIL / ⚠️ PARTIAL
- **执行时间：** 实际执行时间
- **问题描述：** 如果失败，描述问题
- **截图/日志：** 如果有问题，提供截图或日志

### 性能测试结果记录

对于每个性能测试，记录：
- **测试场景：** 描述测试场景
- **测试指标：** 记录的性能指标（响应时间、吞吐量等）
- **测试结果：** 是否达到要求
- **测试数据：** 测试数据量

### 安全测试结果记录

对于每个安全测试，记录：
- **测试场景：** 描述测试场景
- **测试结果：** 是否通过
- **发现的问题：** 如果发现问题，详细描述
- **严重程度：** 关键、高、中、低

---

## ✅ 测试完成检查清单

### 功能测试完成
- [ ] 所有功能测试用例执行完成
- [ ] 所有功能测试用例通过率 ≥ 95%
- [ ] 所有关键功能测试用例 100% 通过

### 安全测试完成
- [ ] 所有安全测试用例执行完成
- [ ] 所有安全漏洞已修复或记录为已知风险
- [ ] 所有权限验证测试 100% 通过

### 性能测试完成
- [ ] 所有性能测试用例执行完成
- [ ] 所有性能指标达到要求
- [ ] 大数据量测试性能指标达到要求

### 合规测试完成
- [ ] 所有合规测试用例执行完成
- [ ] GDPR 合规要求验证通过
- [ ] 《个人信息保护法》合规要求验证通过

---

**最后更新：** 2026-01-14
