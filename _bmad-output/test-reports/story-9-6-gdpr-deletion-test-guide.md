# Story 9.6: GDPR 数据删除请求 - 测试指南

**日期：** 2026-01-14  
**状态：** 测试中  
**修复的问题：** H1, H2, H3, M2, M3, L1, L2

---

## 📋 测试前置条件

1. **后端服务运行**
   ```bash
   cd fenghua-backend
   npm run start:dev
   ```
   确保服务运行在 `http://localhost:3001`

2. **前端服务运行**（可选，用于 UI 测试）
   ```bash
   cd fenghua-frontend
   npm run dev
   ```
   确保服务运行在 `http://localhost:3005`（或配置的端口）

3. **数据库迁移**
   ```bash
   cd fenghua-backend
   # 确保迁移 032-add-gdpr-deletion-request-table.sql 已执行
   ```

4. **Bull Queue 运行**
   - 确保 Redis 服务运行
   - 确保 Bull Queue 处理器正在处理 `gdpr-deletion-queue`

---

## 🧪 API 测试

### 运行自动化测试脚本

```bash
cd fenghua-backend
TEST_EMAIL=your@email.com \
TEST_PASSWORD=yourpassword \
BACKEND_URL=http://localhost:3001 \
npx ts-node ../scripts/test-gdpr-deletion-api.ts
```

### 测试用例

#### 1. 创建删除请求（有效确认）
- **测试点：** 使用 "确认删除" 或 "DELETE" 创建请求
- **预期结果：** 返回 202 Accepted，包含 request ID 和 PENDING 状态

#### 2. 创建删除请求（无效确认）
- **测试点：** 使用错误的确认字符串
- **预期结果：** 返回 400 Bad Request，错误消息提示需要正确的确认

#### 3. 确认信息验证（大小写不敏感）
- **测试点：** 测试 "DELETE", "delete", "Delete", "  DELETE  " 等变体
- **预期结果：** 所有变体都应该被接受（修复 L2）
- **测试点：** 测试 "确认删除" 和 " 确认删除 "（带空格）
- **预期结果：** 应该被接受

#### 4. 获取删除请求列表
- **测试点：** GET `/gdpr/deletion-requests?limit=50&offset=0`
- **预期结果：** 返回用户的删除请求列表，只能看到自己的请求

#### 5. 获取删除请求详情
- **测试点：** GET `/gdpr/deletion-requests/:id`
- **预期结果：** 返回请求详情，包括状态、摘要等

#### 6. 安全测试 - 无认证
- **测试点：** 不带 Authorization header 的请求
- **预期结果：** 返回 401 Unauthorized

#### 7. 安全测试 - 访问其他用户的请求
- **测试点：** 使用用户 A 的 token 访问用户 B 的请求 ID
- **预期结果：** 返回 404 Not Found（用户只能访问自己的请求）

---

## 🔍 功能验证测试

### 修复验证

#### H1: 部分失败检测逻辑
1. **准备：** 创建一个删除请求
2. **模拟：** 在删除过程中，让某些记录删除失败（例如，数据库约束错误）
3. **验证：** 
   - 检查 `deletion_summary.failedCount > 0`
   - 检查 `status` 是否为 `PARTIALLY_COMPLETED`
   - 检查审计日志中是否有 `GDPR_DELETION_PARTIALLY_COMPLETED` 记录

#### H2: 用户创建的产品删除逻辑
1. **准备：** 
   - 用户创建一些产品
   - 确保某些产品没有其他用户的关联
   - 确保某些产品有其他用户的关联
2. **执行：** 创建删除请求
3. **验证：**
   - 没有其他用户关联的产品应该被删除
   - 有其他用户关联的产品应该保留（只删除关联关系）

#### H3: 进度跟踪准确性
1. **准备：** 创建一个删除请求，确保有足够的数据（> 1000 条记录）
2. **执行：** 创建删除请求并监控进度
3. **验证：**
   - 进度应该从 0% 开始
   - 进度应该准确反映已处理的记录数 / 总记录数
   - 不应该出现进度超过 100% 的情况

#### M2: 审计日志处理限制
1. **准备：** 确保用户有超过 10000 条审计日志（如果可能）
2. **执行：** 创建删除请求
3. **验证：** 所有审计日志都应该被处理（不应该有硬编码的 LIMIT）

#### L1: 错误消息记录
1. **准备：** 创建一个删除请求，确保某些操作会失败
2. **执行：** 等待删除完成（或部分完成）
3. **验证：** `deletion_summary.errors` 数组应该包含详细的错误信息

#### L2: 确认信息验证
- 已在 API 测试中验证（测试用例 3）

---

## 🎨 前端 UI 测试

### 访问页面
1. 登录系统
2. 导航到 `/gdpr/deletion` 或从首页点击 "GDPR 数据删除"

### 测试场景

#### 场景 1: 前端专员删除请求
1. **准备：** 使用前端专员账户登录
2. **验证：** 页面应该显示 "删除我的采购商数据" 选项
3. **执行：** 输入 "确认删除" 并提交
4. **验证：** 
   - 请求创建成功
   - 状态显示为 PENDING → QUEUED → PROCESSING → COMPLETED
   - 轮询每 10 秒更新一次
   - 完成后显示删除摘要

#### 场景 2: 后端专员删除请求
1. **准备：** 使用后端专员账户登录
2. **验证：** 页面应该显示 "删除我的供应商数据" 选项
3. **执行：** 输入 "DELETE"（大小写不敏感）并提交
4. **验证：** 同场景 1

#### 场景 3: 总监/管理员删除请求
1. **准备：** 使用总监或管理员账户登录
2. **验证：** 页面应该显示 "删除我的所有数据" 选项
3. **执行：** 输入 "确认删除" 并提交
4. **验证：** 同场景 1

#### 场景 4: 确认验证
1. **测试：** 输入错误的确认字符串（如 "wrong"）
2. **验证：** 应该显示错误消息，不允许提交

#### 场景 5: 轮询机制
1. **准备：** 创建一个删除请求
2. **验证：** 
   - 轮询每 10 秒更新一次
   - 当状态为 COMPLETED、FAILED 或 PARTIALLY_COMPLETED 时停止轮询
   - 连续错误超过 3 次时停止轮询

---

## 📊 性能测试

### 大数据量测试
1. **准备：** 
   - 创建大量测试数据（> 10000 条客户记录）
   - 创建大量互动记录
   - 创建大量产品关联
2. **执行：** 创建删除请求
3. **验证：**
   - 删除应该分批处理（每批 1000 条）
   - 进度跟踪应该准确
   - 不应该出现内存溢出或超时

---

## 🔒 安全测试

### 测试用例

1. **用户只能访问自己的请求**
   - 使用用户 A 的 token 访问用户 B 的请求 ID
   - 应该返回 404 Not Found

2. **角色权限验证**
   - 前端专员只能删除采购商数据
   - 后端专员只能删除供应商数据
   - 总监/管理员可以删除所有数据

3. **确认机制验证**
   - 必须输入 "确认删除" 或 "DELETE" 才能提交
   - 其他字符串应该被拒绝

---

## 📝 测试结果记录

### API 测试结果

| 测试用例 | 状态 | 备注 |
|---------|------|------|
| 创建删除请求（有效确认） | ⏳ | |
| 创建删除请求（无效确认） | ⏳ | |
| 确认信息验证 | ⏳ | |
| 获取删除请求列表 | ⏳ | |
| 获取删除请求详情 | ⏳ | |
| 安全测试 - 无认证 | ⏳ | |
| 安全测试 - 访问其他用户请求 | ⏳ | |

### 修复验证结果

| 修复项 | 状态 | 验证结果 |
|--------|------|----------|
| H1: 部分失败检测 | ⏳ | |
| H2: 产品删除逻辑 | ⏳ | |
| H3: 进度跟踪 | ⏳ | |
| M2: 审计日志限制 | ⏳ | |
| L1: 错误消息记录 | ⏳ | |
| L2: 确认信息验证 | ⏳ | |

---

## 🐛 已知问题

- 无

---

## ✅ 测试完成标准

- [ ] 所有 API 测试用例通过
- [ ] 所有修复项已验证
- [ ] 前端 UI 测试通过
- [ ] 安全测试通过
- [ ] 性能测试通过（如果适用）
- [ ] 测试结果已记录

---

## 📚 相关文档

- [Story 9.6 实现文档](../implementation-artifacts/stories/9-6-gdpr-data-deletion-request.md)
- [代码审查报告](../code-reviews/story-9-6-code-review.md)（如果存在）
