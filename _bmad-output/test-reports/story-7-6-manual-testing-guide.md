# Story 7.6 手动测试指南

**Story:** 7-6-import-history-and-error-reports  
**创建日期:** 2025-01-08  
**测试环境:** 开发/测试环境

---

## 📋 测试前准备

### 1. 环境检查

#### 后端环境
- [ ] 后端服务已启动
- [ ] 数据库连接正常
- [ ] Redis 服务已启动（可选，用于缓存优化）
- [ ] 已运行数据库迁移：`020-add-error-details-to-import-history.sql`

**检查命令：**
```bash
# 检查数据库迁移
psql -d your_database -c "SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'import_history' AND column_name = 'error_details';"

# 检查索引
psql -d your_database -c "SELECT indexname FROM pg_indexes WHERE tablename = 'import_history' AND indexname = 'idx_import_history_error_details';"
```

#### 前端环境
- [ ] 前端服务已启动
- [ ] 可以正常访问导入界面
- [ ] 已登录为总监或管理员角色

### 2. 测试数据准备

#### 准备测试文件

**文件 1: 完全成功的导入文件（customers_success.xlsx）**
```
| 客户名称 | 邮箱 | 电话 | 地址 |
|---------|------|------|------|
| 测试客户1 | test1@example.com | 13800138001 | 北京市朝阳区 |
| 测试客户2 | test2@example.com | 13800138002 | 上海市浦东新区 |
| 测试客户3 | test3@example.com | 13800138003 | 广州市天河区 |
```

**文件 2: 完全失败的导入文件（customers_failed.xlsx）**
```
| 客户名称 | 邮箱 | 电话 | 地址 |
|---------|------|------|------|
| 测试客户4 | invalid-email | 123 |  |
| 测试客户5 |  | abc |  |
```

**文件 3: 部分成功的导入文件（customers_partial.xlsx）**
```
| 客户名称 | 邮箱 | 电话 | 地址 |
|---------|------|------|------|
| 测试客户6 | test6@example.com | 13800138006 | 深圳市南山区 |
| 测试客户7 | invalid-email | 123 |  |
| 测试客户8 | test8@example.com | 13800138008 | 杭州市西湖区 |
| 测试客户9 |  | abc |  |
```

**文件 4: 大量数据的导入文件（customers_large.xlsx）**
- 创建包含 100+ 条记录的文件（部分成功，部分失败）
- 用于测试分页和性能

---

## 🧪 测试场景

### 场景 1: AC1 - 导入历史列表显示

#### 测试步骤

1. **访问导入历史页面**
   - 登录系统（总监或管理员角色）
   - 导航到：数据导入 → 导入历史
   - 或直接访问：`/import/history`

2. **验证列表显示**
   - [ ] 页面正常加载，无错误
   - [ ] 显示导入历史列表
   - [ ] 列表包含以下列：
     - 导入时间
     - 导入文件（文件名）
     - 导入状态（成功/失败/部分成功/处理中）
     - 导入记录数（总记录数）
     - 成功数
     - 失败数
     - 导入类型（客户/产品/互动记录）
   - [ ] 列表按时间倒序排列（最新的在前）

3. **验证统计信息卡片**
   - [ ] 显示统计信息卡片（在列表上方）
   - [ ] 包含以下统计：
     - 总任务数
     - 已完成（绿色）
     - 部分成功（黄色）
     - 失败（红色）
     - 处理中（蓝色）
   - [ ] 统计数字正确

#### 预期结果
- ✅ 导入历史列表正常显示
- ✅ 所有必需字段都显示
- ✅ 列表按时间倒序排列
- ✅ 统计信息正确显示

#### 截图要点
- 导入历史列表页面
- 统计信息卡片

---

### 场景 2: AC2 - 导入任务详情查看

#### 测试步骤

1. **执行一个部分成功的导入**
   - 上传 `customers_partial.xlsx` 文件
   - 完成导入流程
   - 等待导入完成

2. **查看任务详情**
   - 在导入历史列表中，找到刚才的导入任务
   - 点击"查看详情"按钮（或点击任务行）
   - 验证任务详情弹窗打开

3. **验证基本信息**
   - [ ] 显示文件名
   - [ ] 显示状态（应为"部分成功"）
   - [ ] 显示开始时间
   - [ ] 显示完成时间（如果有）

4. **验证导入结果摘要**
   - [ ] 显示总记录数
   - [ ] 显示成功数（绿色背景）
   - [ ] 显示失败数（红色背景）
   - [ ] 数字正确

5. **验证错误报告显示**
   - [ ] 显示"错误详情"部分
   - [ ] 列出所有失败的记录
   - [ ] 每个失败记录显示错误原因

#### 预期结果
- ✅ 任务详情弹窗正常打开
- ✅ 基本信息完整显示
- ✅ 导入结果摘要正确
- ✅ 错误报告正确显示

#### 截图要点
- 任务详情弹窗
- 错误详情列表

---

### 场景 3: AC3 - 错误报告详细信息

#### 测试步骤

1. **查看错误详情**
   - 打开一个包含失败记录的任务详情
   - 滚动到"错误详情"部分

2. **验证错误详情列表**
   - [ ] 显示失败记录列表
   - [ ] 每个记录显示：
     - 行号
     - 错误数量（如"2 个错误"）
     - 展开/折叠按钮
   - [ ] 点击"展开"按钮
   - [ ] 验证展开后显示：
     - 原始数据内容（所有字段）
     - 错误列表（字段名和错误消息）

3. **测试分页功能（如果有大量错误）**
   - 使用包含大量错误记录的任务
   - [ ] 验证分页控件显示
   - [ ] 点击"下一页"
   - [ ] 验证数据正确加载
   - [ ] 点击"上一页"
   - [ ] 验证返回上一页

4. **下载 Excel 错误报告**
   - 在任务详情页面，找到"下载报告"按钮
   - 选择"Excel"格式
   - 点击下载
   - [ ] 文件成功下载
   - [ ] 打开 Excel 文件
   - [ ] 验证文件包含：
     - 所有原始数据列
     - `_row_number` 列（行号）
     - `_error_message` 列（错误消息）
     - `_error_fields` 列（错误字段）
   - [ ] 验证错误信息正确

5. **下载 CSV 错误报告**
   - 在任务详情页面，选择"CSV"格式
   - 点击下载
   - [ ] 文件成功下载
   - [ ] 打开 CSV 文件
   - [ ] 验证内容与 Excel 文件一致

6. **测试重新导入功能**
   - 在任务详情页面，找到"重新导入"按钮
   - [ ] 按钮仅在有失败记录时显示
   - 点击"重新导入"按钮
   - [ ] 显示确认提示或加载状态
   - [ ] 创建新的导入任务
   - [ ] 显示新的任务 ID
   - [ ] 验证新任务只包含失败记录
   - [ ] 验证错误信息保留

#### 预期结果
- ✅ 错误详情正确显示
- ✅ 可以展开/折叠错误详情
- ✅ Excel 文件下载成功且内容正确
- ✅ CSV 文件下载成功且内容正确
- ✅ 重新导入功能正常工作

#### 截图要点
- 展开的错误详情
- 下载的 Excel 文件内容
- 重新导入后的新任务

---

### 场景 4: AC4 - 导入历史筛选和分页

#### 测试步骤

1. **测试状态筛选**
   - 在导入历史页面，找到状态筛选下拉框
   - [ ] 选择"全部状态" - 显示所有任务
   - [ ] 选择"已完成" - 只显示已完成的任务
   - [ ] 选择"失败" - 只显示失败的任务
   - [ ] 选择"部分成功" - 只显示部分成功的任务
   - [ ] 选择"处理中" - 只显示处理中的任务
   - [ ] 验证筛选结果正确

2. **测试导入类型筛选**
   - 找到导入类型筛选下拉框
   - [ ] 选择"全部类型" - 显示所有类型的任务
   - [ ] 选择"客户" - 只显示客户导入任务
   - [ ] 选择"产品" - 只显示产品导入任务
   - [ ] 选择"互动记录" - 只显示互动记录导入任务
   - [ ] 验证筛选结果正确

3. **测试时间范围筛选**
   - 找到开始日期选择器
   - 选择开始日期（如：2025-01-01）
   - [ ] 验证列表只显示该日期之后的任务
   - 找到结束日期选择器
   - 选择结束日期（如：2025-01-08）
   - [ ] 验证列表只显示该日期范围内的任务
   - [ ] 验证统计信息根据筛选条件更新

4. **测试搜索功能**
   - 找到搜索输入框
   - 输入文件名（部分匹配）
   - [ ] 验证搜索结果正确
   - 清空搜索，输入任务 ID（部分匹配）
   - [ ] 验证搜索结果正确
   - [ ] 验证搜索是实时更新的（或需要点击搜索按钮）

5. **测试分页功能**
   - 确保有足够多的导入历史记录（> 50 条）
   - [ ] 验证分页控件显示
   - [ ] 显示当前页码和总页数
   - [ ] 点击"下一页"
   - [ ] 验证加载下一页数据
   - [ ] 点击"上一页"
   - [ ] 验证返回上一页
   - [ ] 验证每页显示正确的记录数（默认 20 条）

6. **测试组合筛选**
   - 同时应用多个筛选条件：
     - 状态：部分成功
     - 导入类型：客户
     - 时间范围：最近一周
     - 搜索：特定关键词
   - [ ] 验证组合筛选结果正确
   - [ ] 验证统计信息根据组合筛选更新

#### 预期结果
- ✅ 所有筛选功能正常工作
- ✅ 筛选结果正确
- ✅ 搜索功能正常工作
- ✅ 分页功能正常工作
- ✅ 组合筛选正常工作
- ✅ 统计信息正确更新

#### 截图要点
- 各种筛选条件的应用
- 分页控件
- 组合筛选结果

---

### 场景 5: 部分成功导入完整流程

#### 测试步骤

1. **执行部分成功导入**
   - 上传 `customers_partial.xlsx` 文件
   - 完成映射和验证步骤
   - 启动导入
   - 等待导入完成

2. **验证导入结果**
   - [ ] 导入状态显示为"部分成功"
   - [ ] 成功数和失败数正确
   - [ ] 在导入历史列表中可以看到该任务

3. **查看错误详情**
   - 打开任务详情
   - [ ] 错误详情正确显示
   - [ ] 失败记录列表正确
   - [ ] 错误原因准确

4. **下载错误报告**
   - 下载 Excel 格式错误报告
   - [ ] 文件包含所有失败记录
   - [ ] 错误信息完整

5. **修正并重新导入**
   - 打开下载的 Excel 文件
   - 修正错误数据
   - 保存文件
   - 在任务详情页面点击"重新导入"
   - [ ] 新任务创建成功
   - [ ] 新任务只包含失败记录
   - [ ] 等待新任务完成
   - [ ] 验证修正后的数据成功导入

#### 预期结果
- ✅ 部分成功导入流程完整
- ✅ 错误详情准确
- ✅ 重新导入功能正常
- ✅ 修正后的数据成功导入

---

### 场景 6: 性能测试（大量错误记录）

#### 测试步骤

1. **准备大量错误数据**
   - 使用 `customers_large.xlsx` 文件
   - 或创建一个包含 100+ 条记录的文件（部分失败）

2. **执行导入**
   - 上传文件并完成导入
   - 记录导入完成时间

3. **查看错误详情**
   - 打开任务详情
   - [ ] 错误详情加载时间合理（< 2 秒）
   - [ ] 分页功能正常工作
   - [ ] 翻页响应时间合理

4. **测试分页性能**
   - 点击"下一页"多次
   - [ ] 每次翻页响应时间合理（< 1 秒）
   - [ ] 无内存泄漏或性能下降

#### 预期结果
- ✅ 大量错误记录查询性能良好
- ✅ 分页功能流畅
- ✅ 无性能问题

---

## 🔍 常见问题排查

### 问题 1: 导入历史列表不显示

**可能原因：**
- 数据库迁移未执行
- 后端服务未启动
- API 端点错误

**排查步骤：**
1. 检查浏览器控制台错误
2. 检查网络请求（F12 → Network）
3. 检查后端日志
4. 验证数据库迁移已执行

### 问题 2: 错误详情不显示

**可能原因：**
- `error_details` 字段未保存
- JSONB 数据格式错误
- 前端解析错误

**排查步骤：**
1. 检查数据库中的 `error_details` 字段
   ```sql
   SELECT task_id, error_details FROM import_history WHERE task_id = 'your_task_id';
   ```
2. 检查浏览器控制台错误
3. 检查 API 响应数据

### 问题 3: 下载错误报告失败

**可能原因：**
- 文件路径错误
- 文件不存在
- 权限问题

**排查步骤：**
1. 检查后端日志
2. 验证文件是否存在
3. 检查文件权限

### 问题 4: 重新导入功能不工作

**可能原因：**
- `error_details` 为空
- Excel 文件格式不正确
- API 调用失败

**排查步骤：**
1. 检查任务是否有 `error_details`
2. 检查浏览器控制台错误
3. 检查网络请求
4. 检查后端日志

### 问题 5: 筛选功能不工作

**可能原因：**
- 前端状态未更新
- API 参数错误
- 数据库查询错误

**排查步骤：**
1. 检查浏览器控制台
2. 检查网络请求参数
3. 检查后端日志
4. 验证数据库查询

---

## ✅ 测试检查清单

### 功能测试
- [ ] AC1: 导入历史列表显示 - 通过
- [ ] AC2: 导入任务详情查看 - 通过
- [ ] AC3: 错误报告详细信息 - 通过
- [ ] AC4: 导入历史筛选和分页 - 通过
- [ ] 部分成功导入流程 - 通过
- [ ] 重新导入功能 - 通过
- [ ] 性能测试 - 通过

### 边界测试
- [ ] 空导入历史列表
- [ ] 只有成功记录的任务
- [ ] 只有失败记录的任务
- [ ] 大量错误记录（> 1000 条）
- [ ] 特殊字符在文件名中
- [ ] 超长文件名

### 错误处理测试
- [ ] 网络错误时的处理
- [ ] API 错误时的处理
- [ ] 文件下载失败时的处理
- [ ] 重新导入失败时的处理

---

## 📝 测试报告模板

### 测试环境
- **测试日期:** YYYY-MM-DD
- **测试人员:** 姓名
- **测试环境:** 开发/测试/生产
- **浏览器:** Chrome/Firefox/Safari 版本
- **后端版本:** 版本号
- **前端版本:** 版本号

### 测试结果

| 测试场景 | 状态 | 备注 |
|---------|------|------|
| AC1: 导入历史列表显示 | ✅/❌ | |
| AC2: 导入任务详情查看 | ✅/❌ | |
| AC3: 错误报告详细信息 | ✅/❌ | |
| AC4: 导入历史筛选和分页 | ✅/❌ | |
| 部分成功导入流程 | ✅/❌ | |
| 重新导入功能 | ✅/❌ | |
| 性能测试 | ✅/❌ | |

### 发现的问题

| 问题编号 | 严重程度 | 描述 | 状态 |
|---------|---------|------|------|
| #1 | High/Medium/Low | 问题描述 | 待修复/已修复 |

### 测试结论

- **总体状态:** ✅ 通过 / ❌ 失败
- **建议:** 可以部署 / 需要修复问题后再部署

---

## 🚀 快速测试脚本

### 使用 curl 测试 API

```bash
# 1. 获取导入历史
curl -X GET "http://localhost:3000/api/import/customers/history?limit=20&offset=0" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 2. 获取任务详情
curl -X GET "http://localhost:3000/api/import/customers/tasks/TASK_ID/details" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 3. 获取错误详情
curl -X GET "http://localhost:3000/api/import/customers/tasks/TASK_ID/errors?limit=50&offset=0" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 4. 获取统计信息
curl -X GET "http://localhost:3000/api/import/customers/history/stats?startDate=2025-01-01&endDate=2025-01-08" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 5. 下载错误报告
curl -X GET "http://localhost:3000/api/import/customers/reports/TASK_ID?format=xlsx" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -o error_report.xlsx

# 6. 重新导入
curl -X POST "http://localhost:3000/api/import/customers/retry/TASK_ID" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## 📚 相关文档

- **Story 文件:** `_bmad-output/implementation-artifacts/stories/7-6-import-history-and-error-reports.md`
- **测试验证报告:** `_bmad-output/test-reports/story-7-6-test-verification-2025-01-08.md`
- **快速验证清单:** `_bmad-output/test-reports/story-7-6-quick-verification-checklist.md`
- **最终验证总结:** `_bmad-output/test-reports/story-7-6-final-verification-summary.md`

---

**祝测试顺利！** 🎉

