# Story 9.5: GDPR 数据导出请求（按角色）- 手动测试指南

**Story:** 9-5-gdpr-data-export-request  
**日期:** 2026-01-13  
**测试者:** [测试人员姓名]

---

## 📋 测试环境准备

### 1. 数据库迁移

- [ ] 运行迁移脚本：`fenghua-backend/migrations/031-add-gdpr-export-request-table.sql`
- [ ] 确认 `gdpr_export_requests` 表已创建
- [ ] 确认所有索引已创建（user_id, status, requested_at, expires_at, download_token）

**验证命令：**
```sql
-- 检查表是否存在
SELECT table_name FROM information_schema.tables 
WHERE table_name = 'gdpr_export_requests';

-- 检查索引
SELECT indexname FROM pg_indexes 
WHERE tablename = 'gdpr_export_requests';
```

### 2. 后端服务

- [ ] 确保后端服务正在运行（默认端口：3001）
- [ ] 确认 `GdprModule` 已正确注册到 `AppModule`
- [ ] 确认 Bull Queue 服务已启动（用于异步处理）
- [ ] 确认定时任务调度器已启动（用于 30 天期限监控和文件清理）
- [ ] 确认导出文件存储目录已创建（环境变量：`GDPR_EXPORT_STORAGE_PATH`）

**检查命令：**
```bash
# 检查后端服务状态
curl http://localhost:3001/health

# 检查 GDPR 端点是否可访问（需要认证）
curl -H "Authorization: Bearer <token>" http://localhost:3001/gdpr/export-requests
```

### 3. 前端服务

- [ ] 确保前端服务正在运行（默认端口：5173）
- [ ] 确认路由 `/gdpr/export` 已配置
- [ ] 确认 GDPR 导出页面组件已正确导入

### 4. 测试用户准备

需要准备以下角色的测试用户：

- [ ] **前端专员（FRONTEND_SPECIALIST）** - 用于测试采购商数据导出
- [ ] **后端专员（BACKEND_SPECIALIST）** - 用于测试供应商数据导出
- [ ] **总监（DIRECTOR）** - 用于测试所有数据导出
- [ ] **管理员（ADMIN）** - 用于测试所有数据导出

### 5. 测试数据准备

- [ ] 系统中存在采购商数据（`companies` 表，`customer_type = 'BUYER'`）
- [ ] 系统中存在供应商数据（`companies` 表，`customer_type = 'SUPPLIER'`）
- [ ] 系统中存在产品-客户互动记录（`product_customer_interactions` 表）
- [ ] 系统中存在产品数据（`products` 表）
- [ ] 系统中存在审计日志数据（`audit_logs` 表）

---

## 🧪 测试用例

### TC1: 前端专员 - 创建采购商数据导出请求（JSON 格式）

**目标:** 验证前端专员可以创建采购商数据导出请求（AC1）

**前置条件:**
- 以前端专员身份登录系统
- 系统中存在该前端专员创建的采购商数据

**测试步骤:**
1. 访问 `/gdpr/export` 页面
2. 确认页面显示"导出我的采购商数据"选项
3. 选择导出格式为 "JSON"
4. 点击"创建导出请求"按钮
5. 观察页面反馈

**预期结果:**
- 页面显示成功消息："导出请求已创建，系统将在30天内生成导出文件"
- 导出请求出现在请求历史列表中
- 请求状态为 "QUEUED" 或 "PROCESSING"
- 请求格式为 "JSON"
- 审计日志中记录操作类型为 "GDPR_EXPORT_REQUEST"

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC2: 前端专员 - 创建采购商数据导出请求（CSV 格式）

**目标:** 验证前端专员可以创建 CSV 格式的导出请求（AC1）

**前置条件:**
- 以前端专员身份登录系统

**测试步骤:**
1. 访问 `/gdpr/export` 页面
2. 选择导出格式为 "CSV"
3. 点击"创建导出请求"按钮

**预期结果:**
- 导出请求成功创建
- 请求格式为 "CSV"

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC3: 后端专员 - 创建供应商数据导出请求

**目标:** 验证后端专员可以创建供应商数据导出请求（AC2）

**前置条件:**
- 以后端专员身份登录系统
- 系统中存在该后端专员创建的供应商数据

**测试步骤:**
1. 访问 `/gdpr/export` 页面
2. 确认页面显示"导出我的供应商数据"选项（不显示采购商数据选项）
3. 选择导出格式（JSON 或 CSV）
4. 点击"创建导出请求"按钮

**预期结果:**
- 导出请求成功创建
- 页面只显示供应商数据导出选项
- 审计日志中记录操作类型为 "GDPR_EXPORT_REQUEST"

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC4: 总监/管理员 - 创建所有数据导出请求

**目标:** 验证总监或管理员可以创建所有数据导出请求（AC3）

**前置条件:**
- 以总监或管理员身份登录系统

**测试步骤:**
1. 访问 `/gdpr/export` 页面
2. 确认页面显示"导出我的所有数据"选项
3. 选择导出格式（JSON 或 CSV）
4. 点击"创建导出请求"按钮

**预期结果:**
- 导出请求成功创建
- 页面显示所有数据导出选项
- 导出文件应包含该用户的所有相关数据（采购商、供应商、产品、互动记录、审计日志）

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC5: 验证导出数据完整性

**目标:** 验证导出文件包含所有相关数据（AC4）

**前置条件:**
- 已创建一个导出请求并等待处理完成（状态为 "COMPLETED"）

**测试步骤:**
1. 等待导出请求处理完成（状态变为 "COMPLETED"）
2. 下载导出文件（JSON 或 CSV）
3. 打开导出文件
4. 验证文件内容

**预期结果:**
- 导出文件包含以下数据：
  - 用户创建的客户记录（根据角色过滤）
  - 用户创建的互动记录（根据角色过滤）
  - 用户创建的产品记录（三种来源：用户创建的、与用户客户关联的、用户互动中的）
  - 用户的活动日志（审计日志）
- 文件结构清晰，易于理解
- JSON 格式：包含结构化的数据对象
- CSV 格式：包含表格式的数据

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC6: 下载导出文件（有效令牌）

**目标:** 验证用户可以通过有效令牌下载导出文件（AC5）

**前置条件:**
- 已有一个状态为 "COMPLETED" 的导出请求
- 导出文件已生成

**测试步骤:**
1. 在导出请求列表中，找到状态为 "COMPLETED" 的请求
2. 点击"下载"按钮
3. 观察文件下载过程

**预期结果:**
- 文件成功下载
- 文件名格式正确（例如：`gdpr-export-{userId}-{requestId}.json`）
- 文件内容完整且正确

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC7: 下载链接有效期验证（7 天）

**目标:** 验证下载链接在 7 天内有效，超过 7 天失效（AC5）

**前置条件:**
- 已有一个状态为 "COMPLETED" 的导出请求
- 导出请求的 `expires_at` 字段已设置（7 天后）

**测试步骤:**
1. 检查导出请求的 `expires_at` 时间
2. 在有效期内尝试下载文件（应该成功）
3. （可选）修改数据库中的 `expires_at` 为过去时间，尝试下载（应该失败）

**预期结果:**
- 在有效期内可以成功下载
- 超过有效期后下载失败，显示"下载链接已过期"错误

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC8: 安全测试 - 用户只能访问自己的导出请求

**目标:** 验证用户只能访问自己的导出请求，不能访问其他用户的导出请求

**前置条件:**
- 用户 A 已创建一个导出请求（requestId: `req-a`）
- 用户 B 已登录系统

**测试步骤:**
1. 以用户 B 身份登录系统
2. 尝试访问用户 A 的导出请求：`GET /gdpr/export-requests/req-a`
3. 尝试下载用户 A 的导出文件：`GET /gdpr/export-requests/req-a/download?token=xxx`

**预期结果:**
- 访问请求详情时返回 404 或 403 错误
- 下载文件时返回 404 或 403 错误
- 错误消息为"导出请求不存在或无权访问"或"无权访问此导出文件"

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC9: 安全测试 - 无效下载令牌验证

**目标:** 验证无效的下载令牌被拒绝

**前置条件:**
- 已有一个状态为 "COMPLETED" 的导出请求
- 知道正确的下载令牌

**测试步骤:**
1. 使用无效的下载令牌尝试下载文件
2. 使用其他请求的下载令牌尝试下载当前请求的文件

**预期结果:**
- 返回 400 错误
- 错误消息为"无效的下载令牌"

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC10: 导出请求列表查询

**目标:** 验证用户可以查看自己的导出请求历史列表

**前置条件:**
- 用户已创建多个导出请求

**测试步骤:**
1. 访问 `/gdpr/export` 页面
2. 查看导出请求列表
3. 验证列表显示的信息

**预期结果:**
- 列表显示用户的所有导出请求
- 每个请求显示：状态、请求时间、文件格式、文件大小（如果已完成）
- 列表按请求时间倒序排列
- 支持分页（limit/offset 参数验证）

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC11: 导出请求状态跟踪

**目标:** 验证导出请求状态正确更新

**前置条件:**
- 已创建一个导出请求

**测试步骤:**
1. 创建导出请求后，观察状态变化
2. 等待处理完成，观察状态更新
3. 检查状态更新顺序

**预期结果:**
- 状态按以下顺序更新：
  1. `PENDING` → 创建请求时
  2. `QUEUED` → 添加到队列后
  3. `PROCESSING` → 开始处理时
  4. `GENERATING_FILE` → 生成文件时
  5. `COMPLETED` → 处理完成时
- 如果处理失败，状态变为 `FAILED`

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC12: 空数据处理

**目标:** 验证用户没有数据时，导出请求仍能正常处理

**前置条件:**
- 创建一个新用户，该用户没有任何相关数据（客户、互动、产品、审计日志）

**测试步骤:**
1. 以新用户身份登录
2. 创建导出请求
3. 等待处理完成

**预期结果:**
- 导出请求成功创建
- 处理完成后，状态变为 "COMPLETED"
- 导出文件为空或包含空数据提示
- 系统日志中记录警告："No data found for user {userId} - creating empty export file"

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC13: 审计日志记录验证

**目标:** 验证所有导出操作都记录到审计日志（AC5）

**前置条件:**
- 以管理员身份登录，可以访问审计日志页面

**测试步骤:**
1. 创建导出请求
2. 等待导出完成
3. 访问审计日志页面（`/audit-logs`）
4. 筛选操作类型为 "GDPR_EXPORT_REQUEST"、"GDPR_EXPORT_COMPLETED"、"GDPR_EXPORT_FAILED"

**预期结果:**
- 审计日志中记录以下操作：
  - `GDPR_EXPORT_REQUEST` - 创建请求时
  - `GDPR_EXPORT_COMPLETED` - 处理完成时
  - `GDPR_EXPORT_FAILED` - 处理失败时（如果有）
- 每个日志记录包含：用户ID、请求ID、时间戳、元数据（格式、记录数等）

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC14: 30 天期限监控（定时任务）

**目标:** 验证定时任务正确监控 30 天期限

**前置条件:**
- 系统中存在超过 25 天但未完成的导出请求
- 系统中存在超过 30 天但未完成的导出请求

**测试步骤:**
1. 检查定时任务是否在每天 3 AM 运行
2. 查看系统日志，确认期限检查已执行
3. 验证审计日志中是否记录了期限违规

**预期结果:**
- 25 天提醒：系统日志中记录警告
- 30 天违规：系统日志中记录错误，审计日志中记录 `GDPR_EXPORT_DEADLINE_VIOLATION`

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC15: 过期文件清理（定时任务）

**目标:** 验证定时任务正确清理过期文件

**前置条件:**
- 系统中存在超过 7 天的导出文件（`expires_at` 已过期）

**测试步骤:**
1. 检查定时任务是否在每天 2 AM 运行
2. 查看系统日志，确认清理任务已执行
3. 验证过期文件是否已从文件系统删除
4. 验证数据库记录是否已标记为 `deleted_at`

**预期结果:**
- 过期文件已从文件系统删除
- 数据库记录已标记为 `deleted_at`
- 系统日志中记录清理操作

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC16: 参数验证测试 - UUID 格式验证

**目标:** 验证路由参数 UUID 格式验证（代码审查修复项 H1）

**测试步骤:**
1. 尝试使用无效的 UUID 格式访问导出请求详情：`GET /gdpr/export-requests/invalid-uuid`
2. 尝试使用无效的 UUID 格式下载文件：`GET /gdpr/export-requests/invalid-uuid/download?token=xxx`

**预期结果:**
- 返回 400 错误
- 错误消息包含"导出请求ID必须是有效的UUID"

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC17: 参数验证测试 - limit/offset 验证

**目标:** 验证查询参数 limit/offset 验证（代码审查修复项 M2）

**测试步骤:**
1. 尝试使用无效的 limit 值：`GET /gdpr/export-requests?limit=-1`
2. 尝试使用无效的 limit 值：`GET /gdpr/export-requests?limit=200`（超过最大值 100）
3. 尝试使用无效的 offset 值：`GET /gdpr/export-requests?offset=-1`

**预期结果:**
- 返回 400 错误
- 错误消息包含相应的验证错误信息

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC18: 前端错误处理验证

**目标:** 验证前端错误处理改进（代码审查修复项 M1）

**测试步骤:**
1. 断开网络连接
2. 尝试加载导出请求列表
3. 观察页面显示

**预期结果:**
- 页面显示错误消息（而不是仅记录到 console）
- 错误消息用户友好："加载导出请求列表失败"

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC19: 文件流错误处理验证

**目标:** 验证文件流错误处理（代码审查修复项 H2）

**测试步骤:**
1. 创建一个导出请求并等待完成
2. 手动删除导出文件
3. 尝试下载文件

**预期结果:**
- 返回 404 错误："导出文件不存在"
- 系统日志中记录错误（不会导致未处理的 Promise 拒绝）

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC20: 性能测试 - 大数据量导出

**目标:** 验证大数据量导出的性能（> 10000 条记录）

**前置条件:**
- 系统中存在大量测试数据（> 10000 条客户、互动、产品记录）

**测试步骤:**
1. 创建导出请求
2. 记录处理时间
3. 验证系统性能不受影响（其他功能仍可正常使用）
4. 验证导出文件大小合理

**预期结果:**
- 导出请求成功处理（可能需要较长时间）
- 系统其他功能不受影响
- 导出文件大小合理（不会导致内存溢出）
- 文件生成时间在可接受范围内

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

## ✅ 测试检查清单

### 功能测试
- [ ] TC1: 前端专员创建采购商数据导出请求（JSON）
- [ ] TC2: 前端专员创建采购商数据导出请求（CSV）
- [ ] TC3: 后端专员创建供应商数据导出请求
- [ ] TC4: 总监/管理员创建所有数据导出请求
- [ ] TC5: 验证导出数据完整性
- [ ] TC6: 下载导出文件（有效令牌）
- [ ] TC7: 下载链接有效期验证（7 天）
- [ ] TC10: 导出请求列表查询
- [ ] TC11: 导出请求状态跟踪
- [ ] TC12: 空数据处理

### 安全测试
- [ ] TC8: 用户只能访问自己的导出请求
- [ ] TC9: 无效下载令牌验证
- [ ] TC16: UUID 格式验证
- [ ] TC17: limit/offset 验证

### 审计和合规测试
- [ ] TC13: 审计日志记录验证
- [ ] TC14: 30 天期限监控
- [ ] TC15: 过期文件清理

### 错误处理测试
- [ ] TC18: 前端错误处理验证
- [ ] TC19: 文件流错误处理验证

### 性能测试
- [ ] TC20: 大数据量导出性能测试

---

## 📝 测试报告模板

### 测试环境
- **测试日期:** YYYY-MM-DD
- **测试人员:** 姓名
- **测试环境:** 开发/测试/生产
- **浏览器:** Chrome/Firefox/Safari 版本
- **后端版本:** 版本号
- **前端版本:** 版本号

### 测试结果汇总

| 测试场景 | 状态 | 备注 |
|---------|------|------|
| TC1: 前端专员创建 JSON 导出请求 | ✅/❌ | |
| TC2: 前端专员创建 CSV 导出请求 | ✅/❌ | |
| TC3: 后端专员创建供应商数据导出 | ✅/❌ | |
| TC4: 总监/管理员创建所有数据导出 | ✅/❌ | |
| TC5: 导出数据完整性验证 | ✅/❌ | |
| TC6: 下载导出文件 | ✅/❌ | |
| TC7: 下载链接有效期验证 | ✅/❌ | |
| TC8: 用户权限验证 | ✅/❌ | |
| TC9: 无效令牌验证 | ✅/❌ | |
| TC10: 导出请求列表查询 | ✅/❌ | |
| TC11: 导出请求状态跟踪 | ✅/❌ | |
| TC12: 空数据处理 | ✅/❌ | |
| TC13: 审计日志记录 | ✅/❌ | |
| TC14: 30 天期限监控 | ✅/❌ | |
| TC15: 过期文件清理 | ✅/❌ | |
| TC16: UUID 格式验证 | ✅/❌ | |
| TC17: limit/offset 验证 | ✅/❌ | |
| TC18: 前端错误处理 | ✅/❌ | |
| TC19: 文件流错误处理 | ✅/❌ | |
| TC20: 大数据量导出性能 | ✅/❌ | |

### 发现的问题

| 问题编号 | 严重程度 | 描述 | 状态 |
|---------|---------|------|------|
| #1 | High/Medium/Low | 问题描述 | 待修复/已修复 |

---

## 🔧 常见问题排查

### 问题 1: 导出请求一直处于 QUEUED 状态

**可能原因:**
- Bull Queue 服务未启动
- 队列处理器未正确注册
- 数据库连接问题

**排查步骤:**
1. 检查后端日志，查看是否有队列处理错误
2. 验证 Bull Queue 配置是否正确
3. 检查 `GdprExportProcessor` 是否已注册

### 问题 2: 导出文件下载失败

**可能原因:**
- 文件路径错误
- 文件不存在
- 下载令牌无效或过期
- 用户权限问题

**排查步骤:**
1. 检查后端日志
2. 验证文件是否存在文件系统中
3. 检查下载令牌是否正确
4. 验证用户所有权

### 问题 3: 导出数据不完整

**可能原因:**
- 角色过滤逻辑错误
- 数据收集逻辑遗漏
- 数据库查询错误

**排查步骤:**
1. 检查后端日志，查看数据收集过程
2. 验证角色过滤是否正确应用
3. 检查数据库查询结果

### 问题 4: 定时任务未执行

**可能原因:**
- 定时任务调度器未启动
- Cron 表达式配置错误
- 数据库连接问题

**排查步骤:**
1. 检查后端日志，查看定时任务执行记录
2. 验证 `GdprExportScheduler` 是否已注册
3. 检查 Cron 表达式是否正确

---

## 📚 相关文档

- **Story 文档:** `_bmad-output/implementation-artifacts/stories/9-5-gdpr-data-export-request.md`
- **代码审查报告:** `_bmad-output/code-reviews/story-9-5-code-review-2026-01-13.md`
- **API 文档:** 参考后端控制器 `gdpr-export.controller.ts`
