# Story 2.2 性能测试计划

**日期：** 2025-01-03  
**Story ID：** 2-2-product-search  
**测试类型：** 性能测试

---

## 📊 性能要求

根据 Story 2.2 的 AC #8：

- **P95 响应时间：** < 1 秒
- **P99 响应时间：** < 3 秒
- **防抖延迟：** 300-500ms（实际实现：500ms）

---

## 🎯 测试目标

1. 验证搜索响应时间是否满足 P95 < 1秒的要求
2. 验证搜索响应时间是否满足 P99 < 3秒的要求
3. 验证防抖功能是否正常工作
4. 验证大量数据下的搜索性能

---

## 📋 测试场景

### 场景1: 产品名称搜索性能

**测试步骤：**
1. 准备测试数据（建议：100+ 产品）
2. 在搜索框输入产品名称（如"不锈钢"）
3. 记录搜索响应时间
4. 重复测试 100 次
5. 计算 P95 和 P99 响应时间

**预期结果：**
- P95 < 1秒
- P99 < 3秒

**测试工具：**
- 浏览器 DevTools Network 面板
- 或使用性能监控工具

---

### 场景2: HS编码搜索性能

**测试步骤：**
1. 在搜索框输入HS编码（如"7323"）
2. 记录搜索响应时间
3. 重复测试 100 次
4. 计算 P95 和 P99 响应时间

**预期结果：**
- P95 < 1秒
- P99 < 3秒

---

### 场景3: 类别搜索性能

**测试步骤：**
1. 选择产品类别进行搜索
2. 记录搜索响应时间
3. 重复测试 100 次
4. 计算 P95 和 P99 响应时间

**预期结果：**
- P95 < 1秒
- P99 < 3秒

---

### 场景4: 多条件组合搜索性能

**测试步骤：**
1. 同时输入搜索关键词和选择类别
2. 记录搜索响应时间
3. 重复测试 100 次
4. 计算 P95 和 P99 响应时间

**预期结果：**
- P95 < 1秒
- P99 < 3秒

---

### 场景5: 防抖功能验证

**测试步骤：**
1. 快速连续输入多个字符（如"不锈钢管"）
2. 观察网络请求数量
3. 验证防抖是否正常工作（应该只有最后一次输入触发请求）

**预期结果：**
- 防抖延迟 500ms
- 快速输入时只发送一次请求

---

### 场景6: 大量数据搜索性能

**测试步骤：**
1. 准备大量测试数据（1000+ 产品）
2. 执行搜索操作
3. 记录响应时间
4. 验证分页功能是否正常工作

**预期结果：**
- 即使数据量大，搜索响应时间仍满足要求
- 分页功能正常工作

---

## 🔧 测试工具和方法

### 方法1: 浏览器 DevTools

1. 打开浏览器 DevTools
2. 切换到 Network 面板
3. 执行搜索操作
4. 查看请求的响应时间（Time）
5. 记录多次测试的结果

### 方法2: 性能监控代码

可以在前端添加性能监控代码：

```typescript
const startTime = performance.now();
const response = await productsService.getProducts(queryParams);
const endTime = performance.now();
const duration = endTime - startTime;
console.log(`Search took ${duration}ms`);
```

### 方法3: 后端日志

在后端添加性能日志：

```typescript
const startTime = Date.now();
// ... search logic ...
const duration = Date.now() - startTime;
this.logger.log(`Search completed in ${duration}ms`);
```

---

## 📊 性能优化建议

### 已实现的优化

1. **数据库索引**
   - `idx_products_name_search`: GIN 索引用于全文搜索
   - `idx_products_category`: B-tree 索引用于类别筛选
   - `idx_products_workspace_status`: 复合索引

2. **前端防抖**
   - 500ms 防抖延迟，减少API调用

3. **分页**
   - 每页 20 条，限制结果数量

### 可选的进一步优化

1. **搜索结果缓存**（可选）
   - 使用 Redis 缓存热门搜索结果
   - 缓存时间：5-10 分钟

2. **数据库查询优化**
   - 使用 `EXPLAIN ANALYZE` 分析查询计划
   - 确保使用索引，避免全表扫描

3. **前端优化**
   - 实现请求取消（AbortController）
   - 优化搜索结果渲染（虚拟滚动，如果结果很多）

---

## 📝 测试检查清单

- [ ] 准备测试数据（100+ 产品）
- [ ] 执行场景1测试（产品名称搜索）
- [ ] 执行场景2测试（HS编码搜索）
- [ ] 执行场景3测试（类别搜索）
- [ ] 执行场景4测试（多条件搜索）
- [ ] 执行场景5测试（防抖功能）
- [ ] 执行场景6测试（大量数据）
- [ ] 记录所有测试结果
- [ ] 计算 P95 和 P99 响应时间
- [ ] 生成性能测试报告

---

## ⚠️ 注意事项

1. **测试环境**
   - 建议在接近生产环境的环境中进行测试
   - 考虑网络延迟的影响

2. **测试数据**
   - 使用真实或接近真实的数据进行测试
   - 确保数据量足够大（100+ 产品）

3. **多次测试**
   - 每个场景至少测试 100 次
   - 排除异常值（网络问题等）

4. **数据库状态**
   - 确保数据库索引已创建
   - 确保数据库统计信息是最新的（运行 `ANALYZE`）

---

**测试计划创建时间：** 2025-01-03  
**建议测试时间：** 开发完成后，部署前

