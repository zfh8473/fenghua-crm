# Story 16.3 端到端测试手动指南

**Story:** 16.3 - 替换用户和角色管理  
**测试日期：** 2025-12-26

---

## 🚀 快速开始

### 1. 确认服务运行状态

**后端服务：**
```bash
curl http://localhost:3001/health
```

**前端服务：**
- 访问：`http://localhost:3005`
- 或检查：`curl http://localhost:3005`

---

## 📋 测试步骤

### 步骤 1: 登录系统

1. **打开浏览器：**
   - 访问：`http://localhost:3005/login`

2. **登录：**
   - 邮箱：`zfh8473@gmail.com`（或你的管理员账户）
   - 密码：你的密码
   - 点击"登录"

3. **验证登录：**
   - ✅ 检查浏览器控制台（F12 > Console）是否有错误
   - ✅ 检查 Network 标签页，查看登录 API 请求
   - ✅ 检查 Application > Local Storage，确认 `fenghua_auth_token` 已存储

**预期结果：**
- 登录成功
- 跳转到主页面或用户管理页面
- Token 存储在 localStorage

---

### 步骤 2: 查看用户列表

1. **导航到用户管理页面：**
   - 点击导航菜单中的"用户管理"
   - 或直接访问：`http://localhost:3005/users`

2. **查看用户列表：**
   - 检查是否显示所有用户
   - 检查每个用户的信息：
     - 邮箱
     - 姓名（first_name + last_name）
     - 角色（应该显示角色名称，如"管理员"、"前端专员"等）
     - 创建时间

3. **验证 null 角色处理：**
   - 如果有用户没有角色，应该显示"无角色"或类似提示

**预期结果：**
- ✅ 用户列表正确显示
- ✅ 所有用户信息完整
- ✅ 角色信息正确显示

---

### 步骤 3: 测试角色筛选

1. **在用户管理页面：**
   - 查找角色筛选器（可能在页面顶部或侧边栏）
   - 如果 UI 中有筛选器，选择特定角色（如 ADMIN）

2. **验证筛选结果：**
   - 检查是否只显示具有选定角色的用户
   - 尝试选择不同的角色

**注意：** 如果前端 UI 中还没有实现角色筛选器，可以通过 API 直接测试：

```bash
# 获取 token（从浏览器 localStorage 复制）
TOKEN="your-token-here"

# 测试按角色筛选
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:3001/users?role=ADMIN"
```

**预期结果：**
- ✅ 筛选功能正常工作
- ✅ 只显示匹配的用户

---

### 步骤 4: 测试搜索功能

1. **在用户管理页面：**
   - 查找搜索框
   - 输入搜索关键词（邮箱或姓名的一部分）

2. **验证搜索结果：**
   - 检查是否显示匹配的用户
   - 尝试不同的搜索关键词

**注意：** 如果前端 UI 中还没有实现搜索功能，可以通过 API 直接测试：

```bash
# 测试搜索
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:3001/users?search=test"
```

**预期结果：**
- ✅ 搜索功能正常工作
- ✅ 显示匹配的用户

---

### 步骤 5: 创建新用户

1. **在用户管理页面：**
   - 点击"创建新用户"或"添加用户"按钮

2. **填写表单：**
   - 邮箱：`test-user-$(date +%s)@example.com`（使用时间戳确保唯一）
   - 密码：`test123456`
   - 姓名：`测试` `用户`
   - 角色：选择 `FRONTEND_SPECIALIST`（前端专员）

3. **提交表单：**
   - 点击"提交"或"创建"

4. **验证创建结果：**
   - ✅ 显示成功消息
   - ✅ 用户出现在用户列表中
   - ✅ 用户信息正确
   - ✅ 角色正确显示

**预期结果：**
- ✅ 用户创建成功
- ✅ 用户信息正确
- ✅ 角色正确分配

---

### 步骤 6: 测试重复邮箱验证

1. **尝试创建用户：**
   - 使用已存在的邮箱（如刚才创建的用户邮箱）
   - 填写其他信息
   - 提交表单

2. **验证错误处理：**
   - ✅ 显示错误消息："User with email ... already exists"
   - ✅ 用户未创建
   - ✅ 表单保持填写状态（允许修正）

**预期结果：**
- ✅ 错误消息正确
- ✅ 用户未创建

---

### 步骤 7: 更新用户信息

1. **选择用户：**
   - 在用户列表中找到刚才创建的用户
   - 点击"编辑"按钮

2. **修改信息：**
   - 修改姓名：`更新` `用户`
   - 修改角色：改为 `ADMIN`（管理员）

3. **提交更改：**
   - 点击"保存"或"更新"

4. **验证更新结果：**
   - ✅ 显示成功消息
   - ✅ 用户列表中的信息已更新
   - ✅ 角色已更新

**预期结果：**
- ✅ 用户信息更新成功
- ✅ 角色更新成功

---

### 步骤 8: 软删除用户

1. **选择用户：**
   - 选择一个用户（不是当前登录的用户）
   - 点击"删除"按钮

2. **确认删除：**
   - 确认删除操作

3. **验证删除结果：**
   - ✅ 用户从列表中消失
   - ✅ 显示成功消息

4. **验证软删除（数据库检查）：**
   ```sql
   -- 在数据库中检查
   SELECT id, email, deleted_at 
   FROM users 
   WHERE email = 'test-user-xxx@example.com';
   -- deleted_at 应该不为 NULL
   ```

**预期结果：**
- ✅ 用户被软删除
- ✅ 用户从列表中消失
- ✅ 数据库中 `deleted_at` 字段已设置

---

### 步骤 9: 测试自我删除保护

1. **尝试删除自己：**
   - 尝试删除当前登录的用户
   - 点击"删除"按钮

2. **验证保护机制：**
   - ✅ 显示错误消息："不能删除自己的账户"
   - ✅ 用户未被删除
   - ✅ 删除按钮被禁用（或显示错误）

**预期结果：**
- ✅ 错误消息正确
- ✅ 用户未被删除

---

### 步骤 10: 测试角色管理 API

1. **获取所有角色：**
   ```bash
   curl -H "Authorization: Bearer $TOKEN" \
     "http://localhost:3001/roles"
   ```

2. **验证响应：**
   - ✅ 返回所有角色列表
   - ✅ 包含：ADMIN, DIRECTOR, FRONTEND_SPECIALIST, BACKEND_SPECIALIST
   - ✅ 每个角色包含 id, name, description

**预期结果：**
- ✅ 角色列表正确
- ✅ 角色信息完整

---

### 步骤 11: 测试角色分配

1. **通过编辑用户分配角色：**
   - 编辑一个用户
   - 分配角色（如 ADMIN）
   - 保存

2. **验证角色分配：**
   - ✅ 角色分配成功
   - ✅ 用户列表中的角色已更新

**预期结果：**
- ✅ 角色分配成功
- ✅ 角色信息正确显示

---

## 🔍 调试技巧

### 浏览器开发者工具

1. **Network 标签页：**
   - 查看所有 API 请求
   - 检查请求和响应
   - 查看错误状态码

2. **Console 标签页：**
   - 查看 JavaScript 错误
   - 查看日志输出

3. **Application > Local Storage：**
   - 检查 `fenghua_auth_token` 是否存在
   - 检查 token 值

### API 测试

使用 curl 或 Postman 直接测试 API：

```bash
# 设置 token
TOKEN="your-token-here"

# 获取用户列表
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:3001/users"

# 创建用户
curl -X POST \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "newuser@example.com",
    "password": "password123",
    "firstName": "New",
    "lastName": "User",
    "role": "FRONTEND_SPECIALIST"
  }' \
  "http://localhost:3001/users"
```

---

## 📝 测试记录模板

### 测试用例记录

**测试用例：** [用例名称]  
**执行时间：** [时间]  
**执行人：** [姓名]  
**结果：** ✅ 通过 / ❌ 失败 / ⚠️ 部分通过

**步骤：**
1. [步骤 1]
2. [步骤 2]
3. [步骤 3]

**预期结果：**
- [预期 1]
- [预期 2]

**实际结果：**
- [实际 1]
- [实际 2]

**问题记录：**
- [问题描述]

**截图/日志：**
- [截图路径或日志内容]

---

## ✅ 测试检查清单

- [ ] 服务运行正常（后端 + 前端）
- [ ] 可以成功登录
- [ ] 可以查看用户列表
- [ ] 可以按角色筛选用户（如果 UI 支持）
- [ ] 可以搜索用户（如果 UI 支持）
- [ ] 可以创建新用户
- [ ] 重复邮箱验证正常工作
- [ ] 可以更新用户信息
- [ ] 可以更新用户角色
- [ ] 可以软删除用户
- [ ] 自我删除保护正常工作
- [ ] 角色管理 API 正常工作
- [ ] 角色分配功能正常工作

---

**创建时间：** 2025-12-26

