# Story 8.3: 客户分析 - 手动测试指南

**Story:** 8-3-customer-analysis  
**测试日期:** 2026-01-12  
**测试人员:** QA Team

---

## 测试环境准备

### 前置条件

1. **用户角色要求:**
   - 至少需要一个 `ADMIN` 或 `DIRECTOR` 角色的用户账号
   - 至少需要一个非 `ADMIN`/`DIRECTOR` 角色的用户账号（用于权限测试）

2. **测试数据要求:**
   - 系统中应存在客户数据（`companies` 表）
   - 系统中应存在产品-客户互动记录（`product_customer_interactions` 表）
   - 至少有一些互动记录的 `interaction_type` 为 `order_signed` 或 `order_completed`
   - 至少有一些互动记录的 `additional_info` JSONB 字段包含 `orderAmount` 或 `amount` 字段

3. **系统要求:**
   - 后端服务运行在 `http://localhost:3001`（或配置的端口）
   - 前端应用运行在 `http://localhost:5173`（或配置的端口）
   - 数据库连接正常
   - Redis 连接正常（可选，用于缓存测试）

---

## 测试用例

### TC1: 访问权限验证

**目标:** 验证只有 `ADMIN` 和 `DIRECTOR` 角色可以访问客户分析页面

**步骤:**
1. 使用非 `ADMIN`/`DIRECTOR` 角色的用户登录系统
2. 尝试直接访问 `/dashboard/customer-analysis` URL
3. 观察页面显示

**预期结果:**
- 页面显示"只有总监和管理员可以访问此页面"的错误提示
- 非授权用户无法查看客户分析数据

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC2: 客户分析数据基础显示

**目标:** 验证客户分析数据能够正确显示

**步骤:**
1. 使用 `ADMIN` 或 `DIRECTOR` 角色用户登录系统
2. 导航到"客户分析"页面（通过侧边栏菜单或直接访问 `/dashboard/customer-analysis`）
3. 等待页面加载完成
4. 观察页面显示的内容

**预期结果:**
- 页面标题显示为"客户分析"
- 显示筛选条件区域（客户类型、开始日期、结束日期）
- 显示客户流失率趋势图
- 显示客户分析表格，包含以下列：
  - 客户名称
  - 客户类型（采购商/供应商）
  - 订单量
  - 订单金额
  - 订单频率
  - 最后互动日期
  - 距离最后互动天数
  - 流失风险（高风险/中风险/低风险/无风险）
  - 生命周期价值
- 表格数据按订单金额降序排列（高价值客户在前）

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC3: 客户类型筛选

**目标:** 验证按客户类型筛选功能

**步骤:**
1. 在客户分析页面，选择"客户类型"下拉框
2. 选择"采购商"
3. 观察表格数据变化
4. 选择"供应商"
5. 观察表格数据变化
6. 选择"全部类型"
7. 观察表格数据恢复

**预期结果:**
- 选择"采购商"后，表格只显示 `customer_type = 'BUYER'` 的客户
- 选择"供应商"后，表格只显示 `customer_type = 'SUPPLIER'` 的客户
- 选择"全部类型"后，表格显示所有客户
- 筛选后，页码重置为第 1 页

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC4: 时间范围筛选

**目标:** 验证按时间范围筛选功能

**步骤:**
1. 在客户分析页面，设置"开始日期"为 3 个月前
2. 设置"结束日期"为今天
3. 观察表格数据变化
4. 观察流失率趋势图变化
5. 清除日期筛选
6. 观察数据恢复

**预期结果:**
- 表格只显示在指定时间范围内有互动记录的客户
- 流失率趋势图只显示指定时间范围内的数据
- 订单频率计算基于指定的时间范围
- 清除筛选后，数据恢复为默认（最近 12 个月）

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC5: 订单金额显示和排序

**目标:** 验证订单金额正确显示和颜色编码

**步骤:**
1. 查看客户分析表格中的"订单金额"列
2. 观察高价值客户（订单金额 > 10000）的显示颜色
3. 观察中等价值客户（订单金额 1000-10000）的显示颜色
4. 观察低价值客户（订单金额 < 1000）的显示颜色
5. 验证表格默认按订单金额降序排列

**预期结果:**
- 订单金额格式为：`¥123,456.78`（人民币符号，千分位分隔符，两位小数）
- 高价值客户（> 10000）显示为绿色加粗
- 中等价值客户（1000-10000）显示为蓝色
- 低价值客户（< 1000）显示为默认颜色
- 表格默认按订单金额降序排列

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC6: 流失风险等级显示

**目标:** 验证流失风险等级正确计算和显示

**步骤:**
1. 查看客户分析表格中的"流失风险"列
2. 识别高风险客户（距离最后互动 > 90 天）
3. 识别中风险客户（距离最后互动 60-90 天）
4. 识别低风险客户（距离最后互动 30-60 天）
5. 识别无风险客户（距离最后互动 ≤ 30 天）
6. 验证颜色编码

**预期结果:**
- 高风险客户显示为红色加粗，标签为"高风险"
- 中风险客户显示为橙色加粗，标签为"中风险"
- 低风险客户显示为黄色加粗，标签为"低风险"
- 无风险客户显示为绿色加粗，标签为"无风险"
- 从未有互动记录的客户应被计算为高风险

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC7: 客户流失率趋势图

**目标:** 验证客户流失率趋势图正确显示

**步骤:**
1. 查看客户流失率趋势图
2. 观察图表数据点
3. 悬停在图表数据点上，查看详细信息
4. 更改时间范围筛选，观察图表变化
5. 验证时间分组逻辑（≤ 3 个月使用周，> 3 个月使用月）

**预期结果:**
- 图表显示折线图，X 轴为时间周期（如 "2026-01" 或 "2026-W01"），Y 轴为流失率（0-100%）
- 悬停显示详细信息（周期、总客户数、流失客户数、流失率）
- 时间范围 ≤ 3 个月时，使用周分组（格式：YYYY-WXX）
- 时间范围 > 3 个月时，使用月分组（格式：YYYY-MM）
- 未指定时间范围时，默认显示最近 12 个月，按月分组
- 图表响应式设计，在不同屏幕尺寸下正常显示

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC8: 分页功能

**目标:** 验证分页功能正常工作

**步骤:**
1. 确保客户数据量 > 20 条（或当前设置的每页数量）
2. 观察表格底部的分页控件
3. 点击"下一页"按钮
4. 观察表格数据变化
5. 点击"上一页"按钮
6. 观察表格数据恢复
7. 验证页码显示正确

**预期结果:**
- 当数据量 > 每页数量时，显示分页控件
- 分页控件显示"第 X 页，共 Y 页"
- 点击"下一页"后，表格显示下一页数据
- 点击"上一页"后，表格显示上一页数据
- 在第一页时，"上一页"按钮禁用
- 在最后一页时，"下一页"按钮禁用
- 更改筛选条件后，页码重置为第 1 页

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC9: 表格排序功能

**目标:** 验证表格列排序功能

**步骤:**
1. 点击"客户名称"列标题，进行排序
2. 观察表格数据变化
3. 再次点击，切换排序方向
4. 点击"订单量"列标题，进行排序
5. 观察表格数据变化
6. 测试其他可排序列

**预期结果:**
- 可排序列（客户名称、客户类型、订单量、订单金额、订单频率、最后互动日期、距离最后互动天数、流失风险、生命周期价值）支持排序
- 点击列标题后，表格按该列排序
- 再次点击后，切换排序方向（升序/降序）
- 排序后，数据正确显示

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC10: 点击客户跳转

**目标:** 验证点击表格行可以跳转到客户详情页

**步骤:**
1. 在客户分析表格中，点击任意一行
2. 观察页面跳转

**预期结果:**
- 点击表格行后，页面跳转到 `/customers/{customerId}` 客户详情页
- 客户详情页正确显示该客户的信息

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC11: CSV 导出功能

**目标:** 验证 CSV 导出功能

**步骤:**
1. 在客户分析页面，应用筛选条件（例如：选择"采购商"，设置时间范围）
2. 点击"导出 CSV"按钮
3. 等待导出完成
4. 检查下载的 CSV 文件
5. 打开 CSV 文件，验证数据内容

**预期结果:**
- 点击"导出 CSV"后，按钮显示"导出中..."状态
- 导出完成后，浏览器自动下载 CSV 文件
- 文件名格式：`客户分析_YYYY-MM-DD.csv`
- CSV 文件包含以下列：
  - 客户ID
  - 客户名称
  - 客户类型
  - 订单量
  - 订单金额
  - 订单频率
  - 最后互动日期
  - 距离最后互动天数
  - 流失风险
  - 生命周期价值
- CSV 文件包含当前筛选条件下的所有数据（不分页）
- 数据格式正确（数字、日期、文本）

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC12: 导出数据量限制

**目标:** 验证导出数据量限制功能

**步骤:**
1. 在客户分析页面，清除所有筛选条件（或设置一个会返回大量数据的筛选条件）
2. 如果数据量 > 50000 条，点击"导出 CSV"按钮
3. 观察错误提示

**预期结果:**
- 如果数据量 > 50000 条，显示错误提示："导出数据量过大（X 条），请使用筛选条件缩小范围，或联系管理员使用异步导出功能"
- 导出按钮恢复正常状态
- 错误提示在页面上显示（红色背景）

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC13: 加载状态和错误处理

**目标:** 验证加载状态和错误处理

**步骤:**
1. 打开浏览器开发者工具，切换到"Network"标签
2. 访问客户分析页面
3. 观察页面加载状态
4. 模拟网络错误（例如：断开网络连接，或使用浏览器扩展拦截请求）
5. 观察错误提示
6. 点击"重试"按钮
7. 恢复网络连接，观察数据加载

**预期结果:**
- 页面加载时，显示骨架屏（Skeleton Loading）
- 数据加载失败时，显示错误提示和"重试"按钮
- 点击"重试"后，重新尝试加载数据
- 网络恢复后，数据能够正常加载

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC14: 订单频率计算

**目标:** 验证订单频率计算准确性

**步骤:**
1. 选择一个有多个订单的客户
2. 记录该客户的订单量和时间范围
3. 手动计算订单频率：订单数 / 时间范围天数
4. 与页面显示的订单频率对比

**预期结果:**
- 订单频率 = 订单数 / 时间范围天数
- 如果未指定时间范围，使用默认时间范围（最近 12 个月）
- 订单频率格式：`X.XX 单/天`（保留两位小数）

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC15: 生命周期价值计算

**目标:** 验证客户生命周期价值计算

**步骤:**
1. 查看客户分析表格中的"生命周期价值"列
2. 选择一个有订单金额数据的客户
3. 验证生命周期价值 = 该客户所有订单金额的总和

**预期结果:**
- 生命周期价值 = 所有订单金额的总和（从 `additional_info` JSONB 字段中提取 `orderAmount` 或 `amount`）
- 如果客户没有订单金额数据，显示 "N/A"
- 生命周期价值格式：`¥123,456.78`（人民币符号，千分位分隔符，两位小数）

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC16: 响应式设计

**目标:** 验证页面在不同屏幕尺寸下的显示

**步骤:**
1. 使用不同屏幕尺寸的设备或浏览器窗口测试：
   - 桌面（1920x1080）
   - 平板（768x1024）
   - 手机（375x667）
2. 观察页面布局和组件显示

**预期结果:**
- 页面在不同屏幕尺寸下正常显示
- 表格支持横向滚动（如果列数过多）
- 图表响应式调整大小
- 筛选条件区域自适应布局（移动端单列，桌面端多列）

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC17: 性能测试（大数据量）

**目标:** 验证页面在大数据量下的性能

**步骤:**
1. 确保系统中有大量客户数据（> 1000 条）
2. 访问客户分析页面
3. 观察页面加载时间
4. 测试分页切换速度
5. 测试筛选和排序响应速度

**预期结果:**
- 页面初始加载时间 < 3 秒
- 分页切换响应时间 < 1 秒
- 筛选和排序响应时间 < 2 秒
- 使用分页显示数据，避免一次性加载所有数据

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC18: 缓存功能（如果配置了 Redis）

**目标:** 验证 Redis 缓存功能（如果配置了 REDIS_URL）

**步骤:**
1. 确保后端配置了 `REDIS_URL`
2. 访问客户分析页面，应用筛选条件
3. 等待数据加载完成
4. 立即刷新页面（或清除浏览器缓存，但不清除 Redis 缓存）
5. 观察数据加载速度
6. 等待 5 分钟后，再次刷新页面
7. 观察数据是否从缓存加载

**预期结果:**
- 如果配置了 Redis，数据会被缓存 5 分钟
- 在缓存有效期内，数据加载速度更快
- 缓存过期后，数据重新从数据库加载

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

## 测试总结

### 测试结果统计

- **总测试用例数:** 18
- **通过:** [ ] 个
- **失败:** [ ] 个
- **阻塞:** [ ] 个

### 发现的问题

1. **问题描述:** 
   - **严重程度:** [ ] 严重 / [ ] 中等 / [ ] 轻微
   - **复现步骤:** 
   - **预期行为:** 
   - **实际行为:** 

2. **问题描述:** 
   - **严重程度:** [ ] 严重 / [ ] 中等 / [ ] 轻微
   - **复现步骤:** 
   - **预期行为:** 
   - **实际行为:** 

### 测试结论

- [ ] **通过** - 所有测试用例通过，功能正常
- [ ] **有条件通过** - 大部分测试用例通过，存在轻微问题
- [ ] **不通过** - 存在严重问题，需要修复

### 测试人员签名

**测试人员:** _________________  
**日期:** _________________

---

## 附录

### 测试环境信息

- **后端版本:** 
- **前端版本:** 
- **数据库版本:** 
- **Redis 版本:** （如果使用）
- **浏览器:** 
- **操作系统:** 

### 测试数据说明

- **客户总数:** 
- **采购商数量:** 
- **供应商数量:** 
- **互动记录总数:** 
- **订单记录总数:** 

