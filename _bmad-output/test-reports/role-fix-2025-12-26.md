# 角色显示修复

**日期：** 2025-12-26  
**问题：** 登录后仍然显示角色为 "user"  
**原因：** `validateToken` 方法中的 GraphQL 查询格式不正确

---

## 🔍 问题分析

### 问题原因

1. **GraphQL 查询格式错误：**
   - 原查询使用 `roles { role }`，但 Twenty CRM 返回的是 `roles { id, name }`
   - 导致无法正确获取角色名称

2. **角色映射问题：**
   - 即使获取到角色，也需要将 Twenty CRM 的角色名称（如 "Admin"）映射到我们的 UserRole enum（"ADMIN"）

3. **Token 缓存：**
   - 用户需要重新登录以获取新的 token，因为 JWT token 在登录时生成并包含角色信息

---

## ✅ 修复方案

### 1. 修复 GraphQL 查询

**文件：** `fenghua-backend/src/auth/auth.service.ts`

**修改前：**
```typescript
workspaceMember {
  roles {
    role
  }
}
```

**修改后：**
```typescript
workspaceMember {
  roles {
    id
    name
  }
}
```

### 2. 修复角色映射逻辑

**修改前：**
```typescript
const roles = result.currentUser.workspaceMember?.roles || [];
const role = roles.length > 0 ? roles[0].role : 'user';
```

**修改后：**
```typescript
const roles = result.currentUser.workspaceMember?.roles || [];
// Map role name to our UserRole enum
let role = 'user';
if (roles.length > 0) {
  const roleName = roles[0].name?.toUpperCase() || '';
  if (roleName.includes('ADMIN')) {
    role = 'ADMIN';
  } else if (roleName.includes('DIRECTOR')) {
    role = 'DIRECTOR';
  } else if (roleName.includes('FRONTEND') || roleName.includes('BUYER')) {
    role = 'FRONTEND_SPECIALIST';
  } else if (roleName.includes('BACKEND') || roleName.includes('SUPPLIER')) {
    role = 'BACKEND_SPECIALIST';
  } else {
    role = roleName || 'user';
  }
}
```

---

## 🚀 解决步骤

### 步骤 1: 重新构建后端

```bash
cd fenghua-backend
npm run build
```

### 步骤 2: 重启后端服务

```bash
npm run start:dev
```

### 步骤 3: 清除浏览器缓存并重新登录

1. **清除 localStorage：**
   - 打开浏览器开发者工具
   - 转到 Application > Local Storage > `http://localhost:3005`
   - 删除 `fenghua_auth_token` 和 `fenghua_user`

2. **重新登录：**
   - 访问 `http://localhost:3005/login`
   - 使用 `zfh8473@gmail.com` 登录
   - 现在应该显示角色为 "ADMIN"

---

## ✅ 验证

登录后应该看到：
- ✅ 角色显示为 "ADMIN"（而不是 "user"）
- ✅ 显示管理员功能链接（用户管理、系统设置等）
- ✅ 可以访问管理员功能页面

---

## 📝 技术说明

### Twenty CRM 角色结构

Twenty CRM 使用以下结构：
- `workspaceMember.roles` 是一个数组
- 每个角色对象包含 `id` 和 `name` 字段
- 角色名称如 "Admin"、"Member" 等

### 角色映射规则

- **"Admin"** → `ADMIN`
- **"Director"** → `DIRECTOR`
- **"Frontend"** 或 **"Buyer"** → `FRONTEND_SPECIALIST`
- **"Backend"** 或 **"Supplier"** → `BACKEND_SPECIALIST`
- 其他 → 保持原值或 `user`

---

**注意：** 
- 数据库中的角色已正确设置为 "Admin"
- 修复后需要重新登录以获取新的 token
- 如果仍然显示 "user"，请清除浏览器缓存并重新登录

