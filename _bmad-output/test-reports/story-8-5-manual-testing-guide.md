# Story 8.5: 采购商分析 - 手动测试指南

**Story:** 8-5-buyer-analysis  
**测试日期:** 2026-01-12  
**测试人员:** QA Team

---

## 测试环境准备

### 前置条件

1. **用户角色要求:**
   - 至少需要一个 `ADMIN` 或 `DIRECTOR` 角色的用户账号
   - 至少需要一个非 `ADMIN`/`DIRECTOR` 角色的用户账号（用于权限测试）

2. **测试数据要求:**
   - 系统中应存在采购商数据（`companies` 表，`customer_type = 'BUYER'`）
   - 系统中应存在产品-客户互动记录（`product_customer_interactions` 表）
   - 至少有一些互动记录的 `interaction_type` 为 `order_signed` 或 `order_completed`
   - 至少有一些互动记录的 `additional_info` JSONB 字段包含 `orderAmount` 或 `amount` 字段
   - 至少有一些产品数据（`products` 表），包含 `category` 字段
   - 至少有一些采购商有最近 30 天内的互动记录（用于活跃度测试）
   - 至少有一些采购商超过 90 天无互动记录（用于流失风险测试）

3. **系统要求:**
   - 后端服务运行在 `http://localhost:3001`（或配置的端口）
   - 前端应用运行在 `http://localhost:5173`（或配置的端口）
   - 数据库连接正常
   - Redis 连接正常（可选，用于缓存测试）

4. **数据库迁移:**
   - 确保已运行迁移文件 `026-add-buyer-analysis-indexes.sql`

---

## 测试用例

### TC1: 访问权限验证

**目标:** 验证只有 `ADMIN` 和 `DIRECTOR` 角色可以访问采购商分析页面

**步骤:**
1. 使用非 `ADMIN`/`DIRECTOR` 角色的用户登录系统
2. 尝试直接访问 `/dashboard/buyer-analysis` URL
3. 观察页面显示

**预期结果:**
- 页面显示"只有总监和管理员可以访问此页面"的错误提示
- 非授权用户无法查看采购商分析数据

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC2: 采购商分析数据基础显示

**目标:** 验证采购商分析数据能够正确显示

**步骤:**
1. 使用 `ADMIN` 或 `DIRECTOR` 角色用户登录系统
2. 导航到"采购商分析"页面（通过侧边栏菜单或直接访问 `/dashboard/buyer-analysis`）
3. 等待页面加载完成
4. 观察页面显示的内容

**预期结果:**
- 页面标题显示为"采购商分析"
- 显示筛选条件区域（产品类别、开始日期、结束日期）
- 显示采购商活跃度趋势图
- 显示采购商流失率趋势图
- 显示采购商分析表格，包含以下列：
  - 采购商名称（可点击跳转到客户详情页）
  - 订单量
  - 订单金额（高价值采购商用绿色高亮显示）
  - 订单频率（单/天）
  - 最后互动日期
  - 距离最后互动天数
  - 活跃度（百分比和评级，使用颜色编码）
  - 流失风险（无风险/低风险/中风险/高风险，使用颜色编码）
  - 生命周期价值
- 表格数据按订单金额降序排列（高价值采购商在前）

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC3: 产品类别筛选

**目标:** 验证按产品类别筛选功能

**步骤:**
1. 在采购商分析页面，在"产品类别"输入框中输入一个存在的产品类别名称
2. 观察表格数据变化
3. 清除产品类别筛选
4. 观察表格数据恢复

**预期结果:**
- 输入产品类别后，表格只显示与该类别产品相关的采购商
- 清除筛选后，表格显示所有采购商

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC4: 时间范围筛选

**目标:** 验证按时间范围筛选功能

**步骤:**
1. 在采购商分析页面，选择"开始日期"和"结束日期"
2. 选择一个时间范围（如最近3个月）
3. 观察表格数据变化
4. 清除日期筛选
5. 观察表格数据恢复

**预期结果:**
- 选择时间范围后，表格只显示在该时间范围内有互动的采购商
- 订单频率计算基于选择的时间范围
- 清除筛选后，表格显示所有采购商

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC5: 活跃度计算和评级

**目标:** 验证采购商活跃度计算和评级正确

**步骤:**
1. 查看采购商分析表格中的"活跃度"列
2. 验证以下情况：
   - 活跃度 = (最近 30 天互动记录数 / 总互动记录数) × 100%
   - 活跃度 >= 30% → 显示"高"（绿色）
   - 活跃度 10-30% → 显示"中"（蓝色）
   - 活跃度 < 10% → 显示"低"（黄色）
   - 如果总互动记录数为 0，活跃度显示为 0%

**预期结果:**
- 活跃度计算正确
- 活跃度评级正确
- 颜色编码正确显示

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC6: 流失风险计算和评级

**目标:** 验证采购商流失风险计算和评级正确

**步骤:**
1. 查看采购商分析表格中的"流失风险"列
2. 验证以下情况：
   - 最近 30 天内有互动 → 显示"无风险"（绿色）
   - 30-60 天无互动 → 显示"低风险"（黄色）
   - 60-90 天无互动 → 显示"中风险"（橙色）
   - 超过 90 天无互动 → 显示"高风险"（红色）

**预期结果:**
- 流失风险计算正确（基于最后互动日期）
- 流失风险评级正确
- 颜色编码正确显示

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC7: 订单频率计算

**目标:** 验证订单频率计算正确

**步骤:**
1. 查看采购商分析表格中的"订单频率"列
2. 验证以下情况：
   - 如果采购商有多个订单（> 1），订单频率 = 订单数 / (最后订单日期 - 第一订单日期 + 1) 天
   - 如果采购商只有 1 个订单或未指定时间范围，订单频率 = 订单数 / 时间范围天数

**预期结果:**
- 订单频率计算正确
- 显示格式为"X.XXXX 单/天"

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC8: 采购商活跃度趋势图

**目标:** 验证采购商活跃度趋势图正确显示

**步骤:**
1. 在采购商分析页面，查看"采购商活跃度趋势"图表
2. 观察图表显示
3. 修改时间范围筛选
4. 观察图表数据更新

**预期结果:**
- 图表正确显示采购商活跃度趋势
- 图表按时间（周或月）分组显示
- 如果时间范围 <= 90 天，使用周分组；否则使用月分组
- 图表数据随筛选条件更新
- 图表显示平均活跃度百分比

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC9: 采购商流失率趋势图

**目标:** 验证采购商流失率趋势图正确显示

**步骤:**
1. 在采购商分析页面，查看"采购商流失率趋势"图表
2. 观察图表显示
3. 修改时间范围筛选
4. 观察图表数据更新

**预期结果:**
- 图表正确显示采购商流失率趋势
- 图表按时间（周或月）分组显示
- 如果时间范围 <= 90 天，使用周分组；否则使用月分组
- 图表数据随筛选条件更新
- 流失率计算正确：流失采购商数 / 总采购商数 × 100%

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC10: 分页功能

**目标:** 验证分页功能正常工作

**步骤:**
1. 在采购商分析页面，如果数据超过20条，观察分页控件
2. 点击"下一页"按钮
3. 观察表格数据变化
4. 点击"上一页"按钮
5. 观察表格数据恢复

**预期结果:**
- 如果数据超过20条，显示分页控件
- 分页控件显示当前页码和总页数
- 点击"下一页"后，显示下一页数据
- 点击"上一页"后，显示上一页数据
- 在第一页时，"上一页"按钮禁用
- 在最后一页时，"下一页"按钮禁用

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC11: 采购商名称跳转

**目标:** 验证点击采购商名称可以跳转到客户详情页

**步骤:**
1. 在采购商分析表格中，点击一个采购商名称
2. 观察页面跳转

**预期结果:**
- 点击采购商名称后，页面跳转到 `/customers?customerId={buyerId}` 详情页
- 客户详情页正确显示该采购商的信息

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC12: 导出功能

**目标:** 验证导出功能正常工作

**步骤:**
1. 在采购商分析页面，点击"导出 CSV"按钮
2. 等待导出完成
3. 检查下载的CSV文件

**预期结果:**
- 点击"导出 CSV"后，按钮显示"导出中..."状态
- 导出完成后，自动下载CSV文件
- CSV文件名格式为：`采购商分析_YYYY-MM-DD.csv`
- CSV文件包含所有筛选后的采购商分析数据
- CSV文件包含以下列：
  - 采购商ID
  - 采购商名称
  - 订单量
  - 订单金额
  - 订单频率
  - 最后互动日期
  - 距离最后互动天数
  - 活跃度
  - 活跃度评级
  - 流失风险
  - 生命周期价值

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC13: 导出数据量限制

**目标:** 验证导出数据量限制功能

**步骤:**
1. 在采购商分析页面，设置筛选条件，使数据量超过 50000 条（如果可能）
2. 点击"导出 CSV"按钮
3. 观察错误提示

**预期结果:**
- 如果数据量超过 50000 条，显示错误提示："导出数据量过大（X 条），请使用筛选条件缩小范围，或联系管理员使用异步导出功能"
- 导出操作被阻止，不会执行

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC14: 排序功能

**目标:** 验证表格排序功能

**步骤:**
1. 在采购商分析表格中，点击"订单金额"列标题进行排序
2. 观察表格数据变化
3. 再次点击"订单金额"列标题，切换排序方向
4. 尝试对其他列进行排序（如订单量、订单频率等）

**预期结果:**
- 点击列标题后，表格按该列排序
- 排序方向可以切换（升序/降序）
- 排序图标正确显示

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC15: 加载状态和错误处理

**目标:** 验证页面加载状态和错误处理

**步骤:**
1. 刷新采购商分析页面
2. 观察加载状态（骨架屏）
3. 如果后端服务停止，观察错误提示
4. 重启后端服务，观察页面恢复

**预期结果:**
- 页面加载时显示骨架屏
- 如果后端服务不可用，显示错误提示
- 错误提示包含"重试"按钮
- 点击"重试"按钮后，重新加载数据

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

### TC16: 缓存功能（可选）

**目标:** 验证 Redis 缓存功能（如果 Redis 可用）

**步骤:**
1. 在采购商分析页面，执行一次查询
2. 立即再次执行相同的查询（不改变筛选条件）
3. 观察后端日志（如果可能）

**预期结果:**
- 第一次查询从数据库获取数据
- 第二次查询从 Redis 缓存获取数据（如果 Redis 可用）
- 缓存过期时间为 5 分钟

**实际结果:** [ ] 通过 / [ ] 失败

**备注:** 

---

## 测试结果汇总

### 测试执行统计

- **总测试用例数:** 16
- **通过:** [ ] 个
- **失败:** [ ] 个
- **跳过:** [ ] 个

### 功能验证

- [ ] TC1: 访问权限验证
- [ ] TC2: 采购商分析数据基础显示
- [ ] TC3: 产品类别筛选
- [ ] TC4: 时间范围筛选
- [ ] TC5: 活跃度计算和评级
- [ ] TC6: 流失风险计算和评级
- [ ] TC7: 订单频率计算
- [ ] TC8: 采购商活跃度趋势图
- [ ] TC9: 采购商流失率趋势图
- [ ] TC10: 分页功能
- [ ] TC11: 采购商名称跳转
- [ ] TC12: 导出功能
- [ ] TC13: 导出数据量限制
- [ ] TC14: 排序功能
- [ ] TC15: 加载状态和错误处理
- [ ] TC16: 缓存功能（可选）

### 发现的问题

**严重问题:**
- 无

**高优先级问题:**
- 无

**中优先级问题:**
- 无

**低优先级问题:**
- 无

### 测试结论

**总体评估:** [ ] 通过 / [ ] 失败 / [ ] 部分通过

**备注:**
- 

---

## 测试人员签名

**测试人员:** [填写姓名]  
**测试日期:** 2026-01-12  
**测试状态:** [ ] 完成

