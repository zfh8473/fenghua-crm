# 部署方案选型：Vercel 与替代方案

**日期：** 2026-01  
**项目：** fenghua-crm  
**目的：** 在「Vercel + 生产级对齐改造（R2、Cron HTTP、Worker 等）」与「迁移到 Railway / Render / Fly.io / 自托管」之间提供对比，便于选型。**本项目已选择迁移到 Railway，Epic 18 现为《迁移到 Railway 的步骤》。**

---

## 一、结论速览

| 场景 | 更合适的选择 | 说明 |
|------|--------------|------|
| 演示、试用、小团队轻量 | **Vercel + 生产级对齐** 或 **Railway** | Vercel 零运维；若不想做 R2/Cron/Worker 等改造，直接用 Railway 更省事 |
| 生产、合规、重文件与定时 | **Railway** 或 **Render** | 常驻进程、Cron、Worker、持久化友好，与「本地版本」行为更接近 |
| 要强控制、多区域、自定义 | **Fly.io** 或 **自托管 (VPS+Docker)** | 运维成本更高，适合有专职运维或明确需求时 |
| **主要用户在中国，且要求稳定、不依赖翻墙** | **国内云（阿里云 / 腾讯云 / 华为云）** 或 **香港节点** | 见 [六、主要用户在中国时的考量](#六主要用户在中国时的考量访问与翻墙) |

**若坚持 Vercel：** 需要做**对象存储（R2/S3）、定时 HTTP 入口、队列/Worker 方案与文档**等改造，才能逼近本地版本效果。若不愿投入，**建议直接迁到 Railway 或 Render**（参见 `docs/railway-deploy.md`），通常改动更小、行为更可预期。

---

## 二、能力对比

### 1. 能力对比表

| 能力 | 本地 | Vercel | Railway | Render | Fly.io | 自托管 (Docker) |
|------|------|--------|---------|--------|--------|-----------------|
| 常驻进程 | ✅ | ❌ | ✅ | ✅ | ✅ | ✅ |
| 持久化磁盘 | ✅ | ❌ 仅 /tmp | ✅ 卷 | ✅ 盘 | ✅ 卷 | ✅ |
| @Cron 定时任务 | ✅ | ❌ 不跑 | ✅ | ✅ Cron Jobs | ✅ 或 外部 | ✅ |
| BullMQ Worker 后台跑完 | ✅ | ⚠️ 不保证 | ✅ | ✅ Background Worker | ✅ | ✅ |
| 文件跨请求存在 | ✅ | ❌ 需 R2/S3 | ✅ | ✅ | ✅ | ✅ |
| 冷启动 | 无 | 有 | 有但可常开 | 有但可常开 | 有 | 无 |
| 函数/请求超时 | 无 | 10s/60s | 无硬性 | 可配 | 可配 | 无 |
| 零运维 / 与 Git 集成 | — | ✅ 很好 | ✅ 好 | ✅ 好 | 一般 | ❌ |
| 全球 CDN（前端） | — | ✅ | 需搭配 | 需搭配 | 多区域 | 自建 |
| 成本（月，粗略） | 电费/云机 | $0–20 | $5–20 | $7–25 | $5–30 | $5–50+ |

- **Vercel**：需配合 R2/S3、Vercel Cron、以及定时 HTTP 与 Worker 方案等改造，才能接近本地；否则附件、导出、定时、Worker 均受限。
- **Railway / Render**：部署 Nest 为 Web Service，再配 Redis、Neon，即可跑 Cron、Worker、写本地盘或对象存储，与本地逻辑几乎一致。
- **Fly.io**：更像「可编程的 VM」，持久卷、多区域、自定义网络都支持，上手比 Railway/Render 略复杂。
- **自托管**：最大灵活性，需要自己管 Docker、HTTPS、备份、监控，运维成本最高。

---

## 三、各平台简述

### Vercel

- **模型：** 前端静态 + 后端 Serverless Functions，按请求启停，无持久化盘，`/tmp` 仅当次请求有效。
- **优点：** 与 Git 集成好、全球 CDN、零运维、免费档友好；前端体验好。
- **缺点：** 无 Cron、无可靠后台 Worker、文件不持久，需 R2/S3 与 Cron/Worker 改造才可对齐本地。
- **适合：** 演示、小团队、前后端分离且接口以「短、无状态」为主；愿做上述改造时也可用于生产。

---

### Railway

- **模型：** 常驻 Web Service + 可选 Volume、Cron、Background Worker；同一项目可跑多个服务（API、Worker）。
- **优点：** 部署 Nest 与本地一致：`npm run build && node dist/main`（或 `nest start`），Cron、BullMQ Worker、写磁盘/R2 都可用；和 Neon、Upstash 等兼容好。
- **缺点：** 免费档有限，出站等计费需留意；多区域需自己配。
- **适合：** 希望**最少改代码**、尽快得到「和本地一样」的生产环境；不愿做 Vercel 生产级对齐改造时的首选替代。参见 `docs/railway-deploy.md`。

---

### Render

- **模型：** Web Service + Background Worker + Cron Jobs；可挂持久化盘。
- **优点：** 与 Railway 类似，Cron、Worker、持久化都支持；文档清晰，与 Neon、Upstash 常见组合有示例。
- **缺点：** 冷启动、免费档休眠策略需注意；价格略高于 Railway 免费档。
- **适合：** 与 Railway 二选一即可；若团队已熟悉 Render，可优先。

---

### Fly.io

- **模型：** 轻量 VM，多区域，支持持久 Volume、私网、多机。
- **优点：** 控制力强，可跑任意进程；适合多区域、自定义网络与存储。
- **缺点：** 概念较多（App、Machine、Volume、 regions），需一定运维经验。
- **适合：** 有多区域、合规、性能等进阶需求时，作为 Vercel/Railway 的升级选项。

---

### 自托管（VPS + Docker）

- **模型：** 自管 VM，用 Docker / Docker Compose 跑 Nest、PostgreSQL、Redis、Nginx 等。
- **优点：** 与本地环境一致度最高，Cron、Worker、文件、备份完全自控。
- **缺点：** 需自行负责 HTTPS、备份、监控、高可用；人力成本高。
- **适合：** 有专职运维、对数据与合规有强管控要求的团队。

---

## 四、选型建议（fenghua-crm）

1. **若以「演示、试用、内部轻量」为主，且接受做 Vercel 生产级对齐：**
   - 选 **Vercel**，补齐：R2、定时 HTTP + Vercel Cron、队列/Worker 文档与必要改造。

2. **若以「演示、试用」为主，但不想做上述改造（本项目当前选择）：**
   - 选 **Railway**（或 Render）：按 `docs/railway-deploy.md` 迁移，去掉 `api/index.js`、`vercel.json`、main 的 Vercel 分支，用标准 `node dist/main`；Cron、Worker、写盘沿用现有实现即可。

3. **若以「生产、合规、重附件/导出/定时」为主：**
   - 优先 **Railway** 或 **Render**，必要时加 R2/S3 做附件与导出；  
   - 若有多区域、强控制需求，再考虑 **Fly.io** 或 **自托管**。

4. **若已深度使用 Vercel，且希望继续用：**
   - 必须做**对象存储、Cron HTTP、Worker 方案**等改造，并接受：Cron 通过 HTTP + 外部调度、Worker 需评估迁出或「请求内同步 + 限流」的折中。

5. **若主要用户在中国，且要求终端用户不翻墙、访问稳定：**
   - 优先 **国内云（阿里云、腾讯云、华为云）大陆或香港节点** 部署 Nest + DB + Redis；大陆需 ICP 备案，香港多可免备案。
   - Railway / Render / Vercel 可作为演示或海外入口，国内主站不建议单独依赖；详见 [六、主要用户在中国时的考量](#六主要用户在中国时的考量访问与翻墙)。

---

## 五、Vercel 生产级对齐 与「迁移到 Railway/Render」的取舍

| 维度 | 做生产级对齐（继续 Vercel） | 迁到 Railway / Render |
|------|-----------------------------|------------------------|
| 代码改动 | 多：R2、Cron 入口、Export/GDPR/导入/备份走对象存储、文档 | 少：去掉 Vercel 特化，恢复 `listen`，Cron/Worker 基本沿用；见 `docs/railway-deploy.md` |
| 运维 | 继续零运维，但需配 R2、Vercel Cron、`CRON_SECRET` 等 | 多一层：Railway/Render 项目与 env，无 Vercel 的 Git 深度集成 |
| 行为与本地一致性 | 做完后接近，仍受 10s/60s、冷启动约束 | 高，常驻进程 + Cron + Worker 与本地一致 |
| 成本 | 前端 Vercel 可继续免费；后端 + R2 等 | Railway/Render 约 $5–25/月 起，通常含出站与基础资源 |

**建议：** 若 1–2 周内能完成 Vercel 生产级对齐，且以 Vercel 为主要入口，可优先做；否则**迁到 Railway 或 Render 通常更快、更稳**（参见 `docs/railway-deploy.md`），再按需加 R2 做附件与导出。

---

## 六、主要用户在中国时的考量（访问与翻墙）

**Railway、Render、Vercel、Fly.io 的服务器均在美国、欧洲等境外**，中国用户访问 = 走国际出口，不经过「墙」内 CDN。下面分**终端用户**和**开发/运维**说明是否涉及翻墙、以及更稳妥的选择。

### 6.1 终端用户（使用 CRM 的员工）— 通常**不需要**主动翻墙

- **现状：**  
  Railway、Render、Vercel、Fly.io 等 B2B/云托管，**未被系统性地列入屏蔽名单**（与 Google、Facebook、Twitter 等不同）。很多国内团队把前后端部署在这些平台上，**终端用户直接访问，多数情况下可以打开**，无需自己开 VPN/代理。

- **但要接受：**
  - **延迟较高：** 请求到美西/美东/欧洲，RTT 常有 200–500ms 甚至更高，页面会感觉略慢。
  - **不稳定因素：** 国际出口拥堵、路由或策略调整时，可能出现偶发超时、加载失败；**没有「保证从国内可访问」的 SLA**。
  - **地域差异：** 不同地区、运营商、时段，体验会有差别。

- **结论：**  
  若主要用户在中国，选 **Railway 或 Render**：  
  - **一般不需要**让业务用户翻墙；  
  - 需做好**预期管理**：可能偏慢、偶发访问问题；若业务强依赖「随时稳定、低延迟」，这类境外托管有风险。

### 6.2 开发 / 运维（部署、控制台、Git、npm）— **很可能**需要翻墙或专线

- **会访问的境外服务：**  
  Railway / Render 控制台、GitHub、npm 官方源、部分 Docker 镜像站、Neon/Upstash 控制台等。这些在不少地区、不少网络下**不稳定或被限制**。

- **常见做法：**
  - 开发机/运维机 **开 VPN 或代理** 访问上述服务；
  - 或用 **国内镜像**（如 npmmirror、镜像站）减少对 npm 官源的依赖；Git 可考虑 Gitee 等，但 Railway/Render 仍要从境内连出。
  - 若公司有 **国际专线 / 跨境网络**，一般可不用个人翻墙。

- **结论：**  
  选 Railway / Render 时，**开发与运维访问控制台、CI/CD、Git 等，通常需要具备翻墙或等效网络能力**；终端业务用户则不强制。

### 6.3 若要求「国内用户不翻墙、且尽量稳定」— 建议用**国内云**或**香港节点**

若业务主要在中国，且希望：

- 终端用户**不依赖翻墙**、访问延迟低、少受国际出口影响；

则更稳妥的是**把应用部署在国内或近大陆区域**，例如：

| 选择 | 说明 | 翻墙（终端用户） | 翻墙（开发/运维） |
|------|------|------------------|-------------------|
| **阿里云 / 腾讯云 / 华为云（中国节点）** | 机房在中国大陆，需** ICP 备案**；数据库、对象存储、VPS/容器都可在国内。 | ❌ 不需要 | 仅访问 GitHub、npm 等境外服务时可能需要；可用国内镜像、Gitee 等减轻 |
| **阿里云 / 腾讯云 香港节点** | 多数场景不需要备案，网络到大陆一般比美西好；合规需自行确认。 | ❌ 通常不需要 | 同左 |
| **Vercel / Railway / Render / Fly.io（美西等）** | 部署简单，但与国内隔着一个国际出口。 | ⚠️ 多数不需翻墙，但可能慢、偶发不可用 | ⚠️ 控制台、Git、npm 等常需翻墙或专线 |

- **技术栈兼容：**  
  Nest、PostgreSQL、Redis、BullMQ、对象存储等，在**阿里云、腾讯云、华为云**上都可以按「自托管 / 云托管」方式跑，和「迁到 Railway/Render」在架构上类似，只是换到国内/香港的 IaaS 或 PaaS（如阿里云 ECS + RDS + OSS，或腾讯云 轻量 / 云托管 +  TencentDB + COS）。  
- **若暂时仍用 Neon、Upstash：**  
  数据库、Redis 在境外，终端用户请求会先到国内/香港的应用服务器，再由应用服务器访问 Neon/Upstash。这样：**业务用户 ↔ 应用** 这一段在国内或香港，**不涉及用户翻墙**；**应用 ↔ Neon/Upstash** 是服务器端跨境，一般不需要用户侧翻墙，但延迟和稳定性取决于应用所在机房到 Neon/Upstash 的链路。

### 6.4 简明结论（中国用户）

| 场景 | 是否涉及翻墙（终端业务用户） | 是否涉及翻墙（开发/运维） | 建议 |
|------|------------------------------|----------------------------|------|
| **Railway / Render / Vercel / Fly.io** | 多数情况下**不需要**；可能慢、偶发不可用 | **很可能需要**（控制台、Git、npm 等） | 可接受「稍慢、偶发问题」且团队能翻墙做运维时，可用 |
| **国内云（阿里/腾讯/华为 大陆或香港）** | **不需要** | 主要用国内镜像、Gitee 时，可大幅减少；仅访问 GitHub 等时可能需翻墙 | **主要用户在中国且要求稳定、不依赖用户翻墙时，优先考虑** |

---

## 七、相关文档

- **Epic 18：迁移到 Railway**：`_bmad-output/epics.md`（Epic 18）、**`docs/railway-deploy.md`**（迁移步骤）
- 基础设施与 Vercel 注意点：`docs/infrastructure-requirements-vercel-neon.md`
- Vercel 部署步骤：`docs/vercel-quick-deploy-steps.md`、`docs/vercel-environment-variables.md`

---

**文档版本：** 1.0  
**最后更新：** 2026-01
